<!DOCTYPE html><html lang="zh-Hans" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>持续构建持续部署文档 | wdj's blog</title><meta name="author" content="wangdj"><meta name="copyright" content="wangdj"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="第一章 rke部署k8s集群   机器  192.168.17.129  192.168.17.130  192.168.17.131  192.168.17.132  参考博客：https:&#x2F;&#x2F;blog.csdn.net&#x2F;godservant&#x2F;article&#x2F;details&#x2F;80895970  安装docker 四台机器均安装docker,版本要求1.11.x 1.12.x 1.13.x 17.">
<meta property="og:type" content="article">
<meta property="og:title" content="持续构建持续部署文档">
<meta property="og:url" content="https://wangdj104.github.io/2019/12/09/jenkins%E8%87%AA%E5%8A%A8%E5%8C%96%E6%9E%84%E5%BB%BA%E9%83%A8%E7%BD%B2/index.html">
<meta property="og:site_name" content="wdj&#39;s blog">
<meta property="og:description" content="第一章 rke部署k8s集群   机器  192.168.17.129  192.168.17.130  192.168.17.131  192.168.17.132  参考博客：https:&#x2F;&#x2F;blog.csdn.net&#x2F;godservant&#x2F;article&#x2F;details&#x2F;80895970  安装docker 四台机器均安装docker,版本要求1.11.x 1.12.x 1.13.x 17.">
<meta property="og:locale">
<meta property="og:image" content="https://wangdj104.github.io/img/touxiang.png">
<meta property="article:published_time" content="2019-12-09T06:45:38.000Z">
<meta property="article:modified_time" content="2023-11-15T03:04:34.628Z">
<meta property="article:author" content="wangdj">
<meta property="article:tag" content="CI&#x2F;CD">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://wangdj104.github.io/img/touxiang.png"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://wangdj104.github.io/2019/12/09/jenkins%E8%87%AA%E5%8A%A8%E5%8C%96%E6%9E%84%E5%BB%BA%E9%83%A8%E7%BD%B2/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: 'Copy Successful',
    error: 'Copy Error',
    noSupport: 'Browser Not Supported'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: 'days',
  dateSuffix: {
    just: 'Just now',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: 'Load More'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '持续构建持续部署文档',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-11-15 11:04:34'
}</script><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
        if (t === 'dark') activateDarkMode()
        else if (t === 'light') activateLightMode()
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.3.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/touxiang.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">26</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">17</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">23</div></a></div><hr class="custom-hr"/></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><span id="blog-info"><a href="/" title="wdj's blog"><span class="site-name">wdj's blog</span></a></span><div id="menus"><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">持续构建持续部署文档</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2019-12-09T06:45:38.000Z" title="Created 2019-12-09 14:45:38">2019-12-09</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2023-11-15T03:04:34.628Z" title="Updated 2023-11-15 11:04:34">2023-11-15</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E8%87%AA%E5%8A%A8%E5%8C%96%E6%9E%84%E5%BB%BA%E6%96%87%E6%A1%A3/">自动化构建文档</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E8%87%AA%E5%8A%A8%E5%8C%96%E6%9E%84%E5%BB%BA%E6%96%87%E6%A1%A3/jenkins%E8%87%AA%E5%8A%A8%E6%9E%84%E5%BB%BA%E9%83%A8%E7%BD%B2/">jenkins自动构建部署</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="持续构建持续部署文档"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post Views:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="第一章-rke部署k8s集群"><a href="#第一章-rke部署k8s集群" class="headerlink" title="第一章 rke部署k8s集群"></a>第一章 rke部署k8s集群</h1><blockquote>
<p>  机器<br>  192.168.17.129<br>  192.168.17.130<br>  192.168.17.131<br>  192.168.17.132<br>  参考博客：<a target="_blank" rel="noopener" href="https://blog.csdn.net/godservant/article/details/80895970">https://blog.csdn.net/godservant/article/details/80895970</a></p>
</blockquote>
<h2 id="安装docker"><a href="#安装docker" class="headerlink" title="安装docker"></a>安装docker</h2><p><img src="/img/media/48bd15a6a74e91332f66dcc57374cf6b.png"></p>
<p>四台机器均安装docker,版本要求1.11.x 1.12.x 1.13.x 17.03.x</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">chmod</span> +x docker-compose<br><span class="hljs-built_in">mv</span> docker-compose /usr/bin/<br>rpm -ivh *.rpm --nodeps --force<br>systemctl start docker<br>systemctl <span class="hljs-built_in">enable</span> docker<br><br>vim /etc/docker/daemon.json<br>&#123;<br><span class="hljs-string">&quot;insecure-registries&quot;</span>:[<span class="hljs-string">&quot;0.0.0.0/0&quot;</span>]<br>&#125;<br><br>systemctl restart docker<br></code></pre></td></tr></table></figure>

<h2 id="运行环境"><a href="#运行环境" class="headerlink" title="运行环境"></a>运行环境</h2><table>
<thead>
<tr>
<th>软件</th>
<th>版本&#x2F;镜像</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td>OS</td>
<td>RHEL 7.2</td>
<td></td>
</tr>
<tr>
<td>Docker</td>
<td>1.12.6</td>
<td></td>
</tr>
<tr>
<td>RKE</td>
<td>v0.0.12-dev</td>
<td></td>
</tr>
<tr>
<td>kubectl</td>
<td>v1.8.4</td>
<td></td>
</tr>
<tr>
<td>Kubernetes</td>
<td>rancher&#x2F;k8s:v1.8.3-rancher2</td>
<td></td>
</tr>
<tr>
<td>canal</td>
<td>quay.io&#x2F;calico&#x2F;node:v2.6.2</td>
<td></td>
</tr>
<tr>
<td></td>
<td>quay.io&#x2F;calico&#x2F;cni:v1.11.0</td>
<td></td>
</tr>
<tr>
<td></td>
<td>quay.io&#x2F;coreos&#x2F;flannel:v0.9.1</td>
<td></td>
</tr>
<tr>
<td>etcd</td>
<td>quay.io&#x2F;coreos&#x2F;etcd:latest</td>
<td></td>
</tr>
<tr>
<td>alpine</td>
<td>alpine:latest</td>
<td></td>
</tr>
<tr>
<td>Nginx proxy</td>
<td>rancher&#x2F;rke-nginx-proxy:v0.1.0</td>
<td></td>
</tr>
<tr>
<td>Cert downloader</td>
<td>rancher&#x2F;rke-cert-deployer:v0.1.1</td>
<td></td>
</tr>
<tr>
<td>Service sidekick</td>
<td>rancher&#x2F;rke-service-sidekick:v0.1.0</td>
<td></td>
</tr>
<tr>
<td>kubedns</td>
<td>gcr.io&#x2F;google_containers&#x2F;k8s-dns-kube-dns-amd64:1.14.5</td>
<td></td>
</tr>
<tr>
<td>dnsmasq</td>
<td>gcr.io&#x2F;google_containers&#x2F;k8s-dns-dnsmasq-nanny-amd64:1.14.5</td>
<td></td>
</tr>
<tr>
<td>Kubedns sidecar</td>
<td>gcr.io&#x2F;google_containers&#x2F;k8s-dns-sidecar-amd64:1.14.5</td>
<td></td>
</tr>
<tr>
<td>Kubedns autoscaler</td>
<td>gcr.io&#x2F;google_containers&#x2F;cluster-proportional-autoscaler-amd64:1.0.0</td>
<td></td>
</tr>
</tbody></table>
<h2 id="部署k8s集群"><a href="#部署k8s集群" class="headerlink" title="部署k8s集群"></a>部署k8s集群</h2><h3 id="创建rke用户并设置rke的ssh免密"><a href="#创建rke用户并设置rke的ssh免密" class="headerlink" title="创建rke用户并设置rke的ssh免密"></a>创建rke用户并设置rke的ssh免密</h3><p>su - rke（只要是集群节点，就需要做免密，包括自己）</p>
<p>1、生成默认格式的密匙key，此过程会在&#x2F;root&#x2F;.ssh&#x2F;文件件夹下生成id_rsa(私钥）和id_rsa.pub(公钥）。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">ssh-keygen<br></code></pre></td></tr></table></figure>

<p><img src="/img/media/8c155f4aa279af2d24060ca82d279ee4.png"></p>
<p>查看&#x2F;root&#x2F;.ssh&#x2F;目录</p>
<p><img src="/img/media/5b8fad9294e9148af71047cac746541c.png"></p>
<p>2、将公钥id_rsa.pub复制到远程主机&#x2F;root&#x2F;.ssh&#x2F;文件中，并且重命名为authorized_keys。（此处以远程主机ip为192.168.17.130举例）</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">ssh-copy-id  -i  ~/.ssh/id_rsa.pub rke@192.168.17.130<br></code></pre></td></tr></table></figure>

<p><img src="/img/media/07a4c4521ebc1bcbaa9a31ea16cb950e.png"></p>
<h3 id="关闭swap分区"><a href="#关闭swap分区" class="headerlink" title="关闭swap分区"></a>关闭swap分区</h3><p>Kubelet运行是需要worker节点关闭swap分区，执行以下命令关闭swap分区</p>
<p>1）永久禁用swap</p>
<p>可以直接修改&#x2F;etc&#x2F;fstab文件，注释掉swap项</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">vi /etc/fstab<br></code></pre></td></tr></table></figure>

<p>2）临时禁用</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">swapoff -a<br></code></pre></td></tr></table></figure>

<h3 id="将rke用户加入到docker用户组"><a href="#将rke用户加入到docker用户组" class="headerlink" title="将rke用户加入到docker用户组"></a>将rke用户加入到docker用户组</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">usermod -aG docker &lt;user_name&gt;<br><br>eg: usermod -aG docker rke<br></code></pre></td></tr></table></figure>

<p>关闭内核防火墙</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">vim /etc/selinux/config<br></code></pre></td></tr></table></figure>
<p><img src="/img/media/de16dd1392ef19a1702cd290b8f8bb3d.png"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">reboot<br></code></pre></td></tr></table></figure>

<h3 id="下载rke和kubectl"><a href="#下载rke和kubectl" class="headerlink" title="下载rke和kubectl"></a>下载rke和kubectl</h3><p>（1）rke最新版本下载: <a target="_blank" rel="noopener" href="https://github.com/rancher/rke/releases/">https://github.com/rancher/rke/releases/</a>, 下载rke_linux-amd64</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">    <span class="hljs-built_in">mv</span> rke_linux-amd64 rke<br>    <span class="hljs-built_in">chmod</span> +x rke<br><span class="hljs-built_in">mv</span> rke  /usr/bin/<br></code></pre></td></tr></table></figure>
<p>（2）Kubectl下载：<a target="_blank" rel="noopener" href="https://storage.googleapis.com/kubernetes-release/release/v1.7.0/bin/darwin/amd64/kubectl">https://storage.googleapis.com/kubernetes-release/release/v1.7.0/bin/darwin/amd64/kubectl</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">chmod</span> +x kubectl<br><span class="hljs-built_in">mv</span> kubectl  /usr/bin/<br></code></pre></td></tr></table></figure>

<h3 id="部署私有容器镜像仓库harbor"><a href="#部署私有容器镜像仓库harbor" class="headerlink" title="部署私有容器镜像仓库harbor"></a>部署私有容器镜像仓库harbor</h3><p>首先将搭建集群所需的镜像上传到公有harbor上.在镜像所在机器保存特定标签的镜像</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">docker images --format <span class="hljs-string">&quot;&#123;&#123;.Repository&#125;&#125;:&#123;&#123;.Tag&#125;&#125;&quot;</span>\|grep 192.168.17.130<br><br>docker save -o rke.tar.gz $(docker images --format <span class="hljs-string">&quot;&#123;&#123;.Repository&#125;&#125;:&#123;&#123;.Tag&#125;&#125;&quot;</span>|grep 192.168.17.130)<br></code></pre></td></tr></table></figure>
<p>所有镜像下载链接: <a target="_blank" rel="noopener" href="https://pan.baidu.com/s/1flpjyrVHX283f-t0b7RFtQ">https://pan.baidu.com/s/1flpjyrVHX283f-t0b7RFtQ</a> 提取码: ubct</p>
<p><img src="/img/media/bb56c8b78b1fc27b90b9c296e5ddf220.png"></p>
<h3 id="修改hosts文件-非必须"><a href="#修改hosts文件-非必须" class="headerlink" title="修改hosts文件(非必须)"></a>修改hosts文件(非必须)</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">vim /etc/hots<br><br>192.168.17.129 rke<br>192.168.17.130 node1<br>192.168.17.131 node2<br>192.168.17.132 node3<br></code></pre></td></tr></table></figure>
<h3 id="编辑集群配置文件cluster-yml"><a href="#编辑集群配置文件cluster-yml" class="headerlink" title="编辑集群配置文件cluster.yml"></a>编辑集群配置文件cluster.yml</h3><p>可以直接在主机的rke用户下执行： .&#x2F;rke config 命令, 生成配置文件: cluster.yml 。本次为了方便，我直接上传cluster.yml，具体内容如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">su - rke<br></code></pre></td></tr></table></figure>
<p>创建cluster.yml文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># If you intened to deploy Kubernetes in an air-gapped environment,</span><br><span class="hljs-comment"># please consult the documentation on how to configure custom RKE images.</span><br>nodes:<br>- address: <span class="hljs-string">&quot;192.168.17.129&quot;</span><br>  port: <span class="hljs-string">&quot;22&quot;</span><br>  internal_address: <span class="hljs-string">&quot;&quot;</span><br>  role:<br>  - controlplane<br>  - etcd<br>  - worker<br>  hostname_override: <span class="hljs-string">&quot;&quot;</span><br>  user: rke<br>  docker_socket: /var/run/docker.sock<br>  ssh_key: <span class="hljs-string">&quot;&quot;</span><br>  ssh_key_path: ~/.ssh/id_rsa<br>  labels: &#123;&#125;<br>- address: <span class="hljs-string">&quot;192.168.17.130&quot;</span><br>  port: <span class="hljs-string">&quot;22&quot;</span><br>  internal_address: <span class="hljs-string">&quot;&quot;</span><br>  role:<br>  - etcd<br>  - worker<br>  hostname_override: <span class="hljs-string">&quot;&quot;</span><br>  user: rke<br>  docker_socket: /var/run/docker.sock<br>  ssh_key: <span class="hljs-string">&quot;&quot;</span><br>  ssh_key_path: ~/.ssh/id_rsa<br>  labels: &#123;&#125;<br>- address: <span class="hljs-string">&quot;192.168.17.131&quot;</span><br>  port: <span class="hljs-string">&quot;22&quot;</span><br>  internal_address: <span class="hljs-string">&quot;&quot;</span><br>  role:<br>  - worker<br>  hostname_override: <span class="hljs-string">&quot;&quot;</span><br>  user: rke<br>  docker_socket: /var/run/docker.sock<br>  ssh_key: <span class="hljs-string">&quot;&quot;</span><br>  ssh_key_path: ~/.ssh/id_rsa<br>  labels: &#123;&#125;<br>services:<br>  etcd:<br>    image: <span class="hljs-string">&quot;&quot;</span><br>    extra_args: &#123;&#125;<br>    extra_binds: []<br>    extra_env: []<br>    external_urls: []<br>    ca_cert: <span class="hljs-string">&quot;&quot;</span><br>    cert: <span class="hljs-string">&quot;&quot;</span><br>    key: <span class="hljs-string">&quot;&quot;</span><br>    path: <span class="hljs-string">&quot;&quot;</span><br>    snapshot: <span class="hljs-literal">false</span><br>    retention: <span class="hljs-string">&quot;&quot;</span><br>    creation: <span class="hljs-string">&quot;&quot;</span><br>  kube-api:<br>    image: <span class="hljs-string">&quot;&quot;</span><br>    extra_args: &#123;&#125;<br>    extra_binds: []<br>    extra_env: []<br>    service_cluster_ip_range: 10.43.0.0/16<br>    service_node_port_range: <span class="hljs-string">&quot;&quot;</span><br>    pod_security_policy: <span class="hljs-literal">false</span><br>  kube-controller:<br>    image: <span class="hljs-string">&quot;&quot;</span><br>    extra_args: &#123;&#125;<br>    extra_binds: []<br>    extra_env: []<br>    cluster_cidr: 10.42.0.0/16<br>    service_cluster_ip_range: 10.43.0.0/16<br>  scheduler:<br>    image: <span class="hljs-string">&quot;&quot;</span><br>    extra_args: &#123;&#125;<br>    extra_binds: []<br>    extra_env: []<br>  kubelet:<br>    image: <span class="hljs-string">&quot;&quot;</span><br>    extra_args: &#123;&#125;<br>    extra_binds: []<br>    extra_env: [Environment=<span class="hljs-string">&quot;KUBELET_SYSTEM_PODS_ARGS=--pod-manifest-path=/etc/kubernetes/manifests --allow-privileged=true --fail-swap-on=false&quot;</span>]<br>    cluster_domain: cluster.local<br>    infra_container_image: <span class="hljs-string">&quot;&quot;</span><br>    cluster_dns_server: 10.43.0.10<br>    fail_swap_on: <span class="hljs-literal">false</span><br>  kubeproxy:<br>    image: <span class="hljs-string">&quot;&quot;</span><br>    extra_args: &#123;&#125;<br>    extra_binds: []<br>    extra_env: []<br>network:<br>  plugin: canal<br>  options: &#123;&#125;<br>authentication:<br>  strategy: x509<br>  options: &#123;&#125;<br>  sans: []<br>addons: <span class="hljs-string">&quot;&quot;</span><br>addons_include: []<br>system_images:<br>  etcd: 192.168.17.132/rke/quay.io/coreos/etcd:v3.1.12<br>  alpine: 192.168.17.132/rke/rancher/rke-tools:v0.1.13<br>  nginx_proxy: 192.168.17.132/rke/rancher/rke-tools:v0.1.13<br>  cert_downloader: 192.168.17.132/rke/rancher/rke-tools:v0.1.13<br>  kubernetes_services_sidecar: 192.168.17.132/rke/rancher/rke-tools:v0.1.13<br>  kubedns: 192.168.17.132/rke/gcr.io/google_containers/k8s-dns-kube-dns-amd64:1.14.7<br>  dnsmasq: 192.168.17.132/rke/gcr.io/google_containers/k8s-dns-dnsmasq-nanny-amd64:1.14.7<br>  kubedns_sidecar: 192.168.17.132/rke/gcr.io/google_containers/k8s-dns-sidecar-amd64:1.14.7<br>  kubedns_autoscaler: 192.168.17.132/rke/gcr.io/google_containers/cluster-proportional-autoscaler-amd64:1.0.0<br>  kubernetes: 192.168.17.132/rke/rancher/hyperkube:v1.9.7-rancher2<br>  flannel: 192.168.17.132/rke/quay.io/coreos/flannel:v0.9.1<br>  flannel_cni: 192.168.17.132/rke/quay.io/coreos/flannel-cni:v0.2.0<br>  calico_node: 192.168.17.132/rke/quay.io/calico/node:v3.1.1<br>  calico_cni: 192.168.17.132/rke/quay.io/calico/cni:v3.1.1<br>  calico_controllers: <span class="hljs-string">&quot;&quot;</span><br>  calico_ctl: 192.168.17.132/rke/quay.io/calico/ctl:v2.0.0<br>  canal_node: 192.168.17.132/rke/quay.io/calico/node:v3.1.1<br>  canal_cni: 192.168.17.132/rke/quay.io/calico/cni:v3.1.1<br>  canal_flannel: 192.168.17.132/rke/quay.io/coreos/flannel:v0.9.1<br>  wave_node: 192.168.17.132/rke/weaveworks/weave-kube:2.1.2<br>  weave_cni: 192.168.17.132/rke/weaveworks/weave-npc:2.1.2<br>  pod_infra_container: 192.168.17.132/rke/gcr.io/google_containers/pause-amd64:3.0<br>  ingress: 192.168.17.132/rke/rancher/nginx-ingress-controller:0.16.2-rancher1<br>  ingress_backend: 192.168.17.132/rke/k8s.gcr.io/defaultbackend:1.4<br>  metrics_server: 192.168.17.132/rke/metrics-server-amd64:v0.2.1<br>ssh_key_path: ~/.ssh/id_rsa<br>ssh_agent_auth: <span class="hljs-literal">false</span><br>authorization:<br>  mode: rbac<br>  options: &#123;&#125;<br>ignore_docker_version: <span class="hljs-literal">false</span><br>kubernetes_version: <span class="hljs-string">&quot;&quot;</span><br>private_registries: []<br>ingress:<br>  provider: <span class="hljs-string">&quot;&quot;</span><br>  options: &#123;&#125;<br>  node_selector: &#123;&#125;<br>  extra_args: &#123;&#125;<br>cluster_name: <span class="hljs-string">&quot;&quot;</span><br>cloud_provider:<br>  name: <span class="hljs-string">&quot;&quot;</span><br>prefix_path: <span class="hljs-string">&quot;&quot;</span><br>addon_job_timeout: 0<br>bastion_host:<br>  address: <span class="hljs-string">&quot;&quot;</span><br>  port: <span class="hljs-string">&quot;&quot;</span><br>  user: <span class="hljs-string">&quot;&quot;</span><br>  ssh_key: <span class="hljs-string">&quot;&quot;</span><br>  ssh_key_path: <span class="hljs-string">&quot;&quot;</span><br>monitoring:<br>  provider: <span class="hljs-string">&quot;&quot;</span><br>  options: &#123;&#125;<br><br></code></pre></td></tr></table></figure>
<h3 id="启动rke，部署集群"><a href="#启动rke，部署集群" class="headerlink" title="启动rke，部署集群"></a>启动rke，部署集群</h3><p>执行</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">rke -d up<br></code></pre></td></tr></table></figure>
<p>或</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">rke up -config cluster.yml<br></code></pre></td></tr></table></figure>

<p>出现下图即为成功</p>
<p><img src="/img/media/4c42edd5fb914ecaccf04a28b21a66e9.png"></p>
<h3 id="移动集群配置文件"><a href="#移动集群配置文件" class="headerlink" title="移动集群配置文件"></a>移动集群配置文件</h3><p>运行rke成功部署集群后会生成.kube_config_cluster.yml文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cp</span> kube_config_cluster.yml /home/rke/.kube/config<br></code></pre></td></tr></table></figure>

<h3 id="删除k8s集群"><a href="#删除k8s集群" class="headerlink" title="删除k8s集群"></a>删除k8s集群</h3><p>运行</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">rke -d remove<br></code></pre></td></tr></table></figure>
<p>或</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">rke remove -config cluster.yml<br></code></pre></td></tr></table></figure>
<p>清理节点上的docker容器，在每个节点上执行如下命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">docker <span class="hljs-built_in">rm</span> -fv $(docker ps -aq)<br></code></pre></td></tr></table></figure>

<h3 id="为集群节点创建标签"><a href="#为集群节点创建标签" class="headerlink" title="为集群节点创建标签"></a>为集群节点创建标签</h3><p>为节点创建标签</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">kubectl label node 192.168.17.131 ci.role=slave<br></code></pre></td></tr></table></figure>
<p>获取节点信息(带节点的标签)</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">kubectl get node --show-labels<br></code></pre></td></tr></table></figure>
<p>查询带特定标签的节点</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">kubectl get node -a -l <span class="hljs-string">&quot; ci.role=slave &quot;</span><br></code></pre></td></tr></table></figure>
<p>删除一个Label，只需在命令行最后指定Label的key名并与一个减号相连即可</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">kubectl label nodes 192.168.17.131 ci.role-<br></code></pre></td></tr></table></figure>
<p>然后在pipeline中就可以加：nodeSelector: ‘ci.role&#x3D;slaver’ 语句了</p>
<p><img src="/img/media/f3b0fb746792560fc48c19dcc125e443.png"></p>
<h3 id="为集群创建maven-setting"><a href="#为集群创建maven-setting" class="headerlink" title="为集群创建maven-setting"></a>为集群创建maven-setting</h3><p>创建configmap-setting.yaml文件：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><code class="hljs bash">apiVersion: v1<br>data:<br>  settings.xml: |<br>    &lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;<br><br>    &lt;settings xmlns=<span class="hljs-string">&quot;http://maven.apache.org/SETTINGS/1.0.0&quot;</span><br>              xmlns:xsi=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><br>              xsi:schemaLocation=<span class="hljs-string">&quot;http://maven.apache.org/SETTINGS/1.0.0 http://maven.apache.org/xsd/settings-1.0.0.xsd&quot;</span>&gt;<br><br>      &lt;pluginGroups&gt;<br>      &lt;/pluginGroups&gt;<br><br>      &lt;proxies&gt;<br>      &lt;/proxies&gt;<br><br>      &lt;servers&gt;<br>       &lt;server&gt;<br>       &lt;<span class="hljs-built_in">id</span>&gt;chinaunicom&lt;/id&gt;<br>       &lt;username&gt;admin&lt;/username&gt;<br>       &lt;password&gt;11111111&lt;/password&gt;<br>      &lt;/server&gt;<br>       &lt;server&gt;<br>       &lt;<span class="hljs-built_in">id</span>&gt;maven-snapshot-manager&lt;/id&gt;<br>       &lt;username&gt;admin&lt;/username&gt;<br>       &lt;password&gt;11111111&lt;/password&gt;<br>       &lt;/server&gt;<br>       &lt;server&gt;<br>       &lt;<span class="hljs-built_in">id</span>&gt;maven-release-manager&lt;/id&gt;<br>       &lt;username&gt;admin&lt;/username&gt;<br>       &lt;password&gt;11111111&lt;/password&gt;<br>       &lt;/server&gt;<br>      &lt;/servers&gt;<br><br>      &lt;mirrors&gt;<br>        &lt;mirror&gt;<br>          &lt;<span class="hljs-built_in">id</span>&gt;chinaunicom&lt;/id&gt;<br>          &lt;mirrorOf&gt;*&lt;/mirrorOf&gt;<br>          &lt;name&gt;Human Readable Name <span class="hljs-keyword">for</span> this Mirror.&lt;/name&gt;<br>          &lt;url&gt;http://192.168.17.132:8081/repository/maven-public/&lt;/url&gt;<br>        &lt;/mirror&gt;<br>         &lt;mirror&gt;<br>          &lt;<span class="hljs-built_in">id</span>&gt;maven-snapshot-manager&lt;/id&gt;<br>          &lt;mirrorOf&gt;*&lt;/mirrorOf&gt;<br>          &lt;name&gt;Human Readable Name <span class="hljs-keyword">for</span> this Mirror.&lt;/name&gt;<br>          &lt;url&gt;http://192.168.17.132:8081/repository/maven-snapshots/&lt;/url&gt;<br>        &lt;/mirror&gt;<br>        &lt;mirror&gt;<br>          &lt;<span class="hljs-built_in">id</span>&gt;maven-release-manager&lt;/id&gt;<br>          &lt;mirrorOf&gt;*&lt;/mirrorOf&gt;<br>          &lt;name&gt;Human Readable Name <span class="hljs-keyword">for</span> this Mirror.&lt;/name&gt;<br>          &lt;url&gt;http://192.168.17.132:8081/repository/maven-releases/&lt;/url&gt;<br>        &lt;/mirror&gt;<br><br><br>      &lt;/mirrors&gt;<br><br>      &lt;profiles&gt;<br>      &lt;/profiles&gt;<br><br>    &lt;/settings&gt;<br>kind: ConfigMap<br>metadata:<br>  name: configmap-maven-settings-mirror-31010<br>  namespace: jenkins<br><br></code></pre></td></tr></table></figure>

<p>执行命令</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">kubectl create -f configmap-setting.yaml<br></code></pre></td></tr></table></figure>
<p>创建名为configmap-maven-settings-mirror-31010的configMap,然后pipeline中就可以如下配置：</p>
<p><img src="/img/media/951808da060f5c65e9c14dadfe2c1f0d.png"></p>
<p>查看configMap</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">kubectl get configmap -n jenkins<br></code></pre></td></tr></table></figure>

<h3 id="为集群创建configMap"><a href="#为集群创建configMap" class="headerlink" title="为集群创建configMap"></a>为集群创建configMap</h3><p>创建kubeconfig-dev.yaml文件：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs bash">apiVersion: v1<br>data:<br>  config: |<br>    apiVersion: v1<br>    kind: Config<br>    clusters:<br>    - cluster:<br>        api-version: v1<br>        certificate-authority-data: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUN3akNDQWFxZ0F3SUJBZ0lCQURBTkJna3Foa2lHOXcwQkFRc0ZBREFTTVJBd0RnWURWUVFERXdkcmRXSmwKTFdOaE1CNFhEVEU1TVRJd01URXlOREkwTTFvWERUSTVNVEV5T0RFeU5ESTBNMW93RWpFUU1BNEdBMVVFQXhNSAphM1ZpWlMxallUQ0NBU0l3RFFZSktvWklodmNOQVFFQkJRQURnZ0VQQURDQ0FRb0NnZ0VCQU53TVdZY1dheGk3ClA0VXNhOExCSW1NL3Q3bUlZMEVHTnZia2dGd3hpR2tBODhBMXJ3SjhzNFE3cFRmS3BzS3Zublp2QlY4aHdpNmQKKzZkK0xFMTlTRFNvL2owRHMzUDRJNFY5S3E1Mk9sRzN4U0pFTXY3VW9DM0VJOE9OM1pMZnIwSlpNRnpvaW1BbwpjUjFDTENlVVN0WDNudXk5K2Y0cjBuaEZGRDcyNkFJTmN3QlB6SjI5RHcwZ3grbmFuVnh6S3UzSjJOSm9hS05jCm41V0dMeUE4V2YxNUdUQVdGL29rcklkTHZFTUxQSUx5SG43elRHZm52TFNTRVhJWTFBZEl2bFRlcmI2UXdNUjIKcWFMSlg4WEo0WTlQR0UvdktUVGdrMHZGdm9ZQTcvbnZQdGRoUTF2aGJqcWpsL2NJM0JtYnhnNFZJL1RUQzl3SQppQ0IzeUdVeXpGRUNBd0VBQWFNak1DRXdEZ1lEVlIwUEFRSC9CQVFEQWdLa01BOEdBMVVkRXdFQi93UUZNQU1CCkFmOHdEUVlKS29aSWh2Y05BUUVMQlFBRGdnRUJBTTBJakVGSHM0TmNiT1FQNVdpd0tXZ0k0WDdMZy9Sa2VCK20KaWx3YzU4aU1XR3ZGT1hJc3ZBaFU1YVdUSHlIQUt2VGd2U2xyamlwSDJxeVZVQTlkSlNkcjBCL2RPdnBac1RIcAprakdFOGFTYkNnajJBQ2o1bEZjT21DSC9oeTRPVHlnSEl0amJDaVpjejMvOVVZVTlkczh4RWlLejlsUDRwelE5Cm5IRGxwemJyU09pbWsrQTFiZTRQWXNIL0ozUWJ6cGs1VERWbEp0eWlGbHhBU2RWdmJUUWtMMjRUMXZHWFp3K1YKcEE0S1h1OTlTaTZncVhHeFQrcElJUE9HSjZzcDM2eXh1RE5YSnhKdGpTUk9zTWhlMm9oT0pXencwYUpWYWtpSQpqbDNiSnlMcDlVd2ZrOEZFOUd2UlVBd1c4VitCYzk1MkhwR2wyaXVyazZoSTVqV2ZEUnc9Ci0tLS0tRU5EIENFUlRJRklDQVRFLS0tLS0K<br>        server: <span class="hljs-string">&quot;https://192.168.17.129:6443&quot;</span><br>      name: <span class="hljs-string">&quot;local&quot;</span><br>    contexts:<br>    - context:<br>        cluster: <span class="hljs-string">&quot;local&quot;</span><br>        user: <span class="hljs-string">&quot;kube-admin-local&quot;</span><br>      name: <span class="hljs-string">&quot;local&quot;</span><br>    current-context: <span class="hljs-string">&quot;local&quot;</span><br>    <span class="hljs-built_in">users</span>:<br>    - name: <span class="hljs-string">&quot;kube-admin-local&quot;</span><br>      user:<br>        client-certificate-data: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUM2VENDQWRHZ0F3SUJBZ0lJSXMrbG05aXN6RW93RFFZSktvWklodmNOQVFFTEJRQXdFakVRTUE0R0ExVUUKQXhNSGEzVmlaUzFqWVRBZUZ3MHhPVEV5TURFeE1qUXlORE5hRncweU1ERXhNekF4TWpReU5EWmFNQzR4RnpBVgpCZ05WQkFvVERuTjVjM1JsYlRwdFlYTjBaWEp6TVJNd0VRWURWUVFERXdwcmRXSmxMV0ZrYldsdU1JSUJJakFOCkJna3Foa2lHOXcwQkFRRUZBQU9DQVE4QU1JSUJDZ0tDQVFFQXNLdGtaZWY4bzMzdzB0VmpmbFZITVMrVHpCM0QKV2NnM1o3L3JMZ0UzTS9ySlkvdUtJV2RiTmxYZG1ZeTBJakdQVEZqNFl4eHV4Ymo4cy9xVmdDR1dJQUk2dVAxcgpxYUlZdm5ud3dWZUVDcTZsZG9TM09vYTFGQzFlTFg3Z0o2OWE0UVprR2lYNHhZYkpkTUNTWm92N3JzamtIbUgvCmJ3Z010cVlzdk9sOTJ6S2NiaEtFNG5GejVlN3A2Qm5wL05BQXhvYnF2K0F4VHlrYUdBYWRna0trM3Jrd2VCUkIKODVQV0pSZDVITDBwOTUybzFwdkthbGx0MVh1a0ZPTHgzc3lJdTQrR1EwbWJWQkVmeVRYM2JoSFlpaG05NDlHdgo1c0MySVN4WUxLT0RSc2xuY1lVcGVYYVR5NldJRmFMODc1ZFVIaG9vRVZFTjJ5WnVYVlMvZmVMWWp3SURBUUFCCm95Y3dKVEFPQmdOVkhROEJBZjhFQkFNQ0JhQXdFd1lEVlIwbEJBd3dDZ1lJS3dZQkJRVUhBd0l3RFFZSktvWkkKaHZjTkFRRUxCUUFEZ2dFQkFKQktqZjZ1Zk40ZjBmdTBHMFQxNHJZWS96VGRPSjNOeGxBMXp3aUJrQndNWHFXcApBQW5HOFp6bzlvYWE0MFNkR2FRUUVCSnR4ZHFBYWNWOW1kREFJM1lmdW1UQlVTdVZCSDdEYUx4RG9HU283NElDCkFpVkYzNWk1cGRkWjNZRCt4c2Q1Ni94QXBJdTFvOGpxVFFRejlQUDFIZFRMaTNZYm9OM0FOdFNKZnFlSlBVckcKYXJjTDdmdGRldEdvdWJUdlhPazIxOXk3YldpRE9xSlFqVkpVajVudkNXL25xRFBmbDZmbkZ1YStxMUg4bXZ4QwpzRDdlMEgra0F0RHN5TW1RbXRzd2l4alpkVU5vRzZYZUlMZ25aaEMrejVWdjlRd0hEMXd4YXdRc0pZK3YzU0drClAydWFMcXFXb1FwQklmZHZXaThzK29DdTA1NXlYNzZpODgxVTFsWT0KLS0tLS1FTkQgQ0VSVElGSUNBVEUtLS0tLQo=<br>        client-key-data: LS0tLS1CRUdJTiBSU0EgUFJJVkFURSBLRVktLS0tLQpNSUlFcEFJQkFBS0NBUUVBc0t0a1plZjhvMzN3MHRWamZsVkhNUytUekIzRFdjZzNaNy9yTGdFM00vckpZL3VLCklXZGJObFhkbVl5MElqR1BURmo0WXh4dXhiajhzL3FWZ0NHV0lBSTZ1UDFycWFJWXZubnd3VmVFQ3E2bGRvUzMKT29hMUZDMWVMWDdnSjY5YTRRWmtHaVg0eFliSmRNQ1Nab3Y3cnNqa0htSC9id2dNdHFZc3ZPbDkyektjYmhLRQo0bkZ6NWU3cDZCbnAvTkFBeG9icXYrQXhUeWthR0FhZGdrS2szcmt3ZUJSQjg1UFdKUmQ1SEwwcDk1Mm8xcHZLCmFsbHQxWHVrRk9MeDNzeUl1NCtHUTBtYlZCRWZ5VFgzYmhIWWlobTk0OUd2NXNDMklTeFlMS09EUnNsbmNZVXAKZVhhVHk2V0lGYUw4NzVkVUhob29FVkVOMnladVhWUy9mZUxZandJREFRQUJBb0lCQUN2MDJPd0tCbS9mTy9ZWgpKY0lmRWJHSk51cklWUHlYdGtGWUhQbTdUN0xkS1JKNVdXcnFQbVdNZzdCYXM4NzJLY05ETjduaEx5WisybEVsCmZlRDllazdJZnpmYnhkZlUvdmNWZS9OL0JObHJqcnVvVmJaNEljRzliL3M5NENPL200cjFmaDZMYUJRdGJ4NWYKYzQyVU1yRFFSd0hRUEMreC93ZkszTUs4RFpabDNRM0xzN21aM0ZHaVB3ajR1dFBYb0pQNzJxdC9xSUVNTnZIOQo0c0xZb1NzekM5NW9hcWk2Unh1V2pvZHVPazJxMjlZR2w4VHQxOXdiOEs3K2xzV0p5YndwVHQ5S1FSRXhucHorCmtYbFdXNWpwaXM2L3JHTkRYWGdhcHdvNW1jSCtPOHVrYmtscDlyaDVPS0hvRGc5aWhHUkhSODBQVkNWVkRxQ2QKRFUvbkpMRUNnWUVBd3MwTmFwcGNLSG9yKzFDU3d6ckJ6WlU5a3YvSXhDNFY5bjRqVUxyallXT1dNb1Bya3pDZwpqK3lRRk9pK0tjaEdJTEdhT3dzUlhGeGRocEdBWk16VGx0UmE0TmZONEI4MFg2SFdWWHFkZjB6ajBsNEcxRlUvCmpKM2xWS0hmU3czNmh2NEV1QVRrRE03NTNzeFY4OGRsK21qV1pKYkt3dHhBdGFQWW81blplbnNDZ1lFQTZDd2IKbDV1Y3dOVGd5RXY4QmYvWHJ4SFJRc2toSVBGbUtNOXBOUGRzUTBPT1pKTnBvYVprdVNVaEZ3NEZzV2Uvb1AvQwpjMGJ6OTlJTFMyZVRrYjhweUZTOStLYUhMNzBZQ1MzcTRjbWlEVE4xZWhwbURDajZ3c2d5aGY0K1pURTlzRmxmCnNkT2xaWElLOFB3c1NXQ3o2Ym1hWExQbnRPVlJ2SWR3WmVwdlYvMENnWUJORWlXeHZKcWpwUnFMbHVoSjk1QS8KejBFS1RNclkyMGJ6UEJxcTBSWXZMT0I2NGZpdFJucndGbTgyNXBKK0kyK2pkY0VJaFN0OE9Fc0VkOEt0bnVCRAo5NFp4R05DcVVJNC9HOStaK0NZaC9JRFNkVU1NZFNIc2QzZ0pVUFh3VXZxQXVEV1R2Tk9oUWE1WWVNMjA0bm8xClpZOFZReGU3bXJxN1lyVE9uWXNPeXdLQmdRQzgxUHNRSVBHcWFMbjJUczdKTmwvL05SZWxJUjcvd3pjYTVDOG0KZEVLcXBxeU9vdExjTmhCZ0FaSGJSWDFkNEFzYzhFZ0FLR3BQV3BmekdXZ050NVJOS3Bka1FGVmRmNGVvRjUrZApTcml4MGZPdmZ2OFd6dEc5VU1TKzlKMWRBbUt4SnMvTk8xMmZsOVRNVWQzWFJINndEMVE4SjlyQjUyM0dUOFljCkxrT25KUUtCZ1FDSXEydk42NTdHbUNOMUtCTlpMOGwvVWJud0twMEtKbVdOZ3RLU0VzTytvcnMvbFNnVlRwbVYKZE9IMXo1cmcvNHVCYnFXeEluMlA2eWpGUWlqck5odGlXR3N0anFPelJlU3FzYmt6QTJINUV3THB1WFVLWDUvZQpMRjhpNWt2bnFPZ1Vab1g4WVQ2L0N4SjZtU1pVTEN0NEVpditJeUc2bTQ1OHpDeW9zbFgrU3c9PQotLS0tLUVORCBSU0EgUFJJVkFURSBLRVktLS0tLQo=<br>kind: ConfigMap<br>metadata:<br>  name: configmap-kubeconfig-dev<br>  namespace: jenkins<br></code></pre></td></tr></table></figure>
<p>执行命令</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">kubectl create -f kubeconfig-dev.yaml<br></code></pre></td></tr></table></figure>
<p>创建名为configmap-kubeconfig-dev的configMap,然后pipeline中就可以如下配置：</p>
<p><img src="/img/media/9a558cb68a01dcf99001cd781e0782ff.png"></p>
<h3 id="调试集群"><a href="#调试集群" class="headerlink" title="调试集群"></a>调试集群</h3><p>查看集群部署信息</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">kubectl cluster-info<br></code></pre></td></tr></table></figure>
<p>查看k8s的节点是否工作正常</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">kubectl get nodes -o wide<br></code></pre></td></tr></table></figure>
<p>查看所有命名空间下的deployment</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">kubectl get deployment --all-namespaces<br></code></pre></td></tr></table></figure>
<p>查看所有命名空间下的svc</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">kubectl get svc --all-namespaces<br></code></pre></td></tr></table></figure>
<p>查看所有命名空间下的pod</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">kubectl get pod -o wide --all-namespaces<br></code></pre></td></tr></table></figure>
<p>查看某个pod的运行日志</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">kubectl logs -f kubernetes-dashboard-7f9f8cc4cf-tm2ld -n kube-system<br></code></pre></td></tr></table></figure>
<p>删除某个pod</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">kubectl delete pod ms-cloud-tenant-service-5dc69784b-f42vh -n cloud<br></code></pre></td></tr></table></figure>
<p>查看某个失败的pod的明细</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">kubectl describe pod metrics-server-6c84bc5674-tf4qw -n kube-system<br></code></pre></td></tr></table></figure>
<p>查看镜像描述信息</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">docker inspect 10.124.133.192/devops/jenkins-slaver-dind:v1.0.0<br></code></pre></td></tr></table></figure>
<p>查看某个命名空间下pod的实时状态变化</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">kubectl get pod -o wide -n jenkins -w<br></code></pre></td></tr></table></figure>
<p>查看所有启动的容器（包括失败的）</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">docker ps -a<br></code></pre></td></tr></table></figure>

<h3 id="部署k8s-dashboard页面"><a href="#部署k8s-dashboard页面" class="headerlink" title="部署k8s dashboard页面"></a>部署k8s dashboard页面</h3><p>参考博客：<a target="_blank" rel="noopener" href="https://www.kubernetes.org.cn/4004.html">https://www.kubernetes.org.cn/4004.html</a></p>
<h4 id="部署dashboard"><a href="#部署dashboard" class="headerlink" title="部署dashboard"></a>部署dashboard</h4><p>(1)新建k8s-dashboard.yaml文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># Copyright 2017 The Kubernetes Authors.</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span><br><span class="hljs-comment"># you may not use this file except in compliance with the License.</span><br><span class="hljs-comment"># You may obtain a copy of the License at</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment">#     http://www.apache.org/licenses/LICENSE-2.0</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># Unless required by applicable law or agreed to in writing, software</span><br><span class="hljs-comment"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span><br><span class="hljs-comment"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span><br><span class="hljs-comment"># See the License for the specific language governing permissions and</span><br><span class="hljs-comment"># limitations under the License.</span><br><br><span class="hljs-comment"># ------------------- Dashboard Secret ------------------- #</span><br><br>apiVersion: v1<br>kind: Secret<br>metadata:<br>  labels:<br>    k8s-app: kubernetes-dashboard<br>  name: kubernetes-dashboard-certs<br>  namespace: kube-system<br><span class="hljs-built_in">type</span>: Opaque<br><br>---<br><span class="hljs-comment"># ------------------- Dashboard Service Account ------------------- #</span><br><br>apiVersion: v1<br>kind: ServiceAccount<br>metadata:<br>  labels:<br>    k8s-app: kubernetes-dashboard<br>  name: kubernetes-dashboard<br>  namespace: kube-system<br><br>---<br><span class="hljs-comment"># ------------------- Dashboard Role &amp; Role Binding ------------------- #</span><br><br>kind: Role<br>apiVersion: rbac.authorization.k8s.io/v1<br>metadata:<br>  name: kubernetes-dashboard-minimal<br>  namespace: kube-system<br>rules:<br>  <span class="hljs-comment"># Allow Dashboard to create &#x27;kubernetes-dashboard-key-holder&#x27; secret.</span><br>- apiGroups: [<span class="hljs-string">&quot;&quot;</span>]<br>  resources: [<span class="hljs-string">&quot;secrets&quot;</span>]<br>  verbs: [<span class="hljs-string">&quot;create&quot;</span>]<br>  <span class="hljs-comment"># Allow Dashboard to create &#x27;kubernetes-dashboard-settings&#x27; config map.</span><br>- apiGroups: [<span class="hljs-string">&quot;&quot;</span>]<br>  resources: [<span class="hljs-string">&quot;configmaps&quot;</span>]<br>  verbs: [<span class="hljs-string">&quot;create&quot;</span>]<br>  <span class="hljs-comment"># Allow Dashboard to get, update and delete Dashboard exclusive secrets.</span><br>- apiGroups: [<span class="hljs-string">&quot;&quot;</span>]<br>  resources: [<span class="hljs-string">&quot;secrets&quot;</span>]<br>  resourceNames: [<span class="hljs-string">&quot;kubernetes-dashboard-key-holder&quot;</span>, <span class="hljs-string">&quot;kubernetes-dashboard-certs&quot;</span>]<br>  verbs: [<span class="hljs-string">&quot;get&quot;</span>, <span class="hljs-string">&quot;update&quot;</span>, <span class="hljs-string">&quot;delete&quot;</span>]<br>  <span class="hljs-comment"># Allow Dashboard to get and update &#x27;kubernetes-dashboard-settings&#x27; config map.</span><br>- apiGroups: [<span class="hljs-string">&quot;&quot;</span>]<br>  resources: [<span class="hljs-string">&quot;configmaps&quot;</span>]<br>  resourceNames: [<span class="hljs-string">&quot;kubernetes-dashboard-settings&quot;</span>]<br>  verbs: [<span class="hljs-string">&quot;get&quot;</span>, <span class="hljs-string">&quot;update&quot;</span>]<br>  <span class="hljs-comment"># Allow Dashboard to get metrics from heapster.</span><br>- apiGroups: [<span class="hljs-string">&quot;&quot;</span>]<br>  resources: [<span class="hljs-string">&quot;services&quot;</span>]<br>  resourceNames: [<span class="hljs-string">&quot;heapster&quot;</span>]<br>  verbs: [<span class="hljs-string">&quot;proxy&quot;</span>]<br>- apiGroups: [<span class="hljs-string">&quot;&quot;</span>]<br>  resources: [<span class="hljs-string">&quot;services/proxy&quot;</span>]<br>  resourceNames: [<span class="hljs-string">&quot;heapster&quot;</span>, <span class="hljs-string">&quot;http:heapster:&quot;</span>, <span class="hljs-string">&quot;https:heapster:&quot;</span>]<br>  verbs: [<span class="hljs-string">&quot;get&quot;</span>]<br><br>---<br>apiVersion: rbac.authorization.k8s.io/v1<br>kind: RoleBinding<br>metadata:<br>  name: kubernetes-dashboard-minimal<br>  namespace: kube-system<br>roleRef:<br>  apiGroup: rbac.authorization.k8s.io<br>  kind: Role<br>  name: kubernetes-dashboard-minimal<br>subjects:<br>- kind: ServiceAccount<br>  name: kubernetes-dashboard<br>  namespace: kube-system<br><br>---<br><span class="hljs-comment"># ------------------- Dashboard Deployment ------------------- #</span><br><br>kind: Deployment<br>apiVersion: apps/v1beta2<br>metadata:<br>  labels:<br>    k8s-app: kubernetes-dashboard<br>  name: kubernetes-dashboard<br>  namespace: kube-system<br>spec:<br>  replicas: 1<br>  revisionHistoryLimit: 10<br>  selector:<br>    matchLabels:<br>      k8s-app: kubernetes-dashboard<br>  template:<br>    metadata:<br>      labels:<br>        k8s-app: kubernetes-dashboard<br>    spec:<br>      containers:<br>      - name: kubernetes-dashboard<br>        image: 192.168.17.132/rke/k8s.gcr.io/kubernetes-dashboard-amd64:v1.8.3<br>        ports:<br>        - containerPort: 8443<br>          protocol: TCP<br>        args:<br>          - --auto-generate-certificates<br>          <span class="hljs-comment"># Uncomment the following line to manually specify Kubernetes API server Host</span><br>          <span class="hljs-comment"># If not specified, Dashboard will attempt to auto discover the API server and connect</span><br>          <span class="hljs-comment"># to it. Uncomment only if the default does not work.</span><br>          <span class="hljs-comment"># - --apiserver-host=http://my-address:port</span><br>        volumeMounts:<br>        - name: kubernetes-dashboard-certs<br>          mountPath: /certs<br>          <span class="hljs-comment"># Create on-disk volume to store exec logs</span><br>        - mountPath: /tmp<br>          name: tmp-volume<br>        livenessProbe:<br>          httpGet:<br>            scheme: HTTPS<br>            path: /<br>            port: 8443<br>          initialDelaySeconds: 30<br>          timeoutSeconds: 30<br>      volumes:<br>      - name: kubernetes-dashboard-certs<br>        secret:<br>          secretName: kubernetes-dashboard-certs<br>      - name: tmp-volume<br>        emptyDir: &#123;&#125;<br>      serviceAccountName: kubernetes-dashboard<br>      <span class="hljs-comment"># Comment the following tolerations if Dashboard must not be deployed on master</span><br>      tolerations:<br>      - key: node-role.kubernetes.io/master<br>        effect: NoSchedule<br><br>---<br><span class="hljs-comment"># ------------------- Dashboard Service ------------------- #</span><br><br>kind: Service<br>apiVersion: v1<br>metadata:<br>  labels:<br>    k8s-app: kubernetes-dashboard<br>  name: kubernetes-dashboard<br>  namespace: kube-system<br>spec:<br>  ports:<br>    - port: 443<br>      targetPort: 8443<br>  selector:<br>    k8s-app: kubernetes-dashboard<br><br><br></code></pre></td></tr></table></figure>
<p>执行</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">kubectl create -f k8s-dashboard.yaml<br></code></pre></td></tr></table></figure>
<p>(2)新建dashboard-usr.yaml文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs bash">apiVersion: v1<br>kind: ServiceAccount<br>metadata:<br>  name: admin-user<br>  namespace: kube-system<br>---<br>apiVersion: rbac.authorization.k8s.io/v1beta1<br>kind: ClusterRoleBinding<br>metadata:<br>  name: admin-user<br>roleRef:<br>  apiGroup: rbac.authorization.k8s.io<br>  kind: ClusterRole<br>  name: cluster-admin<br>subjects:<br>- kind: ServiceAccount<br>  name: admin-user<br>  namespace: kube-system<br></code></pre></td></tr></table></figure>
<p>执行</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">kubectl create -f dashboard-usr.yml<br></code></pre></td></tr></table></figure>

<p>(3)若对yml修改后,更新部署,则执行下述命令</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">kubectl apply -f dashboard-usr.yml<br></code></pre></td></tr></table></figure>
<h4 id="访问dashboard"><a href="#访问dashboard" class="headerlink" title="访问dashboard"></a>访问dashboard</h4><h5 id="通过window配置负载"><a href="#通过window配置负载" class="headerlink" title="通过window配置负载"></a>通过window配置负载</h5><p>(1)安装kubectl</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">curl -LO https://storage.googleapis.com/kubernetes-release/release/v1.7.0/bin/windows/amd64/kubectl.exe<br></code></pre></td></tr></table></figure>
<p>(2) 拷贝集群kube_config_cluster.ym文件到本地config.yml在cmd执行以下命令</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">kubectl --kubeconfig=C:\Users\Administrator\Desktop\config.yml proxy<br></code></pre></td></tr></table></figure>
<p>(3)web访问</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">http://localhost:8001/api/v1/namespaces/kube-system/services/https:kubernetes-dashboard:/proxy/<br></code></pre></td></tr></table></figure>
<p>(4) 生成web访问的token</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">kubectl -n kube-system describe secret $(kubectl -n kube-system get secret |<br>grep admin-user | awk <span class="hljs-string">&#x27;&#123;print $1&#125;&#x27;</span>)<br></code></pre></td></tr></table></figure>

<h5 id="通过configMap配置负载"><a href="#通过configMap配置负载" class="headerlink" title="通过configMap配置负载"></a>通过configMap配置负载</h5><p>(1)编辑configmap文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">kubectl edit configmap tcp-services -n ingress-nginx<br></code></pre></td></tr></table></figure>
<p>添加以下两行</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">data:<br> <span class="hljs-string">&quot;9090&quot;</span>: kube-system/kubernetes-dashboard:443<br></code></pre></td></tr></table></figure>
<p><img src="/img/media/1293af02ca6f3ef0dd976695501592a9.png"><br>(2)生成token</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">kubectl -n kube-system describe secret $(kubectl -n kube-system get secret | grep admin-user | awk <span class="hljs-string">&#x27;&#123;print $1&#125;&#x27;</span>)<br></code></pre></td></tr></table></figure>
<p>(3)第一次部署报错的情况下,删除token</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">kubectl --kubeconfig ../kube_config_cluster.yml delete secret kubernetes-dashboard-key-holder -n kube-system<br></code></pre></td></tr></table></figure>
<p>访问dashboard地址：<a target="_blank" rel="noopener" href="https://192.168.17.131:9090/">https://192.168.17.131:9090</a></p>
<h3 id="部署k8s-dashboard页面图形化数据"><a href="#部署k8s-dashboard页面图形化数据" class="headerlink" title="部署k8s dashboard页面图形化数据"></a>部署k8s dashboard页面图形化数据</h3><p>上传heapster-grafana.yaml heapster.yaml influxdb.yaml文件，创建<br>(1)创建heapster-grafana.yaml文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><code class="hljs bash">apiVersion: apps/v1<br>kind: Deployment<br>metadata:<br>  name: monitoring-grafana<br>  namespace: kube-system<br>spec:<br>  replicas: 1<br>  selector:<br>    matchLabels:<br>      task: monitoring<br>      k8s-app: grafana<br>  template:<br>    metadata:<br>      labels:<br>        task: monitoring<br>        k8s-app: grafana<br>    spec:<br>      containers:<br>      - name: grafana<br>        image: 192.168.17.132/rke/heapster-grafana:v4.3.3<br>        ports:<br>        - containerPort: 3000<br>          protocol: TCP<br>        volumeMounts:<br>        - mountPath: /etc/ssl/certs<br>          name: ca-certificates<br>          readOnly: <span class="hljs-literal">true</span><br>        - mountPath: /var<br>          name: grafana-storage<br>        <span class="hljs-built_in">env</span>:<br>        - name: INFLUXDB_HOST<br>          value: monitoring-influxdb<br>        - name: GF_SERVER_HTTP_PORT<br>          value: <span class="hljs-string">&quot;3000&quot;</span><br>        - name: GF_AUTH_BASIC_ENABLED<br>          value: <span class="hljs-string">&quot;false&quot;</span><br>        - name: GF_AUTH_ANONYMOUS_ENABLED<br>          value: <span class="hljs-string">&quot;true&quot;</span><br>        - name: GF_AUTH_ANONYMOUS_ORG_ROLE<br>          value: Admin<br>        - name: GF_SERVER_ROOT_URL<br>          value: /<br>      volumes:<br>      - name: ca-certificates<br>        hostPath:<br>          path: /etc/ssl/certs<br>      - name: grafana-storage<br>        emptyDir: &#123;&#125;<br>---<br>apiVersion: v1<br>kind: Service<br>metadata:<br>  labels:<br>    kubernetes.io/cluster-service: <span class="hljs-string">&#x27;true&#x27;</span><br>    kubernetes.io/name: monitoring-grafana<br>  name: monitoring-grafana<br>  namespace: kube-system<br>spec:<br>  <span class="hljs-built_in">type</span>: NodePort<br>  ports:<br>  - nodePort: 30108<br>    port: 80<br>    targetPort: 3000<br>  selector:<br>    k8s-app: grafana<br></code></pre></td></tr></table></figure>
<p>(2)创建heapster.yaml文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><code class="hljs bash">apiVersion: v1<br>kind: ServiceAccount<br>metadata:<br>  name: heapster<br>  namespace: kube-system<br>---<br>apiVersion: extensions/v1beta1<br>kind: Deployment<br>metadata:<br>  name: heapster<br>  namespace: kube-system<br>spec:<br>  replicas: 1<br>  selector:<br>    matchLabels:<br>      task: monitoring<br>      k8s-app: heapster<br>  template:<br>    metadata:<br>      labels:<br>        task: monitoring<br>        k8s-app: heapster<br>    spec:<br>      serviceAccountName: heapster<br>      containers:<br>      - name: heapster<br>        image: 192.168.17.132/rke/heapster:v1.4.0<br>        imagePullPolicy: IfNotPresent<br>        <span class="hljs-built_in">command</span>:<br>        - /heapster<br>        <span class="hljs-comment"># - --source=kubernetes:https://$KUBERNETES_SERVICE_HOST:443?inClusterConfig=true&amp;useServiceAccount=true</span><br>        - --<span class="hljs-built_in">source</span>=kubernetes:kubernetes:https://kubernetes.default?useServiceAccount=<span class="hljs-literal">true</span>&amp;kubeletHttps=<span class="hljs-literal">true</span>&amp;kubeletPort=10250&amp;insecure=<span class="hljs-literal">true</span><br>        - --sink=influxdb:http://monitoring-influxdb.kube-system.svc.cluster.local:8086?retention=0s<br>        - --v=2   <br>---<br>apiVersion: v1<br>kind: Service<br>metadata:<br>  labels:<br>    task: monitoring<br>    kubernetes.io/cluster-service: <span class="hljs-string">&#x27;true&#x27;</span><br>    kubernetes.io/name: Heapster<br>  name: heapster<br>  namespace: kube-system<br>spec:<br>  ports:<br>  - port: 80<br>    targetPort: 8082<br>  selector:<br>    k8s-app: heapster<br>---<br>apiVersion: rbac.authorization.k8s.io/v1beta1<br>kind: ClusterRoleBinding<br>metadata:<br>  name: heapster<br>roleRef:<br>  apiGroup: rbac.authorization.k8s.io<br>  kind: ClusterRole<br>  name: cluster-admin<br>subjects:<br>- kind: ServiceAccount<br>  name: heapster<br>  namespace: kube-system<br></code></pre></td></tr></table></figure>
<p>(3)创建influxdb.yaml文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs bash">apiVersion: apps/v1<br>kind: Deployment<br>metadata:<br>  name: monitoring-influxdb<br>  namespace: kube-system<br>spec:<br>  replicas: 1<br>  selector:<br>    matchLabels:<br>      task: monitoring<br>      k8s-app: influxdb<br>  template:<br>    metadata:<br>      labels:<br>        task: monitoring<br>        k8s-app: influxdb<br>    spec:<br>      containers:<br>      - name: influxdb<br>        image: 192.168.17.132/rke/heapster-influxdb:v1.3.3<br>        volumeMounts:<br>        - mountPath: /data<br>          name: influxdb-storage<br>      volumes:<br>      - name: influxdb-storage<br>        emptyDir: &#123;&#125;<br>---<br>apiVersion: v1<br>kind: Service<br>metadata:<br>  labels:<br>    task: monitoring<br>    kubernetes.io/cluster-service: <span class="hljs-string">&#x27;true&#x27;</span><br>    kubernetes.io/name: monitoring-influxdb<br>  name: monitoring-influxdb<br>  namespace: kube-system<br>spec:<br>  <span class="hljs-built_in">type</span>: NodePort<br>  ports:<br>  - nodePort: 31001<br>    port: 8086<br>    targetPort: 8086<br>  selector:<br>    k8s-app: influxdb<br></code></pre></td></tr></table></figure>
<p>(4)创建各个pod</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">kubectl create -f heapster-grafana.yaml<br>kubectl create -f heapster.yaml<br>kubectl create -f influxdb.yaml<br></code></pre></td></tr></table></figure>
<p><img src="/img/media/1434c61c6ef7c7313990f66bcca7db40.png"></p>
<p><strong>–source</strong>: 指定连接的集群。<br>inClusterConfig:Use kube config in service accounts associated with Heapster’s namespace.(default: true)<br>kubeletPort: 指定kubelet的使用端口，默认10255<br>kubeletHttps: 是否使用https去连接kubelets(默认：false)<br>apiVersion: 指定K8S的apiversion<br>insecure: 是否使用安全证书(默认：false)<br>auth: 安全认证<br>useServiceAccount: 是否使用K8S的安全令牌</p>
<p><strong>–sink</strong>: 指定后端数据存储。这里指定influxdb数据库。<br>后缀参数：<br>user: InfluxDB用户<br>pw: InfluxDB密码<br>db: 数据库名<br>secure: 安全连接到InfluxDB(默认：false)<br>withfields： 使用InfluxDB fields(默认：false)。</p>
<h1 id="第二章-自动化构建部署流程搭建"><a href="#第二章-自动化构建部署流程搭建" class="headerlink" title="第二章 自动化构建部署流程搭建"></a>第二章 自动化构建部署流程搭建</h1><h2 id="部署jenkins-master"><a href="#部署jenkins-master" class="headerlink" title="部署jenkins-master"></a>部署jenkins-master</h2><p>(1)下载镜像jenkins-master<br>链接: <a target="_blank" rel="noopener" href="https://pan.baidu.com/s/1lhllaOIsvDXJoiFMPx47Qw">https://pan.baidu.com/s/1lhllaOIsvDXJoiFMPx47Qw</a> 提取码: z24p<br>或者<br>链接: <a target="_blank" rel="noopener" href="https://pan.baidu.com/s/1hROj7nt_iw0Vf1tQTShfYA">https://pan.baidu.com/s/1hROj7nt_iw0Vf1tQTShfYA</a> 提取码: iieu</p>
<p>(2)在192.168.17.131 上建目录</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">mkdir</span> /jenkins-data<br></code></pre></td></tr></table></figure>
<p>(3)赋予权限</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">chown</span> -R 1000:1000 /jenkins-data<br></code></pre></td></tr></table></figure>
<p>(4)创建jenkins-k8s-resources.yml文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><code class="hljs bash">apiVersion: apps/v1beta1<br>kind: Deployment<br>metadata:<br>  name: jenkins-wdj<br>  namespace: jenkins<br>  labels:<br>    k8s-app: jenkins-wdj<br>spec:<br>  replicas: 1<br>  selector:<br>    matchLabels:<br>      k8s-app: jenkins-wdj<br>  template:<br>    metadata:<br>      labels:<br>        k8s-app: jenkins-wdj<br>    spec:<br>      nodeSelector:<br>        kubernetes.io/hostname: 192.168.17.131<br>      containers:<br>      - name: jenkins-wdj<br>        image: 192.168.17.132/rke/jenkinsci-blueocean:v1.0<br>        <span class="hljs-built_in">env</span>:<br>        - name: TZ<br>          value: Asia/Shanghai<br>        imagePullPolicy: IfNotPresent<br>        volumeMounts:<br>        - name: jenkins-home-test<br>          mountPath: /var/jenkins_home<br>        ports:<br>        - containerPort: 8080<br>          name: web<br>        - containerPort: 50000<br>          name: agent<br>      volumes:<br>        - name: jenkins-home-test<br>          hostPath:<br>            path: /jenkins-data<br>            <span class="hljs-built_in">type</span>: DirectoryOrCreate<br><br>---<br><br>kind: Service<br>apiVersion: v1<br>metadata:<br>  labels:<br>    k8s-app: jenkins-wdj<br>  name: jenkins-wdj<br>  namespace: jenkins<br>spec:<br>  <span class="hljs-built_in">type</span>: NodePort<br>  ports:<br>    - port: 8080<br>      name: web<br>      targetPort: 8080<br>      nodePort: 31666<br>    - port: 50000<br>      name: agent<br>      targetPort: 50000<br>  selector:<br>    k8s-app: jenkins-wdj<br><br>---<br><br>apiVersion: v1<br>kind: ServiceAccount<br>metadata:<br>  name: jenkins-wdj<br>  namespace: jenkins<br><br>---<br><br>kind: Role<br>apiVersion: rbac.authorization.k8s.io/v1beta1<br>metadata:<br>  name: jenkins-wdj<br>  namespace: jenkins<br>rules:<br>  - apiGroups: [<span class="hljs-string">&quot;&quot;</span>]<br>    resources: [<span class="hljs-string">&quot;pods&quot;</span>]<br>    verbs: [<span class="hljs-string">&quot;create&quot;</span>,<span class="hljs-string">&quot;delete&quot;</span>,<span class="hljs-string">&quot;get&quot;</span>,<span class="hljs-string">&quot;list&quot;</span>,<span class="hljs-string">&quot;patch&quot;</span>,<span class="hljs-string">&quot;update&quot;</span>,<span class="hljs-string">&quot;watch&quot;</span>]<br>  - apiGroups: [<span class="hljs-string">&quot;&quot;</span>]<br>    resources: [<span class="hljs-string">&quot;pods/exec&quot;</span>]<br>    verbs: [<span class="hljs-string">&quot;create&quot;</span>,<span class="hljs-string">&quot;delete&quot;</span>,<span class="hljs-string">&quot;get&quot;</span>,<span class="hljs-string">&quot;list&quot;</span>,<span class="hljs-string">&quot;patch&quot;</span>,<span class="hljs-string">&quot;update&quot;</span>,<span class="hljs-string">&quot;watch&quot;</span>]<br>  - apiGroups: [<span class="hljs-string">&quot;&quot;</span>]<br>    resources: [<span class="hljs-string">&quot;pods/log&quot;</span>]<br>    verbs: [<span class="hljs-string">&quot;get&quot;</span>,<span class="hljs-string">&quot;list&quot;</span>,<span class="hljs-string">&quot;watch&quot;</span>]<br>  - apiGroups: [<span class="hljs-string">&quot;&quot;</span>]<br>    resources: [<span class="hljs-string">&quot;secrets&quot;</span>]<br>    verbs: [<span class="hljs-string">&quot;get&quot;</span>]<br><br>---<br><br>apiVersion: rbac.authorization.k8s.io/v1beta1<br>kind: RoleBinding<br>metadata:<br>  name: jenkins-wdj<br>  namespace: jenkins<br>roleRef:<br>  apiGroup: rbac.authorization.k8s.io<br>  kind: Role<br>  name: jenkins-wdj<br>subjects:<br>  - kind: ServiceAccount<br>    name: jenkins-wdj<br><br></code></pre></td></tr></table></figure>
<p>(5)启动Jenkins-master</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">kubectl create -f jenkins-k8s-resources.yml<br></code></pre></td></tr></table></figure>
<p><img src="/img/media/e05b9c2c2f007f073a4bcec3ea4c8102.png"></p>
<p>(6)在jenkins中安装kubernetes插件</p>
<p><img src="/img/media/1e6ce77d99611829f81f9af3dee914ba.png"></p>
<h2 id="部署jenkins-slave"><a href="#部署jenkins-slave" class="headerlink" title="部署jenkins-slave"></a>部署jenkins-slave</h2><h3 id="构建jenkins-slave基础镜像"><a href="#构建jenkins-slave基础镜像" class="headerlink" title="构建jenkins-slave基础镜像"></a>构建jenkins-slave基础镜像</h3><p>基于<code>openshift/jenkins-slave-base-centos7:latest</code>所构建的包含了maven, nodejs,helm, go, beego等常用构建工具<br>(1)下载jenkins-slave-base-centos7:latest镜像</p>
<p>下载链接: <a target="_blank" rel="noopener" href="https://pan.baidu.com/s/1Wvs1pRotGWqTT_6BLoRrTg">https://pan.baidu.com/s/1Wvs1pRotGWqTT_6BLoRrTg</a> 提取码: xvde</p>
<p>(2)编辑Dockerfile文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><code class="hljs bash">FROM openshift/jenkins-slave-base-centos7:latest<br><br>LABEL maintainer=caiy17@chinaunicom.cn<br>LABEL Description=<span class="hljs-string">&quot;基于`openshift/jenkins-slave-base-centos7:latest`所构建的包含了maven, nodejs, helm, go, beego等常用构建工具&quot;</span><br>ENV TZ Asia/Shanghai<br><br><span class="hljs-comment">###############################################################################</span><br><span class="hljs-comment"># 生成ssh密钥</span><br><span class="hljs-comment">###############################################################################</span><br>USER root<br><br>RUN ssh-keygen -f /root/.ssh/id_rsa<br><br><span class="hljs-comment">###############################################################################</span><br><span class="hljs-comment"># 设置yum源 安装常用工具</span><br><span class="hljs-comment">###############################################################################</span><br><span class="hljs-comment"># RUN curl -o /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-7.repo \</span><br>    <span class="hljs-comment"># &amp;&amp; yum makecache \</span><br>RUN yum install -y vim telnet net-tools wget unzip<br><br><span class="hljs-comment">###############################################################################</span><br><span class="hljs-comment"># 安装JDK</span><br><span class="hljs-comment">###############################################################################</span><br>ADD packages/jdk-8u181-linux-x64.tar.gz /usr/java<br><br>ENV JAVA_HOME /usr/java/jdk1.8.0_181<br>ENV PATH <span class="hljs-variable">$JAVA_HOME</span>/bin:<span class="hljs-variable">$PATH</span><br><br>RUN <span class="hljs-built_in">chown</span> root:root /usr/java/jdk1.8.0_181 -R \<br>    &amp;&amp; <span class="hljs-built_in">chmod</span> 755 /usr/java/jdk1.8.0_181 -R<br><br><span class="hljs-comment">###############################################################################</span><br><span class="hljs-comment"># 安装maven</span><br><span class="hljs-comment">###############################################################################</span><br>ADD packages/apache-maven-3.6.0-bin.tar.gz /opt<br><br>RUN <span class="hljs-built_in">chown</span> root:root /opt/apache-maven-3.6.0 -R \<br>    &amp;&amp; <span class="hljs-built_in">chmod</span> 755 /opt/apache-maven-3.6.0 -R \<br>    &amp;&amp; <span class="hljs-built_in">ln</span> -s /opt/apache-maven-3.6.0/ /opt/maven<br><br>ENV M2_HOME /opt/maven<br>ENV PATH <span class="hljs-variable">$M2_HOME</span>/bin:<span class="hljs-variable">$PATH</span><br><br><span class="hljs-comment"># 配置maven镜像源</span><br>RUN sed -i <span class="hljs-string">&#x27;N;146 a \ \ \ \ &lt;mirror&gt;\n\ \ \ \ \ \ &lt;id&gt;self-maven&lt;/id&gt;\n\ \ \ \ \ \ &lt;mirrorOf&gt;self-maven&lt;/mirrorOf&gt;\n\ \ \ \ \ \ &lt;name&gt;self-maven&lt;/name&gt;\n\ \ \ \ \ \ &lt;url&gt;http://10.236.5.18:8088/repository/maven-public/&lt;/url&gt;\n\ \ \ \ &lt;/mirror&gt;&#x27;</span> /opt/maven/conf/settings.xml<br><br><span class="hljs-comment">###############################################################################</span><br><span class="hljs-comment"># 安装nodejs</span><br><span class="hljs-comment">###############################################################################</span><br>ADD packages/node-v10.15.3-linux-x64.tar.xz /opt<br><br>RUN <span class="hljs-built_in">chown</span> root:root /opt/node-v10.15.3-linux-x64 -R \<br>    &amp;&amp; <span class="hljs-built_in">chmod</span> 755 /opt/node-v10.15.3-linux-x64 -R \<br>    &amp;&amp; <span class="hljs-built_in">ln</span> -s /opt/node-v10.15.3-linux-x64/ /opt/node<br><br>ENV NODE_HOME /opt/node<br>ENV PATH <span class="hljs-variable">$PATH</span>:<span class="hljs-variable">$NODE_HOME</span>/bin<br><br><span class="hljs-comment">###############################################################################</span><br><span class="hljs-comment"># 安装helm</span><br><span class="hljs-comment">###############################################################################</span><br>ADD packages/helm-v2.8.2-linux-amd64.tar.gz /opt/helm<br><br>ENV HELM_HOME /opt/helm<br>ENV PATH <span class="hljs-variable">$PATH</span>:<span class="hljs-variable">$HELM_HOME</span>/linux-amd64<br><br><span class="hljs-comment">###############################################################################</span><br><span class="hljs-comment"># 安装go</span><br><span class="hljs-comment">###############################################################################</span><br>ADD packages/go1.12.3.linux-amd64.tar.gz /opt<br><br>ENV GOROOT /opt/go<br>ENV GOPATH /root/go<br>ENV PATH <span class="hljs-variable">$PATH</span>:<span class="hljs-variable">$GOROOT</span>/bin:<span class="hljs-variable">$GOPATH</span>/bin<br><br><span class="hljs-comment">###############################################################################</span><br><span class="hljs-comment"># 安装beego</span><br><span class="hljs-comment">###############################################################################</span><br>ADD packages/bee.tar.gz /root/go/bin<br></code></pre></td></tr></table></figure>

<p>(2)执行构建命令</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">docker build -t jenkins-slave:2019-09-11-v1 .<br></code></pre></td></tr></table></figure>
<p>注意最后有个点，代表使用当前路径的 Dockerfile 进行构建</p>
<p>生成的镜像下载链接: <a target="_blank" rel="noopener" href="https://pan.baidu.com/s/1Wvs1pRotGWqTT_6BLoRrTg">https://pan.baidu.com/s/1Wvs1pRotGWqTT_6BLoRrTg</a> 提取码: xvde</p>
<h3 id="生成连接k8s集群的客户端证书"><a href="#生成连接k8s集群的客户端证书" class="headerlink" title="生成连接k8s集群的客户端证书"></a>生成连接k8s集群的客户端证书</h3><p>1)生成连接api-server的服务证书 key并进行连接测试</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cat</span> kube_config_cluster.yml<br></code></pre></td></tr></table></figure>
<p><img src="/img/media/7cdbc99f4aabdeeb2b4d76d63b4a709a.png"></p>
<p>分别执行</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">echo</span> certificate-authority-data | <span class="hljs-built_in">base64</span> -d &gt; ca.crt<br><br><span class="hljs-built_in">echo</span> client-certificate-data | <span class="hljs-built_in">base64</span> -d &gt; client.crt<br><br><span class="hljs-built_in">echo</span> client-key-data | <span class="hljs-built_in">base64</span> -d &gt; client.key<br></code></pre></td></tr></table></figure>
<p>然后根据如上内容生成客户端认证的证书cert.pfx</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">openssl pkcs12 -<span class="hljs-built_in">export</span> -out cert.pfx -inkey client.key -<span class="hljs-keyword">in</span> client.crt -certfile ca.crt<br></code></pre></td></tr></table></figure>

<p><img src="/../img/media/a4afa358f3dd6f143410e70580334c45.png"></p>
<p><img src="/img/media/0d767f68d6ef4478501ec6bef946f652.png"></p>
<p><img src="/img/media/b09555ce03c767497f266bef65d9c515.png"></p>
<p><img src="/img/media/2e7d6352366c4cb1fee855ae558513c9.png"></p>
<p><img src="/img/media/9e76aa863c034baebebefbad7feb96ed.png"></p>
<p><img src="/img/media/9e99239598a34fb95e3d2f5ddf5ff3e4.png"></p>
<p>参考<a target="_blank" rel="noopener" href="http://www.mamicode.com/info-detail-2399348.html">http://www.mamicode.com/info-detail-2399348.html</a></p>
<h3 id="配置jenkins-master（参考）"><a href="#配置jenkins-master（参考）" class="headerlink" title="配置jenkins-master（参考）"></a>配置jenkins-master（参考）</h3><p>打开 jenkins UI 界面依次点击<br>系统管理 –&gt; 系统设置 –&gt; 新增一个云（在界面最下方） –&gt; Kubernetes<br>配置如下：</p>
<p><img src="/img/media/62950b413e70f1c3de8dfee1b3a21c9a.jpg"></p>
<p><img src="/img/media/c9683596df80287a2b436bca17561e4e.jpg"></p>
<p><img src="/img/media/1d767a64016833adbcedb9bda4bbe345.jpg"></p>
<p><img src="/img/media/197688eb8445759061df45b0daafab44.png"></p>
<p>配置完成后点击保存</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs bash">kubectl create serviceaccount jenkins-wdj -n jenkins<br><br>kubectl get serviceaccount --all-namespaces<br><br>kubectl describe serviceaccount/jenkins-wdj -n jenkins<br><br>kubectl get secret -n jenkins<br><br>kubectl get secret jenkin-wdj-token-cm449 -o yaml -n jenkins<br><br>kubectl get secret jenkins-wdj-token-ld6dc -n jenkins -o jsonpath=&#123;<span class="hljs-string">&quot;.data.token&quot;</span>&#125; | <span class="hljs-built_in">base64</span> -d<br><br>kubectl delete serviceaccount/jenkins-xy -n jenkins<br><br>kubectl get sa jenkins-wdj -n jenkins -o yaml<br><br>kubectl get secret jenkins-wdj-token-cm449 -n jenkins -o jsonpath=&#123;<span class="hljs-string">&quot;.data.token&quot;</span>&#125; | <span class="hljs-built_in">base64</span> -d<br></code></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://www.iteye.com/blog/m635674608-2361440">https://www.iteye.com/blog/m635674608-2361440</a></p>
<h3 id="配置jenkins-master（选用）"><a href="#配置jenkins-master（选用）" class="headerlink" title="配置jenkins-master（选用）"></a>配置jenkins-master（选用）</h3><p>（1）新建启动集群时生成的kube_config_cluster.yml文件；</p>
<p>（2）系统管理-》插件管理-》可选插件-》搜索kubernetes插件-》直接安装；</p>
<p><img src="/img/media/7ef920dbf0e418ff57083c2471a19ed0.png"></p>
<p>（3）系统管理-》系统设置-》新增一个云，配置如下：</p>
<p><img src="/img/media/8ae2dee46a519230ca7ca7a7b71914e4.png"></p>
<h2 id="新建pipeline流水线任务"><a href="#新建pipeline流水线任务" class="headerlink" title="新建pipeline流水线任务"></a>新建pipeline流水线任务</h2><h3 id="demo1"><a href="#demo1" class="headerlink" title="demo1"></a>demo1</h3><p>(1)新建一个测试pipeline任务demo;</p>
<p>(2) 脚本</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs bash">def name = <span class="hljs-string">&quot;ci-demo-backend&quot;</span><br>def label = <span class="hljs-string">&quot;<span class="hljs-variable">$&#123;name&#125;</span>-<span class="hljs-variable">$&#123;UUID.randomUUID().toString()&#125;</span>&quot;</span><br><br>podTemplate(<br>    label: label,<br>    namespace: <span class="hljs-string">&#x27;jenkins&#x27;</span>,<br>    cloud: <span class="hljs-string">&#x27;kubernetes&#x27;</span>,<br>    containers: [<br>           containerTemplate(name: <span class="hljs-string">&#x27;jnlp&#x27;</span>, image: <span class="hljs-string">&#x27;192.168.17.132/rke/cicd/jenkins-slaver-dind:v1.1.5&#x27;</span>)<br>    ],<br>    volumes: [<br>            hostPathVolume(hostPath: <span class="hljs-string">&#x27;/var/run/docker.sock&#x27;</span>, mountPath: <span class="hljs-string">&#x27;/var/run/docker.sock&#x27;</span>)<br>    ]<br>) &#123;<br>    node(label) &#123;<br>          stage(<span class="hljs-string">&#x27;test&#x27;</span>) &#123;<br>            <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;hello, world&quot;</span><br>            <span class="hljs-built_in">sleep</span> 60<br>        &#125;<br>      &#125;<br>  &#125;<br><br></code></pre></td></tr></table></figure>

<h3 id="demo2"><a href="#demo2" class="headerlink" title="demo2"></a>demo2</h3><p>（1）K8s集群中设置harbor仓库认证（参考）</p>
<ol>
<li>使用<em>kubectl</em>命令生成<em>secret(<em>不同的</em>namespace</em>要分别生成<em>secret</em>，不共用*)*<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash">kubectl create secret docker-registry harborsecret \<br><br>  --docker-server=192.168.17.132 \<br><br>  --docker-username=admin \<br><br>  --docker-password=Harbor12345 \<br><br>  --docker-email=admin@example.com \<br><br>  --namespace=jenkins<br></code></pre></td></tr></table></figure></li>
<li>查看此secret的配置内容</li>
</ol>
<p>kubectl get secret harborsecret –output&#x3D;yaml -n jenkins</p>
<p><img src="/img/media/fb414ba80ffd2bce475ba27026404085.png"></p>
<p>（2）添加gitlab和harbor仓库的认证(选用)</p>
<p><img src="/img/media/500fb33a91e2a2aefd78f86dca50ce00.png"></p>
<p><img src="/img/media/225e279397e7793d1b03d77171f28b6e.png"></p>
<p><img src="/img/media/043fee371dc8d536a42c492084f44f97.png"></p>
<p><img src="/img/media/db2a9491fd4d8e2a839bbda5fc03002e.png"></p>
<p>（2）下载Git Parameter插件</p>
<p>（3）设置参数化构建过程</p>
<p><img src="/img/media/d40dadb53959c6f3c2fb1c9041ebfa22.png"></p>
<h3 id="demo3"><a href="#demo3" class="headerlink" title="demo3"></a>demo3</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs bash">def label = <span class="hljs-string">&quot;ci-ms-cloud-tenant-service-<span class="hljs-variable">$&#123;UUID.randomUUID().toString()&#125;</span>&quot;</span><br>def deployNamespace = <span class="hljs-string">&quot;cloud&quot;</span><br>def deploymentName = <span class="hljs-string">&quot;ms-cloud-tenant-service&quot;</span><br><br>podTemplate(<br>    label: label,<br>    cloud: <span class="hljs-string">&#x27;kubernetes&#x27;</span>,<br>    namespace: <span class="hljs-string">&#x27;jenkins&#x27;</span>,<br>    containers: [<br>        containerTemplate(name: <span class="hljs-string">&#x27;jnlp&#x27;</span>, image: <span class="hljs-string">&#x27;192.168.17.132/rke/cicd/jenkins-slaver-dind:v1.1.5&#x27;</span>, envVars: [envVar(key: <span class="hljs-string">&#x27;LANG&#x27;</span>, value: <span class="hljs-string">&#x27;en_US.UTF-8&#x27;</span>)],)<br>    ],<br>    volumes: [<br>        configMapVolume(configMapName: <span class="hljs-string">&#x27;configmap-maven-setting-wdj&#x27;</span>, mountPath: <span class="hljs-string">&#x27;/home/jenkins/maven&#x27;</span>),<br>        configMapVolume(configMapName: <span class="hljs-string">&#x27;configmap-kubeconfig-dev&#x27;</span>, mountPath: <span class="hljs-string">&#x27;/home/jenkins/kube&#x27;</span>),<br>        hostPathVolume(hostPath: <span class="hljs-string">&#x27;/var/run/docker.sock&#x27;</span>, mountPath: <span class="hljs-string">&#x27;/var/run/docker.sock&#x27;</span>)<br>    ]<br>) &#123;<br>    node(label) &#123;<br>        stage(<span class="hljs-string">&#x27;拉取代码&#x27;</span>) &#123;<br>			git credentialsId: <span class="hljs-string">&#x27;ab716d57-9399-4978-bfb4-82eaccaea9d2&#x27;</span>, url: <span class="hljs-string">&#x27;http://192.168.17.132:8080/cloud/ms-cloud-tenant-service.git&#x27;</span><br>        &#125;<br>        stage(<span class="hljs-string">&#x27;打jar包&#x27;</span>) &#123;<br>            sh <span class="hljs-string">&#x27;mvn clean package -U -Dmaven.test.skip=true --settings /home/jenkins/maven/settings.xml&#x27;</span><br>        &#125;<br>        def dockerTag=new Date().format(<span class="hljs-string">&quot;yyyyMMddHHmmss&quot;</span>)<br>        def dockerImageName = <span class="hljs-string">&quot;192.168.17.132/devops/ms-cloud-tenant-service:v<span class="hljs-variable">$&#123;dockerTag&#125;</span>&quot;</span><br>        stage(<span class="hljs-string">&#x27;构建docker镜像&#x27;</span>) &#123;<br>            <span class="hljs-built_in">pwd</span>()<br>            sh <span class="hljs-string">&quot;docker build -f docker/Dockerfile --tag=\&quot;<span class="hljs-variable">$&#123;dockerImageName&#125;</span>\&quot; .&quot;</span><br>            <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;===&gt; finish build docker image: <span class="hljs-variable">$&#123;dockerImageName&#125;</span>&quot;</span><br>            sh <span class="hljs-string">&#x27;docker images&#x27;</span><br>        &#125;<br>		 stage(<span class="hljs-string">&#x27;发布docker镜像&#x27;</span>) &#123;<br>            withDockerRegistry(credentialsId: <span class="hljs-string">&#x27;1049ee9b-99fd-42df-8c40-a818fe66ae5a&#x27;</span>, url: <span class="hljs-string">&#x27;http://192.168.17.132/&#x27;</span>)&#123;<br>            sh <span class="hljs-string">&quot;docker push <span class="hljs-variable">$&#123;dockerImageName&#125;</span>&quot;</span><br>			sh <span class="hljs-string">&quot;docker rmi <span class="hljs-variable">$&#123;dockerImageName&#125;</span>&quot;</span><br>			sh <span class="hljs-string">&#x27;docker images&#x27;</span><br>            &#125;<br>         &#125;<br>         stage(<span class="hljs-string">&#x27;部署&#x27;</span>) &#123;<br>                sh <span class="hljs-string">&quot;kubectl --kubeconfig=/home/jenkins/kube/config -n <span class="hljs-variable">$&#123;deployNamespace&#125;</span> patch deployment <span class="hljs-variable">$&#123;deploymentName&#125;</span> -p &#x27;&#123;\&quot;spec\&quot;: &#123;\&quot;template\&quot;: &#123;\&quot;spec\&quot;: &#123;\&quot;containers\&quot;: [&#123;\&quot;name\&quot;:\&quot;<span class="hljs-variable">$&#123;deploymentName&#125;</span>\&quot;, \&quot;image\&quot;:\&quot;<span class="hljs-variable">$&#123;dockerImageName&#125;</span>\&quot;&#125;]&#125;&#125;&#125;&#125;&#x27;&quot;</span><br>                <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;==&gt; deploy <span class="hljs-variable">$&#123;dockerImageName&#125;</span> successfully&quot;</span><br>		&#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p><img src="/img/media/20191209141314.png"></p>
<p>参考文档<br><a target="_blank" rel="noopener" href="https://www.cnblogs.com/miaocunf/p/11694943.html">https://www.cnblogs.com/miaocunf/p/11694943.html</a></p>
<h2 id="jenkins-job迁移"><a href="#jenkins-job迁移" class="headerlink" title="jenkins job迁移"></a>jenkins job迁移</h2><h3 id="Job-Import-Plugin导入"><a href="#Job-Import-Plugin导入" class="headerlink" title="Job Import Plugin导入"></a>Job Import Plugin导入</h3><p>（<a target="_blank" rel="noopener" href="http://10.244.6.41:31000/">http://10.244.6.41:31000</a>到本机192.168.17.131:31666）</p>
<p>(1)首先到新的Jenkins上,在插件管理里先安装下Job Import Plugin，如下所示：</p>
<p><img src="/img/media/aab9692c2a76b52d229ea872a3c61147.png"></p>
<p>(2)安装完后进入“Manage Jenkins” -&gt; “Configure System”下，找到Job Import Pluguin配置的地方，进行如下设置：</p>
<p><img src="/img/media/1c16a9cb84eeb882667095d48da342c2.png"></p>
<p><strong>name</strong>: 这个可以任意命名，这里我命名成要拷贝的Jenkins的IP<br><strong>Url</strong>: 指要从哪里拷贝的Jenkins的URL,现在我们要从192.168.9.10拷贝job,因此这里要设置成192.168.9.10的Jenkins的URL<br><strong>Credentials</strong>：需要添加一个旧Jenkins的账号（也就是192.168.9.10的账号），没有添加的时候点击Add手动添加下，就可以像上面的截图一样下拉选择到这个账号了</p>
<p>(3)设置完后点击保存下，回到Jenkins首页点击Job Import Plugin就可以进行Job的迁移了，如下所示：</p>
<p><img src="/img/media/0544a6a7fdc230bd7c5228732ca9da9c.png"></p>
<p>在Job Import Plugin界面，下拉选择刚才添加的配置，然后点击Query按钮就可以搜索出配置的Jenkins下的job了，然后选择需要的job进行迁移导入即可：</p>
<p><img src="/img/media/3428ab6cd5708a82ce3dfbf268f49d22.png"></p>
<p>(4)因为有时候旧的Jenkins上的插件新Jenkins上未必有，因此可以根据实际情况勾选是否需要安装必要的插件，如上面的截图所示，需不需要覆盖已有的job也根据实际情况勾选下。导入成功会有如下的提示：</p>
<p><img src="/img/media/5a238913d67f296071e798633eadce92.png"></p>
<p><img src="/img/media/2513baf9e14ebce8deda003dffd93ef6.png"></p>
<p>(5)有了上面的提示后就可以会到新的Jenkins的首页，查看Job有没有成功进入，并进入导入的job查看设置有没有成功的复制过来，如下所示：</p>
<p><img src="/img/media/145dcb37570b1fce1ba8c79f95200166.png"></p>
<p>可以看到job及其设置成功的被导入到新的job了。<br>Job Import Pugin也支持多个job同时拷贝，如果旧的Job里有多个job，如上面的步骤里所示，query出来就有很多job可供选择，只需要勾选多个即可同时进行多个job的导入了。</p>
<h3 id="Jenkins-CLI方式导入"><a href="#Jenkins-CLI方式导入" class="headerlink" title="Jenkins CLI方式导入"></a>Jenkins CLI方式导入</h3><p>有时候在公司内部Jenkins部署到不同的网段里，不同网段间可能会限制无法相互访问，这种情况下通过Job Import Plugin进行job导入的方式就行不通了，这时候可以通过Jenkins CLI方式进行job配置导出，然后新Jenkins在根据导出的配置进行再导入操作，完成job的配置迁移。下面我们来具体讲解下。</p>
<p><img src="/img/media/6ae7851883f04b46abf9359baaf6c723.png"></p>
<p>点击进入Jenkins CLI，可以看到Jenkins命令行接口提供很多命令可以用来进行Jenkins的相关操作，可以看到有提供了get-job这样一个命令，这个命令可以将job的定义导出到xml的格式到输出流，这样我们可以通过这个命令将旧Jenkins上的job导出到外部文件，然后还可以看到有另外一个命令create-job，这个命令可以根据已有的xml配置文件进行job创建，那我们可以根据从旧job导出的job配置文件做为输入进行job的创建了。<br>(1)首先在旧的Jenkins上的cli页面点击jenkins-cli.jar就可以下载这个jar到本地，如下所示：</p>
<p><img src="/img/media/556411a2671efe9d0385e418c2410f6b.jpg"></p>
<p>(2)接着点击下Jenkins右上角的账号，选择Configure，然后点击Show API Token，拷贝token，这个token可以用来进行配置导出的时候做为认证使用</p>
<p><img src="/img/media/2e6bb45fb1507f1c1cf67081efad1e44.jpg"></p>
<p><img src="/img/media/7090eab1c1dde4fdd9a48c3d05695ddb.jpg"></p>
<p>(3)在jenkins-cli.jar下载的根目录下执行如下命令进行job导出，这里我新建了个job，命名为test4，现在执行下如下命令进行test4这个job配置的导出：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">java -jar jenkins-cli.jar -s http://192.168.9.10:8080/jenkins -auth<br>admin:493375c06bc0006a455005804796c989 get-job <span class="hljs-string">&quot;test4&quot;</span> &gt; test4.xml<br></code></pre></td></tr></table></figure>
<p><strong><a target="_blank" rel="noopener" href="http://192.168.9.10:8080/jenkins">http://192.168.9.10:8080/jenkins</a></strong> 就Job的Jenkins地址</p>
<p><strong>admin：</strong> 上面截图获取Show API Token下的User ID</p>
<p><strong>493375c06bc0006a455005804796c989：</strong>上面截图获取API Token的值</p>
<p><strong>test4:</strong> 需要导出配置的job名</p>
<p><strong>test4.xml:</strong> 导出的文件的名称，可任意</p>
<p>根据实际情况替换下上面的四个值即可执行完上面的命令就可以看到test4.xml文件生成了</p>
<p><img src="/img/media/709c821cb6bd5c6559260aa06c7b4242.jpg"></p>
<p>(4)接着在新的Jenkins下同样先下载下jenkins-cli.jar，然后将上面生成的test4.xml拷贝到新的Jenkins机器下，同样获取下新Jenkins登录账号的API Token和User ID，执行下如下命令就可以进行job导入了</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">java -jar jenkins-cli.jar -s http://192.168.9.8:8080/jenkins -auth<br>admin:51964e7b89a427be5dd2a28f38c86eff create-job <span class="hljs-string">&quot;test4&quot;</span> &lt; test4.xml<br></code></pre></td></tr></table></figure>
<p>记得将URL替换成新Jenkins的URL，User ID和token也替换下上面的命令执行完后，就可以看到在新的Jenkins下新job被成功导入了</p>
<p>参考自：<a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1470433">https://cloud.tencent.com/developer/article/1470433</a></p>
<h3 id="Job-批量删除"><a href="#Job-批量删除" class="headerlink" title="Job 批量删除"></a>Job 批量删除</h3><p>点击系统管理-》脚本命令行-》脚本命令行-》输入代码，点击运行</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs bash">def jobName = <span class="hljs-string">&quot;devops-ci-ms-cloud-tenant-service&quot;</span><br><br>def maxNumber = 75<br><br>Jenkins.instance.getItemByFullName(jobName).builds.findAll &#123;<br><br>it.number &lt; maxNumber<br><br>&#125;.each &#123;<br><br>it.delete()<br><br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="配置jenkins的credentialsId"><a href="#配置jenkins的credentialsId" class="headerlink" title="配置jenkins的credentialsId"></a>配置jenkins的credentialsId</h2><p>即生产连接gitlab、harbor的credentialsId<br>(1)设置jenkins连接gitlab的git credentialsId</p>
<p><img src="/img/media/4854ea61ae885046243ad09c8bff67a6.png"></p>
<p><img src="/img/media/c861afe09dc7fbd3bb2f5c93306e031d.png"></p>
<p>出错了</p>
<p><img src="/img/media/7aea585ac366e260fa9518c35cde108c.png"></p>
<p>成功的图</p>
<p><img src="/img/media/85899b6fc986ec495ec921e69d91d33f.png"></p>
<p><strong>可能原因分析：</strong><br>这是由于git客户端版本过低造成的！<br>解决方案：<a target="_blank" rel="noopener" href="https://blog.csdn.net/wudinaniya/article/details/97921383">https://blog.csdn.net/wudinaniya/article/details/97921383</a><br>安装了2.16.5<br>(2)生成jenkins连接harbor的credentialsId<br><img src="/img/media/b3a8d91212a69b0a1403987e0aed6535.png"></p>
<h2 id="利用GitLab-webhook来触发Jenkins构建"><a href="#利用GitLab-webhook来触发Jenkins构建" class="headerlink" title="利用GitLab webhook来触发Jenkins构建"></a>利用GitLab webhook来触发Jenkins构建</h2><p>参考自：<a target="_blank" rel="noopener" href="https://www.cnblogs.com/zblade/p/9480366.html">https://www.cnblogs.com/zblade/p/9480366.html</a><br>本文针对如何设置GitLab以及Jenkins，实现每次GitLab上有合并事件的时候，都能触发Jenkins执行相应的操作，主要分为以下几个步骤：</p>
<h3 id="新建GitLab测试项目"><a href="#新建GitLab测试项目" class="headerlink" title="新建GitLab测试项目"></a>新建GitLab测试项目</h3><p>进入个人GitLab账号，在右上角的加号中，选出GitLab 的 New Project，可以新建个人的GitLab工程：</p>
<p><img src="/img/media/52eae3df7ecfb39655766376291d65e5.png"></p>
<p>其余都走默认的设置，填写好project的名字，就可以创建一个新的project，如图：</p>
<p><img src="/img/media/9248135a664f90c740638f7b279af2bf.png"></p>
<h3 id="新建Jenkins的job"><a href="#新建Jenkins的job" class="headerlink" title="新建Jenkins的job"></a>新建Jenkins的job</h3><p>（1）首先验证是否安装了GitLab plugin<br>在“系统管理”-&gt;“插件管理”，查看已安装插件，输入 GitLab，看看是否已经安装，如果没有，则 查看 可选插件，搜索 GitLab，安装后重启即可。<br>（2）新建一个jenkins测试job，如图：<br><img src="/img/media/f2ffa8a27507aa1a00d9fa713620e0d9.png"><br>源码管理选择Git, 输入刚刚新建的GitLab的 URL以及个人的API_TOKEN:<br><img src="/img/media/5712b0baf511e956094247086126a6be.png"><br>目前只有master分支，后续可以根据不同分支对应设置不同的url，监听不同分支的情况。在构建触发器选项中，勾选 Build when a change is pushed to GitLab，该选项最后的URL就是这个工程的URL路径，注意如果是本机，则会显示localhost，可以将localhost改为个人的ip。注意这个url，下一步会用到这个url。点击应用和保存。<br><img src="/img/media/5ea0617e2abe03ac824a35b101bf1d98.png"></p>
<h3 id="设置GitLab的webhook"><a href="#设置GitLab的webhook" class="headerlink" title="设置GitLab的webhook"></a>设置GitLab的webhook</h3><p>在gitlab的当前工程-&gt;settings-&gt;integretions，使用当前工程owner角色的账号制作钩子。将上一步中的url和token填入，选择merge事件。当owner进行合并代码时自动触发jenkins构建操作。</p>
<p><img src="/img/media/7da48258d3e99ddb60f7ce3385d5c197.png"></p>
<p>点击Add webhook后,可能会报Url is blocked: Requests to the local network are not allowed</p>
<p><strong>错误原因：</strong><br>gitlab 10.6版本以后为了安全，不允许向本地网络发送webhook请求</p>
<p><strong>解决方案：</strong><br>最上面一排的扳手设置按钮—&gt;进入左侧 设置—-&gt;网络—-&gt;<br>选择允许webhooks和本机网络交互</p>
<p><img src="/img/media/36d92b54129cacd96532174eb0519f16.png"></p>
<p>点击save changes后，再次回到当前工程-&gt;settings-&gt;integretions中重新制作钩子，然后点击Edit:</p>
<p><img src="/img/media/d9371a678e02a4aa7dfc610c9335255e.png"></p>
<p>点击Test-&gt;Push events:</p>
<p><img src="/img/media/e465e9c52162b6911265497476109cab.png"></p>
<p>查看事件状态,若为200则钩子制作成功：</p>
<p><img src="/img/media/b6735d93d1c7488b5f9b93b07c9aa8f6.png"></p>
<h3 id="可能出现的其它问题"><a href="#可能出现的其它问题" class="headerlink" title="可能出现的其它问题"></a>可能出现的其它问题</h3><p>(1)不允许匿名构建问题</p>
<p><img src="/img/media/63a767833622728b42ceaf9224fe1986.png"></p>
<p><img src="/img/media/3b03c5788c784092b0029c035ca9d38a.png"></p>
<p>出现上述问题，原因就是不支持匿名build，回到jenkins中，在 系统管理-&gt;全局安全管理中，勾选匿名用户具有可读权限 如图：</p>
<p><img src="/img/media/46e81791bb51403d134052310d52c095.png"></p>
<p>然后点击应用和保存， 回到GitLab，继续测试.如果继续报该错，则进入刚刚构建的工程，点击构建触发器中选中的Build When a change is pushed右下角的高级选项，有一个Secret token，点击Generate，会生成一个安全代码：</p>
<p><img src="/img/media/dae770089464cc1ccf9bf21b2fb2731e.png"></p>
<p>复制到webhook中的url下面：</p>
<p><img src="/img/media/a75d1c963de478317735660786d98703.png"></p>
<p>然后保存，再测试，就可以通过，这时候会触发jenkins执行一次操作：</p>
<p><img src="/img/media/53ceea609d5974fbcf927c610cc5ec94.png"></p>
<p>看看控制台输出：</p>
<p><img src="/img/media/67102d5966ac125431c35b1b45f1b412.png"></p>
<p>参考自<a target="_blank" rel="noopener" href="https://www.cnblogs.com/zblade/p/9480366.html">https://www.cnblogs.com/zblade/p/9480366.html</a></p>
<h1 id="附录-遇到的问题"><a href="#附录-遇到的问题" class="headerlink" title="附录 遇到的问题"></a>附录 遇到的问题</h1><p>(1)集群中的每个节点不能直接拉取公有harbor上的镜像</p>
<p><img src="/img/media/c613edf3a6ce5e798063d59bdab3fecc.png"></p>
<p>解决方案：必须把所有的镜像都拉到所有节点的本地？不是的，需要把harbor仓库的rke项目设为公有仓库。</p>
<p>(2)在129机器上运行.&#x2F;rke up 出现下图问题</p>
<p><img src="/img/media/1de96425ac385c4be410dac6195d658a.png"></p>
<p><img src="/img/media/622ae563a5f78b33acfeb48fc0c63d8c.png"></p>
<p>解决方案：129机器没有自己对自己做免密</p>
<p>(3)dashboard页面没有图形化的统计数据</p>
<p><img src="/img/media/1227e87c19081c2d32b2e5b1bf20f178.png"></p>
<p>解决方案：</p>
<p><img src="/img/media/1434c61c6ef7c7313990f66bcca7db40.png"></p>
<p>把–source改为图中红框内的配置。</p>
<p>（4）jenkins-master在192.168.17.131起不来</p>
<p><img src="/img/media/e0a05c505ffc0b7a4d6c3655f4af2e07.png"></p>
<p><img src="/img/media/daa0bf91181639984baaf19bae3eda84.png"></p>
<p><img src="/img/media/6d9f71189ba307805d7d2ac2ab857e42.png"></p>
<p>在131机器上创建目录mkdir &#x2F;jenkins-data 并修改权限chown -R 1000:1000 &#x2F;jenkins-data</p>
<p><img src="/img/media/f28fb9254733602ddf1f3cb3581bb248.png"></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>Author: </span><span class="post-copyright-info"><a href="https://wangdj104.github.io">wangdj</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>Link: </span><span class="post-copyright-info"><a href="https://wangdj104.github.io/2019/12/09/jenkins%E8%87%AA%E5%8A%A8%E5%8C%96%E6%9E%84%E5%BB%BA%E9%83%A8%E7%BD%B2/">https://wangdj104.github.io/2019/12/09/jenkins%E8%87%AA%E5%8A%A8%E5%8C%96%E6%9E%84%E5%BB%BA%E9%83%A8%E7%BD%B2/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/CI-CD/">CI/CD</a></div><div class="post_share"><div class="social-share" data-image="/img/touxiang.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2019/12/10/rpm%E5%AE%89%E8%A3%85ldap/" title="rpm包安装Idap"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">Previous</div><div class="prev_info">rpm包安装Idap</div></div></a></div><div class="next-post pull-right"><a href="/2019/09/03/%E9%85%8D%E7%BD%AE%E6%9C%AC%E5%9C%B0yum%E6%BA%90/" title="配置本地yum源"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">Next</div><div class="next_info">配置本地yum源</div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/touxiang.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">wangdj</div><div class="author-info__description">记录生活中的点点滴滴</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">26</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">17</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">23</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/xxxxxx"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>Announcement</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Contents</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC%E4%B8%80%E7%AB%A0-rke%E9%83%A8%E7%BD%B2k8s%E9%9B%86%E7%BE%A4"><span class="toc-number">1.</span> <span class="toc-text">第一章 rke部署k8s集群</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%89%E8%A3%85docker"><span class="toc-number">1.1.</span> <span class="toc-text">安装docker</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BF%90%E8%A1%8C%E7%8E%AF%E5%A2%83"><span class="toc-number">1.2.</span> <span class="toc-text">运行环境</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2k8s%E9%9B%86%E7%BE%A4"><span class="toc-number">1.3.</span> <span class="toc-text">部署k8s集群</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BArke%E7%94%A8%E6%88%B7%E5%B9%B6%E8%AE%BE%E7%BD%AErke%E7%9A%84ssh%E5%85%8D%E5%AF%86"><span class="toc-number">1.3.1.</span> <span class="toc-text">创建rke用户并设置rke的ssh免密</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B3%E9%97%ADswap%E5%88%86%E5%8C%BA"><span class="toc-number">1.3.2.</span> <span class="toc-text">关闭swap分区</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B0%86rke%E7%94%A8%E6%88%B7%E5%8A%A0%E5%85%A5%E5%88%B0docker%E7%94%A8%E6%88%B7%E7%BB%84"><span class="toc-number">1.3.3.</span> <span class="toc-text">将rke用户加入到docker用户组</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%8B%E8%BD%BDrke%E5%92%8Ckubectl"><span class="toc-number">1.3.4.</span> <span class="toc-text">下载rke和kubectl</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2%E7%A7%81%E6%9C%89%E5%AE%B9%E5%99%A8%E9%95%9C%E5%83%8F%E4%BB%93%E5%BA%93harbor"><span class="toc-number">1.3.5.</span> <span class="toc-text">部署私有容器镜像仓库harbor</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9hosts%E6%96%87%E4%BB%B6-%E9%9D%9E%E5%BF%85%E9%A1%BB"><span class="toc-number">1.3.6.</span> <span class="toc-text">修改hosts文件(非必须)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BC%96%E8%BE%91%E9%9B%86%E7%BE%A4%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6cluster-yml"><span class="toc-number">1.3.7.</span> <span class="toc-text">编辑集群配置文件cluster.yml</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8rke%EF%BC%8C%E9%83%A8%E7%BD%B2%E9%9B%86%E7%BE%A4"><span class="toc-number">1.3.8.</span> <span class="toc-text">启动rke，部署集群</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A7%BB%E5%8A%A8%E9%9B%86%E7%BE%A4%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">1.3.9.</span> <span class="toc-text">移动集群配置文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%A0%E9%99%A4k8s%E9%9B%86%E7%BE%A4"><span class="toc-number">1.3.10.</span> <span class="toc-text">删除k8s集群</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%BA%E9%9B%86%E7%BE%A4%E8%8A%82%E7%82%B9%E5%88%9B%E5%BB%BA%E6%A0%87%E7%AD%BE"><span class="toc-number">1.3.11.</span> <span class="toc-text">为集群节点创建标签</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%BA%E9%9B%86%E7%BE%A4%E5%88%9B%E5%BB%BAmaven-setting"><span class="toc-number">1.3.12.</span> <span class="toc-text">为集群创建maven-setting</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%BA%E9%9B%86%E7%BE%A4%E5%88%9B%E5%BB%BAconfigMap"><span class="toc-number">1.3.13.</span> <span class="toc-text">为集群创建configMap</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B0%83%E8%AF%95%E9%9B%86%E7%BE%A4"><span class="toc-number">1.3.14.</span> <span class="toc-text">调试集群</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2k8s-dashboard%E9%A1%B5%E9%9D%A2"><span class="toc-number">1.3.15.</span> <span class="toc-text">部署k8s dashboard页面</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2dashboard"><span class="toc-number">1.3.15.1.</span> <span class="toc-text">部署dashboard</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AE%BF%E9%97%AEdashboard"><span class="toc-number">1.3.15.2.</span> <span class="toc-text">访问dashboard</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%80%9A%E8%BF%87window%E9%85%8D%E7%BD%AE%E8%B4%9F%E8%BD%BD"><span class="toc-number">1.3.15.2.1.</span> <span class="toc-text">通过window配置负载</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%80%9A%E8%BF%87configMap%E9%85%8D%E7%BD%AE%E8%B4%9F%E8%BD%BD"><span class="toc-number">1.3.15.2.2.</span> <span class="toc-text">通过configMap配置负载</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2k8s-dashboard%E9%A1%B5%E9%9D%A2%E5%9B%BE%E5%BD%A2%E5%8C%96%E6%95%B0%E6%8D%AE"><span class="toc-number">1.3.16.</span> <span class="toc-text">部署k8s dashboard页面图形化数据</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC%E4%BA%8C%E7%AB%A0-%E8%87%AA%E5%8A%A8%E5%8C%96%E6%9E%84%E5%BB%BA%E9%83%A8%E7%BD%B2%E6%B5%81%E7%A8%8B%E6%90%AD%E5%BB%BA"><span class="toc-number">2.</span> <span class="toc-text">第二章 自动化构建部署流程搭建</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2jenkins-master"><span class="toc-number">2.1.</span> <span class="toc-text">部署jenkins-master</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2jenkins-slave"><span class="toc-number">2.2.</span> <span class="toc-text">部署jenkins-slave</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9E%84%E5%BB%BAjenkins-slave%E5%9F%BA%E7%A1%80%E9%95%9C%E5%83%8F"><span class="toc-number">2.2.1.</span> <span class="toc-text">构建jenkins-slave基础镜像</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%94%9F%E6%88%90%E8%BF%9E%E6%8E%A5k8s%E9%9B%86%E7%BE%A4%E7%9A%84%E5%AE%A2%E6%88%B7%E7%AB%AF%E8%AF%81%E4%B9%A6"><span class="toc-number">2.2.2.</span> <span class="toc-text">生成连接k8s集群的客户端证书</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AEjenkins-master%EF%BC%88%E5%8F%82%E8%80%83%EF%BC%89"><span class="toc-number">2.2.3.</span> <span class="toc-text">配置jenkins-master（参考）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AEjenkins-master%EF%BC%88%E9%80%89%E7%94%A8%EF%BC%89"><span class="toc-number">2.2.4.</span> <span class="toc-text">配置jenkins-master（选用）</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%96%B0%E5%BB%BApipeline%E6%B5%81%E6%B0%B4%E7%BA%BF%E4%BB%BB%E5%8A%A1"><span class="toc-number">2.3.</span> <span class="toc-text">新建pipeline流水线任务</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#demo1"><span class="toc-number">2.3.1.</span> <span class="toc-text">demo1</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#demo2"><span class="toc-number">2.3.2.</span> <span class="toc-text">demo2</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#demo3"><span class="toc-number">2.3.3.</span> <span class="toc-text">demo3</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#jenkins-job%E8%BF%81%E7%A7%BB"><span class="toc-number">2.4.</span> <span class="toc-text">jenkins job迁移</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Job-Import-Plugin%E5%AF%BC%E5%85%A5"><span class="toc-number">2.4.1.</span> <span class="toc-text">Job Import Plugin导入</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Jenkins-CLI%E6%96%B9%E5%BC%8F%E5%AF%BC%E5%85%A5"><span class="toc-number">2.4.2.</span> <span class="toc-text">Jenkins CLI方式导入</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Job-%E6%89%B9%E9%87%8F%E5%88%A0%E9%99%A4"><span class="toc-number">2.4.3.</span> <span class="toc-text">Job 批量删除</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%85%8D%E7%BD%AEjenkins%E7%9A%84credentialsId"><span class="toc-number">2.5.</span> <span class="toc-text">配置jenkins的credentialsId</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%A9%E7%94%A8GitLab-webhook%E6%9D%A5%E8%A7%A6%E5%8F%91Jenkins%E6%9E%84%E5%BB%BA"><span class="toc-number">2.6.</span> <span class="toc-text">利用GitLab webhook来触发Jenkins构建</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%B0%E5%BB%BAGitLab%E6%B5%8B%E8%AF%95%E9%A1%B9%E7%9B%AE"><span class="toc-number">2.6.1.</span> <span class="toc-text">新建GitLab测试项目</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%B0%E5%BB%BAJenkins%E7%9A%84job"><span class="toc-number">2.6.2.</span> <span class="toc-text">新建Jenkins的job</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%BE%E7%BD%AEGitLab%E7%9A%84webhook"><span class="toc-number">2.6.3.</span> <span class="toc-text">设置GitLab的webhook</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%AF%E8%83%BD%E5%87%BA%E7%8E%B0%E7%9A%84%E5%85%B6%E5%AE%83%E9%97%AE%E9%A2%98"><span class="toc-number">2.6.4.</span> <span class="toc-text">可能出现的其它问题</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%99%84%E5%BD%95-%E9%81%87%E5%88%B0%E7%9A%84%E9%97%AE%E9%A2%98"><span class="toc-number">3.</span> <span class="toc-text">附录 遇到的问题</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Post</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2023/05/31/%E8%87%AA%E7%AD%BEnginx%E7%9A%84https%E8%AE%BF%E9%97%AE%E8%AF%81%E4%B9%A6/" title="创建SSL证书">创建SSL证书</a><time datetime="2023-05-31T09:03:40.000Z" title="Created 2023-05-31 17:03:40">2023-05-31</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2021/11/05/Java%E5%9F%BA%E7%A1%80/" title="JAVA基础">JAVA基础</a><time datetime="2021-11-05T01:43:21.000Z" title="Created 2021-11-05 09:43:21">2021-11-05</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2019/12/10/rpm%E5%AE%89%E8%A3%85ldap/" title="rpm包安装Idap">rpm包安装Idap</a><time datetime="2019-12-10T02:49:59.000Z" title="Created 2019-12-10 10:49:59">2019-12-10</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2019/12/09/jenkins%E8%87%AA%E5%8A%A8%E5%8C%96%E6%9E%84%E5%BB%BA%E9%83%A8%E7%BD%B2/" title="持续构建持续部署文档">持续构建持续部署文档</a><time datetime="2019-12-09T06:45:38.000Z" title="Created 2019-12-09 14:45:38">2019-12-09</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2019/09/03/%E9%85%8D%E7%BD%AE%E6%9C%AC%E5%9C%B0yum%E6%BA%90/" title="配置本地yum源">配置本地yum源</a><time datetime="2019-09-03T07:43:05.000Z" title="Created 2019-09-03 15:43:05">2019-09-03</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2023 By wangdj</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="Toggle Between Traditional Chinese And Simplified Chinese">简</button><button id="darkmode" type="button" title="Toggle Between Light And Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle between Single-column and Double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="Setting"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back To Top"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>