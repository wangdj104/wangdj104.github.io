<!DOCTYPE html>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" integrity="sha256-CTSx/A06dm1B063156EVh15m6Y67pAjZZaQc89LLSrU=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"wangdj104.github.io","root":"/","images":"/images","scheme":"Muse","darkmode":false,"version":"8.18.2","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"بحث...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js"></script>

    <meta name="description" content="记录生活中的点点滴滴">
<meta property="og:type" content="website">
<meta property="og:title" content="wdj&#39;s blog">
<meta property="og:url" content="https://wangdj104.github.io/index.html">
<meta property="og:site_name" content="wdj&#39;s blog">
<meta property="og:description" content="记录生活中的点点滴滴">
<meta property="og:locale">
<meta property="article:author" content="wangdj">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://wangdj104.github.io/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-Hans","comments":"","permalink":"","path":"index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>wdj's blog</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="تشغيل شريط التصفح" role="button">
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">wdj's blog</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">记录生活中的点点滴滴</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="بحث" role="button">
    </div>
  </div>
</div>







</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          المحتويات
        </li>
        <li class="sidebar-nav-overview">
          عام
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">wangdj</p>
  <div class="site-description" itemprop="description">记录生活中的点点滴滴</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">26</span>
          <span class="site-state-item-name">المقالات</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">23</span>
        <span class="site-state-item-name">التصنيفات</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">17</span>
        <span class="site-state-item-name">الوسوم</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://wangdj104.github.io/2023/05/31/%E8%87%AA%E7%AD%BEnginx%E7%9A%84https%E8%AE%BF%E9%97%AE%E8%AF%81%E4%B9%A6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="wangdj">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="wdj's blog">
      <meta itemprop="description" content="记录生活中的点点滴滴">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | wdj's blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/05/31/%E8%87%AA%E7%AD%BEnginx%E7%9A%84https%E8%AE%BF%E9%97%AE%E8%AF%81%E4%B9%A6/" class="post-title-link" itemprop="url">创建SSL证书</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">نُشر في</span>
      

      <time title="أُنشأ: 2023-05-31 17:03:40 / عُدل: 17:03:14" itemprop="dateCreated datePublished" datetime="2023-05-31T17:03:40+08:00">2023-05-31</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">في</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E9%9A%8F%E6%89%8B%E7%AC%94%E8%AE%B0/" itemprop="url" rel="index"><span itemprop="name">随手笔记</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>主要介绍如何自签https访问需要的ssl证书</p>
<h4 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h4><ul>
<li>openssl-utils</li>
<li>centos7</li>
</ul>
<h4 id="创建SSL证书"><a href="#创建SSL证书" class="headerlink" title="创建SSL证书"></a>创建SSL证书</h4><ol>
<li><p>TLS &#x2F; SSL通过使用公共证书和私钥的组合来工作。SSL密钥在服务器上保密。它用于加密发送给客户端的内容。SSL证书与请求内容的任何人公开共享。它可用于解密由关联的SSL密钥签名的内容。</p>
<p>我们可以在一个命令中使用OpenSSL创建自签名密钥和证书对：</p>
</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">`openssl req -x509 -nodes -days 365 -newkey rsa:2048 -keyout /etc/ssl/private/nginx-selfsigned.key -out /etc/ssl/certs/nginx-selfsigned.crt`</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>openssl</strong>：这是用于创建和管理OpenSSL证书，密钥和其他文件的基本命令行工具。</li>
<li><strong>req</strong>：此子命令指定我们要使用X.509证书签名请求（CSR）管理。“X.509”是SSL和TLS为其密钥和证书管理所遵循的公钥基础结构标准。我们想要创建一个新的X.509证书，所以我们使用这个子命令。</li>
<li><strong>-x509</strong>：通过告诉实用程序我们要创建自签名证书而不是生成证书签名请求（通常会发生）来进一步修改上一个子命令。</li>
<li><strong>-nodes</strong>：这告诉OpenSSL跳过用密码保护我们的证书的选项。当服务器启动时，我们需要Nginx能够在没有用户干预的情况下读取文件。密码短语会阻止这种情况发生，因为我们必须在每次重启后输入密码。</li>
<li><strong>-days 365</strong>：此选项设置证书被视为有效的时间长度。我们在这里设置了一年。</li>
<li><strong>-newkey rsa：2048</strong>：这指定我们要同时生成新证书和新密钥。我们没有创建在上一步中签署证书所需的密钥，因此我们需要将其与证书一起创建。该<code>rsa:2048</code>部分告诉它制作一个2048位长的RSA密钥。</li>
<li><strong>-keyout</strong>：这一行告诉OpenSSL在哪里放置我们正在创建的生成的私钥文件。</li>
<li><strong>-out</strong>：这告诉OpenSSL在哪里放置我们正在创建的证书。</li>
</ul>
<p>如上所述，这些选项将创建密钥文件和证书。我们将询问有关我们服务器的一些问题，以便将信息正确地嵌入到证书中。</p>
<p><img src="/img/ssl01.png" alt="image"></p>
<h4 id="配置nginx"><a href="#配置nginx" class="headerlink" title="配置nginx"></a>配置nginx</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">` vim /data/nginx_anzhuang/nginx/conf/nginx.conf`</span><br></pre></td></tr></table></figure>

<p><img src="/img/ssl02.png" alt="image"></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://wangdj104.github.io/2021/11/05/Java%E5%9F%BA%E7%A1%80/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="wangdj">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="wdj's blog">
      <meta itemprop="description" content="记录生活中的点点滴滴">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | wdj's blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/11/05/Java%E5%9F%BA%E7%A1%80/" class="post-title-link" itemprop="url">JAVA基础</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">نُشر في</span>

      <time title="أُنشأ: 2021-11-05 09:43:21" itemprop="dateCreated datePublished" datetime="2021-11-05T09:43:21+08:00">2021-11-05</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">عُدل في</span>
      <time title="عُدل: 2021-11-15 17:10:14" itemprop="dateModified" datetime="2021-11-15T17:10:14+08:00">2021-11-15</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">في</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E6%8A%80%E6%9C%AF%E6%A0%88/" itemprop="url" rel="index"><span itemprop="name">技术栈</span></a>
        </span>
          ، 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E6%8A%80%E6%9C%AF%E6%A0%88/JAVA%E5%9F%BA%E7%A1%80/" itemprop="url" rel="index"><span itemprop="name">JAVA基础</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="Java中的自增是线程安全的吗，如何实现线程安全的自增"><a href="#Java中的自增是线程安全的吗，如何实现线程安全的自增" class="headerlink" title="Java中的自增是线程安全的吗，如何实现线程安全的自增"></a>Java中的自增是线程安全的吗，如何实现线程安全的自增</h3><ul>
<li><p>自增会带来线程安全问题吗？为什么？<br>是线程不安全的<br>1.i++在字节码层面分为三步：保存当前值，执行添加操作，更新新值<br>2.多线程操作时，可能会同时获取到旧值（假设为1），添加操作后为2，第一个线程刷新新值为3，第二个刷新还是3。</p>
</li>
<li><p>volatile可以保证线程安全吗？<br>不可以！<br>volatile只能保证可见性，以及顺序性<br>但是不能保证多个线程同时操作</p>
</li>
<li><p>如何保证线程安全？<br>1.增加synchronized进行线程同步<br>2.使用lock、unlock处理Reetrantent 锁进行锁定<br>3.使用JVM封装类AtomicInteger<br>AtomicInteger &gt;&gt;&gt; Unsafe &gt;&gt;&gt; cas &gt;&gt;&gt; aba<br>   首先说明，此处 AtomicInteger，一个提供原子操作的 Integer 的类，常见的还有AtomicBoolean、AtomicInteger、AtomicLong、AtomicReference 等，他们的实现原理相同，区别在与运算对象类型的不同。令人兴奋地，还可以通过 AtomicReference<V>将一个对象的所有操作转化成原子操作。</p>
<p>  我们知道，在多线程程序中，诸如+i 或 i++等运算不具有原子性，是不安全的线程操作之一。通常我们会使用 synchronized 将该操作变成一个原子操作，但 JVM 为此类操作特意提供了一些同步类，使得使用更方便，且使程序运行效率变得更高。通过相关资料显示，通常AtomicInteger 的性能是 ReentantLock 的好几倍。</p>
</li>
</ul>
<h3 id="Jdk1-8中的stream有用过吗，详述一下stream的并行操作原理，stream并行的线程池是从哪里来的"><a href="#Jdk1-8中的stream有用过吗，详述一下stream的并行操作原理，stream并行的线程池是从哪里来的" class="headerlink" title="Jdk1.8中的stream有用过吗，详述一下stream的并行操作原理，stream并行的线程池是从哪里来的"></a>Jdk1.8中的stream有用过吗，详述一下stream的并行操作原理，stream并行的线程池是从哪里来的</h3><p>Stream作为Java8的一大亮点，它与java.io包里的InputStream和OutputStream是完全不同的概念。它是对容器对象功能的增强，它专注于对容器对象进行各种非常便利、高效的聚合操作或者大批量数据操作。</p>
<p>Stream API借助于同样新出现的Lambda表达式，极大的提高编程效率和程序可读性。同时，它提供串行和并行两种模式进行汇聚操作，并发模式能够充分利用多核处理器的优势，使用fork&#x2F;join并行方式来拆分任务和加速处理过程。所以说，Java8中首次出现的 java.util.stream是一个函数式语言+多核时代综合影响的产物。</p>
<p>Stream有如下三个操作步骤：</p>
<p>一、创建Stream：从一个数据源，如集合、数组中获取流。</p>
<p>二、中间操作：一个操作的中间链，对数据源的数据进行操作。</p>
<p>三、终止操作：一个终止操作，执行中间操作链，并产生结果。<br><img src="/img/media/20211105110923.png"><br><img src="/img/media/20211105110815.png"></p>
<ul>
<li>Stream流的入门<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">public class StreamDemo1 &#123;</span><br><span class="line">    public static void main(String[]args)&#123;</span><br><span class="line">        //外部迭代</span><br><span class="line">        int [] nums = &#123;1,2,3&#125;;</span><br><span class="line">        int <span class="built_in">sum</span> = 0;</span><br><span class="line">        <span class="keyword">for</span> (int num : nums) &#123;</span><br><span class="line">            <span class="built_in">sum</span> += num;</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">&quot;结果是:&quot;</span> + <span class="built_in">sum</span>);</span><br><span class="line"></span><br><span class="line">        //使用Strem进行内部迭代</span><br><span class="line">        int sum2 = IntStream.of(nums).map( i -&gt; i *2).<span class="built_in">sum</span>();</span><br><span class="line">        System.out.println(<span class="string">&quot;结果为:&quot;</span> + sum2);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;惰性求值是终止没有调用的情况下,中间的操作不会执行&quot;</span>);</span><br><span class="line"></span><br><span class="line">        IntStream.of(nums).map(StreamDemo1::doubNum);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public  static int doubNum(int i)&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;执行了乘以二&quot;</span>);</span><br><span class="line">        <span class="built_in">return</span> i * 2;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>Stream流的创建<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">public class StremDemo2 &#123;</span><br><span class="line">    public static void main(String[]args)&#123;</span><br><span class="line">        List&lt;String&gt; list = new ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        //从集合中创建</span><br><span class="line">        list.stream();</span><br><span class="line">        list.parallelStream();</span><br><span class="line"></span><br><span class="line">        //从数组中创建</span><br><span class="line">        Arrays.stream(new int [] &#123;1,2,3&#125;);</span><br><span class="line"></span><br><span class="line">        //使用rondom创建无线流</span><br><span class="line">        new Random().ints().<span class="built_in">limit</span>(10);</span><br><span class="line"></span><br><span class="line">        //创建数字流</span><br><span class="line">        IntStream.of(1,2,3);</span><br><span class="line">        IntStream.rangeClosed(1,10);</span><br><span class="line">        Random r = new Random();</span><br><span class="line"></span><br><span class="line">        //自己产生流</span><br><span class="line">        Stream.generate(()-&gt; r.nextInt()).<span class="built_in">limit</span>(20).forEach(System.out::println);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>Strem流中常用的几个方法<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">public class StreamDemo3 &#123;</span><br><span class="line">    public static void main(String[]args)&#123;</span><br><span class="line">        String str = <span class="string">&quot;i want to be a software enginner&quot;</span>;</span><br><span class="line"></span><br><span class="line">        Stream.of(str.split(<span class="string">&quot; &quot;</span>)).map( s -&gt; s.length()).forEach(System.out::println);</span><br><span class="line"></span><br><span class="line">        Stream.of(str.split(<span class="string">&quot; &quot;</span>)).filter(s -&gt; s.contains(<span class="string">&quot;a&quot;</span>)).map(s -&gt; s.length()).forEach(System.out::println);</span><br><span class="line"></span><br><span class="line">        Stream.of(str.split(<span class="string">&quot; &quot;</span>)).flatMap(s -&gt; str.chars().boxed()).forEach(i -&gt; System.out.println((char)i.intValue()));</span><br><span class="line"></span><br><span class="line">        Stream.of(str.split(<span class="string">&quot; &quot;</span>)).peek(System.out::println).forEach(System.out::println);</span><br><span class="line"></span><br><span class="line">        //limit 使用 ,主要用于无线流</span><br><span class="line">        new Random().ints().filter(i -&gt; i &gt; 100 &amp;&amp; i &lt; 1000).<span class="built_in">limit</span>(10).forEach(System.out::println) ;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>流的操作二<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">public class StreamDemo4 &#123;</span><br><span class="line">    public static void main(String[]args)&#123;</span><br><span class="line">        String str = <span class="string">&quot;hello lambda hello&quot;</span>;</span><br><span class="line"></span><br><span class="line">        //使用并行流</span><br><span class="line">        str.chars().parallel().forEach( s -&gt; System.out.println((char)s));</span><br><span class="line">        //保证顺序</span><br><span class="line">        str.chars().parallel().forEachOrdered(i -&gt; System.out.println((char)i));</span><br><span class="line"></span><br><span class="line">        //收集器</span><br><span class="line">        List&lt;String&gt; list = Stream.of(str.split(<span class="string">&quot; &quot;</span>)).collect(Collectors.toList());</span><br><span class="line">        System.out.println(<span class="string">&quot;这是一个list:&quot;</span> + list);</span><br><span class="line"></span><br><span class="line">        //使用reduce拼接字符串</span><br><span class="line">        Optional&lt;String&gt; letters = Stream.of(str.split(<span class="string">&quot; &quot;</span>)).reduce((s1,s2) -&gt; s1 + &quot;|&quot; + s2);</span><br><span class="line"></span><br><span class="line">        System.out.println(letters.orElse(&quot;&quot;));</span><br><span class="line"></span><br><span class="line">        //计算所有单词总长度</span><br><span class="line">        Integer lent = Stream.of(str.split(<span class="string">&quot; &quot;</span>)).map(s -&gt; s.length()).reduce(0,(s1,s2) -&gt; s1 + s2);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;单词的总长度是:&quot;</span> + lent);</span><br><span class="line"></span><br><span class="line">        //max</span><br><span class="line">        Optional&lt;String&gt; max = Stream.of(str.split(<span class="string">&quot; &quot;</span>)).max((s1,s2) -&gt; s1.length() - s2.length());</span><br><span class="line">        System.out.println(<span class="string">&quot;单词最长的是:&quot;</span> + max.get());</span><br><span class="line"></span><br><span class="line">        OptionalInt findFirst =  new Random().ints().findFirst();</span><br><span class="line">        System.out.println(<span class="string">&quot;短路操作&quot;</span> + findFirst.getAsInt());</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></li>
<li>串行流和并行流以及线程池<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">   public class StreamDemo5 &#123;</span><br><span class="line">     public static void main(String[]args)&#123;</span><br><span class="line"></span><br><span class="line">        IntStream.range(1,100).parallel().peek(StreamDemo5::debug).count();</span><br><span class="line"></span><br><span class="line">        //parallel 并行流</span><br><span class="line">        IntStream.range(1,100).parallel().peek(StreamDemo5::debug).</span><br><span class="line">                //sequential串行流</span><br><span class="line">                sequential().peek(StreamDemo5::debug2).count();</span><br><span class="line"></span><br><span class="line">        ForkJoinPool pool = new ForkJoinPool(20);</span><br><span class="line">        pool.submit(() -&gt; IntStream.range(<span class="number">1</span>,<span class="number">100</span>).parallel().peek(StreamDemo5::debug).count());</span><br><span class="line">        pool.shutdown();</span><br><span class="line"></span><br><span class="line">        synchronized (pool)&#123;</span><br><span class="line">            try &#123;</span><br><span class="line">                pool.wait();</span><br><span class="line">            &#125; catch (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static void debug(int i)&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;debug&quot;</span> + i);</span><br><span class="line">        System.out.println(<span class="string">&quot;线程&quot;</span> + Thread.currentThread().getName()  + <span class="string">&quot;：&quot;</span> + i);</span><br><span class="line">        try &#123;</span><br><span class="line">            TimeUnit.SECONDS.<span class="built_in">sleep</span>(3);</span><br><span class="line">        &#125; catch (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static void debug2(int i)&#123;</span><br><span class="line">        System.err.println(<span class="string">&quot;debug&quot;</span> + i);</span><br><span class="line">        try &#123;</span><br><span class="line">            TimeUnit.SECONDS.<span class="built_in">sleep</span>(3);</span><br><span class="line">        &#125; catch (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="请聊一下java的集合类-以及在实际项目中你是如何用的"><a href="#请聊一下java的集合类-以及在实际项目中你是如何用的" class="headerlink" title="请聊一下java的集合类,以及在实际项目中你是如何用的"></a>请聊一下java的集合类,以及在实际项目中你是如何用的</h3><p>参照java集合一章</p>
<p>注意说出集合体系,常用类 接口 实现类</p>
<p>加上你所知道的高并发集合类,JUC	参照集合增强内容</p>
<p>在实际项目中引用, 照实说就好了</p>
<p>问集合的引子… …</p>
<p><img src="/img/media/20211115.png"><br>集合类型主要有3种：set(集）、list(列表）和map(映射)。</p>
<p>集合接口分为：Collection和Map，list、set实现了Collection接口</p>
<ul>
<li>List总结：</li>
</ul>
<p>可以重复，通过索引取出加入数据，顺序与插入顺序一致，可以含有null元素</p>
<p>ArrayList:底层数据结构是数组结构array，查询速度快，增删改慢，因为是一种类似数组的形式进行存储，因此它的随机访问速度极快；</p>
<p>Vector：底层是数组结构array，与ArrayList相同，查询速度快，增删改慢；</p>
<p>LinkedList:底层使用链表结构，增删速度快，查询稍慢；</p>
<p>ArrayList与Vector的区别：</p>
<p>1.如果集合中的元素数量大于当前集合数组的长度时，Vector的增长率是目前数组长度的100%，而ArryaList增长率为目前数组长度的50%。所以，如果集合中使用数据量比较大的数据，用Vector有一定优势</p>
<p>2.线程同步ArrayList是线程不同步，所以Vector线程安全，但是因为每个方法都加上了synchronized，所以在效率上小于ArrayList</p>
<ul>
<li>Set总结：<br>数据无序且唯一,实现类都不是线程安全的类，解决方案：Set set &#x3D; Collections.sysnchronizedSet(Set对象);</li>
</ul>
<p>HashSet：是Set接口（Set接口是继承了Collection接口的）最常用的实现类，顾名思义，底层是用了哈希表（散列&#x2F;hash）算法。其底层其实也是一个数组，存在的意义是提供查询速度，插入的速度也是比较快，但是适用于少量数据的插入操作。</p>
<p>LinkedHashSet：继承了HashSet类，所以它的底层用的也是哈希表的数据结构，但因为保持数据的先后添加顺序，所以又加了链表结构，但因为多加了一种数据结构，所以效率较低，不建议使用，如果要求一个集合急要保证元素不重复，也需要记录元素的先后添加顺序，才选择使用LinkedHashSet</p>
<p>TreeSet：Set接口的实现类，也拥有set接口的一般特性，但是不同的是他也实现了SortSet接口，它底层采用的是红黑树算法（红黑树就是满足一下红黑性质的二叉搜索树：①每个节点是黑色或者红色②根节点是黑色的③每个叶子结点是黑色的④如果一个节点是红色的，那么他的两个子节点是黑色的⑤对每个节点，从该节点到其所有的后代叶子结点的简单路径上，仅包含相同数目的黑色结点，红黑树是许多“平衡”搜索树的一种，可以保证在最坏情况下的基本操作集合的时间复杂度为O(lgn)。</p>
<ul>
<li>Map总结：<br>java的Map(映射)是一种把键对象和值对象进行映射的集合，其中每一个元素都包含了键对象和值对象，其中值对象也可以是Map类型的数据，因此，Map支持多级映射，Map中的键是唯一的，但值可以不唯一，Map集合有两种实现，一种是利用哈希表来完成的叫做HashMap，它和HashSet都是利用哈希表来完成的，区别其实就是在哈希表的每个桶中，HashSet只有key，而HashMap在每个key上挂了一个value；另一种就是TreeMap，它实现了SortMap接口，也就是使用了红黑树的数据结构，和TreeSet一样也能实现自然排序和客户化排序两种排序方式，而哈希表不提供排序。</li>
</ul>
<p>HashMap：哈希表的实现原理中，先采用一个数组表示位桶，每个位桶的实现在1.8之前都是使用链表，但当每个位桶的数据较多的时候，链表查询的效率就会不高，因此在1.8之后，当位桶的数据超过阈值（8）的时候，就会采用红黑树来存储该位桶的数据（在阈值之前还是使用链表来进行存储），所以，哈希表的实现包括数组+链表+红黑树，在使用哈希表的集合中我们都认为他们的增删改查操作的时间复杂度都是O(1)的，不过常数项很大，因为哈希函数在进行计算的代价比较高,HashMap和Hashtable类似，不同之处在于HashMap是非同步的，并且允许null，即null value和null key。，但是将HashMap视为Collection时（values()方法可返回Collection），其迭代子操作时间开销和HashMap 的容量成比例。因此，如果迭代操作的性能相当重要的话，不要将HashMap的初始化容量设得过高，或者load factor过低。</p>
<p>TreeMap：TreeMap 是一个有序的key-value集合，它是通过红黑树实现的。TreeMap 继承于AbstractMap，所以它是一个Map，即一个key-value集合。TreeMap 实现了NavigableMap接口，意味着它支持一系列的导航方法。比如返回有序的key集合。TreeMap 实现了Cloneable接口，意味着它能被克隆。TreeMap 实现了java.io.Serializable接口，意味着它支持序列化。</p>
<p>TreeMap基于红黑树（Red-Black tree）实现。该映射根据其键的自然顺序进行排序，或者根据创建映射时提供的 Comparator 进行排序，具体取决于使用的构造方法。TreeMap的基本操作 containsKey、get、put 和 remove 的时间复杂度是 log(n) 。另外，TreeMap是非同步的。 它的iterator 方法返回的迭代器是fail-fastl的。</p>
<p>HashTable:Hashtable继承Map接口，实现一个key-value映射的哈希表。任何非空（non-null）的对象都可作为key或者value，线程安全。</p>
<h3 id="Hashmap为什么要使用红黑树？"><a href="#Hashmap为什么要使用红黑树？" class="headerlink" title="Hashmap为什么要使用红黑树？"></a>Hashmap为什么要使用红黑树？</h3><p>在jdk1.8版本后，java对HashMap做了改进，在链表长度大于8的时候，将后面的数据存在红黑树中，以加快检索速度</p>
<p>红黑树虽然本质上是一棵二叉查找树，但它在二叉查找树的基础上增加了着色和相关的性质使得红黑树相对平衡，从而保证了红黑树的查找、插入、删除的时间复杂度最坏为O(log n)。加快检索速率。</p>
<h3 id="集合类是怎么解决高并发中的问题？"><a href="#集合类是怎么解决高并发中的问题？" class="headerlink" title="集合类是怎么解决高并发中的问题？"></a>集合类是怎么解决高并发中的问题？</h3><p>思路 先说一下那些是非安全</p>
<p>​      普通的安全的集合类</p>
<p>​      JUC中高并发的集合类</p>
<p>线程非安全的集合类 ArrayList LinkedList HashSet TreeSet HashMap TreeMap 实际开发中我们自己用这样的集合最多,因为一般我们自己写的业务代码中,不太涉及到多线程共享同一个集合的问题</p>
<p>线程安全的集合类 Vector HashTable 虽然效率没有JUC中的高性能集合高,但是也能够适应大部分环境</p>
<p>高性能线程安全的集合类</p>
<p> 1.ConcurrentHashMap</p>
<p> 2.ConcurrentHashMap和HashTable的区别</p>
<p> 3.ConcurrentHashMap线程安全的具体实现方式&#x2F;底层具体实现</p>
<p> 4.说说CopyOnWriteArrayList</p>
<p>ConcurrentHashMap 在JDK1.7的时候，ConcurrentHashMap（分段锁）对整个桶数组进行了分割分段(Segment)，每一把锁只锁容器其中一部分数据，多线程访问容器里不同数据段的数据，就不会存在锁竞争 JDK1.8 ConcurrentHashMap取消了Segment分段锁，采用CAS和synchronized来保证并发安全。数据结构跟HashMap1.8的结构类似，数组+链表&#x2F;红黑二叉树。Java 8在链表长度超过一定阈值时将链表（寻址时间复杂度为O(N)）转换为红黑树（寻址时间复杂度为O(log(N))） synchronized只锁定当前链表或红黑二叉树的首节点，这样只 要hash不冲突，就不会产生并发，效率又提升N倍。</p>
<p>ConcurrentSkipListMap是<strong>线程安全的有序的哈希表(相当于线程安全的TreeMap)</strong>; 它<strong>继承于AbstractMap类，并且实现ConcurrentNavigableMap接口</strong>。ConcurrentSkipListMap是<strong>通过“跳表”来实现的</strong>，</p>
<p>ConcurrentSkipListSet是<strong>线程安全的有序的集合(相当于线程安全的TreeSet)<strong>；</strong>它继承于AbstractSet，并实现了NavigableSet接口</strong>。ConcurrentSkipListSet是通过ConcurrentSkipListMap实现的，它也支持并发。</p>
<p> CopyOnWriteArraySet addIfAbsent和 CopyOnWriteArrayList（写入并复制）也是juc里面的，它解决了并发修改异常，每当有写入的时候，就在底层重新复制一个新容器写入，最后把新容器的引用地址赋给旧的容器，在别人写入的时候，其他线程读数据，依然是旧容器的线程。这样是开销很大的，所以不适合频繁写入的操作。适合并发迭代操作多的场景。只能保证数据的最终一致性</p>
<h3 id="简述一下自定义异常的应用场景？"><a href="#简述一下自定义异常的应用场景？" class="headerlink" title="简述一下自定义异常的应用场景？"></a>简述一下自定义异常的应用场景？</h3><p>借助异常机制,我们可以省略很多业务逻辑上的判断处理,直接借助java的异常机制可以简化业务逻辑判断代码的编写</p>
<p>1当你不想把你的错误直接暴露给前端或者你想让前端从业务角度判断后台的异常，这个时候自定义异常类是你的不二选择</p>
<p>2 虽然JAVA给我们提供了丰富的异常类型,但是在实际的业务上,还有很多情况JAVA提供的异常类型不能准确的表述出我们业务上的含义</p>
<p>3 控制项目的后期服务 … …</p>
<h3 id="描述一下Object类中常用的方法"><a href="#描述一下Object类中常用的方法" class="headerlink" title="描述一下Object类中常用的方法"></a>描述一下Object类中常用的方法</h3><h4 id="Object类中的toString-方法"><a href="#Object类中的toString-方法" class="headerlink" title="Object类中的toString()方法"></a>Object类中的toString()方法</h4><p>   1.object 默认方法toString方法，toString() 输出一个对象的地址字符串（哈希code码）！<br>   2.可以通过重写toString方法，获取对象的属性！</p>
<h4 id="Object类中的equals-方法"><a href="#Object类中的equals-方法" class="headerlink" title="Object类中的equals()方法"></a>Object类中的equals()方法</h4><p>   1.Object类equals()比较的是对象的引用是否指向同一块内存地址！<br>   2.重写equals()方法比较俩对象的属性值是否相同</p>
<h4 id="Object"><a href="#Object" class="headerlink" title="Object()"></a>Object()</h4><p>默认构造方法</p>
<h4 id="clone"><a href="#clone" class="headerlink" title="clone()"></a>clone()</h4><p>创建并返回此对象的一个副本。</p>
<h4 id="finalize"><a href="#finalize" class="headerlink" title="finalize()"></a>finalize()</h4><p>当垃圾回收器确定不存在对该对象的更多引用时，由对象的垃圾回收器调用此方法。</p>
<h4 id="getClass"><a href="#getClass" class="headerlink" title="getClass()"></a>getClass()</h4><p>返回一个对象的运行时类。</p>
<h4 id="hashCode"><a href="#hashCode" class="headerlink" title="hashCode()"></a>hashCode()</h4><p>返回该对象的哈希码值。</p>
<h4 id="为什么wait-notify会放在Object里边？"><a href="#为什么wait-notify会放在Object里边？" class="headerlink" title="为什么wait notify会放在Object里边？"></a>为什么wait notify会放在Object里边？</h4><p>wait(),notify(),notifyAll()用来操作线程为什么定义在Object类中？<br>1、这些方法存在于同步中；<br>2、使用这些方法必须标识同步所属的锁；<br>3、锁可以是任意对象，所以任意对象调用方法一定定义在Object类中。</p>
<h4 id="wait-sleep-区别？"><a href="#wait-sleep-区别？" class="headerlink" title="wait(),sleep()区别？"></a>wait(),sleep()区别？</h4><p>wait():释放资源，释放锁<br>sleep():释放资源，不释放锁</p>
<h4 id="notify"><a href="#notify" class="headerlink" title="notify()"></a>notify()</h4><p>唤醒在此对象监视器上等待的单个线程。</p>
<h4 id="notifyAll"><a href="#notifyAll" class="headerlink" title="notifyAll()"></a>notifyAll()</h4><p>唤醒在此对象监视器上等待的所有线程。</p>
<h4 id="wait"><a href="#wait" class="headerlink" title="wait()"></a>wait()</h4><p>导致当前的线程等待，直到其他线程调用此对象的 notify() 方法或 notifyAll() 方法。</p>
<h4 id="wait-long-timeout"><a href="#wait-long-timeout" class="headerlink" title="wait(long timeout)"></a>wait(long timeout)</h4><p>导致当前的线程等待，直到其他线程调用此对象的 notify() 方法或 notifyAll() 方法，或者超过指定的时间量。</p>
<h4 id="wait-long-timeout-int-nanos"><a href="#wait-long-timeout-int-nanos" class="headerlink" title="wait(long timeout, int nanos)"></a>wait(long timeout, int nanos)</h4><p>导致当前的线程等待，直到其他线程调用此对象的 notify() 方法或 notifyAll() 方法，或者其他某个线程中断当前线程，或者已超过某个实际时间量。</p>
<h3 id="1-8的新特性有了解过吗？-注意了解其他版本新特征-JDK更新认识"><a href="#1-8的新特性有了解过吗？-注意了解其他版本新特征-JDK更新认识" class="headerlink" title="1.8的新特性有了解过吗？   (注意了解其他版本新特征) +JDK更新认识"></a>1.8的新特性有了解过吗？   (注意了解其他版本新特征) +JDK更新认识</h3><p>·    <strong>Lambda表达式</strong></p>
<p>·    <strong>函数式接口 函数式编程</strong></p>
<p>·    <strong>方法引用和构造器调用</strong></p>
<p>·    <strong>Stream API</strong></p>
<p>·    <strong>接口中的默认方法和静态方法</strong></p>
<p>·    <strong>新时间日期API</strong></p>
<p>新的日期类</p>
<table>
<thead>
<tr>
<th><strong>属性</strong></th>
<th><strong>含义</strong></th>
</tr>
</thead>
<tbody><tr>
<td><strong>Instant</strong></td>
<td>代表的是时间戳</td>
</tr>
<tr>
<td><strong>LocalDate</strong></td>
<td>代表日期，比如2020-01-14</td>
</tr>
<tr>
<td><strong>LocalTime</strong></td>
<td>代表时刻，比如12:59:59</td>
</tr>
<tr>
<td><strong>LocalDateTime</strong></td>
<td>代表具体时间 2020-01-12 12:22:26</td>
</tr>
<tr>
<td><strong>ZonedDateTime</strong></td>
<td>代表一个包含时区的完整的日期时间，偏移量是以UTC&#x2F; 格林威治时间为基准的</td>
</tr>
<tr>
<td><strong>Period</strong></td>
<td>代表时间段</td>
</tr>
<tr>
<td><strong>ZoneOffset</strong></td>
<td>代表时区偏移量，比如：+8:00</td>
</tr>
<tr>
<td><strong>Clock</strong></td>
<td>代表时钟，比如获取目前美国纽约的时间</td>
</tr>
</tbody></table>
<h3 id="简述一下Java面向对象的基本特征，继承、封装与多态，以及你自己的应用？"><a href="#简述一下Java面向对象的基本特征，继承、封装与多态，以及你自己的应用？" class="headerlink" title="简述一下Java面向对象的基本特征，继承、封装与多态，以及你自己的应用？"></a>简述一下Java面向对象的基本特征，继承、封装与多态，以及你自己的应用？</h3><p>知识参照面向对象章节</p>
<p>注意单独解释 继承 封装 多态的概念</p>
<p>继承 基本概念解释 后面多态的条件</p>
<p>封装 基本概念解释 隐藏实现细节,公开使用方式 </p>
<p>多态 基本概念解释 就是处理参数 提接口 打破单继承 </p>
<p>设计模式 设计原则</p>
<h3 id="Java中重写和重载的区别？"><a href="#Java中重写和重载的区别？" class="headerlink" title="Java中重写和重载的区别？"></a>Java中重写和重载的区别？</h3><p>联系: 名字相似 都是多个同名方法</p>
<p>重载  在同一个类之中发生的</p>
<p>重写 继承中,子类重写父类方法</p>
<p>1 目的差别</p>
<p>2 语法差别</p>
<h3 id="怎样声明一个类不会被继承，什么场景下会用？"><a href="#怎样声明一个类不会被继承，什么场景下会用？" class="headerlink" title="怎样声明一个类不会被继承，什么场景下会用？"></a>怎样声明一个类不会被继承，什么场景下会用？</h3><p>final修饰的类不能有子类 大部分都是出于安全考虑</p>
<p>String举例</p>
<h3 id="什么是ForkJoin框架-适用场景"><a href="#什么是ForkJoin框架-适用场景" class="headerlink" title="什么是ForkJoin框架 适用场景"></a>什么是ForkJoin框架 适用场景</h3><p>虽然目前处理器核心数已经发展到很大数目，但是按任务并发处理并不能完全充分的利用处理器资源，因为一般的应用程序没有那么多的并发处理任务。基于这种现状，考虑把一个任务拆分成多个单元，每个单元分别得到执行，最后合并每个单元的结果。 </p>
<p>Fork&#x2F;Join框架是JAVA7提供的一个用于并行执行任务的框架，是一个把大任务分割成若干小任务，最终汇总每个小任务结果得到大任务结果的框架。 </p>
<p><img src="/img/media/clip_image006.jpg" alt="img"></p>
<p><img src="/img/media/clip_image003.png" alt="img"></p>
<p><strong>2. 工作窃取算法（work-stealing）</strong> </p>
<p>一个大任务拆分成多个小任务，为了减少线程间的竞争，把这些子任务分别放到不同的队列中，并且每个队列都有单独的线程来执行队列里的任务，线程和队列一一对应。 </p>
<p>但是会出现这样一种情况：A线程处理完了自己队列的任务，B线程的队列里还有很多任务要处理。 </p>
<p>A是一个很热情的线程，想过去帮忙，但是如果两个线程访问同一个队列，会产生竞争，所以A想了一个办法，从双端队列的尾部拿任务执行。而B线程永远是从双端队列的头部拿任务执行。 </p>
<p><img src="/img/media/clip_image002-1615278523435.jpg" alt="img"></p>
<p>注意：线程池中的每个线程都有自己的工作队列（PS，这一点和ThreadPoolExecutor不同，ThreadPoolExecutor是所有线程公用一个工作队列，所有线程都从这个工作队列中取任务），当自己队列中的任务都完成以后，会从其它线程的工作队列中偷一个任务执行，这样可以充分利用资源。 </p>
<p><strong>工作窃取算法的优点：</strong> </p>
<p>​     利用了线程进行并行计算，减少了线程间的竞争。 </p>
<p><strong>工作窃取算法的缺点：</strong> </p>
<p>​     任务争夺问题</p>
<h3 id="Java种的代理有几种实现方式？"><a href="#Java种的代理有几种实现方式？" class="headerlink" title="Java种的代理有几种实现方式？"></a>Java种的代理有几种实现方式？</h3><p>动态代理</p>
<p>JDK &gt;&gt;&gt; Proxy  </p>
<p>​    1 面向接口的动态代理  代理一个对象去增强面向某个接口中定义的方法</p>
<p>​    2 没有接口不可用 </p>
<p>​    3 只能读取到接口上的一些注解</p>
<p>MyBatis</p>
<p>DeptMapper dm&#x3D;sqlSession.getMapper(DeptMapper.class)</p>
<p>第三方  CGlib</p>
<p>​    1 面向父类的动态代理</p>
<p>​    2 有没有接口都可以使用</p>
<p>​    3 可以读取类上的注解</p>
<p>​     AOP 日志 性能检测 事务</p>
<p>MyBatis 源码  spring源码</p>
<h3 id="happens-before规则"><a href="#happens-before规则" class="headerlink" title="happens-before规则"></a>happens-before规则</h3><p>​		先行发生原则（Happens-Before）是判断数据是否存在竞争、线程是否安全的主要依据。<br>​		先行发生是Java内存，模型中定义的两项操作之间的偏序关系，如果操作A先行发生于操作B，那么操作</p>
<h4 id="A产生的影响能够被操作B观察到。"><a href="#A产生的影响能够被操作B观察到。" class="headerlink" title="A产生的影响能够被操作B观察到。"></a>A产生的影响能够被操作B观察到。</h4><p>口诀：如果两个操作之间具有happen-before关系，那么前一个操作的结果就会对后面的一个操作可<br>见。是Java内存模型中定义的两个操作之间的偏序关系。</p>
<h3 id="常见的happen-before规则："><a href="#常见的happen-before规则：" class="headerlink" title="常见的happen-before规则："></a>常见的happen-before规则：</h3><h6 id="1-程序顺序规则："><a href="#1-程序顺序规则：" class="headerlink" title="1.程序顺序规则："></a>1.程序顺序规则：</h6><p>一个线程中的每个操作，happen-before在该线程中的任意后续操作。(注解：如果只有一个线程的操<br>作，那么前一个操作的结果肯定会对后续的操作可见。)<br>程序顺序规则中所说的每个操作happen-before于该线程中的任意后续操作并不是说前一个操作必须要<br>在后一个操作之前执行，而是指前一个操作的执行结果必须对后一个操作可见，如果不满足这个要求那就不允许这两个操作进行重排序</p>
<h6 id="2-锁规则："><a href="#2-锁规则：" class="headerlink" title="2.锁规则："></a>2.锁规则：</h6><p>对一个锁的解锁，happen-before在随后对这个锁加锁。(注解：这个最常见的就是synchronized方法和<br>syncronized块)</p>
<h6 id="3-volatile变量规则："><a href="#3-volatile变量规则：" class="headerlink" title="3.volatile变量规则："></a>3.volatile变量规则：</h6><p>对一个volatile域的写，happen-before在任意后续对这个volatile域的读。该规则在CurrentHashMap<br>的读操作中不需要加锁有很好的体现。</p>
<h6 id="4-传递性："><a href="#4-传递性：" class="headerlink" title="4.传递性："></a>4.传递性：</h6><p>如果A happen-before B，且B happen-before C，那么A happen - before C.</p>
<h6 id="5-线程启动规则："><a href="#5-线程启动规则：" class="headerlink" title="5.线程启动规则："></a>5.线程启动规则：</h6><p>Thread对象的start()方法happen-before此线程的每一个动作。</p>
<h6 id="6-线程终止规则："><a href="#6-线程终止规则：" class="headerlink" title="6.线程终止规则："></a>6.线程终止规则：</h6><p>线程的所有操作都happen-before对此线程的终止检测，可以通过Thread.join()方法结束，<br>Thread.isAlive()的返回值等手段检测到线程已经终止执行。</p>
<h6 id="7-线程中断规则："><a href="#7-线程中断规则：" class="headerlink" title="7.线程中断规则："></a>7.线程中断规则：</h6><p>对线程interrupt()方法的调用happen-before发生于被中断线程的代码检测到中断时事件的发生。</p>
<h3 id="jvm监控系统是通过jmx做的么？"><a href="#jvm监控系统是通过jmx做的么？" class="headerlink" title="jvm监控系统是通过jmx做的么？"></a>jvm监控系统是通过jmx做的么？</h3><p>​		一般都是，但是要是记录比较详细的性能定位指标，都会导致进入 safepoint，从而降低了线上应用性<br>能<br>​		例如 jstack，jmap打印堆栈，打印内存使用情况，都会让 jvm 进入safepoint，才能获取线程稳定状态<br>从而采集信息。<br>​		同时，JMX暴露向外的接口采集信息，例如使用jvisualvm，还会涉及rpc和网络消耗，以及JVM忙时，无<br>法采集到信息从而有指标断点。这些都是基于 JMX 的外部监控很难解决的问题。<br>​		所以，推荐使用JVM内部采集 JFR，这样即使在JVM很忙时，也能采集到有用的信息</p>
<h3 id="jvm有哪些垃圾回收器"><a href="#jvm有哪些垃圾回收器" class="headerlink" title="jvm有哪些垃圾回收器"></a>jvm有哪些垃圾回收器</h3><p><img src="/img/media/Snipaste_2021-03-10_13-38-48.png" alt="img"></p>
<p>图中展示了7种作用于不同分代的收集器，如果两个收集器之间存在连线，则说明它们可以搭配使用。虚<br>拟机所处的区域则表示它是属于新生代还是老年代收集器。<br>新生代收集器（全部的都是复制算法）：Serial、ParNew、Parallel Scavenge<br>    老年代收集器：CMS（标记-清理）、Serial Old（标记-整理）、Parallel Old（标记整理）<br>    整堆收集器： G1（一个Region中是标记-清除算法，2个Region之间是复制算法）<br>同时，先解释几个名词：</p>
<h4 id="1，并行（Parallel）：多个垃圾收集线程并行工作，此时用户线程处于等待状态"><a href="#1，并行（Parallel）：多个垃圾收集线程并行工作，此时用户线程处于等待状态" class="headerlink" title="1，并行（Parallel）：多个垃圾收集线程并行工作，此时用户线程处于等待状态"></a>1，并行（Parallel）：多个垃圾收集线程并行工作，此时用户线程处于等待状态</h4><h4 id="2，并发（Concurrent）：用户线程和垃圾收集线程同时执行"><a href="#2，并发（Concurrent）：用户线程和垃圾收集线程同时执行" class="headerlink" title="2，并发（Concurrent）：用户线程和垃圾收集线程同时执行"></a>2，并发（Concurrent）：用户线程和垃圾收集线程同时执行</h4><h4 id="3，吞吐量：运行用户代码时间／（运行用户代码时间＋垃圾回收时间）"><a href="#3，吞吐量：运行用户代码时间／（运行用户代码时间＋垃圾回收时间）" class="headerlink" title="3，吞吐量：运行用户代码时间／（运行用户代码时间＋垃圾回收时间）"></a>3，吞吐量：运行用户代码时间／（运行用户代码时间＋垃圾回收时间）</h4><h2 id="1-Serial收集器是最基本的、发展历史最悠久的收集器。"><a href="#1-Serial收集器是最基本的、发展历史最悠久的收集器。" class="headerlink" title="1.Serial收集器是最基本的、发展历史最悠久的收集器。"></a>1.<strong>Serial收集器是最基本的、发展历史最悠久的收集器。</strong></h2><p>特点：单线程、简单高效（与其他收集器的单线程相比），对于限定单个CPU的环境来说，Serial收集器<br>由于没有线程交互的开销，专心做垃圾收集自然可以获得最高的单线程手机效率。收集器进行垃圾回收<br>时，必须暂停其他所有的工作线程，直到它结束（Stop The World）。<br>应用场景：适用于Client模式下的虚拟机。</p>
<h4 id="Serial-Serial-Old收集器运行示意图"><a href="#Serial-Serial-Old收集器运行示意图" class="headerlink" title="Serial &#x2F; Serial Old收集器运行示意图"></a>Serial &#x2F; Serial Old收集器运行示意图</h4><p><img src="/img/media/Snipaste_2021-03-10_13-40-04.png" alt="img"></p>
<h2 id="2-ParNew收集器其实就是Serial收集器的多线程版本。"><a href="#2-ParNew收集器其实就是Serial收集器的多线程版本。" class="headerlink" title="2.ParNew收集器其实就是Serial收集器的多线程版本。"></a>2.<strong>ParNew收集器其实就是Serial收集器的多线程版本。</strong></h2><p>除了使用多线程外其余行为均和Serial收集器一模一样（参数控制、收集算法、Stop The World、对象<br>分配规则、回收策略等）。<br>    特点：多线程、ParNew收集器默认开启的收集线程数与CPU的数量相同，在CPU非常多的环境中，可以<br>使用-XX:ParallelGCThreads参数来限制垃圾收集的线程数。<br>    和Serial收集器一样存在Stop The World问题<br>应用场景：ParNew收集器是许多运行在Server模式下的虚拟机中首选的新生代收集器，因为它是除了<br>    Serial收集器外，唯一一个能与CMS收集器配合工作的。<br>ParNew&#x2F;Serial Old组合收集器运行示意图如下：</p>
<p><img src="/img/media/Snipaste_2021-03-10_13-40-38.png" alt="img"></p>
<h2 id="3-Parallel-Scavenge-收集器与吞吐量关系密切，故也称为吞吐量优先收集器。"><a href="#3-Parallel-Scavenge-收集器与吞吐量关系密切，故也称为吞吐量优先收集器。" class="headerlink" title="3.Parallel Scavenge 收集器与吞吐量关系密切，故也称为吞吐量优先收集器。"></a>3.<strong>Parallel Scavenge 收集器与吞吐量关系密切，故也称为吞吐量优先收集器。</strong></h2><p>特点：属于新生代收集器也是采用复制算法的收集器，又是并行的多线程收集器（与ParNew收集器类<br>似）。<br>    该收集器的目标是达到一个可控制的吞吐量。还有一个值得关注的点是：GC自适应调节策略（与<br>ParNew收集器最重要的一个区别）<br>        GC自适应调节策略：Parallel Scavenge收集器可设置-XX:+UseAdptiveSizePolicy参数。当开关打开时不<br>需要手动指定新生代的大小（-Xmn）、Eden与Survivor区的比例（-XX:SurvivorRation）、晋升老年代<br>的对象年龄（-XX:PretenureSizeThreshold）等，虚拟机会根据系统的运行状况收集性能监控信息，动<br>态设置这些参数以提供最优的停顿时间和最高的吞吐量，这种调节方式称为GC的自适应调节策略。</p>
<h5 id="Parallel-Scavenge收集器使用两个参数控制吞吐量："><a href="#Parallel-Scavenge收集器使用两个参数控制吞吐量：" class="headerlink" title="Parallel Scavenge收集器使用两个参数控制吞吐量："></a>Parallel Scavenge收集器使用两个参数控制吞吐量：</h5><p>​		XX:MaxGCPauseMillis 控制最大的垃圾收集停顿时间<br>​		XX:GCRatio 直接设置吞吐量的大小。</p>
<h2 id="4-Serial-Old是Serial收集器的老年代版本。"><a href="#4-Serial-Old是Serial收集器的老年代版本。" class="headerlink" title="4.Serial Old是Serial收集器的老年代版本。"></a>4.<strong>Serial Old是Serial收集器的老年代版本。</strong></h2><p>特点：同样是单线程收集器，采用标记-整理算法。<br>应用场景：主要也是使用在Client模式下的虚拟机中。也可在Server模式下使用。<br>Server模式下主要的两大用途（在后续中详细讲解···）：</p>
<ol>
<li>在JDK1.5以及以前的版本中与Parallel Scavenge收集器搭配使用。</li>
<li>作为CMS收集器的后备方案，在并发收集Concurent Mode Failure时使用。<br>Serial &#x2F; Serial Old收集器工作过程图（Serial收集器图示相同）：</li>
</ol>
<p><img src="/img/media/Snipaste_2021-03-10_13-41-14.png" alt="img"></p>
<h2 id="5-Parallel-Old是Parallel-Scavenge收集器的老年代版本。"><a href="#5-Parallel-Old是Parallel-Scavenge收集器的老年代版本。" class="headerlink" title="5.Parallel Old是Parallel Scavenge收集器的老年代版本。"></a>5.<strong>Parallel Old是Parallel Scavenge收集器的老年代版本。</strong></h2><p>特点：多线程，采用标记-整理算法。<br>    应用场景：注重高吞吐量以及CPU资源敏感的场合，都可以优先考虑Parallel Scavenge+Parallel Old 收<br>集器。<br>    Parallel Scavenge&#x2F;Parallel Old收集器工作过程图：</p>
<h2 id="6-CMS收集器是一种以获取最短回收停顿时间为目标的收集器。"><a href="#6-CMS收集器是一种以获取最短回收停顿时间为目标的收集器。" class="headerlink" title="6.CMS收集器是一种以获取最短回收停顿时间为目标的收集器。"></a>6.<strong>CMS收集器是一种以获取最短回收停顿时间为目标的收集器。</strong></h2><p>特点：基于标记-清除算法实现。并发收集、低停顿。<br>应用场景：适用于注重服务的响应速度，希望系统停顿时间最短，给用户带来更好的体验等场景下。如<br>    web程序、b&#x2F;s服务。<br>CMS收集器的运行过程分为下列4步：<br>    初始标记：标记GC Roots能直接到的对象。速度很快但是仍存在Stop The World问题。<br>    并发标记：进行GC Roots Tracing 的过程，找出存活对象且用户线程可并发执行。<br>    重新标记：为了修正并发标记期间因用户程序继续运行而导致标记产生变动的那一部分对象的标记记<br>录。仍然存在Stop The World问题。<br>并发清除：对标记的对象进行清除回收。<br>CMS收集器的内存回收过程是与用户线程一起并发执行的。<br> CMS收集器的工作过程图：</p>
<p><img src="/img/media/Snipaste_2021-03-10_13-41-57.png" alt="img"></p>
<h5 id="CMS收集器的缺点："><a href="#CMS收集器的缺点：" class="headerlink" title="CMS收集器的缺点："></a>CMS收集器的缺点：</h5><p>​	对CPU资源非常敏感。</p>
<p>​	无法处理浮动垃圾，可能出现Concurrent Model Failure失败而导致另一次Full GC的产生。<br>​		因为采用标记-清除算法所以会存在空间碎片的问题，导致大对象无法分配空间，不得不提前触发<br>一次Full GC。</p>
<p>​	</p>
<p><img src="/img/media/Snipaste_2021-03-10_13-44-43.png" alt="img"></p>
<h2 id="7-G1收集器一款面向服务端应用的垃圾收集器。"><a href="#7-G1收集器一款面向服务端应用的垃圾收集器。" class="headerlink" title="7.G1收集器一款面向服务端应用的垃圾收集器。"></a>7.<strong>G1收集器一款面向服务端应用的垃圾收集器。</strong></h2><p>特点如下：<br>        并行与并发：</p>
<p>​			G1能充分利用多CPU、多核环境下的硬件优势，使用多个CPU来缩短Stop-The-World停顿<br>时间。部分收集器原本需要停顿Java线程来执行GC动作，G1收集器仍然可以通过并发的方式让Java程序<br>继续运行。</p>
<p>​		分代收集：</p>
<p>​			G1能够独自管理整个Java堆，并且采用不同的方式去处理新创建的对象和已经存活了一段时间、熬过多次GC的旧对象以获取更好的收集效果</p>
<p>​		空间整合：</p>
<p>​				G1运作期间不会产生空间碎片，收集后能提供规整的可用内存。</p>
<p>​		可预测的停顿：</p>
<pre><code>            G1除了追求低停顿外，还能建立可预测的停顿时间模型。能让使用者明确指定在一个长
</code></pre>
<p>度为M毫秒的时间段内，消耗在垃圾收集上的时间不得超过N毫秒。</p>
<p>G1收集器运行示意图：</p>
<p>​	<img src="/img/media/Snipaste_2021-03-10_13-46-29.png" alt="img"></p>
<h5 id="关于gc的选择"><a href="#关于gc的选择" class="headerlink" title="关于gc的选择"></a>关于gc的选择</h5><p>​		除非应用程序有非常严格的暂停时间要求，否则请先运行应用程序并允许VM选择收集器（如果没有特别<br>要求。使用VM提供给的默认GC就好）。<br>​		如有必要，调整堆大小以提高性能。 如果性能仍然不能满足目标，请使用以下准则作为选择收集器的起<br>点：</p>
<p>​		</p>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">	如果应用程序的数据集较小（最大约<span class="number">100</span> MB），则选择带有选项-XX：+ UseSerialGC的串行</span><br><span class="line">收集器。</span><br><span class="line">		如果应用程序将在单个处理器上运行，并且没有暂停时间要求，则选择带有选项-XX：+</span><br><span class="line">UseSerialGC的串行收集器。</span><br><span class="line">		如果（a）峰值应用程序性能是第一要务，并且（<span class="keyword">b）没有暂停时间要求或可接受一秒或更长</span></span><br><span class="line"><span class="keyword"></span>时间的暂停，则让VM选择收集器或使用-XX：+ UseParallelGC选择并行收集器 。</span><br><span class="line">		如果响应时间比整体吞吐量更重要，并且垃圾收集暂停时间必须保持在大约一秒钟以内，则选</span><br><span class="line">择具有-XX：+ UseG1GC。（值得注意的是<span class="keyword">JDK9中CMS已经被Deprecated，不可使用！移除</span></span><br><span class="line"><span class="keyword"></span>该选项）</span><br><span class="line">		如果使用的是<span class="keyword">jdk8，并且堆内存达到了16G，那么推荐使用G1收集器，来控制每次垃圾收集</span></span><br><span class="line"><span class="keyword"></span>的时间。</span><br><span class="line">		如果响应时间是高优先级，或使用的堆非常大，请使用-XX：UseZGC选择完全并发的收集</span><br><span class="line">器。（值得注意的是<span class="keyword">JDK11开始可以启动ZGC，但是此时ZGC具有实验性质，在JDK15中</span></span><br><span class="line"><span class="keyword"></span>[<span class="number">202009</span>发布]才取消实验性质的标签，可以直接显示启用，但是<span class="keyword">JDK15默认GC仍然是G1）</span></span><br></pre></td></tr></table></figure>

<p>​		这些准则仅提供选择收集器的起点，因为性能取决于堆的大小，应用程序维护的实时数据量以及可用处<br>理器的数量和速度。<br>​		如果推荐的收集器没有达到所需的性能，则首先尝试调整堆和新生代大小以达到所需的目标。 如果性能<br>仍然不足，尝试使用其他收集器<br>​		总体原则：减少STOP THE WORD时间，使用并发收集器（比如CMS+ParNew，G1）来减少暂停时间，<br>加快响应时间，并使用并行收集器来增加多处理器硬件上的总体吞吐量。</p>
<h3 id="pc计数器"><a href="#pc计数器" class="headerlink" title="pc计数器"></a>pc计数器</h3><p>​	pc计数器是一种指针，也叫bcp（bytecode pointer）字节码指针 ，当栈帧成立，读取字节码文件时，你需要知道它读取到哪里了，pc计数器就有着这么一个作用，用来标记读取字节码的当前位置。</p>
<h3 id="介绍一下垃圾回收算法"><a href="#介绍一下垃圾回收算法" class="headerlink" title="介绍一下垃圾回收算法"></a>介绍一下垃圾回收算法</h3><h3 id="老年代和新生代"><a href="#老年代和新生代" class="headerlink" title="老年代和新生代"></a>老年代和新生代</h3><h3 id="内存溢出的原因"><a href="#内存溢出的原因" class="headerlink" title="内存溢出的原因"></a>内存溢出的原因</h3><p>内存溢出的原因<br>java.lang.OutOfMemoryError: ……java heap space….. 堆栈溢出，代码问题的可能性极大<br>java.lang.OutOfMemoryError: GC over head limit exceeded 系统处于高频的GC状态，而且<br>回收的效果依然不佳的情况，就会开始报这个错误，这种情况一般是产生了很多不可以被释放<br>的对象，有可能是引用使用不当导致，或申请大对象导致，但是java heap space的内存溢出<br>有可能提前不会报这个错误，也就是可能内存就直接不够导致，而不是高频GC.<br>java.lang.OutOfMemoryError: PermGen space jdk1.7之前才会出现的问题 ，原因是系统的<br>代码非常多或引用的第三方包非常多、或代码中使用了大量的常量、或通过intern注入常量、<br>或者通过动态代码加载等方法，导致常量池的膨胀<br>java.lang.OutOfMemoryError: Direct buffer memory 直接内存不足，因为jvm垃圾回收不<br>会回收掉直接内存这部分的内存，所以可能原因是直接或间接使用了ByteBuffer中的<br>allocateDirect方法的时候，而没有做clear<br>java.lang.StackOverflowError - Xss设置的太小了<br>java.lang.OutOfMemoryError: unable to create new native thread 堆外内存不足，无法为<br>线程分配内存区域<br>java.lang.OutOfMemoryError: request {} byte for {}out of swap 地址空间不够</p>
<h3 id="线上Gc频繁"><a href="#线上Gc频繁" class="headerlink" title="线上Gc频繁"></a>线上Gc频繁</h3><ol>
<li>查看监控，以了解出现问题的时间点以及当前FGC的频率（可对比正常情况看频率是否正常）</li>
<li>了解该时间点之前有没有程序上线、基础组件升级等情况。</li>
<li>了解JVM的参数设置，包括：堆空间各个区域的大小设置，新生代和老年代分别采用了哪些垃<br>圾收集器，然后分析JVM参数设置是否合理。</li>
<li>再对步骤1中列出的可能原因做排除法，其中元空间被打满、内存泄漏、代码显式调用gc方法<br>比较容易排查。</li>
<li>针对大对象或者长生命周期对象导致的FGC，可通过 jmap -histo 命令并结合dump堆内存文<br>件作进一步分析，需要先定位到可疑对象。</li>
<li>通过可疑对象定位到具体代码再次分析，这时候要结合GC原理和JVM参数设置，弄清楚可疑</li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://wangdj104.github.io/2019/12/10/rpm%E5%AE%89%E8%A3%85ldap/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="wangdj">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="wdj's blog">
      <meta itemprop="description" content="记录生活中的点点滴滴">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | wdj's blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2019/12/10/rpm%E5%AE%89%E8%A3%85ldap/" class="post-title-link" itemprop="url">rpm包安装Idap</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">نُشر في</span>

      <time title="أُنشأ: 2019-12-10 10:49:59" itemprop="dateCreated datePublished" datetime="2019-12-10T10:49:59+08:00">2019-12-10</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">عُدل في</span>
      <time title="عُدل: 2023-11-15 11:12:36" itemprop="dateModified" datetime="2023-11-15T11:12:36+08:00">2023-11-15</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">في</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E6%9C%8D%E5%8A%A1%E9%85%8D%E7%BD%AE%E6%96%87%E6%A1%A3/" itemprop="url" rel="index"><span itemprop="name">服务配置文档</span></a>
        </span>
          ، 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E6%9C%8D%E5%8A%A1%E9%85%8D%E7%BD%AE%E6%96%87%E6%A1%A3/Idap%E6%9C%8D%E5%8A%A1/" itemprop="url" rel="index"><span itemprop="name">Idap服务</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="安装openldap"><a href="#安装openldap" class="headerlink" title="安装openldap"></a>安装openldap</h2><h3 id="rpm包安装"><a href="#rpm包安装" class="headerlink" title="rpm包安装"></a>rpm包安装</h3><p>下载链接: <a target="_blank" rel="noopener" href="https://pan.baidu.com/s/1bWPcquCyqA6iFgktPqE2fQ">https://pan.baidu.com/s/1bWPcquCyqA6iFgktPqE2fQ</a> 提取码: 4834</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rpm -ivh *.rpm --nodeps --force</span><br></pre></td></tr></table></figure>
<h3 id="设置DB-Cache"><a href="#设置DB-Cache" class="headerlink" title="设置DB Cache"></a>设置DB Cache</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cp</span> /usr/share/openldap-servers/DB_CONFIG.example /var/lib/ldap/DB_CONFIG</span><br><span class="line">sudo <span class="built_in">chown</span> -R ldap.ldap /var/lib/ldap/</span><br><span class="line">sudo <span class="built_in">chown</span> -R ldap.ldap /etc/openldap/slapd.d</span><br></pre></td></tr></table></figure>
<h3 id="创建配置文件"><a href="#创建配置文件" class="headerlink" title="创建配置文件"></a>创建配置文件</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/openldap/slapd.conf</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">\<span class="comment">###### SAMPLE 1 - SIMPLE DIRECTORY ############</span></span><br><span class="line">\<span class="comment">#</span></span><br><span class="line">\<span class="comment"># NOTES: inetorgperson picks up attributes and objectclasses</span></span><br><span class="line">\<span class="comment">#        from all three schemas</span></span><br><span class="line">\<span class="comment">#</span></span><br><span class="line">\<span class="comment"># NB: RH Linux schemas in /etc/openldap</span></span><br><span class="line">include /etc/openldap/schema/corba.schema</span><br><span class="line">include /etc/openldap/schema/core.schema</span><br><span class="line">include /etc/openldap/schema/cosine.schema</span><br><span class="line">include /etc/openldap/schema/duaconf.schema</span><br><span class="line">include /etc/openldap/schema/dyngroup.schema</span><br><span class="line">include /etc/openldap/schema/inetorgperson.schema</span><br><span class="line">include /etc/openldap/schema/java.schema</span><br><span class="line">include /etc/openldap/schema/misc.schema</span><br><span class="line">include /etc/openldap/schema/nis.schema</span><br><span class="line">include /etc/openldap/schema/openldap.schema</span><br><span class="line">include /etc/openldap/schema/ppolicy.schema</span><br><span class="line">include /etc/openldap/schema/collective.schema</span><br><span class="line">\<span class="comment"># NO SECURITY - no access clause</span></span><br><span class="line">\<span class="comment"># defaults to anonymous access for read</span></span><br><span class="line">\<span class="comment"># only rootdn can write</span></span><br><span class="line">\<span class="comment"># NO REFERRALS</span></span><br><span class="line">\<span class="comment"># DON&#x27;T bother with ARGS file unless you feel strongly</span></span><br><span class="line">\<span class="comment"># slapd scripts stop scripts need this to work</span></span><br><span class="line">pidfile /var/run/openldap/slapd.pid</span><br><span class="line"></span><br><span class="line">\<span class="comment"># enable a lot of logging - we might need it</span></span><br><span class="line">\<span class="comment"># but generates huge logs</span></span><br><span class="line">loglevel -1</span><br><span class="line">\<span class="comment"># MODULELOAD definitions</span></span><br><span class="line">\<span class="comment"># not required (comment out) before version 2.3</span></span><br><span class="line">moduleload back_bdb.la</span><br><span class="line">\<span class="comment"># NO TLS-enabled connections</span></span><br><span class="line">\<span class="comment"># backend definition not required</span></span><br><span class="line"></span><br><span class="line">\<span class="comment">####################################################################################################</span></span><br><span class="line">\<span class="comment"># bdb database definitions</span></span><br><span class="line">\<span class="comment">#</span></span><br><span class="line">\<span class="comment"># replace example and com below with a suitable domain</span></span><br><span class="line">\<span class="comment">#</span></span><br><span class="line">\<span class="comment"># If you don&#x27;t have a domain you can leave it since example.com</span></span><br><span class="line">\<span class="comment"># is reserved for experimentation or change them to my and inc</span></span><br><span class="line">\<span class="comment">#</span></span><br><span class="line">\<span class="comment">####################################################################################################</span></span><br><span class="line"></span><br><span class="line">database bdb</span><br><span class="line">**suffix** <span class="string">&quot;dc=devops-dev, dc=chinaunicom&quot;</span></span><br><span class="line"></span><br><span class="line">\<span class="comment"># root or superuser</span></span><br><span class="line">**rootdn** <span class="string">&quot;cn=Manager,dc=devops-dev, dc=chinaunicom&quot;</span></span><br><span class="line">**rootpw** &#123;SSHA&#125;obNNrW3soCjEh0QdDquGq4vHyPiyb2qN</span><br><span class="line">\<span class="comment"># The database directory MUST exist prior to running slapd AND</span></span><br><span class="line">\<span class="comment"># change path as necessary</span></span><br><span class="line">directory /var/lib/ldap</span><br><span class="line">\<span class="comment"># Indices to maintain for this directory</span></span><br><span class="line">\<span class="comment"># unique id so equality match only</span></span><br><span class="line">index uid eq</span><br><span class="line">\<span class="comment"># allows general searching on commonname, givenname and email</span></span><br><span class="line">index cn,gn,mail eq,sub</span><br><span class="line">\<span class="comment"># allows multiple variants on surname searching</span></span><br><span class="line">index sn eq,sub</span><br><span class="line">\<span class="comment"># sub above includes subintial,subany,subfinal</span></span><br><span class="line">\<span class="comment"># optimise department searches</span></span><br><span class="line">index ou eq</span><br><span class="line">\<span class="comment"># if searches will include objectClass uncomment following</span></span><br><span class="line">\<span class="comment"># index objectClass eq</span></span><br><span class="line">\<span class="comment"># shows use of default index parameter</span></span><br><span class="line">index default eq,sub</span><br><span class="line">\<span class="comment"># indices missing - uses default eq,sub</span></span><br><span class="line">index telephonenumber eq</span><br><span class="line">\<span class="comment"># other database parameters</span></span><br><span class="line">\<span class="comment"># read more in slapd.conf reference section</span></span><br><span class="line">cachesize 10000</span><br><span class="line">checkpoint 128 15</span><br></pre></td></tr></table></figure>

<p>(1)修改管理员用户<br>rootdn cn&#x3D;Manager,dc&#x3D;devops-dev,dc&#x3D;chinaunicom</p>
<p>(2)修改管理员密码<br>通过slappasswd命令生成{SSHA}加密密码<br><img src="/img/ldap/5867a4d257275f393d70786efcd7a195.png"><br>rootpw {SSHA}obNNrW3soCjEh0QdDquGq4vHyPiyb2qN</p>
<h3 id="检测配置有无问题"><a href="#检测配置有无问题" class="headerlink" title="检测配置有无问题"></a>检测配置有无问题</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">slaptest -f /etc/openldap/slapd.conf</span><br></pre></td></tr></table></figure>
<p><img src="/img/ldap/6ef62394b41e2f01906dd8e350477101.png"><br>报错的这个文件是在启动的时候进行初始化的。先忽视这个问题，不妨我们先启动它。</p>
<h3 id="修改配置"><a href="#修改配置" class="headerlink" title="修改配置"></a>修改配置</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/openldap/slapd.d/cn\=config\/olcDatabase\=&#123;2&#125;hdb.ldif</span><br><span class="line"></span><br><span class="line">   olcSuffix: dc=mypaas,dc=com</span><br><span class="line">   olcRootDN: cn=Manager,dc=mypaas,dc=com \<span class="comment">#管理账号的用户名</span></span><br><span class="line">   olcRootPW: &#123;SSHA&#125;GPEzYwuXyEjXetnjC7uKXydXoERcF3HB　　　　\<span class="comment">#管理账号的密码</span></span><br></pre></td></tr></table></figure>
<h3 id="修改监控认证配置"><a href="#修改监控认证配置" class="headerlink" title="修改监控认证配置"></a>修改监控认证配置</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/openldap/slapd.d/cn\=config\/olcDatabase\=&#123;1&#125;monitor.ldif</span><br><span class="line"></span><br><span class="line">   olcAccess: &#123;0&#125;to * by  dn.base=<span class="string">&quot;gidNumber=0+uidNumber=0,cn=peercred,cn=extern</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">   al,cn=auth&quot;</span> <span class="built_in">read</span> by dn.base=<span class="string">&quot;cn=Manager,dc=devops-dev,dc=chinaunicom&quot;</span> <span class="built_in">read</span> by * none</span><br></pre></td></tr></table></figure>
<p><strong>注意</strong>   和 cn=config/olcDatabase={2}hdb.ldif 文件中的 olcRootDN 相同</p>
<h3 id="启动OpenLDAP服务和开机启动"><a href="#启动OpenLDAP服务和开机启动" class="headerlink" title="启动OpenLDAP服务和开机启动"></a>启动OpenLDAP服务和开机启动</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl start slapd.service</span><br><span class="line">systemctl <span class="built_in">enable</span> slapd.service</span><br></pre></td></tr></table></figure>
<h3 id="再次检查配置"><a href="#再次检查配置" class="headerlink" title="再次检查配置"></a>再次检查配置</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">slaptest -f /etc/openldap/slapd.conf</span><br></pre></td></tr></table></figure>
<h3 id="检查服务状态"><a href="#检查服务状态" class="headerlink" title="检查服务状态"></a>检查服务状态</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl status slapd</span><br></pre></td></tr></table></figure>

<h3 id="导入模板"><a href="#导入模板" class="headerlink" title="导入模板"></a>导入模板</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ls</span> /etc/openldap/schema/*.ldif | xargs -I &#123;&#125; sudo ldapadd -Y EXTERNAL -H ldapi:/// -f &#123;&#125;</span><br></pre></td></tr></table></figure>

<h2 id="安装phpldapadmin"><a href="#安装phpldapadmin" class="headerlink" title="安装phpldapadmin"></a>安装phpldapadmin</h2><p>参考：<a target="_blank" rel="noopener" href="https://www.cnblogs.com/linuxws/p/9084455.html">https://www.cnblogs.com/linuxws/p/9084455.html</a></p>
<h3 id="rpm包安装-1"><a href="#rpm包安装-1" class="headerlink" title="rpm包安装"></a>rpm包安装</h3><p>链接: <a target="_blank" rel="noopener" href="https://pan.baidu.com/s/1h2_vxYPVAYlKxYimr9oU4w">https://pan.baidu.com/s/1h2_vxYPVAYlKxYimr9oU4w</a> 提取码: 2vum</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rpm -ivh *.rpm --nodeps --force</span><br></pre></td></tr></table></figure>

<h3 id="修改配置文件httpd-conf"><a href="#修改配置文件httpd-conf" class="headerlink" title="修改配置文件httpd.conf"></a>修改配置文件httpd.conf</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/httpd/conf/httpd.conf</span><br></pre></td></tr></table></figure>
<p>找到AllowOverride一行，修改none为all</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;Directory /&gt;</span><br><span class="line">AllowOverride all</span><br><span class="line">Require all denied</span><br><span class="line">&lt;/Directory&gt;</span><br></pre></td></tr></table></figure>
<p><strong>注意</strong> 如果想修改端口号，修改Listen 80一行</p>
<h3 id="启动服务，测试页面"><a href="#启动服务，测试页面" class="headerlink" title="启动服务，测试页面"></a>启动服务，测试页面</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl start httpd.service</span><br><span class="line">systemctl <span class="built_in">enable</span> httpd.service</span><br></pre></td></tr></table></figure>
<p>  curl <a target="_blank" rel="noopener" href="http://127.0.0.1/">http://127.0.0.1/</a></p>
<h3 id="修改配置文件"><a href="#修改配置文件" class="headerlink" title="修改配置文件"></a>修改配置文件</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/phpldapadmin/config.php</span><br></pre></td></tr></table></figure>
<p>找到并取消下面几行的注释：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$servers</span>-&gt;setValue(‘server’,’host’,’127.0.0.1’);</span><br><span class="line"></span><br><span class="line"><span class="variable">$servers</span>-&gt;setValue(‘server’,’port’,389);</span><br><span class="line"></span><br><span class="line"><span class="variable">$servers</span>-&gt;setValue(‘server’,’base’,array(‘**dc=devops-dev,dc=chinaunicom**’));</span><br><span class="line"></span><br><span class="line">\<span class="comment"># array里加上openldap配置文件中设置的olcSuffix</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$servers</span>-&gt;setValue(‘login’,’auth_type’,’session’);</span><br><span class="line"></span><br><span class="line"><span class="variable">$servers</span>-&gt;setValue(‘login’,’attr’,’dn’);</span><br><span class="line"></span><br><span class="line">把下边这一行注释掉0</span><br><span class="line"><span class="variable">$servers</span>-&gt;setValue(‘login’,’attr’,’uid’);</span><br></pre></td></tr></table></figure>
<h3 id="修改访问配置文件，允许任意ip访问"><a href="#修改访问配置文件，允许任意ip访问" class="headerlink" title="修改访问配置文件，允许任意ip访问"></a>修改访问配置文件，允许任意ip访问</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/httpd/conf.d/phpldapadmin.conf</span><br></pre></td></tr></table></figure>
<p> 添加一行指令，允许这个IP段访问</p>
<p><img src="/img/ldap/d788daaaf9e49a4ddd547125f57f5547.png"></p>
<p>Require ip 192.168.0　　#指定可访问的ip段（不填不能访问到这个管理工具）</p>
<p>重启httpd服务</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart httpd.service</span><br></pre></td></tr></table></figure>
<h3 id="创建基础目录"><a href="#创建基础目录" class="headerlink" title="创建基础目录"></a>创建基础目录</h3><p>在&#x2F;etc&#x2F;openldap目录下添加base.ldif文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /etc/openldap/</span><br><span class="line">vim base.ldif</span><br><span class="line"></span><br><span class="line">dn: dc=devops-dev,dc=chinaunicom</span><br><span class="line">o: ldap</span><br><span class="line">objectclass: dcObject</span><br><span class="line">objectclass: organization</span><br><span class="line">dc: devops-dev</span><br></pre></td></tr></table></figure>

<h3 id="导入基础目录"><a href="#导入基础目录" class="headerlink" title="导入基础目录"></a>导入基础目录</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ldapadd -x -D <span class="string">&quot;cn=Manager,dc=devops-dev,dc=chinaunicom&quot;</span> -W -f base.ldif</span><br><span class="line">ldapsearch -x -b <span class="string">&#x27; dc=devops-dev,dc=chinaunicom &#x27;</span> <span class="string">&#x27;(objectClass=*)&#x27;</span></span><br></pre></td></tr></table></figure>

<h2 id="其它问题"><a href="#其它问题" class="headerlink" title="其它问题"></a>其它问题</h2><h3 id="问题1"><a href="#问题1" class="headerlink" title="问题1"></a>问题1</h3><p><img src="/img/ldap/4a2479d830bcb3738063b9101b6826d1.png"></p>
<p><img src="/img/ldap/3abc9b2256c8e570effdf2821f1b3965.png"></p>
<p>错误原因：管理员密码错误<br>这个需要自行判断，如需要修改rootdn的密码，在&#x2F;etc&#x2F;openldap&#x2F;slapd.conf中改掉roodn的rootpw项，然后执行如下操作</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">rm</span> -fr /etc/openldap/slapd.d/*</span><br><span class="line">$ sudo slaptest -f /etc/openldap/slapd.conf -F /etc/openldap/slapd.d</span><br><span class="line">\<span class="comment">#测试配置文件语法是否有错误，如果提示testing succeeded则可以进入下一步</span></span><br><span class="line">$ sudo <span class="built_in">chown</span> -R ldap.ldap /etc/openldap/slapd.d</span><br><span class="line">$ sudo systemctl restart slapd.service</span><br></pre></td></tr></table></figure>
<p><strong>提示：</strong> 删除&#x2F;etc&#x2F;openldap&#x2F;slapd.d&#x2F;目录下的内容，并不会导致ldap数据库的丢失，实际上，ldap数据库存储位置（通常位于&#x2F;var&#x2F;lib&#x2F;ldap目录下）由主配置文件里的directory项指定。</p>
<h3 id="问题2"><a href="#问题2" class="headerlink" title="问题2"></a>问题2</h3><p>Cannot load modules&#x2F;libphp5.so into server: &#x2F;lib64&#x2F;libcrypto.so.10: version &#96;OPENSSL_1.0.2’ not found (required by &#x2F;etc&#x2F;httpd&#x2F;modules&#x2F;libphp5.so)</p>
<p>利用rpm -qa|grep openssl查看安装的openssl的版本<br>若为openssl-1.0.1,则需要安装openssl-1.0.2,如下rpm包：</p>
<p>openssl-1.0.2k-16.el7_6.1.x86_64.rpm<br>openssl-libs-1.0.2k-16.el7_6.1.x86_64.rpm</p>
<h3 id="问题3"><a href="#问题3" class="headerlink" title="问题3"></a>问题3</h3><p><img src="/img/ldap/9d7eea3f11904edc58358441d9ab64b2.png"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/httpd/conf.d/phpldapadmin.conf</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&lt;Directory /usr/share/phpldapadmin/htdocs&gt;</span><br><span class="line"></span><br><span class="line"> &lt;IfModule mod_authz_core.c&gt;</span><br><span class="line">   \<span class="comment"># Apache 2.4</span></span><br><span class="line">   Require all granted</span><br><span class="line"> &lt;/IfModule&gt;</span><br><span class="line"></span><br><span class="line"> &lt;IfModule !mod_authz_core.c&gt;</span><br><span class="line">   \<span class="comment"># Apache 2.2</span></span><br><span class="line">    Order Deny,Allow</span><br><span class="line">    Allow from all</span><br><span class="line">    Allow from 127.0.0.1</span><br><span class="line">    Allow from ::1</span><br><span class="line"> &lt;/IfModule&gt;</span><br><span class="line">&lt;/Directory&gt;</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart httpd.service</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://wangdj104.github.io/2019/12/09/jenkins%E8%87%AA%E5%8A%A8%E5%8C%96%E6%9E%84%E5%BB%BA%E9%83%A8%E7%BD%B2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="wangdj">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="wdj's blog">
      <meta itemprop="description" content="记录生活中的点点滴滴">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | wdj's blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2019/12/09/jenkins%E8%87%AA%E5%8A%A8%E5%8C%96%E6%9E%84%E5%BB%BA%E9%83%A8%E7%BD%B2/" class="post-title-link" itemprop="url">持续构建持续部署文档</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">نُشر في</span>

      <time title="أُنشأ: 2019-12-09 14:45:38" itemprop="dateCreated datePublished" datetime="2019-12-09T14:45:38+08:00">2019-12-09</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">عُدل في</span>
      <time title="عُدل: 2023-11-15 11:04:34" itemprop="dateModified" datetime="2023-11-15T11:04:34+08:00">2023-11-15</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">في</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%87%AA%E5%8A%A8%E5%8C%96%E6%9E%84%E5%BB%BA%E6%96%87%E6%A1%A3/" itemprop="url" rel="index"><span itemprop="name">自动化构建文档</span></a>
        </span>
          ، 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%87%AA%E5%8A%A8%E5%8C%96%E6%9E%84%E5%BB%BA%E6%96%87%E6%A1%A3/jenkins%E8%87%AA%E5%8A%A8%E6%9E%84%E5%BB%BA%E9%83%A8%E7%BD%B2/" itemprop="url" rel="index"><span itemprop="name">jenkins自动构建部署</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="第一章-rke部署k8s集群"><a href="#第一章-rke部署k8s集群" class="headerlink" title="第一章 rke部署k8s集群"></a>第一章 rke部署k8s集群</h1><blockquote>
<p>  机器<br>  192.168.17.129<br>  192.168.17.130<br>  192.168.17.131<br>  192.168.17.132<br>  参考博客：<a target="_blank" rel="noopener" href="https://blog.csdn.net/godservant/article/details/80895970">https://blog.csdn.net/godservant/article/details/80895970</a></p>
</blockquote>
<h2 id="安装docker"><a href="#安装docker" class="headerlink" title="安装docker"></a>安装docker</h2><p><img src="/img/media/48bd15a6a74e91332f66dcc57374cf6b.png"></p>
<p>四台机器均安装docker,版本要求1.11.x 1.12.x 1.13.x 17.03.x</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">chmod</span> +x docker-compose</span><br><span class="line"><span class="built_in">mv</span> docker-compose /usr/bin/</span><br><span class="line">rpm -ivh *.rpm --nodeps --force</span><br><span class="line">systemctl start docker</span><br><span class="line">systemctl <span class="built_in">enable</span> docker</span><br><span class="line"></span><br><span class="line">vim /etc/docker/daemon.json</span><br><span class="line">&#123;</span><br><span class="line"><span class="string">&quot;insecure-registries&quot;</span>:[<span class="string">&quot;0.0.0.0/0&quot;</span>]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">systemctl restart docker</span><br></pre></td></tr></table></figure>

<h2 id="运行环境"><a href="#运行环境" class="headerlink" title="运行环境"></a>运行环境</h2><table>
<thead>
<tr>
<th>软件</th>
<th>版本&#x2F;镜像</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td>OS</td>
<td>RHEL 7.2</td>
<td></td>
</tr>
<tr>
<td>Docker</td>
<td>1.12.6</td>
<td></td>
</tr>
<tr>
<td>RKE</td>
<td>v0.0.12-dev</td>
<td></td>
</tr>
<tr>
<td>kubectl</td>
<td>v1.8.4</td>
<td></td>
</tr>
<tr>
<td>Kubernetes</td>
<td>rancher&#x2F;k8s:v1.8.3-rancher2</td>
<td></td>
</tr>
<tr>
<td>canal</td>
<td>quay.io&#x2F;calico&#x2F;node:v2.6.2</td>
<td></td>
</tr>
<tr>
<td></td>
<td>quay.io&#x2F;calico&#x2F;cni:v1.11.0</td>
<td></td>
</tr>
<tr>
<td></td>
<td>quay.io&#x2F;coreos&#x2F;flannel:v0.9.1</td>
<td></td>
</tr>
<tr>
<td>etcd</td>
<td>quay.io&#x2F;coreos&#x2F;etcd:latest</td>
<td></td>
</tr>
<tr>
<td>alpine</td>
<td>alpine:latest</td>
<td></td>
</tr>
<tr>
<td>Nginx proxy</td>
<td>rancher&#x2F;rke-nginx-proxy:v0.1.0</td>
<td></td>
</tr>
<tr>
<td>Cert downloader</td>
<td>rancher&#x2F;rke-cert-deployer:v0.1.1</td>
<td></td>
</tr>
<tr>
<td>Service sidekick</td>
<td>rancher&#x2F;rke-service-sidekick:v0.1.0</td>
<td></td>
</tr>
<tr>
<td>kubedns</td>
<td>gcr.io&#x2F;google_containers&#x2F;k8s-dns-kube-dns-amd64:1.14.5</td>
<td></td>
</tr>
<tr>
<td>dnsmasq</td>
<td>gcr.io&#x2F;google_containers&#x2F;k8s-dns-dnsmasq-nanny-amd64:1.14.5</td>
<td></td>
</tr>
<tr>
<td>Kubedns sidecar</td>
<td>gcr.io&#x2F;google_containers&#x2F;k8s-dns-sidecar-amd64:1.14.5</td>
<td></td>
</tr>
<tr>
<td>Kubedns autoscaler</td>
<td>gcr.io&#x2F;google_containers&#x2F;cluster-proportional-autoscaler-amd64:1.0.0</td>
<td></td>
</tr>
</tbody></table>
<h2 id="部署k8s集群"><a href="#部署k8s集群" class="headerlink" title="部署k8s集群"></a>部署k8s集群</h2><h3 id="创建rke用户并设置rke的ssh免密"><a href="#创建rke用户并设置rke的ssh免密" class="headerlink" title="创建rke用户并设置rke的ssh免密"></a>创建rke用户并设置rke的ssh免密</h3><p>su - rke（只要是集群节点，就需要做免密，包括自己）</p>
<p>1、生成默认格式的密匙key，此过程会在&#x2F;root&#x2F;.ssh&#x2F;文件件夹下生成id_rsa(私钥）和id_rsa.pub(公钥）。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh-keygen</span><br></pre></td></tr></table></figure>

<p><img src="/img/media/8c155f4aa279af2d24060ca82d279ee4.png"></p>
<p>查看&#x2F;root&#x2F;.ssh&#x2F;目录</p>
<p><img src="/img/media/5b8fad9294e9148af71047cac746541c.png"></p>
<p>2、将公钥id_rsa.pub复制到远程主机&#x2F;root&#x2F;.ssh&#x2F;文件中，并且重命名为authorized_keys。（此处以远程主机ip为192.168.17.130举例）</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh-copy-id  -i  ~/.ssh/id_rsa.pub rke@192.168.17.130</span><br></pre></td></tr></table></figure>

<p><img src="/img/media/07a4c4521ebc1bcbaa9a31ea16cb950e.png"></p>
<h3 id="关闭swap分区"><a href="#关闭swap分区" class="headerlink" title="关闭swap分区"></a>关闭swap分区</h3><p>Kubelet运行是需要worker节点关闭swap分区，执行以下命令关闭swap分区</p>
<p>1）永久禁用swap</p>
<p>可以直接修改&#x2F;etc&#x2F;fstab文件，注释掉swap项</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/fstab</span><br></pre></td></tr></table></figure>

<p>2）临时禁用</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">swapoff -a</span><br></pre></td></tr></table></figure>

<h3 id="将rke用户加入到docker用户组"><a href="#将rke用户加入到docker用户组" class="headerlink" title="将rke用户加入到docker用户组"></a>将rke用户加入到docker用户组</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">usermod -aG docker &lt;user_name&gt;</span><br><span class="line"></span><br><span class="line">eg: usermod -aG docker rke</span><br></pre></td></tr></table></figure>

<p>关闭内核防火墙</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/selinux/config</span><br></pre></td></tr></table></figure>
<p><img src="/img/media/de16dd1392ef19a1702cd290b8f8bb3d.png"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">reboot</span><br></pre></td></tr></table></figure>

<h3 id="下载rke和kubectl"><a href="#下载rke和kubectl" class="headerlink" title="下载rke和kubectl"></a>下载rke和kubectl</h3><p>（1）rke最新版本下载: <a target="_blank" rel="noopener" href="https://github.com/rancher/rke/releases/">https://github.com/rancher/rke/releases/</a>, 下载rke_linux-amd64</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">    <span class="built_in">mv</span> rke_linux-amd64 rke</span><br><span class="line">    <span class="built_in">chmod</span> +x rke</span><br><span class="line"><span class="built_in">mv</span> rke  /usr/bin/</span><br></pre></td></tr></table></figure>
<p>（2）Kubectl下载：<a target="_blank" rel="noopener" href="https://storage.googleapis.com/kubernetes-release/release/v1.7.0/bin/darwin/amd64/kubectl">https://storage.googleapis.com/kubernetes-release/release/v1.7.0/bin/darwin/amd64/kubectl</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">chmod</span> +x kubectl</span><br><span class="line"><span class="built_in">mv</span> kubectl  /usr/bin/</span><br></pre></td></tr></table></figure>

<h3 id="部署私有容器镜像仓库harbor"><a href="#部署私有容器镜像仓库harbor" class="headerlink" title="部署私有容器镜像仓库harbor"></a>部署私有容器镜像仓库harbor</h3><p>首先将搭建集群所需的镜像上传到公有harbor上.在镜像所在机器保存特定标签的镜像</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker images --format <span class="string">&quot;&#123;&#123;.Repository&#125;&#125;:&#123;&#123;.Tag&#125;&#125;&quot;</span>\|grep 192.168.17.130</span><br><span class="line"></span><br><span class="line">docker save -o rke.tar.gz $(docker images --format <span class="string">&quot;&#123;&#123;.Repository&#125;&#125;:&#123;&#123;.Tag&#125;&#125;&quot;</span>|grep 192.168.17.130)</span><br></pre></td></tr></table></figure>
<p>所有镜像下载链接: <a target="_blank" rel="noopener" href="https://pan.baidu.com/s/1flpjyrVHX283f-t0b7RFtQ">https://pan.baidu.com/s/1flpjyrVHX283f-t0b7RFtQ</a> 提取码: ubct</p>
<p><img src="/img/media/bb56c8b78b1fc27b90b9c296e5ddf220.png"></p>
<h3 id="修改hosts文件-非必须"><a href="#修改hosts文件-非必须" class="headerlink" title="修改hosts文件(非必须)"></a>修改hosts文件(非必须)</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/hots</span><br><span class="line"></span><br><span class="line">192.168.17.129 rke</span><br><span class="line">192.168.17.130 node1</span><br><span class="line">192.168.17.131 node2</span><br><span class="line">192.168.17.132 node3</span><br></pre></td></tr></table></figure>
<h3 id="编辑集群配置文件cluster-yml"><a href="#编辑集群配置文件cluster-yml" class="headerlink" title="编辑集群配置文件cluster.yml"></a>编辑集群配置文件cluster.yml</h3><p>可以直接在主机的rke用户下执行： .&#x2F;rke config 命令, 生成配置文件: cluster.yml 。本次为了方便，我直接上传cluster.yml，具体内容如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">su - rke</span><br></pre></td></tr></table></figure>
<p>创建cluster.yml文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># If you intened to deploy Kubernetes in an air-gapped environment,</span></span><br><span class="line"><span class="comment"># please consult the documentation on how to configure custom RKE images.</span></span><br><span class="line">nodes:</span><br><span class="line">- address: <span class="string">&quot;192.168.17.129&quot;</span></span><br><span class="line">  port: <span class="string">&quot;22&quot;</span></span><br><span class="line">  internal_address: <span class="string">&quot;&quot;</span></span><br><span class="line">  role:</span><br><span class="line">  - controlplane</span><br><span class="line">  - etcd</span><br><span class="line">  - worker</span><br><span class="line">  hostname_override: <span class="string">&quot;&quot;</span></span><br><span class="line">  user: rke</span><br><span class="line">  docker_socket: /var/run/docker.sock</span><br><span class="line">  ssh_key: <span class="string">&quot;&quot;</span></span><br><span class="line">  ssh_key_path: ~/.ssh/id_rsa</span><br><span class="line">  labels: &#123;&#125;</span><br><span class="line">- address: <span class="string">&quot;192.168.17.130&quot;</span></span><br><span class="line">  port: <span class="string">&quot;22&quot;</span></span><br><span class="line">  internal_address: <span class="string">&quot;&quot;</span></span><br><span class="line">  role:</span><br><span class="line">  - etcd</span><br><span class="line">  - worker</span><br><span class="line">  hostname_override: <span class="string">&quot;&quot;</span></span><br><span class="line">  user: rke</span><br><span class="line">  docker_socket: /var/run/docker.sock</span><br><span class="line">  ssh_key: <span class="string">&quot;&quot;</span></span><br><span class="line">  ssh_key_path: ~/.ssh/id_rsa</span><br><span class="line">  labels: &#123;&#125;</span><br><span class="line">- address: <span class="string">&quot;192.168.17.131&quot;</span></span><br><span class="line">  port: <span class="string">&quot;22&quot;</span></span><br><span class="line">  internal_address: <span class="string">&quot;&quot;</span></span><br><span class="line">  role:</span><br><span class="line">  - worker</span><br><span class="line">  hostname_override: <span class="string">&quot;&quot;</span></span><br><span class="line">  user: rke</span><br><span class="line">  docker_socket: /var/run/docker.sock</span><br><span class="line">  ssh_key: <span class="string">&quot;&quot;</span></span><br><span class="line">  ssh_key_path: ~/.ssh/id_rsa</span><br><span class="line">  labels: &#123;&#125;</span><br><span class="line">services:</span><br><span class="line">  etcd:</span><br><span class="line">    image: <span class="string">&quot;&quot;</span></span><br><span class="line">    extra_args: &#123;&#125;</span><br><span class="line">    extra_binds: []</span><br><span class="line">    extra_env: []</span><br><span class="line">    external_urls: []</span><br><span class="line">    ca_cert: <span class="string">&quot;&quot;</span></span><br><span class="line">    cert: <span class="string">&quot;&quot;</span></span><br><span class="line">    key: <span class="string">&quot;&quot;</span></span><br><span class="line">    path: <span class="string">&quot;&quot;</span></span><br><span class="line">    snapshot: <span class="literal">false</span></span><br><span class="line">    retention: <span class="string">&quot;&quot;</span></span><br><span class="line">    creation: <span class="string">&quot;&quot;</span></span><br><span class="line">  kube-api:</span><br><span class="line">    image: <span class="string">&quot;&quot;</span></span><br><span class="line">    extra_args: &#123;&#125;</span><br><span class="line">    extra_binds: []</span><br><span class="line">    extra_env: []</span><br><span class="line">    service_cluster_ip_range: 10.43.0.0/16</span><br><span class="line">    service_node_port_range: <span class="string">&quot;&quot;</span></span><br><span class="line">    pod_security_policy: <span class="literal">false</span></span><br><span class="line">  kube-controller:</span><br><span class="line">    image: <span class="string">&quot;&quot;</span></span><br><span class="line">    extra_args: &#123;&#125;</span><br><span class="line">    extra_binds: []</span><br><span class="line">    extra_env: []</span><br><span class="line">    cluster_cidr: 10.42.0.0/16</span><br><span class="line">    service_cluster_ip_range: 10.43.0.0/16</span><br><span class="line">  scheduler:</span><br><span class="line">    image: <span class="string">&quot;&quot;</span></span><br><span class="line">    extra_args: &#123;&#125;</span><br><span class="line">    extra_binds: []</span><br><span class="line">    extra_env: []</span><br><span class="line">  kubelet:</span><br><span class="line">    image: <span class="string">&quot;&quot;</span></span><br><span class="line">    extra_args: &#123;&#125;</span><br><span class="line">    extra_binds: []</span><br><span class="line">    extra_env: [Environment=<span class="string">&quot;KUBELET_SYSTEM_PODS_ARGS=--pod-manifest-path=/etc/kubernetes/manifests --allow-privileged=true --fail-swap-on=false&quot;</span>]</span><br><span class="line">    cluster_domain: cluster.local</span><br><span class="line">    infra_container_image: <span class="string">&quot;&quot;</span></span><br><span class="line">    cluster_dns_server: 10.43.0.10</span><br><span class="line">    fail_swap_on: <span class="literal">false</span></span><br><span class="line">  kubeproxy:</span><br><span class="line">    image: <span class="string">&quot;&quot;</span></span><br><span class="line">    extra_args: &#123;&#125;</span><br><span class="line">    extra_binds: []</span><br><span class="line">    extra_env: []</span><br><span class="line">network:</span><br><span class="line">  plugin: canal</span><br><span class="line">  options: &#123;&#125;</span><br><span class="line">authentication:</span><br><span class="line">  strategy: x509</span><br><span class="line">  options: &#123;&#125;</span><br><span class="line">  sans: []</span><br><span class="line">addons: <span class="string">&quot;&quot;</span></span><br><span class="line">addons_include: []</span><br><span class="line">system_images:</span><br><span class="line">  etcd: 192.168.17.132/rke/quay.io/coreos/etcd:v3.1.12</span><br><span class="line">  alpine: 192.168.17.132/rke/rancher/rke-tools:v0.1.13</span><br><span class="line">  nginx_proxy: 192.168.17.132/rke/rancher/rke-tools:v0.1.13</span><br><span class="line">  cert_downloader: 192.168.17.132/rke/rancher/rke-tools:v0.1.13</span><br><span class="line">  kubernetes_services_sidecar: 192.168.17.132/rke/rancher/rke-tools:v0.1.13</span><br><span class="line">  kubedns: 192.168.17.132/rke/gcr.io/google_containers/k8s-dns-kube-dns-amd64:1.14.7</span><br><span class="line">  dnsmasq: 192.168.17.132/rke/gcr.io/google_containers/k8s-dns-dnsmasq-nanny-amd64:1.14.7</span><br><span class="line">  kubedns_sidecar: 192.168.17.132/rke/gcr.io/google_containers/k8s-dns-sidecar-amd64:1.14.7</span><br><span class="line">  kubedns_autoscaler: 192.168.17.132/rke/gcr.io/google_containers/cluster-proportional-autoscaler-amd64:1.0.0</span><br><span class="line">  kubernetes: 192.168.17.132/rke/rancher/hyperkube:v1.9.7-rancher2</span><br><span class="line">  flannel: 192.168.17.132/rke/quay.io/coreos/flannel:v0.9.1</span><br><span class="line">  flannel_cni: 192.168.17.132/rke/quay.io/coreos/flannel-cni:v0.2.0</span><br><span class="line">  calico_node: 192.168.17.132/rke/quay.io/calico/node:v3.1.1</span><br><span class="line">  calico_cni: 192.168.17.132/rke/quay.io/calico/cni:v3.1.1</span><br><span class="line">  calico_controllers: <span class="string">&quot;&quot;</span></span><br><span class="line">  calico_ctl: 192.168.17.132/rke/quay.io/calico/ctl:v2.0.0</span><br><span class="line">  canal_node: 192.168.17.132/rke/quay.io/calico/node:v3.1.1</span><br><span class="line">  canal_cni: 192.168.17.132/rke/quay.io/calico/cni:v3.1.1</span><br><span class="line">  canal_flannel: 192.168.17.132/rke/quay.io/coreos/flannel:v0.9.1</span><br><span class="line">  wave_node: 192.168.17.132/rke/weaveworks/weave-kube:2.1.2</span><br><span class="line">  weave_cni: 192.168.17.132/rke/weaveworks/weave-npc:2.1.2</span><br><span class="line">  pod_infra_container: 192.168.17.132/rke/gcr.io/google_containers/pause-amd64:3.0</span><br><span class="line">  ingress: 192.168.17.132/rke/rancher/nginx-ingress-controller:0.16.2-rancher1</span><br><span class="line">  ingress_backend: 192.168.17.132/rke/k8s.gcr.io/defaultbackend:1.4</span><br><span class="line">  metrics_server: 192.168.17.132/rke/metrics-server-amd64:v0.2.1</span><br><span class="line">ssh_key_path: ~/.ssh/id_rsa</span><br><span class="line">ssh_agent_auth: <span class="literal">false</span></span><br><span class="line">authorization:</span><br><span class="line">  mode: rbac</span><br><span class="line">  options: &#123;&#125;</span><br><span class="line">ignore_docker_version: <span class="literal">false</span></span><br><span class="line">kubernetes_version: <span class="string">&quot;&quot;</span></span><br><span class="line">private_registries: []</span><br><span class="line">ingress:</span><br><span class="line">  provider: <span class="string">&quot;&quot;</span></span><br><span class="line">  options: &#123;&#125;</span><br><span class="line">  node_selector: &#123;&#125;</span><br><span class="line">  extra_args: &#123;&#125;</span><br><span class="line">cluster_name: <span class="string">&quot;&quot;</span></span><br><span class="line">cloud_provider:</span><br><span class="line">  name: <span class="string">&quot;&quot;</span></span><br><span class="line">prefix_path: <span class="string">&quot;&quot;</span></span><br><span class="line">addon_job_timeout: 0</span><br><span class="line">bastion_host:</span><br><span class="line">  address: <span class="string">&quot;&quot;</span></span><br><span class="line">  port: <span class="string">&quot;&quot;</span></span><br><span class="line">  user: <span class="string">&quot;&quot;</span></span><br><span class="line">  ssh_key: <span class="string">&quot;&quot;</span></span><br><span class="line">  ssh_key_path: <span class="string">&quot;&quot;</span></span><br><span class="line">monitoring:</span><br><span class="line">  provider: <span class="string">&quot;&quot;</span></span><br><span class="line">  options: &#123;&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="启动rke，部署集群"><a href="#启动rke，部署集群" class="headerlink" title="启动rke，部署集群"></a>启动rke，部署集群</h3><p>执行</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rke -d up</span><br></pre></td></tr></table></figure>
<p>或</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rke up -config cluster.yml</span><br></pre></td></tr></table></figure>

<p>出现下图即为成功</p>
<p><img src="/img/media/4c42edd5fb914ecaccf04a28b21a66e9.png"></p>
<h3 id="移动集群配置文件"><a href="#移动集群配置文件" class="headerlink" title="移动集群配置文件"></a>移动集群配置文件</h3><p>运行rke成功部署集群后会生成.kube_config_cluster.yml文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cp</span> kube_config_cluster.yml /home/rke/.kube/config</span><br></pre></td></tr></table></figure>

<h3 id="删除k8s集群"><a href="#删除k8s集群" class="headerlink" title="删除k8s集群"></a>删除k8s集群</h3><p>运行</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rke -d remove</span><br></pre></td></tr></table></figure>
<p>或</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rke remove -config cluster.yml</span><br></pre></td></tr></table></figure>
<p>清理节点上的docker容器，在每个节点上执行如下命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="built_in">rm</span> -fv $(docker ps -aq)</span><br></pre></td></tr></table></figure>

<h3 id="为集群节点创建标签"><a href="#为集群节点创建标签" class="headerlink" title="为集群节点创建标签"></a>为集群节点创建标签</h3><p>为节点创建标签</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl label node 192.168.17.131 ci.role=slave</span><br></pre></td></tr></table></figure>
<p>获取节点信息(带节点的标签)</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get node --show-labels</span><br></pre></td></tr></table></figure>
<p>查询带特定标签的节点</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get node -a -l <span class="string">&quot; ci.role=slave &quot;</span></span><br></pre></td></tr></table></figure>
<p>删除一个Label，只需在命令行最后指定Label的key名并与一个减号相连即可</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl label nodes 192.168.17.131 ci.role-</span><br></pre></td></tr></table></figure>
<p>然后在pipeline中就可以加：nodeSelector: ‘ci.role&#x3D;slaver’ 语句了</p>
<p><img src="/img/media/f3b0fb746792560fc48c19dcc125e443.png"></p>
<h3 id="为集群创建maven-setting"><a href="#为集群创建maven-setting" class="headerlink" title="为集群创建maven-setting"></a>为集群创建maven-setting</h3><p>创建configmap-setting.yaml文件：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">data:</span><br><span class="line">  settings.xml: |</span><br><span class="line">    &lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="line"></span><br><span class="line">    &lt;settings xmlns=<span class="string">&quot;http://maven.apache.org/SETTINGS/1.0.0&quot;</span></span><br><span class="line">              xmlns:xsi=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="line">              xsi:schemaLocation=<span class="string">&quot;http://maven.apache.org/SETTINGS/1.0.0 http://maven.apache.org/xsd/settings-1.0.0.xsd&quot;</span>&gt;</span><br><span class="line"></span><br><span class="line">      &lt;pluginGroups&gt;</span><br><span class="line">      &lt;/pluginGroups&gt;</span><br><span class="line"></span><br><span class="line">      &lt;proxies&gt;</span><br><span class="line">      &lt;/proxies&gt;</span><br><span class="line"></span><br><span class="line">      &lt;servers&gt;</span><br><span class="line">       &lt;server&gt;</span><br><span class="line">       &lt;<span class="built_in">id</span>&gt;chinaunicom&lt;/id&gt;</span><br><span class="line">       &lt;username&gt;admin&lt;/username&gt;</span><br><span class="line">       &lt;password&gt;11111111&lt;/password&gt;</span><br><span class="line">      &lt;/server&gt;</span><br><span class="line">       &lt;server&gt;</span><br><span class="line">       &lt;<span class="built_in">id</span>&gt;maven-snapshot-manager&lt;/id&gt;</span><br><span class="line">       &lt;username&gt;admin&lt;/username&gt;</span><br><span class="line">       &lt;password&gt;11111111&lt;/password&gt;</span><br><span class="line">       &lt;/server&gt;</span><br><span class="line">       &lt;server&gt;</span><br><span class="line">       &lt;<span class="built_in">id</span>&gt;maven-release-manager&lt;/id&gt;</span><br><span class="line">       &lt;username&gt;admin&lt;/username&gt;</span><br><span class="line">       &lt;password&gt;11111111&lt;/password&gt;</span><br><span class="line">       &lt;/server&gt;</span><br><span class="line">      &lt;/servers&gt;</span><br><span class="line"></span><br><span class="line">      &lt;mirrors&gt;</span><br><span class="line">        &lt;mirror&gt;</span><br><span class="line">          &lt;<span class="built_in">id</span>&gt;chinaunicom&lt;/id&gt;</span><br><span class="line">          &lt;mirrorOf&gt;*&lt;/mirrorOf&gt;</span><br><span class="line">          &lt;name&gt;Human Readable Name <span class="keyword">for</span> this Mirror.&lt;/name&gt;</span><br><span class="line">          &lt;url&gt;http://192.168.17.132:8081/repository/maven-public/&lt;/url&gt;</span><br><span class="line">        &lt;/mirror&gt;</span><br><span class="line">         &lt;mirror&gt;</span><br><span class="line">          &lt;<span class="built_in">id</span>&gt;maven-snapshot-manager&lt;/id&gt;</span><br><span class="line">          &lt;mirrorOf&gt;*&lt;/mirrorOf&gt;</span><br><span class="line">          &lt;name&gt;Human Readable Name <span class="keyword">for</span> this Mirror.&lt;/name&gt;</span><br><span class="line">          &lt;url&gt;http://192.168.17.132:8081/repository/maven-snapshots/&lt;/url&gt;</span><br><span class="line">        &lt;/mirror&gt;</span><br><span class="line">        &lt;mirror&gt;</span><br><span class="line">          &lt;<span class="built_in">id</span>&gt;maven-release-manager&lt;/id&gt;</span><br><span class="line">          &lt;mirrorOf&gt;*&lt;/mirrorOf&gt;</span><br><span class="line">          &lt;name&gt;Human Readable Name <span class="keyword">for</span> this Mirror.&lt;/name&gt;</span><br><span class="line">          &lt;url&gt;http://192.168.17.132:8081/repository/maven-releases/&lt;/url&gt;</span><br><span class="line">        &lt;/mirror&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">      &lt;/mirrors&gt;</span><br><span class="line"></span><br><span class="line">      &lt;profiles&gt;</span><br><span class="line">      &lt;/profiles&gt;</span><br><span class="line"></span><br><span class="line">    &lt;/settings&gt;</span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  name: configmap-maven-settings-mirror-31010</span><br><span class="line">  namespace: jenkins</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>执行命令</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f configmap-setting.yaml</span><br></pre></td></tr></table></figure>
<p>创建名为configmap-maven-settings-mirror-31010的configMap,然后pipeline中就可以如下配置：</p>
<p><img src="/img/media/951808da060f5c65e9c14dadfe2c1f0d.png"></p>
<p>查看configMap</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get configmap -n jenkins</span><br></pre></td></tr></table></figure>

<h3 id="为集群创建configMap"><a href="#为集群创建configMap" class="headerlink" title="为集群创建configMap"></a>为集群创建configMap</h3><p>创建kubeconfig-dev.yaml文件：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">data:</span><br><span class="line">  config: |</span><br><span class="line">    apiVersion: v1</span><br><span class="line">    kind: Config</span><br><span class="line">    clusters:</span><br><span class="line">    - cluster:</span><br><span class="line">        api-version: v1</span><br><span class="line">        certificate-authority-data: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUN3akNDQWFxZ0F3SUJBZ0lCQURBTkJna3Foa2lHOXcwQkFRc0ZBREFTTVJBd0RnWURWUVFERXdkcmRXSmwKTFdOaE1CNFhEVEU1TVRJd01URXlOREkwTTFvWERUSTVNVEV5T0RFeU5ESTBNMW93RWpFUU1BNEdBMVVFQXhNSAphM1ZpWlMxallUQ0NBU0l3RFFZSktvWklodmNOQVFFQkJRQURnZ0VQQURDQ0FRb0NnZ0VCQU53TVdZY1dheGk3ClA0VXNhOExCSW1NL3Q3bUlZMEVHTnZia2dGd3hpR2tBODhBMXJ3SjhzNFE3cFRmS3BzS3Zublp2QlY4aHdpNmQKKzZkK0xFMTlTRFNvL2owRHMzUDRJNFY5S3E1Mk9sRzN4U0pFTXY3VW9DM0VJOE9OM1pMZnIwSlpNRnpvaW1BbwpjUjFDTENlVVN0WDNudXk5K2Y0cjBuaEZGRDcyNkFJTmN3QlB6SjI5RHcwZ3grbmFuVnh6S3UzSjJOSm9hS05jCm41V0dMeUE4V2YxNUdUQVdGL29rcklkTHZFTUxQSUx5SG43elRHZm52TFNTRVhJWTFBZEl2bFRlcmI2UXdNUjIKcWFMSlg4WEo0WTlQR0UvdktUVGdrMHZGdm9ZQTcvbnZQdGRoUTF2aGJqcWpsL2NJM0JtYnhnNFZJL1RUQzl3SQppQ0IzeUdVeXpGRUNBd0VBQWFNak1DRXdEZ1lEVlIwUEFRSC9CQVFEQWdLa01BOEdBMVVkRXdFQi93UUZNQU1CCkFmOHdEUVlKS29aSWh2Y05BUUVMQlFBRGdnRUJBTTBJakVGSHM0TmNiT1FQNVdpd0tXZ0k0WDdMZy9Sa2VCK20KaWx3YzU4aU1XR3ZGT1hJc3ZBaFU1YVdUSHlIQUt2VGd2U2xyamlwSDJxeVZVQTlkSlNkcjBCL2RPdnBac1RIcAprakdFOGFTYkNnajJBQ2o1bEZjT21DSC9oeTRPVHlnSEl0amJDaVpjejMvOVVZVTlkczh4RWlLejlsUDRwelE5Cm5IRGxwemJyU09pbWsrQTFiZTRQWXNIL0ozUWJ6cGs1VERWbEp0eWlGbHhBU2RWdmJUUWtMMjRUMXZHWFp3K1YKcEE0S1h1OTlTaTZncVhHeFQrcElJUE9HSjZzcDM2eXh1RE5YSnhKdGpTUk9zTWhlMm9oT0pXencwYUpWYWtpSQpqbDNiSnlMcDlVd2ZrOEZFOUd2UlVBd1c4VitCYzk1MkhwR2wyaXVyazZoSTVqV2ZEUnc9Ci0tLS0tRU5EIENFUlRJRklDQVRFLS0tLS0K</span><br><span class="line">        server: <span class="string">&quot;https://192.168.17.129:6443&quot;</span></span><br><span class="line">      name: <span class="string">&quot;local&quot;</span></span><br><span class="line">    contexts:</span><br><span class="line">    - context:</span><br><span class="line">        cluster: <span class="string">&quot;local&quot;</span></span><br><span class="line">        user: <span class="string">&quot;kube-admin-local&quot;</span></span><br><span class="line">      name: <span class="string">&quot;local&quot;</span></span><br><span class="line">    current-context: <span class="string">&quot;local&quot;</span></span><br><span class="line">    <span class="built_in">users</span>:</span><br><span class="line">    - name: <span class="string">&quot;kube-admin-local&quot;</span></span><br><span class="line">      user:</span><br><span class="line">        client-certificate-data: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUM2VENDQWRHZ0F3SUJBZ0lJSXMrbG05aXN6RW93RFFZSktvWklodmNOQVFFTEJRQXdFakVRTUE0R0ExVUUKQXhNSGEzVmlaUzFqWVRBZUZ3MHhPVEV5TURFeE1qUXlORE5hRncweU1ERXhNekF4TWpReU5EWmFNQzR4RnpBVgpCZ05WQkFvVERuTjVjM1JsYlRwdFlYTjBaWEp6TVJNd0VRWURWUVFERXdwcmRXSmxMV0ZrYldsdU1JSUJJakFOCkJna3Foa2lHOXcwQkFRRUZBQU9DQVE4QU1JSUJDZ0tDQVFFQXNLdGtaZWY4bzMzdzB0VmpmbFZITVMrVHpCM0QKV2NnM1o3L3JMZ0UzTS9ySlkvdUtJV2RiTmxYZG1ZeTBJakdQVEZqNFl4eHV4Ymo4cy9xVmdDR1dJQUk2dVAxcgpxYUlZdm5ud3dWZUVDcTZsZG9TM09vYTFGQzFlTFg3Z0o2OWE0UVprR2lYNHhZYkpkTUNTWm92N3JzamtIbUgvCmJ3Z010cVlzdk9sOTJ6S2NiaEtFNG5GejVlN3A2Qm5wL05BQXhvYnF2K0F4VHlrYUdBYWRna0trM3Jrd2VCUkIKODVQV0pSZDVITDBwOTUybzFwdkthbGx0MVh1a0ZPTHgzc3lJdTQrR1EwbWJWQkVmeVRYM2JoSFlpaG05NDlHdgo1c0MySVN4WUxLT0RSc2xuY1lVcGVYYVR5NldJRmFMODc1ZFVIaG9vRVZFTjJ5WnVYVlMvZmVMWWp3SURBUUFCCm95Y3dKVEFPQmdOVkhROEJBZjhFQkFNQ0JhQXdFd1lEVlIwbEJBd3dDZ1lJS3dZQkJRVUhBd0l3RFFZSktvWkkKaHZjTkFRRUxCUUFEZ2dFQkFKQktqZjZ1Zk40ZjBmdTBHMFQxNHJZWS96VGRPSjNOeGxBMXp3aUJrQndNWHFXcApBQW5HOFp6bzlvYWE0MFNkR2FRUUVCSnR4ZHFBYWNWOW1kREFJM1lmdW1UQlVTdVZCSDdEYUx4RG9HU283NElDCkFpVkYzNWk1cGRkWjNZRCt4c2Q1Ni94QXBJdTFvOGpxVFFRejlQUDFIZFRMaTNZYm9OM0FOdFNKZnFlSlBVckcKYXJjTDdmdGRldEdvdWJUdlhPazIxOXk3YldpRE9xSlFqVkpVajVudkNXL25xRFBmbDZmbkZ1YStxMUg4bXZ4QwpzRDdlMEgra0F0RHN5TW1RbXRzd2l4alpkVU5vRzZYZUlMZ25aaEMrejVWdjlRd0hEMXd4YXdRc0pZK3YzU0drClAydWFMcXFXb1FwQklmZHZXaThzK29DdTA1NXlYNzZpODgxVTFsWT0KLS0tLS1FTkQgQ0VSVElGSUNBVEUtLS0tLQo=</span><br><span class="line">        client-key-data: LS0tLS1CRUdJTiBSU0EgUFJJVkFURSBLRVktLS0tLQpNSUlFcEFJQkFBS0NBUUVBc0t0a1plZjhvMzN3MHRWamZsVkhNUytUekIzRFdjZzNaNy9yTGdFM00vckpZL3VLCklXZGJObFhkbVl5MElqR1BURmo0WXh4dXhiajhzL3FWZ0NHV0lBSTZ1UDFycWFJWXZubnd3VmVFQ3E2bGRvUzMKT29hMUZDMWVMWDdnSjY5YTRRWmtHaVg0eFliSmRNQ1Nab3Y3cnNqa0htSC9id2dNdHFZc3ZPbDkyektjYmhLRQo0bkZ6NWU3cDZCbnAvTkFBeG9icXYrQXhUeWthR0FhZGdrS2szcmt3ZUJSQjg1UFdKUmQ1SEwwcDk1Mm8xcHZLCmFsbHQxWHVrRk9MeDNzeUl1NCtHUTBtYlZCRWZ5VFgzYmhIWWlobTk0OUd2NXNDMklTeFlMS09EUnNsbmNZVXAKZVhhVHk2V0lGYUw4NzVkVUhob29FVkVOMnladVhWUy9mZUxZandJREFRQUJBb0lCQUN2MDJPd0tCbS9mTy9ZWgpKY0lmRWJHSk51cklWUHlYdGtGWUhQbTdUN0xkS1JKNVdXcnFQbVdNZzdCYXM4NzJLY05ETjduaEx5WisybEVsCmZlRDllazdJZnpmYnhkZlUvdmNWZS9OL0JObHJqcnVvVmJaNEljRzliL3M5NENPL200cjFmaDZMYUJRdGJ4NWYKYzQyVU1yRFFSd0hRUEMreC93ZkszTUs4RFpabDNRM0xzN21aM0ZHaVB3ajR1dFBYb0pQNzJxdC9xSUVNTnZIOQo0c0xZb1NzekM5NW9hcWk2Unh1V2pvZHVPazJxMjlZR2w4VHQxOXdiOEs3K2xzV0p5YndwVHQ5S1FSRXhucHorCmtYbFdXNWpwaXM2L3JHTkRYWGdhcHdvNW1jSCtPOHVrYmtscDlyaDVPS0hvRGc5aWhHUkhSODBQVkNWVkRxQ2QKRFUvbkpMRUNnWUVBd3MwTmFwcGNLSG9yKzFDU3d6ckJ6WlU5a3YvSXhDNFY5bjRqVUxyallXT1dNb1Bya3pDZwpqK3lRRk9pK0tjaEdJTEdhT3dzUlhGeGRocEdBWk16VGx0UmE0TmZONEI4MFg2SFdWWHFkZjB6ajBsNEcxRlUvCmpKM2xWS0hmU3czNmh2NEV1QVRrRE03NTNzeFY4OGRsK21qV1pKYkt3dHhBdGFQWW81blplbnNDZ1lFQTZDd2IKbDV1Y3dOVGd5RXY4QmYvWHJ4SFJRc2toSVBGbUtNOXBOUGRzUTBPT1pKTnBvYVprdVNVaEZ3NEZzV2Uvb1AvQwpjMGJ6OTlJTFMyZVRrYjhweUZTOStLYUhMNzBZQ1MzcTRjbWlEVE4xZWhwbURDajZ3c2d5aGY0K1pURTlzRmxmCnNkT2xaWElLOFB3c1NXQ3o2Ym1hWExQbnRPVlJ2SWR3WmVwdlYvMENnWUJORWlXeHZKcWpwUnFMbHVoSjk1QS8KejBFS1RNclkyMGJ6UEJxcTBSWXZMT0I2NGZpdFJucndGbTgyNXBKK0kyK2pkY0VJaFN0OE9Fc0VkOEt0bnVCRAo5NFp4R05DcVVJNC9HOStaK0NZaC9JRFNkVU1NZFNIc2QzZ0pVUFh3VXZxQXVEV1R2Tk9oUWE1WWVNMjA0bm8xClpZOFZReGU3bXJxN1lyVE9uWXNPeXdLQmdRQzgxUHNRSVBHcWFMbjJUczdKTmwvL05SZWxJUjcvd3pjYTVDOG0KZEVLcXBxeU9vdExjTmhCZ0FaSGJSWDFkNEFzYzhFZ0FLR3BQV3BmekdXZ050NVJOS3Bka1FGVmRmNGVvRjUrZApTcml4MGZPdmZ2OFd6dEc5VU1TKzlKMWRBbUt4SnMvTk8xMmZsOVRNVWQzWFJINndEMVE4SjlyQjUyM0dUOFljCkxrT25KUUtCZ1FDSXEydk42NTdHbUNOMUtCTlpMOGwvVWJud0twMEtKbVdOZ3RLU0VzTytvcnMvbFNnVlRwbVYKZE9IMXo1cmcvNHVCYnFXeEluMlA2eWpGUWlqck5odGlXR3N0anFPelJlU3FzYmt6QTJINUV3THB1WFVLWDUvZQpMRjhpNWt2bnFPZ1Vab1g4WVQ2L0N4SjZtU1pVTEN0NEVpditJeUc2bTQ1OHpDeW9zbFgrU3c9PQotLS0tLUVORCBSU0EgUFJJVkFURSBLRVktLS0tLQo=</span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  name: configmap-kubeconfig-dev</span><br><span class="line">  namespace: jenkins</span><br></pre></td></tr></table></figure>
<p>执行命令</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f kubeconfig-dev.yaml</span><br></pre></td></tr></table></figure>
<p>创建名为configmap-kubeconfig-dev的configMap,然后pipeline中就可以如下配置：</p>
<p><img src="/img/media/9a558cb68a01dcf99001cd781e0782ff.png"></p>
<h3 id="调试集群"><a href="#调试集群" class="headerlink" title="调试集群"></a>调试集群</h3><p>查看集群部署信息</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl cluster-info</span><br></pre></td></tr></table></figure>
<p>查看k8s的节点是否工作正常</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get nodes -o wide</span><br></pre></td></tr></table></figure>
<p>查看所有命名空间下的deployment</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get deployment --all-namespaces</span><br></pre></td></tr></table></figure>
<p>查看所有命名空间下的svc</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get svc --all-namespaces</span><br></pre></td></tr></table></figure>
<p>查看所有命名空间下的pod</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pod -o wide --all-namespaces</span><br></pre></td></tr></table></figure>
<p>查看某个pod的运行日志</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl logs -f kubernetes-dashboard-7f9f8cc4cf-tm2ld -n kube-system</span><br></pre></td></tr></table></figure>
<p>删除某个pod</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl delete pod ms-cloud-tenant-service-5dc69784b-f42vh -n cloud</span><br></pre></td></tr></table></figure>
<p>查看某个失败的pod的明细</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl describe pod metrics-server-6c84bc5674-tf4qw -n kube-system</span><br></pre></td></tr></table></figure>
<p>查看镜像描述信息</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker inspect 10.124.133.192/devops/jenkins-slaver-dind:v1.0.0</span><br></pre></td></tr></table></figure>
<p>查看某个命名空间下pod的实时状态变化</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pod -o wide -n jenkins -w</span><br></pre></td></tr></table></figure>
<p>查看所有启动的容器（包括失败的）</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker ps -a</span><br></pre></td></tr></table></figure>

<h3 id="部署k8s-dashboard页面"><a href="#部署k8s-dashboard页面" class="headerlink" title="部署k8s dashboard页面"></a>部署k8s dashboard页面</h3><p>参考博客：<a target="_blank" rel="noopener" href="https://www.kubernetes.org.cn/4004.html">https://www.kubernetes.org.cn/4004.html</a></p>
<h4 id="部署dashboard"><a href="#部署dashboard" class="headerlink" title="部署dashboard"></a>部署dashboard</h4><p>(1)新建k8s-dashboard.yaml文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Copyright 2017 The Kubernetes Authors.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span></span><br><span class="line"><span class="comment"># you may not use this file except in compliance with the License.</span></span><br><span class="line"><span class="comment"># You may obtain a copy of the License at</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#     http://www.apache.org/licenses/LICENSE-2.0</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Unless required by applicable law or agreed to in writing, software</span></span><br><span class="line"><span class="comment"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span></span><br><span class="line"><span class="comment"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span></span><br><span class="line"><span class="comment"># See the License for the specific language governing permissions and</span></span><br><span class="line"><span class="comment"># limitations under the License.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ------------------- Dashboard Secret ------------------- #</span></span><br><span class="line"></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Secret</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: kubernetes-dashboard</span><br><span class="line">  name: kubernetes-dashboard-certs</span><br><span class="line">  namespace: kube-system</span><br><span class="line"><span class="built_in">type</span>: Opaque</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line"><span class="comment"># ------------------- Dashboard Service Account ------------------- #</span></span><br><span class="line"></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: kubernetes-dashboard</span><br><span class="line">  name: kubernetes-dashboard</span><br><span class="line">  namespace: kube-system</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line"><span class="comment"># ------------------- Dashboard Role &amp; Role Binding ------------------- #</span></span><br><span class="line"></span><br><span class="line">kind: Role</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">metadata:</span><br><span class="line">  name: kubernetes-dashboard-minimal</span><br><span class="line">  namespace: kube-system</span><br><span class="line">rules:</span><br><span class="line">  <span class="comment"># Allow Dashboard to create &#x27;kubernetes-dashboard-key-holder&#x27; secret.</span></span><br><span class="line">- apiGroups: [<span class="string">&quot;&quot;</span>]</span><br><span class="line">  resources: [<span class="string">&quot;secrets&quot;</span>]</span><br><span class="line">  verbs: [<span class="string">&quot;create&quot;</span>]</span><br><span class="line">  <span class="comment"># Allow Dashboard to create &#x27;kubernetes-dashboard-settings&#x27; config map.</span></span><br><span class="line">- apiGroups: [<span class="string">&quot;&quot;</span>]</span><br><span class="line">  resources: [<span class="string">&quot;configmaps&quot;</span>]</span><br><span class="line">  verbs: [<span class="string">&quot;create&quot;</span>]</span><br><span class="line">  <span class="comment"># Allow Dashboard to get, update and delete Dashboard exclusive secrets.</span></span><br><span class="line">- apiGroups: [<span class="string">&quot;&quot;</span>]</span><br><span class="line">  resources: [<span class="string">&quot;secrets&quot;</span>]</span><br><span class="line">  resourceNames: [<span class="string">&quot;kubernetes-dashboard-key-holder&quot;</span>, <span class="string">&quot;kubernetes-dashboard-certs&quot;</span>]</span><br><span class="line">  verbs: [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;update&quot;</span>, <span class="string">&quot;delete&quot;</span>]</span><br><span class="line">  <span class="comment"># Allow Dashboard to get and update &#x27;kubernetes-dashboard-settings&#x27; config map.</span></span><br><span class="line">- apiGroups: [<span class="string">&quot;&quot;</span>]</span><br><span class="line">  resources: [<span class="string">&quot;configmaps&quot;</span>]</span><br><span class="line">  resourceNames: [<span class="string">&quot;kubernetes-dashboard-settings&quot;</span>]</span><br><span class="line">  verbs: [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;update&quot;</span>]</span><br><span class="line">  <span class="comment"># Allow Dashboard to get metrics from heapster.</span></span><br><span class="line">- apiGroups: [<span class="string">&quot;&quot;</span>]</span><br><span class="line">  resources: [<span class="string">&quot;services&quot;</span>]</span><br><span class="line">  resourceNames: [<span class="string">&quot;heapster&quot;</span>]</span><br><span class="line">  verbs: [<span class="string">&quot;proxy&quot;</span>]</span><br><span class="line">- apiGroups: [<span class="string">&quot;&quot;</span>]</span><br><span class="line">  resources: [<span class="string">&quot;services/proxy&quot;</span>]</span><br><span class="line">  resourceNames: [<span class="string">&quot;heapster&quot;</span>, <span class="string">&quot;http:heapster:&quot;</span>, <span class="string">&quot;https:heapster:&quot;</span>]</span><br><span class="line">  verbs: [<span class="string">&quot;get&quot;</span>]</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: RoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  name: kubernetes-dashboard-minimal</span><br><span class="line">  namespace: kube-system</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: Role</span><br><span class="line">  name: kubernetes-dashboard-minimal</span><br><span class="line">subjects:</span><br><span class="line">- kind: ServiceAccount</span><br><span class="line">  name: kubernetes-dashboard</span><br><span class="line">  namespace: kube-system</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line"><span class="comment"># ------------------- Dashboard Deployment ------------------- #</span></span><br><span class="line"></span><br><span class="line">kind: Deployment</span><br><span class="line">apiVersion: apps/v1beta2</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: kubernetes-dashboard</span><br><span class="line">  name: kubernetes-dashboard</span><br><span class="line">  namespace: kube-system</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  revisionHistoryLimit: 10</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      k8s-app: kubernetes-dashboard</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        k8s-app: kubernetes-dashboard</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: kubernetes-dashboard</span><br><span class="line">        image: 192.168.17.132/rke/k8s.gcr.io/kubernetes-dashboard-amd64:v1.8.3</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 8443</span><br><span class="line">          protocol: TCP</span><br><span class="line">        args:</span><br><span class="line">          - --auto-generate-certificates</span><br><span class="line">          <span class="comment"># Uncomment the following line to manually specify Kubernetes API server Host</span></span><br><span class="line">          <span class="comment"># If not specified, Dashboard will attempt to auto discover the API server and connect</span></span><br><span class="line">          <span class="comment"># to it. Uncomment only if the default does not work.</span></span><br><span class="line">          <span class="comment"># - --apiserver-host=http://my-address:port</span></span><br><span class="line">        volumeMounts:</span><br><span class="line">        - name: kubernetes-dashboard-certs</span><br><span class="line">          mountPath: /certs</span><br><span class="line">          <span class="comment"># Create on-disk volume to store exec logs</span></span><br><span class="line">        - mountPath: /tmp</span><br><span class="line">          name: tmp-volume</span><br><span class="line">        livenessProbe:</span><br><span class="line">          httpGet:</span><br><span class="line">            scheme: HTTPS</span><br><span class="line">            path: /</span><br><span class="line">            port: 8443</span><br><span class="line">          initialDelaySeconds: 30</span><br><span class="line">          timeoutSeconds: 30</span><br><span class="line">      volumes:</span><br><span class="line">      - name: kubernetes-dashboard-certs</span><br><span class="line">        secret:</span><br><span class="line">          secretName: kubernetes-dashboard-certs</span><br><span class="line">      - name: tmp-volume</span><br><span class="line">        emptyDir: &#123;&#125;</span><br><span class="line">      serviceAccountName: kubernetes-dashboard</span><br><span class="line">      <span class="comment"># Comment the following tolerations if Dashboard must not be deployed on master</span></span><br><span class="line">      tolerations:</span><br><span class="line">      - key: node-role.kubernetes.io/master</span><br><span class="line">        effect: NoSchedule</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line"><span class="comment"># ------------------- Dashboard Service ------------------- #</span></span><br><span class="line"></span><br><span class="line">kind: Service</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: kubernetes-dashboard</span><br><span class="line">  name: kubernetes-dashboard</span><br><span class="line">  namespace: kube-system</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">    - port: 443</span><br><span class="line">      targetPort: 8443</span><br><span class="line">  selector:</span><br><span class="line">    k8s-app: kubernetes-dashboard</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>执行</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f k8s-dashboard.yaml</span><br></pre></td></tr></table></figure>
<p>(2)新建dashboard-usr.yaml文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: admin-user</span><br><span class="line">  namespace: kube-system</span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1beta1</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  name: admin-user</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: cluster-admin</span><br><span class="line">subjects:</span><br><span class="line">- kind: ServiceAccount</span><br><span class="line">  name: admin-user</span><br><span class="line">  namespace: kube-system</span><br></pre></td></tr></table></figure>
<p>执行</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f dashboard-usr.yml</span><br></pre></td></tr></table></figure>

<p>(3)若对yml修改后,更新部署,则执行下述命令</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f dashboard-usr.yml</span><br></pre></td></tr></table></figure>
<h4 id="访问dashboard"><a href="#访问dashboard" class="headerlink" title="访问dashboard"></a>访问dashboard</h4><h5 id="通过window配置负载"><a href="#通过window配置负载" class="headerlink" title="通过window配置负载"></a>通过window配置负载</h5><p>(1)安装kubectl</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -LO https://storage.googleapis.com/kubernetes-release/release/v1.7.0/bin/windows/amd64/kubectl.exe</span><br></pre></td></tr></table></figure>
<p>(2) 拷贝集群kube_config_cluster.ym文件到本地config.yml在cmd执行以下命令</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl --kubeconfig=C:\Users\Administrator\Desktop\config.yml proxy</span><br></pre></td></tr></table></figure>
<p>(3)web访问</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://localhost:8001/api/v1/namespaces/kube-system/services/https:kubernetes-dashboard:/proxy/</span><br></pre></td></tr></table></figure>
<p>(4) 生成web访问的token</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n kube-system describe secret $(kubectl -n kube-system get secret |</span><br><span class="line">grep admin-user | awk <span class="string">&#x27;&#123;print $1&#125;&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h5 id="通过configMap配置负载"><a href="#通过configMap配置负载" class="headerlink" title="通过configMap配置负载"></a>通过configMap配置负载</h5><p>(1)编辑configmap文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl edit configmap tcp-services -n ingress-nginx</span><br></pre></td></tr></table></figure>
<p>添加以下两行</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">data:</span><br><span class="line"> <span class="string">&quot;9090&quot;</span>: kube-system/kubernetes-dashboard:443</span><br></pre></td></tr></table></figure>
<p><img src="/img/media/1293af02ca6f3ef0dd976695501592a9.png"><br>(2)生成token</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n kube-system describe secret $(kubectl -n kube-system get secret | grep admin-user | awk <span class="string">&#x27;&#123;print $1&#125;&#x27;</span>)</span><br></pre></td></tr></table></figure>
<p>(3)第一次部署报错的情况下,删除token</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl --kubeconfig ../kube_config_cluster.yml delete secret kubernetes-dashboard-key-holder -n kube-system</span><br></pre></td></tr></table></figure>
<p>访问dashboard地址：<a target="_blank" rel="noopener" href="https://192.168.17.131:9090/">https://192.168.17.131:9090</a></p>
<h3 id="部署k8s-dashboard页面图形化数据"><a href="#部署k8s-dashboard页面图形化数据" class="headerlink" title="部署k8s dashboard页面图形化数据"></a>部署k8s dashboard页面图形化数据</h3><p>上传heapster-grafana.yaml heapster.yaml influxdb.yaml文件，创建<br>(1)创建heapster-grafana.yaml文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: monitoring-grafana</span><br><span class="line">  namespace: kube-system</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      task: monitoring</span><br><span class="line">      k8s-app: grafana</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        task: monitoring</span><br><span class="line">        k8s-app: grafana</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: grafana</span><br><span class="line">        image: 192.168.17.132/rke/heapster-grafana:v4.3.3</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 3000</span><br><span class="line">          protocol: TCP</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - mountPath: /etc/ssl/certs</span><br><span class="line">          name: ca-certificates</span><br><span class="line">          readOnly: <span class="literal">true</span></span><br><span class="line">        - mountPath: /var</span><br><span class="line">          name: grafana-storage</span><br><span class="line">        <span class="built_in">env</span>:</span><br><span class="line">        - name: INFLUXDB_HOST</span><br><span class="line">          value: monitoring-influxdb</span><br><span class="line">        - name: GF_SERVER_HTTP_PORT</span><br><span class="line">          value: <span class="string">&quot;3000&quot;</span></span><br><span class="line">        - name: GF_AUTH_BASIC_ENABLED</span><br><span class="line">          value: <span class="string">&quot;false&quot;</span></span><br><span class="line">        - name: GF_AUTH_ANONYMOUS_ENABLED</span><br><span class="line">          value: <span class="string">&quot;true&quot;</span></span><br><span class="line">        - name: GF_AUTH_ANONYMOUS_ORG_ROLE</span><br><span class="line">          value: Admin</span><br><span class="line">        - name: GF_SERVER_ROOT_URL</span><br><span class="line">          value: /</span><br><span class="line">      volumes:</span><br><span class="line">      - name: ca-certificates</span><br><span class="line">        hostPath:</span><br><span class="line">          path: /etc/ssl/certs</span><br><span class="line">      - name: grafana-storage</span><br><span class="line">        emptyDir: &#123;&#125;</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    kubernetes.io/cluster-service: <span class="string">&#x27;true&#x27;</span></span><br><span class="line">    kubernetes.io/name: monitoring-grafana</span><br><span class="line">  name: monitoring-grafana</span><br><span class="line">  namespace: kube-system</span><br><span class="line">spec:</span><br><span class="line">  <span class="built_in">type</span>: NodePort</span><br><span class="line">  ports:</span><br><span class="line">  - nodePort: 30108</span><br><span class="line">    port: 80</span><br><span class="line">    targetPort: 3000</span><br><span class="line">  selector:</span><br><span class="line">    k8s-app: grafana</span><br></pre></td></tr></table></figure>
<p>(2)创建heapster.yaml文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: heapster</span><br><span class="line">  namespace: kube-system</span><br><span class="line">---</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: heapster</span><br><span class="line">  namespace: kube-system</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      task: monitoring</span><br><span class="line">      k8s-app: heapster</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        task: monitoring</span><br><span class="line">        k8s-app: heapster</span><br><span class="line">    spec:</span><br><span class="line">      serviceAccountName: heapster</span><br><span class="line">      containers:</span><br><span class="line">      - name: heapster</span><br><span class="line">        image: 192.168.17.132/rke/heapster:v1.4.0</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        <span class="built_in">command</span>:</span><br><span class="line">        - /heapster</span><br><span class="line">        <span class="comment"># - --source=kubernetes:https://$KUBERNETES_SERVICE_HOST:443?inClusterConfig=true&amp;useServiceAccount=true</span></span><br><span class="line">        - --<span class="built_in">source</span>=kubernetes:kubernetes:https://kubernetes.default?useServiceAccount=<span class="literal">true</span>&amp;kubeletHttps=<span class="literal">true</span>&amp;kubeletPort=10250&amp;insecure=<span class="literal">true</span></span><br><span class="line">        - --sink=influxdb:http://monitoring-influxdb.kube-system.svc.cluster.local:8086?retention=0s</span><br><span class="line">        - --v=2   </span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    task: monitoring</span><br><span class="line">    kubernetes.io/cluster-service: <span class="string">&#x27;true&#x27;</span></span><br><span class="line">    kubernetes.io/name: Heapster</span><br><span class="line">  name: heapster</span><br><span class="line">  namespace: kube-system</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">  - port: 80</span><br><span class="line">    targetPort: 8082</span><br><span class="line">  selector:</span><br><span class="line">    k8s-app: heapster</span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1beta1</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  name: heapster</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: cluster-admin</span><br><span class="line">subjects:</span><br><span class="line">- kind: ServiceAccount</span><br><span class="line">  name: heapster</span><br><span class="line">  namespace: kube-system</span><br></pre></td></tr></table></figure>
<p>(3)创建influxdb.yaml文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: monitoring-influxdb</span><br><span class="line">  namespace: kube-system</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      task: monitoring</span><br><span class="line">      k8s-app: influxdb</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        task: monitoring</span><br><span class="line">        k8s-app: influxdb</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: influxdb</span><br><span class="line">        image: 192.168.17.132/rke/heapster-influxdb:v1.3.3</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - mountPath: /data</span><br><span class="line">          name: influxdb-storage</span><br><span class="line">      volumes:</span><br><span class="line">      - name: influxdb-storage</span><br><span class="line">        emptyDir: &#123;&#125;</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    task: monitoring</span><br><span class="line">    kubernetes.io/cluster-service: <span class="string">&#x27;true&#x27;</span></span><br><span class="line">    kubernetes.io/name: monitoring-influxdb</span><br><span class="line">  name: monitoring-influxdb</span><br><span class="line">  namespace: kube-system</span><br><span class="line">spec:</span><br><span class="line">  <span class="built_in">type</span>: NodePort</span><br><span class="line">  ports:</span><br><span class="line">  - nodePort: 31001</span><br><span class="line">    port: 8086</span><br><span class="line">    targetPort: 8086</span><br><span class="line">  selector:</span><br><span class="line">    k8s-app: influxdb</span><br></pre></td></tr></table></figure>
<p>(4)创建各个pod</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f heapster-grafana.yaml</span><br><span class="line">kubectl create -f heapster.yaml</span><br><span class="line">kubectl create -f influxdb.yaml</span><br></pre></td></tr></table></figure>
<p><img src="/img/media/1434c61c6ef7c7313990f66bcca7db40.png"></p>
<p><strong>–source</strong>: 指定连接的集群。<br>inClusterConfig:Use kube config in service accounts associated with Heapster’s namespace.(default: true)<br>kubeletPort: 指定kubelet的使用端口，默认10255<br>kubeletHttps: 是否使用https去连接kubelets(默认：false)<br>apiVersion: 指定K8S的apiversion<br>insecure: 是否使用安全证书(默认：false)<br>auth: 安全认证<br>useServiceAccount: 是否使用K8S的安全令牌</p>
<p><strong>–sink</strong>: 指定后端数据存储。这里指定influxdb数据库。<br>后缀参数：<br>user: InfluxDB用户<br>pw: InfluxDB密码<br>db: 数据库名<br>secure: 安全连接到InfluxDB(默认：false)<br>withfields： 使用InfluxDB fields(默认：false)。</p>
<h1 id="第二章-自动化构建部署流程搭建"><a href="#第二章-自动化构建部署流程搭建" class="headerlink" title="第二章 自动化构建部署流程搭建"></a>第二章 自动化构建部署流程搭建</h1><h2 id="部署jenkins-master"><a href="#部署jenkins-master" class="headerlink" title="部署jenkins-master"></a>部署jenkins-master</h2><p>(1)下载镜像jenkins-master<br>链接: <a target="_blank" rel="noopener" href="https://pan.baidu.com/s/1lhllaOIsvDXJoiFMPx47Qw">https://pan.baidu.com/s/1lhllaOIsvDXJoiFMPx47Qw</a> 提取码: z24p<br>或者<br>链接: <a target="_blank" rel="noopener" href="https://pan.baidu.com/s/1hROj7nt_iw0Vf1tQTShfYA">https://pan.baidu.com/s/1hROj7nt_iw0Vf1tQTShfYA</a> 提取码: iieu</p>
<p>(2)在192.168.17.131 上建目录</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> /jenkins-data</span><br></pre></td></tr></table></figure>
<p>(3)赋予权限</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">chown</span> -R 1000:1000 /jenkins-data</span><br></pre></td></tr></table></figure>
<p>(4)创建jenkins-k8s-resources.yml文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: apps/v1beta1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: jenkins-wdj</span><br><span class="line">  namespace: jenkins</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: jenkins-wdj</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      k8s-app: jenkins-wdj</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        k8s-app: jenkins-wdj</span><br><span class="line">    spec:</span><br><span class="line">      nodeSelector:</span><br><span class="line">        kubernetes.io/hostname: 192.168.17.131</span><br><span class="line">      containers:</span><br><span class="line">      - name: jenkins-wdj</span><br><span class="line">        image: 192.168.17.132/rke/jenkinsci-blueocean:v1.0</span><br><span class="line">        <span class="built_in">env</span>:</span><br><span class="line">        - name: TZ</span><br><span class="line">          value: Asia/Shanghai</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - name: jenkins-home-test</span><br><span class="line">          mountPath: /var/jenkins_home</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 8080</span><br><span class="line">          name: web</span><br><span class="line">        - containerPort: 50000</span><br><span class="line">          name: agent</span><br><span class="line">      volumes:</span><br><span class="line">        - name: jenkins-home-test</span><br><span class="line">          hostPath:</span><br><span class="line">            path: /jenkins-data</span><br><span class="line">            <span class="built_in">type</span>: DirectoryOrCreate</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line"></span><br><span class="line">kind: Service</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: jenkins-wdj</span><br><span class="line">  name: jenkins-wdj</span><br><span class="line">  namespace: jenkins</span><br><span class="line">spec:</span><br><span class="line">  <span class="built_in">type</span>: NodePort</span><br><span class="line">  ports:</span><br><span class="line">    - port: 8080</span><br><span class="line">      name: web</span><br><span class="line">      targetPort: 8080</span><br><span class="line">      nodePort: 31666</span><br><span class="line">    - port: 50000</span><br><span class="line">      name: agent</span><br><span class="line">      targetPort: 50000</span><br><span class="line">  selector:</span><br><span class="line">    k8s-app: jenkins-wdj</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line"></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: jenkins-wdj</span><br><span class="line">  namespace: jenkins</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line"></span><br><span class="line">kind: Role</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1beta1</span><br><span class="line">metadata:</span><br><span class="line">  name: jenkins-wdj</span><br><span class="line">  namespace: jenkins</span><br><span class="line">rules:</span><br><span class="line">  - apiGroups: [<span class="string">&quot;&quot;</span>]</span><br><span class="line">    resources: [<span class="string">&quot;pods&quot;</span>]</span><br><span class="line">    verbs: [<span class="string">&quot;create&quot;</span>,<span class="string">&quot;delete&quot;</span>,<span class="string">&quot;get&quot;</span>,<span class="string">&quot;list&quot;</span>,<span class="string">&quot;patch&quot;</span>,<span class="string">&quot;update&quot;</span>,<span class="string">&quot;watch&quot;</span>]</span><br><span class="line">  - apiGroups: [<span class="string">&quot;&quot;</span>]</span><br><span class="line">    resources: [<span class="string">&quot;pods/exec&quot;</span>]</span><br><span class="line">    verbs: [<span class="string">&quot;create&quot;</span>,<span class="string">&quot;delete&quot;</span>,<span class="string">&quot;get&quot;</span>,<span class="string">&quot;list&quot;</span>,<span class="string">&quot;patch&quot;</span>,<span class="string">&quot;update&quot;</span>,<span class="string">&quot;watch&quot;</span>]</span><br><span class="line">  - apiGroups: [<span class="string">&quot;&quot;</span>]</span><br><span class="line">    resources: [<span class="string">&quot;pods/log&quot;</span>]</span><br><span class="line">    verbs: [<span class="string">&quot;get&quot;</span>,<span class="string">&quot;list&quot;</span>,<span class="string">&quot;watch&quot;</span>]</span><br><span class="line">  - apiGroups: [<span class="string">&quot;&quot;</span>]</span><br><span class="line">    resources: [<span class="string">&quot;secrets&quot;</span>]</span><br><span class="line">    verbs: [<span class="string">&quot;get&quot;</span>]</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line"></span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1beta1</span><br><span class="line">kind: RoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  name: jenkins-wdj</span><br><span class="line">  namespace: jenkins</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: Role</span><br><span class="line">  name: jenkins-wdj</span><br><span class="line">subjects:</span><br><span class="line">  - kind: ServiceAccount</span><br><span class="line">    name: jenkins-wdj</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>(5)启动Jenkins-master</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f jenkins-k8s-resources.yml</span><br></pre></td></tr></table></figure>
<p><img src="/img/media/e05b9c2c2f007f073a4bcec3ea4c8102.png"></p>
<p>(6)在jenkins中安装kubernetes插件</p>
<p><img src="/img/media/1e6ce77d99611829f81f9af3dee914ba.png"></p>
<h2 id="部署jenkins-slave"><a href="#部署jenkins-slave" class="headerlink" title="部署jenkins-slave"></a>部署jenkins-slave</h2><h3 id="构建jenkins-slave基础镜像"><a href="#构建jenkins-slave基础镜像" class="headerlink" title="构建jenkins-slave基础镜像"></a>构建jenkins-slave基础镜像</h3><p>基于<code>openshift/jenkins-slave-base-centos7:latest</code>所构建的包含了maven, nodejs,helm, go, beego等常用构建工具<br>(1)下载jenkins-slave-base-centos7:latest镜像</p>
<p>下载链接: <a target="_blank" rel="noopener" href="https://pan.baidu.com/s/1Wvs1pRotGWqTT_6BLoRrTg">https://pan.baidu.com/s/1Wvs1pRotGWqTT_6BLoRrTg</a> 提取码: xvde</p>
<p>(2)编辑Dockerfile文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line">FROM openshift/jenkins-slave-base-centos7:latest</span><br><span class="line"></span><br><span class="line">LABEL maintainer=caiy17@chinaunicom.cn</span><br><span class="line">LABEL Description=<span class="string">&quot;基于`openshift/jenkins-slave-base-centos7:latest`所构建的包含了maven, nodejs, helm, go, beego等常用构建工具&quot;</span></span><br><span class="line">ENV TZ Asia/Shanghai</span><br><span class="line"></span><br><span class="line"><span class="comment">###############################################################################</span></span><br><span class="line"><span class="comment"># 生成ssh密钥</span></span><br><span class="line"><span class="comment">###############################################################################</span></span><br><span class="line">USER root</span><br><span class="line"></span><br><span class="line">RUN ssh-keygen -f /root/.ssh/id_rsa</span><br><span class="line"></span><br><span class="line"><span class="comment">###############################################################################</span></span><br><span class="line"><span class="comment"># 设置yum源 安装常用工具</span></span><br><span class="line"><span class="comment">###############################################################################</span></span><br><span class="line"><span class="comment"># RUN curl -o /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-7.repo \</span></span><br><span class="line">    <span class="comment"># &amp;&amp; yum makecache \</span></span><br><span class="line">RUN yum install -y vim telnet net-tools wget unzip</span><br><span class="line"></span><br><span class="line"><span class="comment">###############################################################################</span></span><br><span class="line"><span class="comment"># 安装JDK</span></span><br><span class="line"><span class="comment">###############################################################################</span></span><br><span class="line">ADD packages/jdk-8u181-linux-x64.tar.gz /usr/java</span><br><span class="line"></span><br><span class="line">ENV JAVA_HOME /usr/java/jdk1.8.0_181</span><br><span class="line">ENV PATH <span class="variable">$JAVA_HOME</span>/bin:<span class="variable">$PATH</span></span><br><span class="line"></span><br><span class="line">RUN <span class="built_in">chown</span> root:root /usr/java/jdk1.8.0_181 -R \</span><br><span class="line">    &amp;&amp; <span class="built_in">chmod</span> 755 /usr/java/jdk1.8.0_181 -R</span><br><span class="line"></span><br><span class="line"><span class="comment">###############################################################################</span></span><br><span class="line"><span class="comment"># 安装maven</span></span><br><span class="line"><span class="comment">###############################################################################</span></span><br><span class="line">ADD packages/apache-maven-3.6.0-bin.tar.gz /opt</span><br><span class="line"></span><br><span class="line">RUN <span class="built_in">chown</span> root:root /opt/apache-maven-3.6.0 -R \</span><br><span class="line">    &amp;&amp; <span class="built_in">chmod</span> 755 /opt/apache-maven-3.6.0 -R \</span><br><span class="line">    &amp;&amp; <span class="built_in">ln</span> -s /opt/apache-maven-3.6.0/ /opt/maven</span><br><span class="line"></span><br><span class="line">ENV M2_HOME /opt/maven</span><br><span class="line">ENV PATH <span class="variable">$M2_HOME</span>/bin:<span class="variable">$PATH</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置maven镜像源</span></span><br><span class="line">RUN sed -i <span class="string">&#x27;N;146 a \ \ \ \ &lt;mirror&gt;\n\ \ \ \ \ \ &lt;id&gt;self-maven&lt;/id&gt;\n\ \ \ \ \ \ &lt;mirrorOf&gt;self-maven&lt;/mirrorOf&gt;\n\ \ \ \ \ \ &lt;name&gt;self-maven&lt;/name&gt;\n\ \ \ \ \ \ &lt;url&gt;http://10.236.5.18:8088/repository/maven-public/&lt;/url&gt;\n\ \ \ \ &lt;/mirror&gt;&#x27;</span> /opt/maven/conf/settings.xml</span><br><span class="line"></span><br><span class="line"><span class="comment">###############################################################################</span></span><br><span class="line"><span class="comment"># 安装nodejs</span></span><br><span class="line"><span class="comment">###############################################################################</span></span><br><span class="line">ADD packages/node-v10.15.3-linux-x64.tar.xz /opt</span><br><span class="line"></span><br><span class="line">RUN <span class="built_in">chown</span> root:root /opt/node-v10.15.3-linux-x64 -R \</span><br><span class="line">    &amp;&amp; <span class="built_in">chmod</span> 755 /opt/node-v10.15.3-linux-x64 -R \</span><br><span class="line">    &amp;&amp; <span class="built_in">ln</span> -s /opt/node-v10.15.3-linux-x64/ /opt/node</span><br><span class="line"></span><br><span class="line">ENV NODE_HOME /opt/node</span><br><span class="line">ENV PATH <span class="variable">$PATH</span>:<span class="variable">$NODE_HOME</span>/bin</span><br><span class="line"></span><br><span class="line"><span class="comment">###############################################################################</span></span><br><span class="line"><span class="comment"># 安装helm</span></span><br><span class="line"><span class="comment">###############################################################################</span></span><br><span class="line">ADD packages/helm-v2.8.2-linux-amd64.tar.gz /opt/helm</span><br><span class="line"></span><br><span class="line">ENV HELM_HOME /opt/helm</span><br><span class="line">ENV PATH <span class="variable">$PATH</span>:<span class="variable">$HELM_HOME</span>/linux-amd64</span><br><span class="line"></span><br><span class="line"><span class="comment">###############################################################################</span></span><br><span class="line"><span class="comment"># 安装go</span></span><br><span class="line"><span class="comment">###############################################################################</span></span><br><span class="line">ADD packages/go1.12.3.linux-amd64.tar.gz /opt</span><br><span class="line"></span><br><span class="line">ENV GOROOT /opt/go</span><br><span class="line">ENV GOPATH /root/go</span><br><span class="line">ENV PATH <span class="variable">$PATH</span>:<span class="variable">$GOROOT</span>/bin:<span class="variable">$GOPATH</span>/bin</span><br><span class="line"></span><br><span class="line"><span class="comment">###############################################################################</span></span><br><span class="line"><span class="comment"># 安装beego</span></span><br><span class="line"><span class="comment">###############################################################################</span></span><br><span class="line">ADD packages/bee.tar.gz /root/go/bin</span><br></pre></td></tr></table></figure>

<p>(2)执行构建命令</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker build -t jenkins-slave:2019-09-11-v1 .</span><br></pre></td></tr></table></figure>
<p>注意最后有个点，代表使用当前路径的 Dockerfile 进行构建</p>
<p>生成的镜像下载链接: <a target="_blank" rel="noopener" href="https://pan.baidu.com/s/1Wvs1pRotGWqTT_6BLoRrTg">https://pan.baidu.com/s/1Wvs1pRotGWqTT_6BLoRrTg</a> 提取码: xvde</p>
<h3 id="生成连接k8s集群的客户端证书"><a href="#生成连接k8s集群的客户端证书" class="headerlink" title="生成连接k8s集群的客户端证书"></a>生成连接k8s集群的客户端证书</h3><p>1)生成连接api-server的服务证书 key并进行连接测试</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> kube_config_cluster.yml</span><br></pre></td></tr></table></figure>
<p><img src="/img/media/7cdbc99f4aabdeeb2b4d76d63b4a709a.png"></p>
<p>分别执行</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> certificate-authority-data | <span class="built_in">base64</span> -d &gt; ca.crt</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> client-certificate-data | <span class="built_in">base64</span> -d &gt; client.crt</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> client-key-data | <span class="built_in">base64</span> -d &gt; client.key</span><br></pre></td></tr></table></figure>
<p>然后根据如上内容生成客户端认证的证书cert.pfx</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl pkcs12 -<span class="built_in">export</span> -out cert.pfx -inkey client.key -<span class="keyword">in</span> client.crt -certfile ca.crt</span><br></pre></td></tr></table></figure>

<p><img src="/../img/media/a4afa358f3dd6f143410e70580334c45.png"></p>
<p><img src="/img/media/0d767f68d6ef4478501ec6bef946f652.png"></p>
<p><img src="/img/media/b09555ce03c767497f266bef65d9c515.png"></p>
<p><img src="/img/media/2e7d6352366c4cb1fee855ae558513c9.png"></p>
<p><img src="/img/media/9e76aa863c034baebebefbad7feb96ed.png"></p>
<p><img src="/img/media/9e99239598a34fb95e3d2f5ddf5ff3e4.png"></p>
<p>参考<a target="_blank" rel="noopener" href="http://www.mamicode.com/info-detail-2399348.html">http://www.mamicode.com/info-detail-2399348.html</a></p>
<h3 id="配置jenkins-master（参考）"><a href="#配置jenkins-master（参考）" class="headerlink" title="配置jenkins-master（参考）"></a>配置jenkins-master（参考）</h3><p>打开 jenkins UI 界面依次点击<br>系统管理 –&gt; 系统设置 –&gt; 新增一个云（在界面最下方） –&gt; Kubernetes<br>配置如下：</p>
<p><img src="/img/media/62950b413e70f1c3de8dfee1b3a21c9a.jpg"></p>
<p><img src="/img/media/c9683596df80287a2b436bca17561e4e.jpg"></p>
<p><img src="/img/media/1d767a64016833adbcedb9bda4bbe345.jpg"></p>
<p><img src="/img/media/197688eb8445759061df45b0daafab44.png"></p>
<p>配置完成后点击保存</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">kubectl create serviceaccount jenkins-wdj -n jenkins</span><br><span class="line"></span><br><span class="line">kubectl get serviceaccount --all-namespaces</span><br><span class="line"></span><br><span class="line">kubectl describe serviceaccount/jenkins-wdj -n jenkins</span><br><span class="line"></span><br><span class="line">kubectl get secret -n jenkins</span><br><span class="line"></span><br><span class="line">kubectl get secret jenkin-wdj-token-cm449 -o yaml -n jenkins</span><br><span class="line"></span><br><span class="line">kubectl get secret jenkins-wdj-token-ld6dc -n jenkins -o jsonpath=&#123;<span class="string">&quot;.data.token&quot;</span>&#125; | <span class="built_in">base64</span> -d</span><br><span class="line"></span><br><span class="line">kubectl delete serviceaccount/jenkins-xy -n jenkins</span><br><span class="line"></span><br><span class="line">kubectl get sa jenkins-wdj -n jenkins -o yaml</span><br><span class="line"></span><br><span class="line">kubectl get secret jenkins-wdj-token-cm449 -n jenkins -o jsonpath=&#123;<span class="string">&quot;.data.token&quot;</span>&#125; | <span class="built_in">base64</span> -d</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://www.iteye.com/blog/m635674608-2361440">https://www.iteye.com/blog/m635674608-2361440</a></p>
<h3 id="配置jenkins-master（选用）"><a href="#配置jenkins-master（选用）" class="headerlink" title="配置jenkins-master（选用）"></a>配置jenkins-master（选用）</h3><p>（1）新建启动集群时生成的kube_config_cluster.yml文件；</p>
<p>（2）系统管理-》插件管理-》可选插件-》搜索kubernetes插件-》直接安装；</p>
<p><img src="/img/media/7ef920dbf0e418ff57083c2471a19ed0.png"></p>
<p>（3）系统管理-》系统设置-》新增一个云，配置如下：</p>
<p><img src="/img/media/8ae2dee46a519230ca7ca7a7b71914e4.png"></p>
<h2 id="新建pipeline流水线任务"><a href="#新建pipeline流水线任务" class="headerlink" title="新建pipeline流水线任务"></a>新建pipeline流水线任务</h2><h3 id="demo1"><a href="#demo1" class="headerlink" title="demo1"></a>demo1</h3><p>(1)新建一个测试pipeline任务demo;</p>
<p>(2) 脚本</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">def name = <span class="string">&quot;ci-demo-backend&quot;</span></span><br><span class="line">def label = <span class="string">&quot;<span class="variable">$&#123;name&#125;</span>-<span class="variable">$&#123;UUID.randomUUID().toString()&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line">podTemplate(</span><br><span class="line">    label: label,</span><br><span class="line">    namespace: <span class="string">&#x27;jenkins&#x27;</span>,</span><br><span class="line">    cloud: <span class="string">&#x27;kubernetes&#x27;</span>,</span><br><span class="line">    containers: [</span><br><span class="line">           containerTemplate(name: <span class="string">&#x27;jnlp&#x27;</span>, image: <span class="string">&#x27;192.168.17.132/rke/cicd/jenkins-slaver-dind:v1.1.5&#x27;</span>)</span><br><span class="line">    ],</span><br><span class="line">    volumes: [</span><br><span class="line">            hostPathVolume(hostPath: <span class="string">&#x27;/var/run/docker.sock&#x27;</span>, mountPath: <span class="string">&#x27;/var/run/docker.sock&#x27;</span>)</span><br><span class="line">    ]</span><br><span class="line">) &#123;</span><br><span class="line">    node(label) &#123;</span><br><span class="line">          stage(<span class="string">&#x27;test&#x27;</span>) &#123;</span><br><span class="line">            <span class="built_in">echo</span> <span class="string">&quot;hello, world&quot;</span></span><br><span class="line">            <span class="built_in">sleep</span> 60</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="demo2"><a href="#demo2" class="headerlink" title="demo2"></a>demo2</h3><p>（1）K8s集群中设置harbor仓库认证（参考）</p>
<ol>
<li>使用<em>kubectl</em>命令生成<em>secret(<em>不同的</em>namespace</em>要分别生成<em>secret</em>，不共用*)*<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">kubectl create secret docker-registry harborsecret \</span><br><span class="line"></span><br><span class="line">  --docker-server=192.168.17.132 \</span><br><span class="line"></span><br><span class="line">  --docker-username=admin \</span><br><span class="line"></span><br><span class="line">  --docker-password=Harbor12345 \</span><br><span class="line"></span><br><span class="line">  --docker-email=admin@example.com \</span><br><span class="line"></span><br><span class="line">  --namespace=jenkins</span><br></pre></td></tr></table></figure></li>
<li>查看此secret的配置内容</li>
</ol>
<p>kubectl get secret harborsecret –output&#x3D;yaml -n jenkins</p>
<p><img src="/img/media/fb414ba80ffd2bce475ba27026404085.png"></p>
<p>（2）添加gitlab和harbor仓库的认证(选用)</p>
<p><img src="/img/media/500fb33a91e2a2aefd78f86dca50ce00.png"></p>
<p><img src="/img/media/225e279397e7793d1b03d77171f28b6e.png"></p>
<p><img src="/img/media/043fee371dc8d536a42c492084f44f97.png"></p>
<p><img src="/img/media/db2a9491fd4d8e2a839bbda5fc03002e.png"></p>
<p>（2）下载Git Parameter插件</p>
<p>（3）设置参数化构建过程</p>
<p><img src="/img/media/d40dadb53959c6f3c2fb1c9041ebfa22.png"></p>
<h3 id="demo3"><a href="#demo3" class="headerlink" title="demo3"></a>demo3</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">def label = <span class="string">&quot;ci-ms-cloud-tenant-service-<span class="variable">$&#123;UUID.randomUUID().toString()&#125;</span>&quot;</span></span><br><span class="line">def deployNamespace = <span class="string">&quot;cloud&quot;</span></span><br><span class="line">def deploymentName = <span class="string">&quot;ms-cloud-tenant-service&quot;</span></span><br><span class="line"></span><br><span class="line">podTemplate(</span><br><span class="line">    label: label,</span><br><span class="line">    cloud: <span class="string">&#x27;kubernetes&#x27;</span>,</span><br><span class="line">    namespace: <span class="string">&#x27;jenkins&#x27;</span>,</span><br><span class="line">    containers: [</span><br><span class="line">        containerTemplate(name: <span class="string">&#x27;jnlp&#x27;</span>, image: <span class="string">&#x27;192.168.17.132/rke/cicd/jenkins-slaver-dind:v1.1.5&#x27;</span>, envVars: [envVar(key: <span class="string">&#x27;LANG&#x27;</span>, value: <span class="string">&#x27;en_US.UTF-8&#x27;</span>)],)</span><br><span class="line">    ],</span><br><span class="line">    volumes: [</span><br><span class="line">        configMapVolume(configMapName: <span class="string">&#x27;configmap-maven-setting-wdj&#x27;</span>, mountPath: <span class="string">&#x27;/home/jenkins/maven&#x27;</span>),</span><br><span class="line">        configMapVolume(configMapName: <span class="string">&#x27;configmap-kubeconfig-dev&#x27;</span>, mountPath: <span class="string">&#x27;/home/jenkins/kube&#x27;</span>),</span><br><span class="line">        hostPathVolume(hostPath: <span class="string">&#x27;/var/run/docker.sock&#x27;</span>, mountPath: <span class="string">&#x27;/var/run/docker.sock&#x27;</span>)</span><br><span class="line">    ]</span><br><span class="line">) &#123;</span><br><span class="line">    node(label) &#123;</span><br><span class="line">        stage(<span class="string">&#x27;拉取代码&#x27;</span>) &#123;</span><br><span class="line">			git credentialsId: <span class="string">&#x27;ab716d57-9399-4978-bfb4-82eaccaea9d2&#x27;</span>, url: <span class="string">&#x27;http://192.168.17.132:8080/cloud/ms-cloud-tenant-service.git&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line">        stage(<span class="string">&#x27;打jar包&#x27;</span>) &#123;</span><br><span class="line">            sh <span class="string">&#x27;mvn clean package -U -Dmaven.test.skip=true --settings /home/jenkins/maven/settings.xml&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line">        def dockerTag=new Date().format(<span class="string">&quot;yyyyMMddHHmmss&quot;</span>)</span><br><span class="line">        def dockerImageName = <span class="string">&quot;192.168.17.132/devops/ms-cloud-tenant-service:v<span class="variable">$&#123;dockerTag&#125;</span>&quot;</span></span><br><span class="line">        stage(<span class="string">&#x27;构建docker镜像&#x27;</span>) &#123;</span><br><span class="line">            <span class="built_in">pwd</span>()</span><br><span class="line">            sh <span class="string">&quot;docker build -f docker/Dockerfile --tag=\&quot;<span class="variable">$&#123;dockerImageName&#125;</span>\&quot; .&quot;</span></span><br><span class="line">            <span class="built_in">echo</span> <span class="string">&quot;===&gt; finish build docker image: <span class="variable">$&#123;dockerImageName&#125;</span>&quot;</span></span><br><span class="line">            sh <span class="string">&#x27;docker images&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line">		 stage(<span class="string">&#x27;发布docker镜像&#x27;</span>) &#123;</span><br><span class="line">            withDockerRegistry(credentialsId: <span class="string">&#x27;1049ee9b-99fd-42df-8c40-a818fe66ae5a&#x27;</span>, url: <span class="string">&#x27;http://192.168.17.132/&#x27;</span>)&#123;</span><br><span class="line">            sh <span class="string">&quot;docker push <span class="variable">$&#123;dockerImageName&#125;</span>&quot;</span></span><br><span class="line">			sh <span class="string">&quot;docker rmi <span class="variable">$&#123;dockerImageName&#125;</span>&quot;</span></span><br><span class="line">			sh <span class="string">&#x27;docker images&#x27;</span></span><br><span class="line">            &#125;</span><br><span class="line">         &#125;</span><br><span class="line">         stage(<span class="string">&#x27;部署&#x27;</span>) &#123;</span><br><span class="line">                sh <span class="string">&quot;kubectl --kubeconfig=/home/jenkins/kube/config -n <span class="variable">$&#123;deployNamespace&#125;</span> patch deployment <span class="variable">$&#123;deploymentName&#125;</span> -p &#x27;&#123;\&quot;spec\&quot;: &#123;\&quot;template\&quot;: &#123;\&quot;spec\&quot;: &#123;\&quot;containers\&quot;: [&#123;\&quot;name\&quot;:\&quot;<span class="variable">$&#123;deploymentName&#125;</span>\&quot;, \&quot;image\&quot;:\&quot;<span class="variable">$&#123;dockerImageName&#125;</span>\&quot;&#125;]&#125;&#125;&#125;&#125;&#x27;&quot;</span></span><br><span class="line">                <span class="built_in">echo</span> <span class="string">&quot;==&gt; deploy <span class="variable">$&#123;dockerImageName&#125;</span> successfully&quot;</span></span><br><span class="line">		&#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/img/media/20191209141314.png"></p>
<p>参考文档<br><a target="_blank" rel="noopener" href="https://www.cnblogs.com/miaocunf/p/11694943.html">https://www.cnblogs.com/miaocunf/p/11694943.html</a></p>
<h2 id="jenkins-job迁移"><a href="#jenkins-job迁移" class="headerlink" title="jenkins job迁移"></a>jenkins job迁移</h2><h3 id="Job-Import-Plugin导入"><a href="#Job-Import-Plugin导入" class="headerlink" title="Job Import Plugin导入"></a>Job Import Plugin导入</h3><p>（<a target="_blank" rel="noopener" href="http://10.244.6.41:31000/">http://10.244.6.41:31000</a>到本机192.168.17.131:31666）</p>
<p>(1)首先到新的Jenkins上,在插件管理里先安装下Job Import Plugin，如下所示：</p>
<p><img src="/img/media/aab9692c2a76b52d229ea872a3c61147.png"></p>
<p>(2)安装完后进入“Manage Jenkins” -&gt; “Configure System”下，找到Job Import Pluguin配置的地方，进行如下设置：</p>
<p><img src="/img/media/1c16a9cb84eeb882667095d48da342c2.png"></p>
<p><strong>name</strong>: 这个可以任意命名，这里我命名成要拷贝的Jenkins的IP<br><strong>Url</strong>: 指要从哪里拷贝的Jenkins的URL,现在我们要从192.168.9.10拷贝job,因此这里要设置成192.168.9.10的Jenkins的URL<br><strong>Credentials</strong>：需要添加一个旧Jenkins的账号（也就是192.168.9.10的账号），没有添加的时候点击Add手动添加下，就可以像上面的截图一样下拉选择到这个账号了</p>
<p>(3)设置完后点击保存下，回到Jenkins首页点击Job Import Plugin就可以进行Job的迁移了，如下所示：</p>
<p><img src="/img/media/0544a6a7fdc230bd7c5228732ca9da9c.png"></p>
<p>在Job Import Plugin界面，下拉选择刚才添加的配置，然后点击Query按钮就可以搜索出配置的Jenkins下的job了，然后选择需要的job进行迁移导入即可：</p>
<p><img src="/img/media/3428ab6cd5708a82ce3dfbf268f49d22.png"></p>
<p>(4)因为有时候旧的Jenkins上的插件新Jenkins上未必有，因此可以根据实际情况勾选是否需要安装必要的插件，如上面的截图所示，需不需要覆盖已有的job也根据实际情况勾选下。导入成功会有如下的提示：</p>
<p><img src="/img/media/5a238913d67f296071e798633eadce92.png"></p>
<p><img src="/img/media/2513baf9e14ebce8deda003dffd93ef6.png"></p>
<p>(5)有了上面的提示后就可以会到新的Jenkins的首页，查看Job有没有成功进入，并进入导入的job查看设置有没有成功的复制过来，如下所示：</p>
<p><img src="/img/media/145dcb37570b1fce1ba8c79f95200166.png"></p>
<p>可以看到job及其设置成功的被导入到新的job了。<br>Job Import Pugin也支持多个job同时拷贝，如果旧的Job里有多个job，如上面的步骤里所示，query出来就有很多job可供选择，只需要勾选多个即可同时进行多个job的导入了。</p>
<h3 id="Jenkins-CLI方式导入"><a href="#Jenkins-CLI方式导入" class="headerlink" title="Jenkins CLI方式导入"></a>Jenkins CLI方式导入</h3><p>有时候在公司内部Jenkins部署到不同的网段里，不同网段间可能会限制无法相互访问，这种情况下通过Job Import Plugin进行job导入的方式就行不通了，这时候可以通过Jenkins CLI方式进行job配置导出，然后新Jenkins在根据导出的配置进行再导入操作，完成job的配置迁移。下面我们来具体讲解下。</p>
<p><img src="/img/media/6ae7851883f04b46abf9359baaf6c723.png"></p>
<p>点击进入Jenkins CLI，可以看到Jenkins命令行接口提供很多命令可以用来进行Jenkins的相关操作，可以看到有提供了get-job这样一个命令，这个命令可以将job的定义导出到xml的格式到输出流，这样我们可以通过这个命令将旧Jenkins上的job导出到外部文件，然后还可以看到有另外一个命令create-job，这个命令可以根据已有的xml配置文件进行job创建，那我们可以根据从旧job导出的job配置文件做为输入进行job的创建了。<br>(1)首先在旧的Jenkins上的cli页面点击jenkins-cli.jar就可以下载这个jar到本地，如下所示：</p>
<p><img src="/img/media/556411a2671efe9d0385e418c2410f6b.jpg"></p>
<p>(2)接着点击下Jenkins右上角的账号，选择Configure，然后点击Show API Token，拷贝token，这个token可以用来进行配置导出的时候做为认证使用</p>
<p><img src="/img/media/2e6bb45fb1507f1c1cf67081efad1e44.jpg"></p>
<p><img src="/img/media/7090eab1c1dde4fdd9a48c3d05695ddb.jpg"></p>
<p>(3)在jenkins-cli.jar下载的根目录下执行如下命令进行job导出，这里我新建了个job，命名为test4，现在执行下如下命令进行test4这个job配置的导出：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">java -jar jenkins-cli.jar -s http://192.168.9.10:8080/jenkins -auth</span><br><span class="line">admin:493375c06bc0006a455005804796c989 get-job <span class="string">&quot;test4&quot;</span> &gt; test4.xml</span><br></pre></td></tr></table></figure>
<p><strong><a target="_blank" rel="noopener" href="http://192.168.9.10:8080/jenkins">http://192.168.9.10:8080/jenkins</a></strong> 就Job的Jenkins地址</p>
<p><strong>admin：</strong> 上面截图获取Show API Token下的User ID</p>
<p><strong>493375c06bc0006a455005804796c989：</strong>上面截图获取API Token的值</p>
<p><strong>test4:</strong> 需要导出配置的job名</p>
<p><strong>test4.xml:</strong> 导出的文件的名称，可任意</p>
<p>根据实际情况替换下上面的四个值即可执行完上面的命令就可以看到test4.xml文件生成了</p>
<p><img src="/img/media/709c821cb6bd5c6559260aa06c7b4242.jpg"></p>
<p>(4)接着在新的Jenkins下同样先下载下jenkins-cli.jar，然后将上面生成的test4.xml拷贝到新的Jenkins机器下，同样获取下新Jenkins登录账号的API Token和User ID，执行下如下命令就可以进行job导入了</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">java -jar jenkins-cli.jar -s http://192.168.9.8:8080/jenkins -auth</span><br><span class="line">admin:51964e7b89a427be5dd2a28f38c86eff create-job <span class="string">&quot;test4&quot;</span> &lt; test4.xml</span><br></pre></td></tr></table></figure>
<p>记得将URL替换成新Jenkins的URL，User ID和token也替换下上面的命令执行完后，就可以看到在新的Jenkins下新job被成功导入了</p>
<p>参考自：<a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1470433">https://cloud.tencent.com/developer/article/1470433</a></p>
<h3 id="Job-批量删除"><a href="#Job-批量删除" class="headerlink" title="Job 批量删除"></a>Job 批量删除</h3><p>点击系统管理-》脚本命令行-》脚本命令行-》输入代码，点击运行</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">def jobName = <span class="string">&quot;devops-ci-ms-cloud-tenant-service&quot;</span></span><br><span class="line"></span><br><span class="line">def maxNumber = 75</span><br><span class="line"></span><br><span class="line">Jenkins.instance.getItemByFullName(jobName).builds.findAll &#123;</span><br><span class="line"></span><br><span class="line">it.number &lt; maxNumber</span><br><span class="line"></span><br><span class="line">&#125;.each &#123;</span><br><span class="line"></span><br><span class="line">it.delete()</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="配置jenkins的credentialsId"><a href="#配置jenkins的credentialsId" class="headerlink" title="配置jenkins的credentialsId"></a>配置jenkins的credentialsId</h2><p>即生产连接gitlab、harbor的credentialsId<br>(1)设置jenkins连接gitlab的git credentialsId</p>
<p><img src="/img/media/4854ea61ae885046243ad09c8bff67a6.png"></p>
<p><img src="/img/media/c861afe09dc7fbd3bb2f5c93306e031d.png"></p>
<p>出错了</p>
<p><img src="/img/media/7aea585ac366e260fa9518c35cde108c.png"></p>
<p>成功的图</p>
<p><img src="/img/media/85899b6fc986ec495ec921e69d91d33f.png"></p>
<p><strong>可能原因分析：</strong><br>这是由于git客户端版本过低造成的！<br>解决方案：<a target="_blank" rel="noopener" href="https://blog.csdn.net/wudinaniya/article/details/97921383">https://blog.csdn.net/wudinaniya/article/details/97921383</a><br>安装了2.16.5<br>(2)生成jenkins连接harbor的credentialsId<br><img src="/img/media/b3a8d91212a69b0a1403987e0aed6535.png"></p>
<h2 id="利用GitLab-webhook来触发Jenkins构建"><a href="#利用GitLab-webhook来触发Jenkins构建" class="headerlink" title="利用GitLab webhook来触发Jenkins构建"></a>利用GitLab webhook来触发Jenkins构建</h2><p>参考自：<a target="_blank" rel="noopener" href="https://www.cnblogs.com/zblade/p/9480366.html">https://www.cnblogs.com/zblade/p/9480366.html</a><br>本文针对如何设置GitLab以及Jenkins，实现每次GitLab上有合并事件的时候，都能触发Jenkins执行相应的操作，主要分为以下几个步骤：</p>
<h3 id="新建GitLab测试项目"><a href="#新建GitLab测试项目" class="headerlink" title="新建GitLab测试项目"></a>新建GitLab测试项目</h3><p>进入个人GitLab账号，在右上角的加号中，选出GitLab 的 New Project，可以新建个人的GitLab工程：</p>
<p><img src="/img/media/52eae3df7ecfb39655766376291d65e5.png"></p>
<p>其余都走默认的设置，填写好project的名字，就可以创建一个新的project，如图：</p>
<p><img src="/img/media/9248135a664f90c740638f7b279af2bf.png"></p>
<h3 id="新建Jenkins的job"><a href="#新建Jenkins的job" class="headerlink" title="新建Jenkins的job"></a>新建Jenkins的job</h3><p>（1）首先验证是否安装了GitLab plugin<br>在“系统管理”-&gt;“插件管理”，查看已安装插件，输入 GitLab，看看是否已经安装，如果没有，则 查看 可选插件，搜索 GitLab，安装后重启即可。<br>（2）新建一个jenkins测试job，如图：<br><img src="/img/media/f2ffa8a27507aa1a00d9fa713620e0d9.png"><br>源码管理选择Git, 输入刚刚新建的GitLab的 URL以及个人的API_TOKEN:<br><img src="/img/media/5712b0baf511e956094247086126a6be.png"><br>目前只有master分支，后续可以根据不同分支对应设置不同的url，监听不同分支的情况。在构建触发器选项中，勾选 Build when a change is pushed to GitLab，该选项最后的URL就是这个工程的URL路径，注意如果是本机，则会显示localhost，可以将localhost改为个人的ip。注意这个url，下一步会用到这个url。点击应用和保存。<br><img src="/img/media/5ea0617e2abe03ac824a35b101bf1d98.png"></p>
<h3 id="设置GitLab的webhook"><a href="#设置GitLab的webhook" class="headerlink" title="设置GitLab的webhook"></a>设置GitLab的webhook</h3><p>在gitlab的当前工程-&gt;settings-&gt;integretions，使用当前工程owner角色的账号制作钩子。将上一步中的url和token填入，选择merge事件。当owner进行合并代码时自动触发jenkins构建操作。</p>
<p><img src="/img/media/7da48258d3e99ddb60f7ce3385d5c197.png"></p>
<p>点击Add webhook后,可能会报Url is blocked: Requests to the local network are not allowed</p>
<p><strong>错误原因：</strong><br>gitlab 10.6版本以后为了安全，不允许向本地网络发送webhook请求</p>
<p><strong>解决方案：</strong><br>最上面一排的扳手设置按钮—&gt;进入左侧 设置—-&gt;网络—-&gt;<br>选择允许webhooks和本机网络交互</p>
<p><img src="/img/media/36d92b54129cacd96532174eb0519f16.png"></p>
<p>点击save changes后，再次回到当前工程-&gt;settings-&gt;integretions中重新制作钩子，然后点击Edit:</p>
<p><img src="/img/media/d9371a678e02a4aa7dfc610c9335255e.png"></p>
<p>点击Test-&gt;Push events:</p>
<p><img src="/img/media/e465e9c52162b6911265497476109cab.png"></p>
<p>查看事件状态,若为200则钩子制作成功：</p>
<p><img src="/img/media/b6735d93d1c7488b5f9b93b07c9aa8f6.png"></p>
<h3 id="可能出现的其它问题"><a href="#可能出现的其它问题" class="headerlink" title="可能出现的其它问题"></a>可能出现的其它问题</h3><p>(1)不允许匿名构建问题</p>
<p><img src="/img/media/63a767833622728b42ceaf9224fe1986.png"></p>
<p><img src="/img/media/3b03c5788c784092b0029c035ca9d38a.png"></p>
<p>出现上述问题，原因就是不支持匿名build，回到jenkins中，在 系统管理-&gt;全局安全管理中，勾选匿名用户具有可读权限 如图：</p>
<p><img src="/img/media/46e81791bb51403d134052310d52c095.png"></p>
<p>然后点击应用和保存， 回到GitLab，继续测试.如果继续报该错，则进入刚刚构建的工程，点击构建触发器中选中的Build When a change is pushed右下角的高级选项，有一个Secret token，点击Generate，会生成一个安全代码：</p>
<p><img src="/img/media/dae770089464cc1ccf9bf21b2fb2731e.png"></p>
<p>复制到webhook中的url下面：</p>
<p><img src="/img/media/a75d1c963de478317735660786d98703.png"></p>
<p>然后保存，再测试，就可以通过，这时候会触发jenkins执行一次操作：</p>
<p><img src="/img/media/53ceea609d5974fbcf927c610cc5ec94.png"></p>
<p>看看控制台输出：</p>
<p><img src="/img/media/67102d5966ac125431c35b1b45f1b412.png"></p>
<p>参考自<a target="_blank" rel="noopener" href="https://www.cnblogs.com/zblade/p/9480366.html">https://www.cnblogs.com/zblade/p/9480366.html</a></p>
<h1 id="附录-遇到的问题"><a href="#附录-遇到的问题" class="headerlink" title="附录 遇到的问题"></a>附录 遇到的问题</h1><p>(1)集群中的每个节点不能直接拉取公有harbor上的镜像</p>
<p><img src="/img/media/c613edf3a6ce5e798063d59bdab3fecc.png"></p>
<p>解决方案：必须把所有的镜像都拉到所有节点的本地？不是的，需要把harbor仓库的rke项目设为公有仓库。</p>
<p>(2)在129机器上运行.&#x2F;rke up 出现下图问题</p>
<p><img src="/img/media/1de96425ac385c4be410dac6195d658a.png"></p>
<p><img src="/img/media/622ae563a5f78b33acfeb48fc0c63d8c.png"></p>
<p>解决方案：129机器没有自己对自己做免密</p>
<p>(3)dashboard页面没有图形化的统计数据</p>
<p><img src="/img/media/1227e87c19081c2d32b2e5b1bf20f178.png"></p>
<p>解决方案：</p>
<p><img src="/img/media/1434c61c6ef7c7313990f66bcca7db40.png"></p>
<p>把–source改为图中红框内的配置。</p>
<p>（4）jenkins-master在192.168.17.131起不来</p>
<p><img src="/img/media/e0a05c505ffc0b7a4d6c3655f4af2e07.png"></p>
<p><img src="/img/media/daa0bf91181639984baaf19bae3eda84.png"></p>
<p><img src="/img/media/6d9f71189ba307805d7d2ac2ab857e42.png"></p>
<p>在131机器上创建目录mkdir &#x2F;jenkins-data 并修改权限chown -R 1000:1000 &#x2F;jenkins-data</p>
<p><img src="/img/media/f28fb9254733602ddf1f3cb3581bb248.png"></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://wangdj104.github.io/2019/09/03/%E9%85%8D%E7%BD%AE%E6%9C%AC%E5%9C%B0yum%E6%BA%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="wangdj">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="wdj's blog">
      <meta itemprop="description" content="记录生活中的点点滴滴">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | wdj's blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2019/09/03/%E9%85%8D%E7%BD%AE%E6%9C%AC%E5%9C%B0yum%E6%BA%90/" class="post-title-link" itemprop="url">配置本地yum源</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">نُشر في</span>
      

      <time title="أُنشأ: 2019-09-03 15:43:05 / عُدل: 22:38:08" itemprop="dateCreated datePublished" datetime="2019-09-03T15:43:05+08:00">2019-09-03</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">في</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E9%9A%8F%E6%89%8B%E7%AC%94%E8%AE%B0/" itemprop="url" rel="index"><span itemprop="name">随手笔记</span></a>
        </span>
          ، 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E9%9A%8F%E6%89%8B%E7%AC%94%E8%AE%B0/%E9%85%8D%E7%BD%AE%E6%9C%AC%E5%9C%B0yum%E6%BA%90/" itemprop="url" rel="index"><span itemprop="name">配置本地yum源</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="本地yum源配置"><a href="#本地yum源配置" class="headerlink" title="本地yum源配置"></a>本地yum源配置</h3><p>下载地址：<a target="_blank" rel="noopener" href="https://pan.baidu.com/s/1Q0wIDlXXQu1-map1iZ_VYg">https://pan.baidu.com/s/1Q0wIDlXXQu1-map1iZ_VYg</a> 提取码: wsvq<br>(1)准备ISO源，挂载CentOS-7-x86_64-Everything-1511.iso，把里面所有文件都拷贝到本地目录&#x2F;develop&#x2F;yum（自己创建）<br>(2)再新建一个目录mkdir -p &#x2F;home&#x2F;mcloud&#x2F;centos-yum<br>(3)将iso文件挂载到新建目录&#x2F;home&#x2F;mcloud&#x2F;centos-yum下（相当于解压iso文件）,挂载成功后如图所示。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mount -o rw CentOS-7-x86_64-Everything-1511.iso /home/mcloud/centos-yum</span><br></pre></td></tr></table></figure>
<p><img src="/img/yum_1.png" alt="image"><br>(4)将挂载到&#x2F;home&#x2F;mcloud&#x2F;centos-yum下的ISO文件解压后的所有文件拷贝到&#x2F;develop&#x2F;yum下。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cp</span> -r /home/mcloud/centos-yum/* /develop/yum</span><br></pre></td></tr></table></figure>
<p>(5)编辑&#x2F;etc&#x2F;yum.repos.d&#x2F;底下repo文件。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[self_packages]</span><br><span class="line">name=self_packages</span><br><span class="line">baseurl=file:///develop/yum</span><br><span class="line">gpgcheck=1</span><br><span class="line">enabled=1</span><br><span class="line">gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-CentOS-7</span><br></pre></td></tr></table></figure>
<p>(6)yum clean all<br>(7)yum makecache</p>
<h3 id="局域网yum源"><a href="#局域网yum源" class="headerlink" title="局域网yum源"></a>局域网yum源</h3><p>(1)安装nginx，准备nginx-1.10.2.tar.gz包，并解压（在10.170.200.6上安装）</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar -zxvf nginx-1.10.2.tar.gz</span><br></pre></td></tr></table></figure>
<p>(2)进入nginx目录 cd nginx-1.10.2<br>(3)安装编译nginx</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./configure &amp;&amp; make &amp;&amp; make install</span><br></pre></td></tr></table></figure>
<p>(4)编辑nginx.conf，配置nginx，nginx路径为&#x2F;usr&#x2F;local&#x2F;nginx，如需更改nginx默认的80端口，只需更改listen即可。<br>location &#x2F; {<br>root &#x2F;develop&#x2F;yum&#x2F;;<br>autoindex on;<br>}<br><img src="/img/yum_2.png" alt="image"><br>(5)启动nginx服务</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /usr/local/nginx/sbin/</span><br><span class="line">./nginx</span><br><span class="line">./nginx -s stop</span><br><span class="line">./nginx -s quit</span><br><span class="line">./nginx -s reload</span><br></pre></td></tr></table></figure>
<p>备注：<br>.&#x2F;nginx -s quit:此方式停止步骤是待nginx进程处理任务完毕进行停止。<br>.&#x2F;nginx -s stop:此方式相当于先查出nginx进程id再使用kill命令强制杀掉进程。<br>.&#x2F;nginx -s reload：当nginx的配置文件nginx.conf修改后，要想让配置生效需要重启nginx，使用.&#x2F;nginx -s reload不用先停止nginx再启动nginx即可将配置信息在nginx 生效。<br>(6)查看nginx进程<br>ps aux|grep nginx</p>
<p>(7)配置nginx开机自启动<br>切换到&#x2F;lib&#x2F;systemd&#x2F;system&#x2F;目录，创建nginx.service文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">vim nginx.service</span><br><span class="line"></span><br><span class="line"><span class="comment"># cd /lib/systemd/system/</span></span><br><span class="line"><span class="comment"># vim nginx.service</span></span><br><span class="line">文件内容如下：</span><br><span class="line">[Unit]</span><br><span class="line">Description=nginx</span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=forking</span><br><span class="line">ExecStart=/usr/local/nginx/sbin/nginx</span><br><span class="line">ExecReload=/usr/local/nginx/sbin/nginx reload</span><br><span class="line">ExecStop=/usr/local/nginx/sbin/nginx quit</span><br><span class="line">PrivateTmp=<span class="literal">true</span></span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure>
<p>退出并保存文件，执行systemctl enable nginx.service使nginx开机启动</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl start nginx.service    启动nginx</span><br><span class="line">systemctl stop nginx.service     结束nginx</span><br><span class="line">systemctl restart nginx.service   重启nginx</span><br></pre></td></tr></table></figure>
<p>(8)准备ISO源，挂载CentOS-7-x86_64-Everything-1511.iso，把里面所有文件都拷贝到本地目录&#x2F;develop&#x2F;yum（自己创建）<br>(9)再新建一个目录mkdir &#x2F;home&#x2F;mcloud&#x2F;centos-yum<br>(10)将iso文件挂载到新建目录&#x2F;home&#x2F;mcloud&#x2F;centos-yum下,挂载成功后如图所示。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mount CentOS-7-x86_64-Everything-1511.iso /home/mcloud/centos-yum</span><br></pre></td></tr></table></figure>
<p><img src="/img/yum_3.png" alt="image"><br>(11)将挂载到&#x2F;home&#x2F;mcloud&#x2F;centos-yum下的ISO文件解压后文件中的Packages文件中的所有rpm包拷贝到&#x2F;develop&#x2F;yum下。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cp</span> -r /home/mcloud/centos-yum/Packages/* /develop/yum</span><br></pre></td></tr></table></figure>
<p>(12)需要提前安装createrepo</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install createrepo</span><br></pre></td></tr></table></figure>
<p>(13)createrepo &#x2F;develop&#x2F;yum 更新yum目录，会在&#x2F;develop&#x2F;yum底下生产一个repodata目录<br><img src="/img/yum_4.png" alt="image"><br>如果添加或者删除了个人的rpm包，不需要再次重新create，浪费时间，只需要createrepo –update &#x2F;develop&#x2F;yum就可以了。<br>(14)编辑&#x2F;etc&#x2F;yum.repos.d&#x2F;底下repo文件。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[core-0]</span><br><span class="line">name=core-0</span><br><span class="line">baseurl=http://10.170.200.6:8088</span><br><span class="line">enabled=1</span><br><span class="line">gpgcheck=0</span><br><span class="line">priority=1</span><br></pre></td></tr></table></figure>
<p>(15)</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yum clean all</span><br><span class="line">yum makecache</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://wangdj104.github.io/2019/08/29/Idap%E6%9C%8D%E5%8A%A1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="wangdj">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="wdj's blog">
      <meta itemprop="description" content="记录生活中的点点滴滴">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | wdj's blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2019/08/29/Idap%E6%9C%8D%E5%8A%A1/" class="post-title-link" itemprop="url">Idap之二进制安装</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">نُشر في</span>

      <time title="أُنشأ: 2019-08-29 23:14:59" itemprop="dateCreated datePublished" datetime="2019-08-29T23:14:59+08:00">2019-08-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">عُدل في</span>
      <time title="عُدل: 2019-12-10 11:04:58" itemprop="dateModified" datetime="2019-12-10T11:04:58+08:00">2019-12-10</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">في</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E6%9C%8D%E5%8A%A1%E9%85%8D%E7%BD%AE%E6%96%87%E6%A1%A3/" itemprop="url" rel="index"><span itemprop="name">服务配置文档</span></a>
        </span>
          ، 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E6%9C%8D%E5%8A%A1%E9%85%8D%E7%BD%AE%E6%96%87%E6%A1%A3/Idap%E6%9C%8D%E5%8A%A1/" itemprop="url" rel="index"><span itemprop="name">Idap服务</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="第一章-LDAP认证"><a href="#第一章-LDAP认证" class="headerlink" title="第一章 LDAP认证"></a>第一章 LDAP认证</h3><p><img src="/img/Idap_1.png" alt="image"><br>在上图中，LDAP Client指各种需要身份认证的软件，例如Apache、Proftpd和Samba等。LDAP Sever指的是实现LDAP协议的软件，例如OpenLDAP等。LDAP Directory Services指的是OpenLDAP的数据存储，如关系型数据库（MySQL）或查询效率更高的嵌入式数据库（BerkeleyDB），甚至是平面文本数据库（—个txt的文本文件）。可见，OpenLDAP软件只是LDAP协议的一种实现形式，并不包括后台数据库存储。但在很多时候管理员经常将LDAP Server和DataStorage放在同一台服务器，这样就产生了人们通常所说的“LDAP数据库”。虽然后台数据库（backend）可以是多种多样，但LDAP协议还规定了数据的存储方式。LDAP数据库是树状结构的，与DNS类似，如下图所示：<br><img src="/img/Idap_2.png" alt="image"><br>在上图中，以这种方式存储数据最大的一个好处就是查询速度快，LDAP数据库专门对读操作进行了优化， OpenLDAP配合Berkeley DB可使其读操作的效率得到很大提高。LDAP数据库的树状结构的另一个好处是便于分布式的管理。</p>
<h3 id="第二章-Harbor用户模型"><a href="#第二章-Harbor用户模型" class="headerlink" title="第二章 Harbor用户模型"></a>第二章 Harbor用户模型</h3><h4 id="用户模型"><a href="#用户模型" class="headerlink" title="用户模型"></a>用户模型</h4><p>Harbor登录用户有管理员和普通用户两种类型<br>管理员模型：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">dn: uid=wangdj104,ou=admin,cn=devops-dev-gitlab,dc=jichen,dc=chinaunicom</span><br><span class="line">cn:: 546L6YGT5rGf                  <span class="comment">#加密后的用户全名  此为王..</span></span><br><span class="line">employeetype: admin               <span class="comment">#标志为管理员</span></span><br><span class="line">mail: 1138523117@qq.com          <span class="comment">#邮箱必填</span></span><br><span class="line">objectclass: inetOrgPerson</span><br><span class="line">objectclass: top</span><br><span class="line">sn:: 546L                          <span class="comment">#加密后的用户姓  此为王</span></span><br><span class="line">uid: wangdj104</span><br><span class="line">userpassword: &#123;MD5&#125;DyoNF/7H+m7ndqjlKtr12w==  <span class="comment">#md5加密后的用户密码 此为111111</span></span><br></pre></td></tr></table></figure>

<p>普通用户模型：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">dn: uid=zhangj1143,ou=<span class="built_in">users</span>,cn=devops-dev-gitlab,dc=jichen,dc=chinaunicom</span><br><span class="line">cn:: 5byg5Yab                <span class="comment">#加密后的用户全名  此为张..</span></span><br><span class="line">employeetype: user           <span class="comment">#标志为普通用户</span></span><br><span class="line">mail: 23659874@qq.com       <span class="comment">#邮箱必填</span></span><br><span class="line">objectclass: inetOrgPerson</span><br><span class="line">objectclass: top</span><br><span class="line">sn:: 5byg                    <span class="comment">#加密后的用户姓  此为张</span></span><br><span class="line">uid: zhangj1143</span><br><span class="line">userpassword: &#123;MD5&#125;DyoNF/7H+m7ndqjlKtr12w==  <span class="comment">#md5加密后的用户密码 此为111111</span></span><br></pre></td></tr></table></figure>
<h4 id="用户模型的建立"><a href="#用户模型的建立" class="headerlink" title="用户模型的建立"></a>用户模型的建立</h4><p>ldap环境搭建好后，登录界面化管理工具phpldapadmin后，显示如下。然后开始导入用户组和用户。<br><img src="/img/Idap_3.png" alt="image"><br>1）增加基础dn（相当于集团）</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">dn: dc=jichen,dc=chinaunicom</span><br><span class="line">dc: jichen</span><br><span class="line">o: jichen                 <span class="comment">#以上三项需和上图保持一致</span></span><br><span class="line">objectclass: dcObject</span><br><span class="line">objectclass: organization</span><br></pre></td></tr></table></figure>
<p><img src="/img/Idap_4.png" alt="image"><br>2）导入组（cn,相当于分公司）</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">dn: cn=devops-dev- gitlab,dc=jichen,dc=chinaunicom</span><br><span class="line">cn: devops-dev-gitlab             <span class="comment">#设置的组名称</span></span><br><span class="line">gidnumber: 500                  <span class="comment">#可设其它值</span></span><br><span class="line">objectclass: posixGroup</span><br><span class="line">objectclass: top</span><br></pre></td></tr></table></figure>
<p><img src="/img/Idap_5.png" alt="image"><br><img src="/img/Idap_6.png" alt="image"><br>3）导入组织单元（ou,相当于部门）</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">dn: ou=admin,cn=devops-dev-gitlab,dc=jichen,dc=chinaunicom</span><br><span class="line">objectclass: organizationalUnit</span><br><span class="line">objectclass: top</span><br><span class="line">ou: admin                       <span class="comment">#管理部门</span></span><br><span class="line"></span><br><span class="line">dn: ou=<span class="built_in">users</span>,cn=devops-dev-gitlab,dc=jichen,dc=chinaunicom</span><br><span class="line">objectclass: organizationalUnit</span><br><span class="line">objectclass: top</span><br><span class="line">ou: <span class="built_in">users</span>                   <span class="comment">#普通用户</span></span><br></pre></td></tr></table></figure>
<p><img src="/img/Idap_7.png" alt="image"><br><img src="/img/Idap_8.png" alt="image"><br>4）导入员工</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">dn: uid=wangdj104,ou=admin,cn=devops-dev-gitlab,dc=jichen,dc=chinaunicom</span><br><span class="line">cn:: 546L6YGT5rGf                  <span class="comment">#加密后的用户全名  此为王道江</span></span><br><span class="line">employeetype: admin               <span class="comment">#标志为管理员</span></span><br><span class="line">mail: 1138523117@qq.com          <span class="comment">#邮箱必填</span></span><br><span class="line">objectclass: inetOrgPerson</span><br><span class="line">objectclass: top</span><br><span class="line">sn:: 546L                          <span class="comment">#加密后的用户姓  此为王</span></span><br><span class="line">uid: wangdj104</span><br><span class="line">userpassword: &#123;MD5&#125;DyoNF/7H+m7ndqjlKtr12w==  <span class="comment">#md5加密后的用户密码 此为111111</span></span><br><span class="line"></span><br><span class="line">dn: uid=zhangj1143,ou=<span class="built_in">users</span>,cn=devops-dev-gitlab,dc=jichen,dc=chinaunicom</span><br><span class="line">cn:: 5byg5Yab                <span class="comment">#加密后的用户全名  此为王道江</span></span><br><span class="line">employeetype: user           <span class="comment">#标志为普通用户</span></span><br><span class="line">mail: 23659874@qq.com       <span class="comment">#邮箱必填</span></span><br><span class="line">objectclass: inetOrgPerson</span><br><span class="line">objectclass: top</span><br><span class="line">sn:: 5byg                    <span class="comment">#加密后的用户姓  此为张</span></span><br><span class="line">uid: zhangj1143</span><br><span class="line">userpassword: &#123;MD5&#125;DyoNF/7H+m7ndqjlKtr12w==  <span class="comment">#md5加密后的用户密码 此为111111</span></span><br></pre></td></tr></table></figure>
<p><img src="/img/Idap_9.png" alt="image"><br><img src="/img/Idap_10.png" alt="image"></p>
<h4 id="用户权限的管理"><a href="#用户权限的管理" class="headerlink" title="用户权限的管理"></a>用户权限的管理</h4><p>使用上述建立的用户登录harbor,页面如下：<br><img src="/img/Idap_11.png" alt="image"><br><img src="/img/Idap_12.png" alt="image"><br><img src="/img/Idap_13.png" alt="image"><br>修改其权限为管理员，使用admin账号登录harbor<br><img src="/img/Idap_14.png" alt="image"><br><img src="/img/Idap_15.png" alt="image"><br>再次登录wangdj104账户，可以有更多的权限<br><img src="/img/Idap_16.png" alt="image"></p>
<h3 id="第三章-安装Berkeley-DB"><a href="#第三章-安装Berkeley-DB" class="headerlink" title="第三章 安装Berkeley DB"></a>第三章 安装Berkeley DB</h3><p>Berkeley DB(BDB)是OpenLDAP后台数据库的默认配置，因此在安装OpenLDAP之前应先安装BDB<br>安装包下载链接: <a target="_blank" rel="noopener" href="https://pan.baidu.com/s/12TvaQRXADay2OvtiVOcLBg">https://pan.baidu.com/s/12TvaQRXADay2OvtiVOcLBg</a> 提取码: khgw<br><img src="/img/Idap_17.png" alt="image"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> db-5.3.28/build_unix/</span><br><span class="line">../dist/configure -prefix=/usr/local/BerkeleyDB(最好是装在此目录下，否则安装ldap时会报lib是一个目录的错误)</span><br><span class="line">make</span><br><span class="line">make install</span><br></pre></td></tr></table></figure>

<h3 id="第四章-OpenLDAP安装"><a href="#第四章-OpenLDAP安装" class="headerlink" title="第四章 OpenLDAP安装"></a>第四章 OpenLDAP安装</h3><p>linux搭建开源ldap服务器方法参考博文：<br><a target="_blank" rel="noopener" href="https://blog.csdn.net/u010783533/article/details/88572697">https://blog.csdn.net/u010783533/article/details/88572697</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/developerinit/article/details/77170569">https://blog.csdn.net/developerinit/article/details/77170569</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/muriyue6/article/details/82845523">https://blog.csdn.net/muriyue6/article/details/82845523</a><br><a target="_blank" rel="noopener" href="https://www.cnblogs.com/MYSQLZOUQI/p/4840965.html">https://www.cnblogs.com/MYSQLZOUQI/p/4840965.html</a></p>
<h4 id="Idap安装"><a href="#Idap安装" class="headerlink" title="Idap安装"></a>Idap安装</h4><p>ldap是统一认证服务，它的优点是存储用户认证等不经常改变的信息，有清晰的组织结构。本文使用的是openldap-2.4.47.tgz。<br>安装包下载链接：<a href="ftp://ftp.openldap.org/pub/OpenLDAP/openldap-release">ftp://ftp.openldap.org/pub/OpenLDAP/openldap-release</a><br>（1）开始前需设置编译参数，如下所示</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> CPPFLAGS=<span class="string">&quot;-I/usr/local/BerkeleyDB/include&quot;</span></span><br><span class="line"><span class="built_in">export</span> LDFLAGS=<span class="string">&quot;-L/usr/local/BerkeleyDB/lib&quot;</span></span><br><span class="line"><span class="built_in">export</span> LD_LIBRARY_PATH=<span class="string">&quot;/usr/local/BerkeleyDB/lib&quot;</span></span><br></pre></td></tr></table></figure>
<p>（2）</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./configure --prefix=/home/deployer/idap/ldap</span><br></pre></td></tr></table></figure>
<p>（3）</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make depend</span><br></pre></td></tr></table></figure>
<p>   Make depend是一种makefile的规则，通过扫描各个目录下的所有C&#x2F;C++ 代码，从而判断出文件之间的依赖关系，如a.cc文件中调用了b.h(如以形势include&lt;b.h&gt;)，如果之后a.cc文件被改动，那 么只需要重新编译a.cc文件，不需要编译b.h文件。否则所有的文件都需要重新编译<br>（4）</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">make</span><br><span class="line">make <span class="built_in">test</span>（需要一段时间，可选操作）</span><br><span class="line">make install</span><br></pre></td></tr></table></figure>
<p>安装完成后：etc目录显示的是配置文件，bin目录显示的ldap的客户端工具，sbin目录显示的是服务器相关执行文件，libexec下是ldap服务启动程序，.ldif是ldap特定的文件格式，这种格式的文件用于ldap数据的添加。<br><img src="/img/Idap_18.png" alt="image"></p>
<h4 id="配置Idap"><a href="#配置Idap" class="headerlink" title="配置Idap"></a>配置Idap</h4><p>（1）设置LDAP使用的Schema<br>编辑slapd.conf</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /home/deployer/idap/ldap/etc/openldap</span><br></pre></td></tr></table></figure>
<p>在文件中找到如下语句。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">include  /home/deployer/idap/ldap/etc/schema/core.schema</span><br></pre></td></tr></table></figure>
<p>在该语句的后面添加以下语句。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">include /home/deployer/idap/ldap/etc/openldap/schema/corba.schema</span><br><span class="line">include /home/deployer/idap/ldap/etc/openldap/schema/cosine.schema</span><br><span class="line">include /home/deployer/idap/ldap/etc/openldap/schema/dyngroup.schema</span><br><span class="line">include /home/deployer/idap/ldap/etc/openldap/schema/inetorgperson.schema</span><br><span class="line">include /home/deployer/idap/ldap/etc/openldap/schema/java.schema</span><br><span class="line">include /home/deployer/idap/ldap/etc/openldap/schema/misc.schema</span><br><span class="line">include /home/deployer/idap/ldap/etc/openldap/schema/nis.schema</span><br><span class="line">include /home/deployer/idap/ldap/etc/openldap/schema/openldap.schema</span><br></pre></td></tr></table></figure>
<p>(2)为目录树设置后缀<br>在slapd.conf文件中找到如下语句:<br>suffix “dc&#x3D;my-domain, dc&#x3D;com”<br>将其改为如下内容。<br>suffix “dc&#x3D;my-test, dc&#x3D;chinaunicom”</p>
<p>(3)为LDAP服务器管理员设置DN<br>在slapd.conf文件中找到如下语句:<br>rootdn “cn&#x3D;Manager, dc&#x3D;my-domain, dc &#x3D; com”<br>将其改为如下内容。<br>rootdn “cn&#x3D;Manager, dc&#x3D;my-test, dc &#x3D; chinaunicom”</p>
<p>(4)为LDAP服务器管理员设置口令<br> 1）生成加密密码：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /home/deployer/idap/ldap/sbin</span><br><span class="line">[root@localhost sbin] <span class="comment"># ./slappasswd</span></span><br><span class="line">New password:</span><br><span class="line">Re-enter new password:</span><br><span class="line">&#123;SSHA&#125;YARtaZb0fjq3B2gJuflulDS7vezL7O1p</span><br></pre></td></tr></table></figure>
<p> 2)设置管理员密码<br>在slapd.conf文件中找到如下语句：<br>rootpw secret<br>将其改为如下内容。<br>rootpw {SSHA}YARtaZb0fjq3B2gJuflulDS7vezL7O1p<br>(5)初始化OpenLDAP（可选）</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@instance-0pk09gjj /]<span class="comment"># cd /home/deployer/idap/ldap/var/openldap-data/</span></span><br><span class="line">[root@instance-0pk09gjj openldap-data]<span class="comment"># cp DB_CONFIG.example DB_CONFIG</span></span><br></pre></td></tr></table></figure>

<p>(6)启动LDAP服务器<br>要启动LDAP服务器，只需执行以下命令。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">nohup</span> /home/deployer/idap/ldap/libexec/slapd -f /home/deployer/idap/ldap/etc/openldap/slapd.conf -d 255 &amp;</span><br></pre></td></tr></table></figure>
<p>然后执行以下命令确保sland进程启动成功。执行结果如下所示，显示“|-slapd”表示LDAP服务器已经成功启动。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># pstree|grep &quot;slapd&quot;</span></span><br><span class="line">                  |-slapd -----&#123;slapd&#125;/</span><br></pre></td></tr></table></figure>
<p>(7)创建一个ldif文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost bin]<span class="comment"># cd /home/deployer/idap/ldap/etc/openldap</span></span><br><span class="line">[root@localhost bin]<span class="comment"># vim /home/deployer/idap/ldap/etc/openldap/example.ldif</span></span><br><span class="line">[root@localhost bin]<span class="comment"># cat /home/deployer/idap/ldap/etc/openldap/example.ldif</span></span><br><span class="line">dn:dc=my-test,dc=chinaunicom</span><br><span class="line">objectclass:dcObject</span><br><span class="line">objectclass:organization</span><br><span class="line">dc:my-test</span><br><span class="line">o:my-test,Inc.</span><br><span class="line"></span><br><span class="line">dn:ou=Harbor,dc=my-test,dc=chinaunicom</span><br><span class="line">objectclass:organizationalUnit</span><br><span class="line">ou:Harbor</span><br></pre></td></tr></table></figure>

<p>(8) 添加添加ldif文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/home/deployer/idap/ldap/bin/ldapadd -x -D <span class="string">&#x27;cn=Manager,dc=my-test,dc=chinaunicom&#x27;</span> -W -f /home/deployer/idap/ldap/etc/openldap/example.ldif</span><br></pre></td></tr></table></figure>
<p><img src="/img/Idap_19.png" alt="image"><br><img src="/img/Idap_20.png" alt="image"></p>
<h3 id="第五章-phpLDAPadmin安装配置"><a href="#第五章-phpLDAPadmin安装配置" class="headerlink" title="第五章 phpLDAPadmin安装配置"></a>第五章 phpLDAPadmin安装配置</h3><p>安装博客：<a target="_blank" rel="noopener" href="http://blog.sina.com.cn/s/blog_681e31a20102vqdc.html">http://blog.sina.com.cn/s/blog_681e31a20102vqdc.html</a><br>安装包下载链接：<a target="_blank" rel="noopener" href="https://pan.baidu.com/s/1fEu-CENRJ5ja8knHQzyuZw">https://pan.baidu.com/s/1fEu-CENRJ5ja8knHQzyuZw</a> 提取码: fgij<br><img src="/img/Idap_21.png" alt="image"></p>
<h4 id="安装Apache"><a href="#安装Apache" class="headerlink" title="安装Apache"></a>安装Apache</h4><p> 下载apache版本httpd-2.2.26.tar.gz，并下载相关的支持组件包 apr-1.5.0.tar.gz, apr-util-1.5.3.tar.gz<br>（1）解压apache及相关组件包源码</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># tar -zxvf  httpd-2.2.26.tar.gz</span></span><br><span class="line"><span class="comment"># tar -zxvf  apr-1.5.0.tar.gz</span></span><br><span class="line"><span class="comment"># tar -zxvf  apr-util-1.5.3.tar.gz</span></span><br></pre></td></tr></table></figure>
<p>（2）安装apr</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cd  apr-1.5.0</span></span><br><span class="line"><span class="comment"># ./configure --prefix=/usr/local/apr</span></span><br><span class="line"><span class="comment"># make</span></span><br><span class="line"><span class="comment"># make install</span></span><br></pre></td></tr></table></figure>
<p>（3）安装apr-util</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cd apr-util-1.5.3</span></span><br><span class="line"><span class="comment"># ./configure --prefix=/usr/local/apr-util   --with-apr=/usr/local/apr</span></span><br><span class="line"><span class="comment"># make</span></span><br><span class="line"><span class="comment"># make install</span></span><br></pre></td></tr></table></figure>
<p>（4）安装apache</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#cd  httpd-2.2.26</span></span><br><span class="line"><span class="comment"># ./configure --prefix=/usr/local/apache --enable-so  --enable-rewrite --with-apr=/usr/local/apr --with-apr-util=/usr/local/apr-util</span></span><br><span class="line">//安装到指定目录，so开启动态模块支持，rewrite开启地址重写。</span><br><span class="line"><span class="comment"># make;</span></span><br><span class="line"><span class="comment">#make install</span></span><br></pre></td></tr></table></figure>

<h4 id="安装php5"><a href="#安装php5" class="headerlink" title="安装php5"></a>安装php5</h4><p>(1) 安装libxml2<br>获取php支持组件libxml2-2.7.8.tar.gz<br>安装如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#tar -zxvf  libxml2-2.7.8.tar.gz</span></span><br><span class="line"><span class="comment">#cd libxml2-2.7.8</span></span><br><span class="line"><span class="comment">#./configure --prefix=/usr/local/libxml2</span></span><br><span class="line"><span class="comment">#make</span></span><br><span class="line"><span class="comment">#make install</span></span><br></pre></td></tr></table></figure>
<p>   安装成功以后，在&#x2F;usr&#x2F;local&#x2F;libxml2&#x2F;目录下将生成bin、include、lib、man和share五个目录。在后面安装PHP5源代码包的配置时，会通过在configure命令的选项中加上”–with-libxml-dir&#x3D;&#x2F;usr&#x2F; local&#x2F;libxml2”选项，用于指定安装libxml2库文件的位置。<br>(2) 安装php5</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># tar -zxvf  php-5.6.0.tar.gz</span></span><br><span class="line"><span class="comment"># cd  php-5.6.0</span></span><br><span class="line"><span class="comment">#  ./configure  --prefix=/usr/local/php5  \</span></span><br><span class="line">                --with-apxs2=/usr/local/apache/bin/apxs   \</span><br><span class="line">                --with-ldap=/home/deployer/idap/ldap  \</span><br><span class="line">                --with-config-file-path=/usr/local/php5  \</span><br><span class="line">                --with-libxml-dir=/usr/local/libxml2    \</span><br><span class="line">                --with-gettext</span><br></pre></td></tr></table></figure>
<p>&#x2F;&#x2F;指定安装目录，跟apache融合，指定配置文件位置，启用ldap支持（必须的），启用 gettext支持（必须要启用的支持）<br>注：出现以下信息则配置环境成功（.&#x2F;configure），才可继续输入安装命令make和make install。<br><img src="/img/Idap_22.png" alt="image"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">   make</span><br><span class="line">   make install</span><br><span class="line">   <span class="built_in">cp</span> php.ini-development     /usr/local/php5/php.ini</span><br><span class="line">//把配置文件拷贝过去,编辑它，在适当位置添加include_path = /usr/local/php5/lib/php</span><br></pre></td></tr></table></figure>

<h4 id="配置Apache"><a href="#配置Apache" class="headerlink" title="配置Apache"></a>配置Apache</h4><p>(1) 配置apache主文件httpd.conf<br>有三个地方需要修改</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/local/apache/conf/httpd.conf</span><br></pre></td></tr></table></figure>
<p><img src="/img/Idap_23.png" alt="image"><br><img src="/img/Idap_24.png" alt="image"><br><img src="/img/Idap_25.png" alt="image"></p>
<p>(2) 配置apache支持php</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/local/apache/conf/httpd.conf</span><br></pre></td></tr></table></figure>
<p>在AddType application&#x2F;x-gzip .gz .tgz 下添加如下内容<br><img src="/img/Idap_26.png" alt="image"><br>在DirectoryIndex index.html 后添加如下内容<br><img src="/img/Idap_27.png" alt="image"></p>
<h4 id="测试Apche-PHP安装是否成功"><a href="#测试Apche-PHP安装是否成功" class="headerlink" title="测试Apche +PHP安装是否成功"></a>测试Apche +PHP安装是否成功</h4><p>启动apache，命令行输入</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /usr/local/apache/bin</span><br><span class="line">./apachectl start</span><br></pre></td></tr></table></figure>
<p>在浏览器输入IP ： <a target="_blank" rel="noopener" href="http://192.168.117.132,显示如下则成功安装apache/">http://192.168.117.132，显示如下则成功安装apache</a><br><img src="/img/Idap_28.png" alt="image"></p>
<h4 id="安装配置phpLDAPadmin"><a href="#安装配置phpLDAPadmin" class="headerlink" title="安装配置phpLDAPadmin"></a>安装配置phpLDAPadmin</h4><p>(1)安装phpldapadmin</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">tar zxvf phpldapadmin-1.2.3.tgz</span><br><span class="line"><span class="built_in">mv</span>  phpldapadmin-1.2.3   /usr/local/phpldapadmin</span><br><span class="line"><span class="built_in">cd</span>  /usr/local/phpldapadmin/config</span><br><span class="line"><span class="built_in">cp</span>  config.php.example  config.php</span><br></pre></td></tr></table></figure>
<p>openldapadmin的安装很简单，只需要解压，然后移动到相应的目录就可以了。默认情况下phpldapadmin自带了一个示例配置文件config.php.example，对该文件稍做修改，就可以使用了。<br>（2）配置config.conf</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim  config.php</span><br></pre></td></tr></table></figure>
<p><img src="/img/Idap_29.png" alt="image"><br>注：上面的array（’’）里面需要跟之前oepnldap的配置文件slapd.conf里的suffix的值一致<br><img src="/img/Idap_30.png" alt="image"><br>注：登陆的账号和密码设置为空，则网页弹出需要手动输入（账号为slapd.conf的rootdn，密码是rootpw）；若想绑定账号，则绑定密码项绑定与否都可以<br>(3)建立phpldapadmin虚拟目录及设置用户认证。<br>在httpd.conf文件末添加下图所示内容，建立虚拟目录<br><img src="/img/Idap_31.png" alt="image"><br>设置admin密码</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"> <span class="built_in">mkdir</span> -p /etc/apach2</span><br><span class="line"> <span class="built_in">cd</span> /etc/apach2</span><br><span class="line">/usr/local/apache/bin/htpasswd  -c php_ldap_admin_pwd   admin</span><br></pre></td></tr></table></figure>
<p>(4)配置phpLDAPadmin使用中文<br>1)编辑文件&#x2F;usr&#x2F;local&#x2F;phpldapadmin&#x2F;config&#x2F;config.php，修改语句：<br>&#x2F;&#x2F; $config-&gt;custom-&gt;appearance[‘language’] &#x3D; ‘auto’;<br>将“&#x2F;&#x2F;”注释符号去处，并将语句改为：<br>$config-&gt; custom-&gt;appearance[‘language’] &#x3D; ‘zh_CN’;<br>2)使用下列的命令转换phpLDAPadmin语言文件的编码。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">iconv -f gbk -t utf8 /usr/local/phpldapadmin/locale/zh_CN/LC_MESSAGES/messages.mo &gt; /usr/local/phpldapadmin/locale/zh_CN/LC_MESSAGES/messages.new.po</span><br><span class="line">msgfmt -o /usr/local/phpldapadmin/locale/zh_CN/LC_MESSAGES/messages.mo /usr/ <span class="built_in">local</span>/phpldapadmin/locale/zh_CN/LC_MESSAGES/messages.new.po</span><br></pre></td></tr></table></figure>
<p>(5)启动phpldapadmin<br>保存上述httpd.conf文件，重启Apache服务</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /usr/local/apache/bin</span><br><span class="line">./apachectl  restart</span><br></pre></td></tr></table></figure>
<p>浏览器输入：<a target="_blank" rel="noopener" href="http://192.21.11.132/phpldapadmin/%E8%BF%9B%E8%A1%8C%E8%AE%BF%E9%97%AE%E3%80%82%E5%A6%82%E4%B8%8B%E5%9B%BE">http://192.21.11.132/phpldapadmin/进行访问。如下图</a><br><img src="/img/Idap_32.png" alt="image"><br><img src="/img/Idap_33.png" alt="image"><br>注：在建立phpldapadmin虚拟目录及设置用户认证后，在浏览器打开phpldapadmin出现下图错误，phpldapadmin&#x2F;lib&#x2F;functions.php 是下载安装包的文件，不应有错。在官网查了下（<a target="_blank" rel="noopener" href="http://sourceforge.net/u/nihilisticz/phpldapadmin/ci/7e53dab990748c546b79f0610c3a7a58431e9ebc/">http://sourceforge.net/u/nihilisticz/phpldapadmin/ci/7e53dab990748c546b79f0610c3a7a58431e9ebc/</a> ），原来是软件版本更新，几个文件都需要修改，照着上面依次修改了lib&#x2F;PageRender.php、lib&#x2F;ds_ldap.php、 lib&#x2F;ds_ldap.php 、lib&#x2F;functions.php 、lib\TemplateRender.php 里面的函数及相应代码，最后运行成功。<br><img src="/img/Idap_34.png" alt="image"></p>
<h3 id="第六章-Harbor集成LDAP"><a href="#第六章-Harbor集成LDAP" class="headerlink" title="第六章 Harbor集成LDAP"></a>第六章 Harbor集成LDAP</h3><p>默认配置文件在harbor.cfg，我们可以先不添加配置，直接在harbor web界面进行配置，也可两者同时设置。</p>
<h4 id="LDAP账号生成"><a href="#LDAP账号生成" class="headerlink" title="LDAP账号生成"></a>LDAP账号生成</h4><p>Openldap是一个统一的账户管理工具，只进行用户的管理，不进行权限的管理，权限管理在各自的组件中进行。<br>搭建phpldapadmin界面化管理工具，创建组、组织单元、账户：<br>1）	创建一个组<br>点击dc&#x3D;my-test,dc&#x3D;chinaunicom-》创建一个子条目-》默认-》posixGroup-》RDN选择cn,cn框填写组名-》创建对象，本例为devops-dev-harbor;<br>2）	创建一个组织单元ou<br>点击cn&#x3D;devops-dev-harbor-》创建一个子条目-》默认-》organizationalUnit-》RDN选择ou,ou框填写单元名-》创建对象<br>3）	创建一个用户<br>点击ou&#x3D;users-》创建一个子条目-》默认-》inetOrgPerson-》RDN选择User Name(uid)-》cn框填写用户名，sn框填写中文名，设置密码，User Name<br><img src="/img/Idap_35.png" alt="image"><br>vim harbor.cfg<br><img src="/img/Idap_36.png" alt="image"><br>再harbor界面设置认证方式为ldap<br><img src="/img/Idap_37.png" alt="image"><br>另外，harbor1.6版本，还可以进行组的管理。<br><img src="/img/Idap_38.png" alt="image"><br>然后点击组管理。新增组<br><img src="/img/Idap_39.png" alt="image"><br><img src="/img/Idap_40.png" alt="image"><br>配置完成后，即可使用创建的账户登录harbor<br><img src="/img/Idap_41.png" alt="image"><br>注意：初次使用ldap的账户登录harbor后，认证模式就不可更改了。并且在用户管理中，可以看到刚刚登录的ldap用户（admin用户下）</p>
<h4 id="权限设置"><a href="#权限设置" class="headerlink" title="权限设置"></a>权限设置</h4><p>Openldap创建的用户是普通的用户，若想将该用户设置成管理员，需要登录harbor的超级管理员（admin）进行设置。<br><img src="/img/Idap_42.png" alt="image"><br>普通用户的页面如下：<br><img src="/img/Idap_43.png" alt="image"></p>
<h3 id="第七章-Sonarqube集成ldap"><a href="#第七章-Sonarqube集成ldap" class="headerlink" title="第七章 Sonarqube集成ldap"></a>第七章 Sonarqube集成ldap</h3><p>参考博客<br><a target="_blank" rel="noopener" href="https://blog.csdn.net/neufeng2010/article/details/99655942">https://blog.csdn.net/neufeng2010/article/details/99655942</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/BeauXie/article/details/81157330">https://blog.csdn.net/BeauXie/article/details/81157330</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_21816375/article/details/80787993">https://blog.csdn.net/qq_21816375/article/details/80787993</a></p>
<h4 id="安装启动sonarqube服务"><a href="#安装启动sonarqube服务" class="headerlink" title="安装启动sonarqube服务"></a>安装启动sonarqube服务</h4><p>安装包下载地址：<a target="_blank" rel="noopener" href="https://www.sonarqube.org/downloads/%E3%80%82">https://www.sonarqube.org/downloads/。</a><br>版本要求7.2.1以上</p>
<p>修改sonar配置文件sonar.properties</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ vim /home/deployer/sonarqube-7.2.1/conf/sonar.properties</span><br></pre></td></tr></table></figure>
<p>修改如下(请将具体信息按照自己的LDAP服务器信息进行修改):</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># LDAP CONFIGURATION</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Enable the LDAP feature</span></span><br><span class="line">sonar.security.realm=LDAP           //取消注释</span><br><span class="line"></span><br><span class="line"><span class="comment"># Set to true when connecting to a LDAP server using a case-insensitive setup.</span></span><br><span class="line"><span class="comment"># sonar.authenticator.downcase=true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># URL of the LDAP server. Note that if you are using ldaps, then you should install the server certificate into the Java truststore.</span></span><br><span class="line">ldap.url=ldap://192.168.117.132:389     //取消注释，填写实际ldap服务器地址</span><br><span class="line"></span><br><span class="line"><span class="comment"># Bind DN is the username of an LDAP user to connect (or bind) with. Leave this blank for anonymous access to the LDAP directory (optional)</span></span><br><span class="line">ldap.bindDn=cn=Manager,dc=my-test,dc=chinaunicom   //取消注释，填写实际ldap服务器基础DN</span><br><span class="line"></span><br><span class="line"><span class="comment"># Bind Password is the password of the user to connect with. Leave this blank for anonymous access to the LDAP directory (optional)</span></span><br><span class="line">ldap.bindPassword=111111   //取消注释，填写实际ldap服务器基础DN密码</span><br><span class="line"></span><br><span class="line"><span class="comment"># Possible values: simple | CRAM-MD5 | DIGEST-MD5 | GSSAPI See http://java.sun.com/products/jndi/tutorial/ldap/security/auth.html (default: simple)</span></span><br><span class="line">ldap.authentication=simple     //取消注释</span><br></pre></td></tr></table></figure>

<p>启动并查看启动日志<br>.&#x2F;sonar.sh console（可以实时查看sonarqube的启动日志）<br>如果报错</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">Running SonarQube...</span><br><span class="line">wrapper  | --&gt; Wrapper Started as Console</span><br><span class="line">wrapper  | Launching a JVM...</span><br><span class="line">jvm 1    | Wrapper (Version 3.2.3) http://wrapper.tanukisoftware.org</span><br><span class="line">jvm 1    |   Copyright 1999-2006 Tanuki Software, Inc.  All Rights Reserved.</span><br><span class="line">jvm 1    |</span><br><span class="line">jvm 1    | 2019.08.19 07:44:17 INFO  app[][o.s.a.AppFileSystem] Cleaning or creating temp directory /home/deployer/sonarqube-7.2.1/temp</span><br><span class="line">jvm 1    | 2019.08.19 07:44:17 INFO  app[][o.s.a.es.EsSettings] Elasticsearch listening on /192.168.117.130:44172</span><br><span class="line">jvm 1    | 2019.08.19 07:44:17 INFO  app[][o.s.a.p.ProcessLauncherImpl] Launch process[[key=<span class="string">&#x27;es&#x27;</span>, ipcIndex=1, logFilenamePrefix=es]] from [/home/deployer/sonarqube-7.2.1/elasticsearch]: /home/deployer/sonarqube-7.2.1/elasticsearch/bin/elasticsearch -Epath.conf=/home/deployer/sonarqube-7.2.1/temp/conf/es</span><br><span class="line">jvm 1    | 2019.08.19 07:44:17 INFO  app[][o.s.a.SchedulerImpl] Waiting <span class="keyword">for</span> Elasticsearch to be up and running</span><br><span class="line">jvm 1    | 2019.08.19 07:44:17 INFO  app[][o.e.p.PluginsService] no modules loaded</span><br><span class="line">jvm 1    | 2019.08.19 07:44:17 INFO  app[][o.e.p.PluginsService] loaded plugin [org.elasticsearch.transport.Netty4Plugin]</span><br><span class="line">jvm 1    | 2019.08.19 07:44:19 WARN  app[][o.s.a.p.AbstractProcessMonitor] Process exited with <span class="built_in">exit</span> value [es]: 1</span><br><span class="line">jvm 1    | 2019.08.19 07:44:19 INFO  app[][o.s.a.SchedulerImpl] Process [es] is stopped</span><br><span class="line">jvm 1    | 2019.08.19 07:44:19 INFO  app[][o.s.a.SchedulerImpl] SonarQube is stopped</span><br></pre></td></tr></table></figure>
<p>出现上述错误原因是不能用root用户启动es<br>创建sonarUser用户并赋权</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@i-vzdytl5t linux-x86-64]<span class="comment"># adduser sonarUser</span></span><br><span class="line">[root@i-vzdytl5t linux-x86-64]<span class="comment"># passwd sonarUser</span></span><br><span class="line">Changing password <span class="keyword">for</span> user sonarUser.</span><br><span class="line">New password:</span><br><span class="line">BAD PASSWORD: The password is shorter than 8 characters</span><br><span class="line">Retype new password:</span><br><span class="line">passwd: all authentication tokens updated successfully.</span><br><span class="line">[root@i-vzdytl5t linux-x86-64]<span class="comment"># chown -R sonarUser:sonarUser sonarqube-7.2.1</span></span><br></pre></td></tr></table></figure>
<p>再次启动sonarqube，若出现下图错误<br><img src="/img/Idap_44.png" alt="image"><br>删除sonarqube-7.2.1&#x2F;temp目录下的所有文件即可<br>如果出现下述错误<br><img src="/img/Idap_45.png" alt="image"><br>切换到root用户，编辑limits.conf添加如下内容</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/security/limits.conf</span><br><span class="line">* soft nofile 65536</span><br><span class="line">* hard nofile 65536</span><br></pre></td></tr></table></figure>
<p>切换到root用户，编辑sysctl.conf</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/sysctl.conf</span><br><span class="line">在文件最后添加一行</span><br><span class="line">vm.max_map_count=262144</span><br></pre></td></tr></table></figure>
<p>重新启动即可，出现下图即为成功安装了集成LDAP的sonarqube<br><img src="/img/Idap_46.png" alt="image"><br>打开sonar网址，输入LDAP中的用户名和密码后点击登录</p>
<h4 id="汉化"><a href="#汉化" class="headerlink" title="汉化"></a>汉化</h4><p>点击界面上的Adminstration,然后选择Marketplace，在Plugins一栏，搜索Chinese Pack，然后点击insatll进行安装，如下所示:<br><img src="/img/Idap_47.png" alt="image"><br>安裝完成以后，点击页面上Restart按钮，重启服务器，如下图所示:<br><img src="/img/Idap_48.png" alt="image"><br>等待一会儿，重启完毕以后，会自动跳转到登录界面。输入admin&#x2F;admin登录以后，便会看到汉化成功:<br><img src="/img/Idap_49.png" alt="image"><br>至此，SonarQube整合LDAP完成</p>
<h3 id="第八章-Gitlab集成ldap"><a href="#第八章-Gitlab集成ldap" class="headerlink" title="第八章 Gitlab集成ldap"></a>第八章 Gitlab集成ldap</h3><p>修改gitlab.rb文件如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">gitlab_rails[<span class="string">&#x27;ldap_enabled&#x27;</span>] = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment">###! **remember to close this block with &#x27;EOS&#x27; below**</span></span><br><span class="line">gitlab_rails[<span class="string">&#x27;ldap_servers&#x27;</span>] = YAML.load &lt;&lt;-<span class="string">&#x27;EOS&#x27;</span></span><br><span class="line">  main: <span class="comment"># &#x27;main&#x27; is the GitLab &#x27;provider ID&#x27; of this LDAP server</span></span><br><span class="line">    label: <span class="string">&#x27;LDAP&#x27;</span></span><br><span class="line">    host: <span class="string">&#x27;_your_ldap_server&#x27;</span></span><br><span class="line">     port: 389</span><br><span class="line">     uid: <span class="string">&#x27;uid&#x27;</span></span><br><span class="line">     bind_dn: <span class="string">&#x27;cn=Manager,dc=jichen,dc=chinaunicom&#x27;</span></span><br><span class="line">     password: <span class="string">&#x27;111111&#x27;</span></span><br><span class="line">     encryption: <span class="string">&#x27;plain&#x27;</span></span><br><span class="line"><span class="comment"># &quot;start_tls&quot; or &quot;simple_tls&quot; or &quot;plain&quot;</span></span><br><span class="line"><span class="comment">#     verify_certificates: true</span></span><br><span class="line"><span class="comment">#     active_directory: true</span></span><br><span class="line">     allow_username_or_email_login: <span class="literal">false</span></span><br><span class="line"><span class="comment">#     lowercase_usernames: false</span></span><br><span class="line"><span class="comment">#     block_auto_created_users: false</span></span><br><span class="line">     base: <span class="string">&#x27;cn=devops-dev-gitlab,dc=jichen,dc=chinaunicom&#x27;</span></span><br><span class="line"><span class="comment">#     user_filter: &#x27;&#x27;</span></span><br><span class="line"><span class="comment">#     ## EE only</span></span><br><span class="line"><span class="comment">#     group_base: &#x27;&#x27;</span></span><br><span class="line"><span class="comment">#     admin_group: &#x27;&#x27;</span></span><br><span class="line"><span class="comment">#     sync_ssh_keys: false</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#   secondary: # &#x27;secondary&#x27; is the GitLab &#x27;provider ID&#x27; of second LDAP server</span></span><br><span class="line"><span class="comment">#     label: &#x27;LDAP&#x27;</span></span><br><span class="line"><span class="comment">#     host: &#x27;_your_ldap_server&#x27;</span></span><br><span class="line"><span class="comment">#     port: 389</span></span><br><span class="line"><span class="comment">#     uid: &#x27;sAMAccountName&#x27;</span></span><br><span class="line"><span class="comment">#     bind_dn: &#x27;_the_full_dn_of_the_user_you_will_bind_with&#x27;</span></span><br><span class="line"><span class="comment">#     password: &#x27;_the_password_of_the_bind_user&#x27;</span></span><br><span class="line"><span class="comment">#     encryption: &#x27;plain&#x27; # &quot;start_tls&quot; or &quot;simple_tls&quot; or &quot;plain&quot;</span></span><br><span class="line"><span class="comment">#     verify_certificates: true</span></span><br><span class="line"><span class="comment">#     active_directory: true</span></span><br><span class="line"><span class="comment">#     allow_username_or_email_login: false</span></span><br><span class="line"><span class="comment">#     lowercase_usernames: false</span></span><br><span class="line"><span class="comment">#     block_auto_created_users: false</span></span><br><span class="line"><span class="comment">#     base: &#x27;&#x27;</span></span><br><span class="line"><span class="comment">#     user_filter: &#x27;&#x27;</span></span><br><span class="line"><span class="comment">#     ## EE only</span></span><br><span class="line"><span class="comment">#     group_base: &#x27;&#x27;</span></span><br><span class="line"><span class="comment">#     admin_group: &#x27;&#x27;</span></span><br><span class="line"><span class="comment">#     sync_ssh_keys: false</span></span><br><span class="line"> EOS</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://wangdj104.github.io/2019/08/07/Pipeline-script-%E8%87%AA%E5%8A%A8%E5%8C%96%E6%B5%8B%E8%AF%95%E6%B5%81%E7%A8%8B%E9%85%8D%E7%BD%AE/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="wangdj">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="wdj's blog">
      <meta itemprop="description" content="记录生活中的点点滴滴">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | wdj's blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2019/08/07/Pipeline-script-%E8%87%AA%E5%8A%A8%E5%8C%96%E6%B5%8B%E8%AF%95%E6%B5%81%E7%A8%8B%E9%85%8D%E7%BD%AE/" class="post-title-link" itemprop="url">Pipeline script 自动化测试流程配置</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">نُشر في</span>

      <time title="أُنشأ: 2019-08-07 22:32:04" itemprop="dateCreated datePublished" datetime="2019-08-07T22:32:04+08:00">2019-08-07</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">عُدل في</span>
      <time title="عُدل: 2019-08-09 00:59:18" itemprop="dateModified" datetime="2019-08-09T00:59:18+08:00">2019-08-09</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">في</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E9%9A%8F%E6%89%8B%E7%AC%94%E8%AE%B0/" itemprop="url" rel="index"><span itemprop="name">随手笔记</span></a>
        </span>
          ، 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E9%9A%8F%E6%89%8B%E7%AC%94%E8%AE%B0/%E8%87%AA%E5%8A%A8%E5%8C%96%E6%B5%8B%E8%AF%95%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/" itemprop="url" rel="index"><span itemprop="name">自动化测试环境搭建</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="操作系统"><a href="#操作系统" class="headerlink" title="操作系统"></a>操作系统</h3><p>windows</p>
<h3 id="基础配置"><a href="#基础配置" class="headerlink" title="基础配置"></a>基础配置</h3><h4 id="Git安装配置"><a href="#Git安装配置" class="headerlink" title="Git安装配置"></a>Git安装配置</h4><p>下载地址：<a target="_blank" rel="noopener" href="https://git-scm.com/downloads">https://git-scm.com/downloads</a><br>安装（推荐）：<a target="_blank" rel="noopener" href="https://git-scm.com/book/zh/v1/">https://git-scm.com/book/zh/v1/</a></p>
<h4 id="Jdk安装配置"><a href="#Jdk安装配置" class="headerlink" title="Jdk安装配置"></a>Jdk安装配置</h4><p>下载地址：<br><a target="_blank" rel="noopener" href="https://www.oracle.com/technetwork/java/javase/downloads/jdk8-downloads-2133151.html">https://www.oracle.com/technetwork/java/javase/downloads/jdk8-downloads-2133151.html</a><br>安装（推荐）：<a target="_blank" rel="noopener" href="https://www.cnblogs.com/tiankong101/p/4226559.html">https://www.cnblogs.com/tiankong101/p/4226559.html</a></p>
<h4 id="Tomcat安装配置"><a href="#Tomcat安装配置" class="headerlink" title="Tomcat安装配置"></a>Tomcat安装配置</h4><p>下载地址：<a target="_blank" rel="noopener" href="https://tomcat.apache.org/download-90.cgi">https://tomcat.apache.org/download-90.cgi</a><br>安装（推荐）：解压到指定目录下即可</p>
<h4 id="Robot-framework-配置"><a href="#Robot-framework-配置" class="headerlink" title="Robot framework 配置"></a>Robot framework 配置</h4><p>1)Python2.7安装配置<br>下载地址：<a target="_blank" rel="noopener" href="https://www.python.org/downloads/">https://www.python.org/downloads/</a></p>
<p>2)ride安装配置<br>下载安装（推荐）：<br><a target="_blank" rel="noopener" href="https://www.cnblogs.com/yinrw/p/5837828.html">https://www.cnblogs.com/yinrw/p/5837828.html</a></p>
<h4 id="Jenkins-配置"><a href="#Jenkins-配置" class="headerlink" title="Jenkins 配置"></a>Jenkins 配置</h4><p>下载地址：<a target="_blank" rel="noopener" href="https://jenkins.io/download/">https://jenkins.io/download/</a><br>下载jenkins.war,放在tomcat下，启动tomcat<br>配置（推荐）：<a target="_blank" rel="noopener" href="https://www.cnblogs.com/c9999/p/6399367.html">https://www.cnblogs.com/c9999/p/6399367.html</a></p>
<p>在jenkins-master节点的jenkins上安装Robot Framework插件<br>如果在线安装插件报下图错误，请尝试离线安装<br><img src="/img/ride_1.png" alt="image"><br>插件下载地址：<a target="_blank" rel="noopener" href="http://mirrors.jenkins-ci.org/plugins/robot/latest/">http://mirrors.jenkins-ci.org/plugins/robot/latest/</a></p>
<h4 id="jenkins-slave-windows工具安装"><a href="#jenkins-slave-windows工具安装" class="headerlink" title="jenkins-slave-windows工具安装"></a>jenkins-slave-windows工具安装</h4><p>安装谷歌浏览器<br>安装git客户端<br>安装Gpg4win</p>
<h4 id="jenkins-master上windows从节点的配置"><a href="#jenkins-master上windows从节点的配置" class="headerlink" title="jenkins-master上windows从节点的配置"></a>jenkins-master上windows从节点的配置</h4><p>参考  <a target="_blank" rel="noopener" href="https://www.jianshu.com/p/20124cdee8e9">https://www.jianshu.com/p/20124cdee8e9</a><br>     <a target="_blank" rel="noopener" href="https://www.jianshu.com/p/ef8d3109ac5f">https://www.jianshu.com/p/ef8d3109ac5f</a><br>     <a target="_blank" rel="noopener" href="http://blog.sina.com.cn/s/blog_13cc013b50102wiau.html">http://blog.sina.com.cn/s/blog_13cc013b50102wiau.html</a><br>     <a target="_blank" rel="noopener" href="https://www.jianshu.com/p/1d0eb3fff364">https://www.jianshu.com/p/1d0eb3fff364</a><br>配置环境变量<br>将从节点上的环境变量Path框中的值复制粘贴到Node Properties中的新增环境变量中</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">%SystemRoot%\system32;%SystemRoot%;%SystemRoot%\System32\Wbem;%SYSTEMROOT%\System32\WindowsPowerShell\v1.0;C:\Python27;C:\Python27\Scripts;C:\station\Git\cmd;%JAVA_HOME%\bin;%JAVA_HOME%\jre\bin;C:\station\Gpg4win\..\GnuPG\bin;C:\Google\Chrome\Application;C:\Windows\System32</span><br></pre></td></tr></table></figure>
<p><img src="/img/ride_2.png" alt="image"><br>修改slave-agent.jnlp下载地址<br>Jenkins -&gt; ”系统管理” -&gt; “系统设置”，如下，找到“Jenkins Location” -&gt;  “Jenkins URL”,把其中的URL地址改成jenkins-master的访问网址<br><img src="/img/ride_3.png" alt="image"><br>点击Launch下载slave-agent.jnlp后,复制到jenkins-slave-windows工作目录下，启动即可</p>
<p>点击launch</p>
<p>安装该文件，</p>
<p>环境变量配置如图所示<br>C:\station\Python27;C:\station\Python27\Scripts;C:\Program Files (x86)\Google\Chrome\Application;C:\Windows\System32;<br>启动方式没有java web start解决办法<br>1：打开”系统管理”——“Configure Global Security”<br>2：启用安全<br>3：随机选取<br>如图所示：<br>系统管理全局安全配置代理<br>是否制定端口，根据自己的实际情况</p>
<p>Jenkins master&#x2F;slave 主从机制配置<br>Master主机系统：linux<br>Slave 机系统：windows&#x2F;linux</p>
<p>	master主机与slave机之间的端口问题<br> 解决办法  制定slave端口 参考文档 <a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/17472291/jenkins-slave-port-number-for-firewall">https://stackoverflow.com/questions/17472291/jenkins-slave-port-number-for-firewall</a><br>TCP<br>49187 - Fixed jnlp port<br>8080 - jenkins http port</p>
<p>在Jenkins中环境变量有：<br>•	主机中的系统环境变量<br>•	Master&#x2F;Slave节点设置的环境变量<br>•	Job执行时的环境变量（<a href="http://ip:port/jenkins/env-vars.html/、参数化构建时的参数也会被设置为环境变量、一些插件提供的环境变量）">http://ip:port/jenkins/env-vars.html/、参数化构建时的参数也会被设置为环境变量、一些插件提供的环境变量）</a><br>其中，如果环境变量名称相同，后者会覆盖前者<br>	在使用Jenkins的过程中，多次遇到Jenkins job中无法获取Slave上的环境变量的情况，以pipeline script 构建失败居多，出现问题如图所示：</p>
<p>构建pipeline</p>
<p>查看此处的环境变量是否是slave机的环境变量<br>解决方法：<br>•	使用绝对路径的命令<br>•	在Jenkins的job中设置环境变量参数<br>•	在Jenkins的节点配置中设置环境变量<br>当然，个人感觉其中最友好的方式是在Jenkins的节点配置中设置环境变量<br>注意：要确定jenkins 系统管理系统设置全局属性环境变量<br>是否做了配置，如果做了配置，slave节点设置的环境变量就会被覆盖<br>Master主机</p>
<p>Slave节点节点属性环境变量</p>
<p>Pipeline script stage 里设置环境变量<br>env.PATH &#x3D; “。。。”</p>
<p>环境变量生效顺序<br>既然上面有那么多的地方可以设置环境变量，当多个地方都有定义的时候，<br>全局环境变量 &lt; Slave 配置环境变量 &lt; Job 参数 &lt; Job injected 环境变量<br>一般不Override系统变量，也就是说不重复定义系统内置的变量，否则可能出现不可预知的问题。<br>s3cmd 配置<br>下载地址：<a target="_blank" rel="noopener" href="https://s3tools.org/download">https://s3tools.org/download</a><br>安装（推荐）：<a target="_blank" rel="noopener" href="https://tecadmin.net/setup-s3cmd-in-windows/">https://tecadmin.net/setup-s3cmd-in-windows/</a><br>    <a target="_blank" rel="noopener" href="https://www.digitalocean.com/docs/spaces/resources/s3cmd/">https://www.digitalocean.com/docs/spaces/resources/s3cmd/</a><br>安装s3cmd ,并运行 python s3cmd –configure 配置信息<br>Enter new values or accept defaults in brackets with Enter.<br>Refer to user manual for detailed description of all options.<br>Access key and Secret key are your identifiers for Amazon S3. Leave them empty for using the env variables.<br>Access Key []:必填（ceph 申请）<br>Secret Key []:必填（ceph 申请）<br>Default Region [US]:<br>Use “s3.amazonaws.com” for S3 Endpoint and not modify it to the target Amazon S3.<br>S3 Endpoint [s3.amazonaws.com]: 必填 远程ceph ip地址:port(如有)<br>Use “%(bucket)s.s3.amazonaws.com” to the target Amazon S3. “%(bucket)s” and “%(location)s” vars can be used if the target S3 system supports dns based buckets.<br>DNS-style bucket+hostname:port template for accessing a bucket []: devops（必填）<br>Encryption password is used to protect your files from reading<br>by unauthorized persons while in transfer to S3<br>Encryption password:<br>Path to GPG program []:<br>When using secure HTTPS protocol all communication with Amazon S3<br>servers is protected from 3rd party eavesdropping. This method is<br>slower than plain HTTP, and can only be proxied with Python 2.7 or newer<br>Use HTTPS protocol []: No<br>On some networks all internet access must go through a HTTP proxy.<br>Try setting it here if you can’t connect to S3 directly<br>HTTP Proxy server name:<br>New settings:<br> Access Key: EXAMPLES7UQOTHDTF3GK4<br> Secret Key: b8e1ec97b97bff326955375c5example<br> Default Region: US<br> S3 Endpoint: nyc3.digitaloceanspaces.com<br> DNS-style bucket+hostname:port template for accessing a bucket: %(bucket)s.n<br>yc3.digitaloceanspaces.com<br> Encryption password: secure_password<br> Path to GPG program: &#x2F;usr&#x2F;bin&#x2F;gpg<br> Use HTTPS protocol: True<br> HTTP Proxy server name:<br> HTTP Proxy server port: 0<br>Test access with supplied credentials? [Y&#x2F;n] Y<br>Please wait, attempting to list all buckets…<br>Success. Your access key and secret key worked fine :-)<br>Now verifying that encryption works…<br>Success. Encryption and decryption worked fine :-)<br>Save settings? [y&#x2F;N] Y<br>Configuration saved to ‘生产配置文件地址’<br>Windows配置文件 s3cmd.ini<br>Linux配置文件 .s3cfg<br>运行页面</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://wangdj104.github.io/2019/07/30/Ceph%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="wangdj">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="wdj's blog">
      <meta itemprop="description" content="记录生活中的点点滴滴">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | wdj's blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2019/07/30/Ceph%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/" class="post-title-link" itemprop="url">Ceph文件系统</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">نُشر في</span>
      

      <time title="أُنشأ: 2019-07-30 00:00:13 / عُدل: 00:07:06" itemprop="dateCreated datePublished" datetime="2019-07-30T00:00:13+08:00">2019-07-30</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">في</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E6%9C%8D%E5%8A%A1%E9%85%8D%E7%BD%AE%E6%96%87%E6%A1%A3/" itemprop="url" rel="index"><span itemprop="name">服务配置文档</span></a>
        </span>
          ، 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E6%9C%8D%E5%8A%A1%E9%85%8D%E7%BD%AE%E6%96%87%E6%A1%A3/Ceph%E6%9C%8D%E5%8A%A1/" itemprop="url" rel="index"><span itemprop="name">Ceph服务</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>1)disable iptables&amp;selinux</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> -n <span class="string">&quot;正在配置iptables防火墙……&quot;</span></span><br><span class="line">systemctl stop firewalld &gt; /dev/null 2&gt;&amp;1</span><br><span class="line">systemctl <span class="built_in">disable</span> firewalld  &gt; /dev/null 2&gt;&amp;1</span><br><span class="line"><span class="keyword">if</span> [ $? -eq 0 ];<span class="keyword">then</span></span><br><span class="line"><span class="built_in">echo</span> -n <span class="string">&quot;Iptables防火墙初始化完毕！&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> -n <span class="string">&quot;正在关闭SELinux……&quot;</span></span><br><span class="line">setenforce 0 &gt; /dev/null 2&gt;&amp;1</span><br><span class="line">sed -i <span class="string">&#x27;/^SELINUX=/s/=.*/=disabled/&#x27;</span> /etc/selinux/config</span><br><span class="line"><span class="keyword">if</span> [ $? -eq 0 ];<span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> -n <span class="string">&quot;SELinux初始化完毕！&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure>
<ol start="2">
<li>set hostname as ceph<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">HOSTNAME=ceph</span><br><span class="line">hostnamectl set-hostname ceph</span><br><span class="line">IP=`ip route |grep src|grep metric|awk -F<span class="string">&quot; &quot;</span> <span class="string">&#x27;&#123; print $9 &#125;&#x27;</span>`</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$IP</span> <span class="variable">$HOSTNAME</span>&quot;</span> &gt;&gt;/etc/hosts</span><br></pre></td></tr></table></figure></li>
<li>install epel.repo<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">yum install -y epel-release</span><br><span class="line"><span class="built_in">cat</span> &lt;&lt;<span class="string">EOF &gt; /etc/yum.repos.d/ceph.repo</span></span><br><span class="line"><span class="string">[Ceph]</span></span><br><span class="line"><span class="string">name=Ceph packages for $basearch</span></span><br><span class="line"><span class="string">baseurl=http://mirrors.163.com/ceph/rpm-jewel/el7/x86_64</span></span><br><span class="line"><span class="string">enabled=1</span></span><br><span class="line"><span class="string">gpgcheck=1</span></span><br><span class="line"><span class="string">type=rpm-md</span></span><br><span class="line"><span class="string">gpgkey=http://mirrors.163.com/ceph/keys/release.asc</span></span><br><span class="line"><span class="string">priority=1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[Ceph-noarch]</span></span><br><span class="line"><span class="string">name=Ceph noarch packages</span></span><br><span class="line"><span class="string">baseurl=http://mirrors.163.com/ceph/rpm-jewel/el7/noarch</span></span><br><span class="line"><span class="string">enabled=1</span></span><br><span class="line"><span class="string">gpgcheck=1</span></span><br><span class="line"><span class="string">type=rpm-md</span></span><br><span class="line"><span class="string">gpgkey=http://mirrors.163.com/ceph/keys/release.asc</span></span><br><span class="line"><span class="string">priority=1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[ceph-source]</span></span><br><span class="line"><span class="string">name=Ceph source packages</span></span><br><span class="line"><span class="string">baseurl=http://mirrors.163.com/ceph/rpm-jewel/el7/SRPMS</span></span><br><span class="line"><span class="string">enabled=1</span></span><br><span class="line"><span class="string">gpgcheck=1</span></span><br><span class="line"><span class="string">type=rpm-md</span></span><br><span class="line"><span class="string">gpgkey=http://mirrors.163.com/ceph/keys/release.asc</span></span><br><span class="line"><span class="string">priority=1</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>
4)update system &amp; install ceph-deploy<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum update -y &amp;&amp;yum clean all &amp;&amp;yum -y install ceph-deploy</span><br></pre></td></tr></table></figure></li>
<li>设置本机密匙<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">  ssh-keygen -t rsa -P <span class="string">&quot;&quot;</span> -f ~/.ssh/id_rsa</span><br><span class="line"><span class="built_in">cat</span> ~/.ssh/id_rsa.pub &gt;&gt; ~/.ssh/authorized_keys</span><br></pre></td></tr></table></figure>
6)ceph服务初始化<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yum clean all &amp;&amp;yum -y install ceph-deploy</span><br><span class="line"><span class="built_in">mkdir</span> /etc/ceph &amp;&amp;<span class="built_in">cd</span> /etc/ceph</span><br><span class="line">ceph-deploy new ceph</span><br></pre></td></tr></table></figure>
7)修改配置文件<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cp</span> ceph.conf ceph.conf.bak</span><br><span class="line">sed -i <span class="string">&#x27;s@^$@osd_pool_default_size = 1@g&#x27;</span> ceph.conf</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;mon_pg_warn_max_per_osd = 1000&quot;</span> &gt;&gt; /etc/ceph/ceph.conf</span><br></pre></td></tr></table></figure>
8)安装ceph<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ceph-deploy install ceph</span><br></pre></td></tr></table></figure>
9)创建monitor服务<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ceph-deploy mon create ceph</span><br><span class="line">ceph-deploy  gatherkeys ceph</span><br></pre></td></tr></table></figure></li>
<li>准备osd<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">mkfs.xfs  /dev/sdb</span><br><span class="line"><span class="built_in">mkdir</span> -p /var/local/osd</span><br><span class="line">mount /dev/sdb  /var/local/osd/</span><br><span class="line"><span class="built_in">chown</span> -R ceph:ceph /var/local/osd*      <span class="comment">#创建osd</span></span><br><span class="line">ceph-deploy osd prepare ceph:/var/local/osd  <span class="comment">#激活osd</span></span><br><span class="line">ceph-deploy osd activate ceph:/var/local/osd</span><br><span class="line"><span class="built_in">chown</span> -R ceph:ceph /var/local/osd*   <span class="comment">#有些同学可能会忘记配置目录权限引起激活osd失败 </span></span><br><span class="line"><span class="comment">#查看状态：###</span></span><br><span class="line">ceph-deploy osd list ceph</span><br></pre></td></tr></table></figure>
11）修改配置文件权限<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ceph-deploy admin ceph</span><br><span class="line"><span class="built_in">chmod</span> +r /etc/ceph/*</span><br></pre></td></tr></table></figure>
12）部署mds服务<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ceph-deploy mds create ceph</span><br><span class="line">ceph mds <span class="built_in">stat</span></span><br></pre></td></tr></table></figure>
13）创建ceph文件系统<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ceph fs <span class="built_in">ls</span></span><br><span class="line">ceph osd pool create cephfs_data 128</span><br><span class="line">ceph osd pool create cephfs_metadata 128</span><br><span class="line">ceph fs new cephfs cephfs_metadata cephfs_data</span><br><span class="line">ceph fs <span class="built_in">ls</span></span><br></pre></td></tr></table></figure>
14）挂载Ceph文件系统<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> /ceph</span><br><span class="line">yum install -y ceph-fuse</span><br><span class="line">IP=`ip route |grep src|grep metric|awk -F<span class="string">&quot; &quot;</span> <span class="string">&#x27;&#123; print $9 &#125;&#x27;</span>`</span><br><span class="line">ceph-fuse -m <span class="variable">$IP</span>:7480/ /ceph</span><br><span class="line"><span class="comment">#ceph-fuse -m $IP:6789/ /ceph</span></span><br><span class="line"><span class="built_in">df</span> -Th</span><br></pre></td></tr></table></figure>
15）查看ceph状态<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ceph mon <span class="built_in">stat</span></span><br><span class="line">ceph osd <span class="built_in">stat</span></span><br><span class="line">ceph osd tree  <span class="comment">#显示crush图</span></span><br><span class="line">ceph pg <span class="built_in">stat</span></span><br><span class="line"><span class="built_in">set</span> password <span class="keyword">for</span> root@localhost = password(<span class="string">&#x27;S@Aj#XrpS114y!9$&#x27;</span>);  <span class="comment">#设置mysql密码</span></span><br></pre></td></tr></table></figure></li>
</ol>
<p>##部署ceph对象存储-bucket<br>1)安装ceph-radosgw</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install ceph-radosgw</span><br></pre></td></tr></table></figure>
<p>2)部署rgw</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ceph-deploy rgw create ceph  <span class="comment">#需在/etc/ceph目录下执行</span></span><br></pre></td></tr></table></figure>
<p>3)如果要修改为80端口，可修改配置文件  重启</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"> vim /etc/ceph/ceph.conf</span><br><span class="line"> [client.rgw.ceph-node1]</span><br><span class="line">rgw_frontends = <span class="string">&quot;civetweb port=80&quot;</span></span><br><span class="line">sudo systemctl restart ceph-radosgw@rgw.ceph.service</span><br><span class="line">netstat -tnlp |grep 7480</span><br></pre></td></tr></table></figure>
<p>4)创建池</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">wget https://raw.githubusercontent.com/aishangwei/ceph-demo/master/ceph-deploy/rgw/pool</span><br><span class="line">wget  https://raw.githubusercontent.com/aishangwei/ceph-demo/master/ceph-deploy/rgw/create_pool.sh</span><br><span class="line"></span><br><span class="line"><span class="built_in">cat</span> create_pool.sh</span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line">PG_NUM=250</span><br><span class="line">PGP_NUM=250</span><br><span class="line">SIZE=3</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> `<span class="built_in">cat</span> /etc/ceph/pool`</span><br><span class="line">        <span class="keyword">do</span></span><br><span class="line">        ceph osd pool create <span class="variable">$i</span> <span class="variable">$PG_NUM</span></span><br><span class="line">        ceph osd pool <span class="built_in">set</span> <span class="variable">$i</span> size <span class="variable">$SIZE</span></span><br><span class="line">        <span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> `<span class="built_in">cat</span> /etc/ceph/pool`</span><br><span class="line">        <span class="keyword">do</span></span><br><span class="line">        ceph osd pool <span class="built_in">set</span> <span class="variable">$i</span> pgp_num <span class="variable">$PGP_NUM</span></span><br><span class="line">        <span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">chmod</span> +x create_pool.sh</span><br><span class="line">./create_pool.sh</span><br></pre></td></tr></table></figure>
<p>5)测试是否能访问ceph集群</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ls</span> -l /var/lib/ceph/</span><br><span class="line"><span class="built_in">cp</span> /var/lib/ceph/radosgw/ceph-rgw.ceph/keyring ./</span><br><span class="line">ceph -s -k keyring --name client.rgw.ceph</span><br></pre></td></tr></table></figure>
<p>6)使用S3 API访问ceph对象存储<br>创建radosgw用户</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">radosgw-admin user create --uid=radosgw --display-name=<span class="string">&quot;radosgw&quot;</span></span><br></pre></td></tr></table></figure>
<p>7)安装s3cmd客户端</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">yum install -y s3cmd</span><br><span class="line">s3cmd --configure  //注意该Access Key填写radosgw的access_key  Secret Key同样</span><br><span class="line">编辑s3配置文件：<span class="built_in">cat</span> .s3cfg</span><br><span class="line">创建桶并放入文件</span><br><span class="line">s3cmd mb s3://devops</span><br><span class="line">s3cmd <span class="built_in">ls</span></span><br><span class="line">s3cmd put /etc/hosts s3://devops</span><br></pre></td></tr></table></figure>
<p>8)使用Swift API访问ceph对象存储</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">radosgw-admin subuser create --uid=radosgw --subuser=radosgw:swift --access=full</span><br><span class="line">yum install python-pip -y</span><br><span class="line">pip install --upgrade python-swiftclient</span><br><span class="line">swift -A http://ceph:7480/auth/1.0 -U radosgw:swift -K 6Dz8f8ubJDNhr57jV5tM0xeFSzBxXN1MzK59qdMh list</span><br><span class="line">swift -A http://ceph:7480/auth/1.0 -U radosgw:swift -K 6Dz8f8ubJDNhr57jV5tM0xeFSzBxXN1MzK59qdMh list</span><br><span class="line">swift -A http://ceph:7480/auth/1.0 -U radosgw:swift -K 6Dz8f8ubJDNhr57jV5tM0xeFSzBxXN1MzK59qdMh post second-bucket</span><br><span class="line">swift -A http://ceph:7480/auth/1.0 -U radosgw:swift -K 6Dz8f8ubJDNhr57jV5tM0xeFSzBxXN1MzK59qdMh list</span><br></pre></td></tr></table></figure>
<p>9)最后验证</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">s3cmd <span class="built_in">ls</span></span><br><span class="line">2019-02-15 07:45  s3://devops</span><br><span class="line">2019-02-15 08:18  s3://second-bucket</span><br><span class="line">s3cmd <span class="built_in">ls</span> s3://devops/20190619/</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://wangdj104.github.io/2019/07/29/LVM%E7%A3%81%E7%9B%98%E6%89%A9%E5%AE%B9%E5%8F%8A%E7%A3%81%E7%9B%98%E6%8C%82%E8%BD%BD/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="wangdj">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="wdj's blog">
      <meta itemprop="description" content="记录生活中的点点滴滴">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | wdj's blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2019/07/29/LVM%E7%A3%81%E7%9B%98%E6%89%A9%E5%AE%B9%E5%8F%8A%E7%A3%81%E7%9B%98%E6%8C%82%E8%BD%BD/" class="post-title-link" itemprop="url">LVM磁盘扩容及磁盘挂载</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">نُشر في</span>
      

      <time title="أُنشأ: 2019-07-29 14:13:25 / عُدل: 16:58:32" itemprop="dateCreated datePublished" datetime="2019-07-29T14:13:25+08:00">2019-07-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">في</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E9%9A%8F%E6%89%8B%E7%AC%94%E8%AE%B0/" itemprop="url" rel="index"><span itemprop="name">随手笔记</span></a>
        </span>
          ، 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E9%9A%8F%E6%89%8B%E7%AC%94%E8%AE%B0/LVM%E7%A3%81%E7%9B%98%E6%89%A9%E5%AE%B9%E5%8F%8A%E7%A3%81%E7%9B%98%E6%8C%82%E8%BD%BD/" itemprop="url" rel="index"><span itemprop="name">LVM磁盘扩容及磁盘挂载</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>   LVM是逻辑盘卷管理（Logical Volume Manager）的简称，他是磁盘管理的另一种工具，目前基本上所有操作系统均支持，LVM是建立在硬盘和分区之上的一个逻辑层，来提高磁盘分区管理的灵活性。<br><img src="/img/LVM_1.png" alt="image"></p>
<h3 id="磁盘扩容"><a href="#磁盘扩容" class="headerlink" title="磁盘扩容"></a>磁盘扩容</h3><p>•	PV（Phsical Volume，物理卷），PV是VG的组成部分，有分区构成，多块盘的时候，可以把一块盘格式化成一个主分区，然后用这个分区做成一个PV，只有一块盘的时候，可以这块盘的某一个分区做成一个PV，实际上一个PV就一个分区。<br>•	VG（Volume Group， 卷组），有若干个PV组成，作用就是将PV组成到以前，然后再重新划分空间。<br>•	LV（Logical Volume，逻辑卷），LV就是从VG中划分出来的卷，LV的使用要比PV灵活的多，可以在空间不够的情况下，增加空间。<br>(1) 创建磁盘分区</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo fdisk /dev/sda</span><br></pre></td></tr></table></figure>
<p>选择 n 创建分区 （默认值）<br>选择 t 修改分区类型 8e  （note:8e为Linux LVM）<br>选择 w 写入分区表</p>
<p>(2) 请求操作系统重新加载分区表</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo partprobe</span><br></pre></td></tr></table></figure>

<p>(3) 创建物理卷PV</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo pvcreate /dev/sda3</span><br></pre></td></tr></table></figure>

<p>(4) 扩展卷组VG</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo vgscan</span><br><span class="line">sudo vgextend VolGroup00 /dev/sda3</span><br><span class="line">Sudo vgdisplay</span><br></pre></td></tr></table></figure>

<p>(5) 扩展逻辑卷LV</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo lvextend -l +100%free /dev/VolGroup00/LogVol01</span><br><span class="line">或者sudo lvextend –L +50G /dev/VolGroup00/LogVol01</span><br><span class="line">sudo lvdisplay /dev/VolGroup00/LogVol01</span><br></pre></td></tr></table></figure>

<p>(6) 扩展文件系统容量</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo xfs_growfs /dev/VolGroup00/LogVol01</span><br></pre></td></tr></table></figure>
<h3 id="磁盘挂载"><a href="#磁盘挂载" class="headerlink" title="磁盘挂载"></a>磁盘挂载</h3><p>(1) 查看操作系统有几块硬盘</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo fdisk -l</span><br></pre></td></tr></table></figure>
<p><img src="/img/LVM_2.png" alt="image"><br>(2) 创建pv</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo pvcreate /dev/sdb</span><br><span class="line">sudo pvdisplay</span><br></pre></td></tr></table></figure>
<p><img src="/img/LVM_3.png" alt="image"><br>(3) 创建vg</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo vgcreate vg_k8s /dev/sdb</span><br><span class="line">sudo vgdisplay vg_k8s</span><br></pre></td></tr></table></figure>
<p><img src="/img/LVM_4.png" alt="image"><br>(4) 创建lv，并挂载</p>
<ol>
<li>创建lv<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo lvcreate -n lv_k8s -l 100%FREE vg_k8s</span><br><span class="line">sudo lvscan</span><br></pre></td></tr></table></figure>
<img src="/img/LVM_5.png" alt="image"></li>
<li>在根目录下创建目录k8s<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="built_in">mkdir</span> /k8s</span><br></pre></td></tr></table></figure>
3）对逻辑卷进行格式化：<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo mkfs -t xfs -n ftype=1 /dev/vg_k8s/lv_k8s</span><br></pre></td></tr></table></figure>
<img src="/img/LVM_6.png" alt="image"></li>
<li>将逻辑卷&#x2F;dev&#x2F;vg_k8s&#x2F;lv_k8s挂载到&#x2F;k8s目录下:<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo mount /dev/vg_k8s/lv_k8s /k8s</span><br><span class="line">sudo <span class="built_in">df</span> -h</span><br></pre></td></tr></table></figure>
<img src="/img/LVM_7.png" alt="image"><br>5)修改&#x2F;etc&#x2F;fstab，添加挂载信息，实现开机自动挂载<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo vi /etc/fstab</span><br></pre></td></tr></table></figure>
<img src="/img/LVM_8.png" alt="image"></li>
<li>重新挂载<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo mount -a</span><br></pre></td></tr></table></figure></li>
<li>重启服务器生效</li>
</ol>
<p>注意：创建pv时，可能出现&#x2F;dev&#x2F;sdb明明存在并且没被使用，但却无法使用&#x2F;dev&#x2F;sdb创建pv。<br>解决办法：执行 dd if&#x3D;&#x2F;dev&#x2F;urandom of&#x3D;&#x2F;dev&#x2F;sdb bs&#x3D;512 count&#x3D;64 然后尝试创建pv成功。<br>具体原因见  <a target="_blank" rel="noopener" href="http://blog.sina.com.cn/s/blog_701300bc0100xmr4.html">http://blog.sina.com.cn/s/blog_701300bc0100xmr4.html</a></p>
<h3 id="修改逻辑盘文件系统类型及重新挂载"><a href="#修改逻辑盘文件系统类型及重新挂载" class="headerlink" title="修改逻辑盘文件系统类型及重新挂载"></a>修改逻辑盘文件系统类型及重新挂载</h3><p>(1)df -Th  查看的是file system, 也就是文件系统层的磁盘大小<br>df查看的是文件系统层的磁盘大小,-T 文件系统类型,-h 方便阅读方式显示<br><img src="/img/LVM_9.png" alt="image"><br>(2)mount 查看挂载<br><img src="/img/LVM_10.png" alt="image"><br>(3)umount &amp;&amp; mount<br><img src="/img/LVM_11.png" alt="image"><br>(4)fdisk -l  查看当前的磁盘分区信息<br><img src="/img/LVM_12.png" alt="image"><br>(5)lsblk 查看的是block device,也就是逻辑磁盘大小。<br><img src="/img/LVM_13.png" alt="image"><br>(6)修改文件系统格式</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkfs -t xfs -n ftype=1 -f /dev/mapper/VG4736-lv_32</span><br></pre></td></tr></table></figure>
<p><img src="/img/LVM_14.png" alt="image"><br>(7)重新挂载</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mount /dev/mapper/VG4736-lv_32 /data01</span><br></pre></td></tr></table></figure>
<p><img src="/img/LVM_15.png" alt="image"><br>(8)lsblk<br><img src="/img/LVM_16.png" alt="image"><br>(9)<br><img src="/img/LVM_17.png" alt="image"><br><img src="/img/LVM_18.png" alt="image"></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://wangdj104.github.io/2019/07/21/Glusterfs%E6%9C%8D%E5%8A%A1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="wangdj">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="wdj's blog">
      <meta itemprop="description" content="记录生活中的点点滴滴">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | wdj's blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2019/07/21/Glusterfs%E6%9C%8D%E5%8A%A1/" class="post-title-link" itemprop="url">Glusterfs服务</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">نُشر في</span>

      <time title="أُنشأ: 2019-07-21 22:33:12" itemprop="dateCreated datePublished" datetime="2019-07-21T22:33:12+08:00">2019-07-21</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">عُدل في</span>
      <time title="عُدل: 2019-08-30 15:16:56" itemprop="dateModified" datetime="2019-08-30T15:16:56+08:00">2019-08-30</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">في</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E6%9C%8D%E5%8A%A1%E9%85%8D%E7%BD%AE%E6%96%87%E6%A1%A3/" itemprop="url" rel="index"><span itemprop="name">服务配置文档</span></a>
        </span>
          ، 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E6%9C%8D%E5%8A%A1%E9%85%8D%E7%BD%AE%E6%96%87%E6%A1%A3/Glusterfs%E6%9C%8D%E5%8A%A1/" itemprop="url" rel="index"><span itemprop="name">Glusterfs服务</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>安装包下载链接: <a target="_blank" rel="noopener" href="https://pan.baidu.com/s/1-HLP6AbAdsy5-v82CBZNIQ">https://pan.baidu.com/s/1-HLP6AbAdsy5-v82CBZNIQ</a> 提取码: pkde<br>本文部署glusterfs集群在四台机器<br>192.168.117.129  gfs129<br>192.168.117.130  gfs130<br>192.168.117.131  gfs131<br>192.168.117.132  gfs132</p>
<h3 id="GlusterFs离线安装-需在四台机器上操作"><a href="#GlusterFs离线安装-需在四台机器上操作" class="headerlink" title="GlusterFs离线安装(需在四台机器上操作)"></a>GlusterFs离线安装(需在四台机器上操作)</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">rpm -Uvh xz-libs-5.2.2-1.el7.x86_64.rpm xz-5.2.2-1.el7.x86_64.rpm xz-libs-5.2.2-1.el7.i686.rpm --force --nodeps</span><br><span class="line">rpm -ihv glusterfs-4.0.2-1.el7.x86_64.rpm glusterfs-libs-4.0.2-1.el7.x86_64.rpm --force --nodeps</span><br><span class="line">rpm -ihv glusterfs-fuse-4.0.2-1.el7.x86_64.rpm glusterfs-client-xlators-4.0.2-1.el7.x86_64.rpm glusterfs-cli-4.0.2-1.el7.x86_64.rpm --force --nodeps</span><br><span class="line">rpm -ihv userspace-rcu-0.10.0-3.el7.x86_64.rpm --force --nodeps</span><br><span class="line">rpm -ivh rpcbind-0.2.0-44.el7.x86_64.rpm libtirpc-0.2.4-0.10.el7.x86_64.rpm --force --nodeps</span><br><span class="line">rpm -ihv glusterfs-server-4.0.2-1.el7.x86_64.rpm glusterfs-api-4.0.2-1.el7.x86_64.rpm --force --nodeps</span><br></pre></td></tr></table></figure>
<h3 id="启动-Glusterfs"><a href="#启动-Glusterfs" class="headerlink" title="启动 Glusterfs"></a>启动 Glusterfs</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl start glusterd.service</span><br><span class="line">systemctl <span class="built_in">enable</span> glusterd.service</span><br></pre></td></tr></table></figure>
<h3 id="添加hosts文件"><a href="#添加hosts文件" class="headerlink" title="添加hosts文件"></a>添加hosts文件</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># vim /etc/hosts</span></span><br><span class="line">192.168.117.129  gfs129</span><br><span class="line">192.168.117.130  gfs130</span><br><span class="line">192.168.117.131  gfs131</span><br><span class="line">192.168.117.132  gfs132</span><br></pre></td></tr></table></figure>
<p>【说明】添加hosts文件这一步不是必需。如果使用IP地址，之后添加节点时也必需使用IP地址。如果使用hosts文件，则4个节点都必需要添加相同的hosts文件</p>
<h3 id="添加GlusterFS集群节点"><a href="#添加GlusterFS集群节点" class="headerlink" title="添加GlusterFS集群节点"></a>添加GlusterFS集群节点</h3><p>【说明】本小节操作在任意节点操作即可,且进行操作前要先检查每台机器的防火墙是否关闭。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@gfs129 ~]<span class="comment"># gluster peer probe gfs129</span></span><br><span class="line">peer probe: success. Probe on localhost not needed</span><br><span class="line">[root@gfs129 ~]<span class="comment"># gluster peer probe gfs130</span></span><br><span class="line">peer probe: success.</span><br><span class="line">[root@gfs129 ~]<span class="comment"># gluster peer probe gfs131</span></span><br><span class="line">peer probe: success.</span><br><span class="line">[root@gfs129 ~]<span class="comment"># gluster peer probe gfs132</span></span><br><span class="line">peer probe: success.</span><br></pre></td></tr></table></figure>
<p>【说明】移除节点gluster peer detach gfs132</p>
<h3 id="查看GlusterFS集群状态（任意节点）"><a href="#查看GlusterFS集群状态（任意节点）" class="headerlink" title="查看GlusterFS集群状态（任意节点）"></a>查看GlusterFS集群状态（任意节点）</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@gfs129 ~]<span class="comment"># gluster peer status</span></span><br><span class="line">Number of Peers: 3</span><br><span class="line"></span><br><span class="line">Hostname: gfs130</span><br><span class="line">Uuid: f5af69ef-545a-4e34-be4a-4b3ab10b7caa</span><br><span class="line">State: Peer <span class="keyword">in</span> Cluster (Connected)</span><br><span class="line"></span><br><span class="line">Hostname: gfs131</span><br><span class="line">Uuid: 239e6236-ec2f-4b75-a39e-57eb8bd7144e</span><br><span class="line">State: Peer <span class="keyword">in</span> Cluster (Connected)</span><br><span class="line"></span><br><span class="line">Hostname: gfs132</span><br><span class="line">Uuid: 631f8255-06d7-45f3-ade3-da6eef88c908</span><br><span class="line">State: Peer <span class="keyword">in</span> Cluster (Connected)</span><br></pre></td></tr></table></figure>
<h3 id="查看GlusterFS-volume"><a href="#查看GlusterFS-volume" class="headerlink" title="查看GlusterFS volume"></a>查看GlusterFS volume</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@gfs129 ~]<span class="comment"># gluster volume info</span></span><br><span class="line">No volumes present</span><br></pre></td></tr></table></figure>
<h3 id="创建Glusterfs所需磁盘"><a href="#创建Glusterfs所需磁盘" class="headerlink" title="创建Glusterfs所需磁盘"></a>创建Glusterfs所需磁盘</h3><p>（1）查看磁盘情况<br>fdisk -l<br>（2）添加sdb磁盘<br>关机，菜单栏找到虚拟机—设置，点击硬盘—添加，按步骤走，重新开机就有sdb了<br><img src="/img/glusterfs_1.png" alt="image"><br><img src="/img/glusterfs_2.png" alt="image"> <img src="/img/glusterfs_3.png" alt="image"><br><img src="/img/glusterfs_4.png" alt="image"><br>（3）新建分区</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">[root@gfs129 ~]<span class="comment"># fdisk /dev/sdb</span></span><br><span class="line">Welcome to fdisk (util-linux 2.23.2).</span><br><span class="line"></span><br><span class="line">Changes will remain <span class="keyword">in</span> memory only, <span class="keyword">until</span> you decide to write them.</span><br><span class="line">Be careful before using the write <span class="built_in">command</span>.</span><br><span class="line"></span><br><span class="line">Device does not contain a recognized partition table</span><br><span class="line">Building a new DOS disklabel with disk identifier 0x51a8f067.</span><br><span class="line"></span><br><span class="line">Command (m <span class="keyword">for</span> <span class="built_in">help</span>):      <span class="comment">#输入n回车,n是“new”新建分区的意思</span></span><br><span class="line">Partition <span class="built_in">type</span>:</span><br><span class="line">   p   primary (0 primary, 0 extended, 4 free)</span><br><span class="line">   e   extended</span><br><span class="line">Select (default p):              <span class="comment">#默认值</span></span><br><span class="line">Using default response p</span><br><span class="line">Partition number (1-4, default 1):    <span class="comment">#默认值</span></span><br><span class="line">First sector (2048-8388607, default 2048):    <span class="comment">#默认值</span></span><br><span class="line">Using default value 2048</span><br><span class="line">Last sector, +sectors or +size&#123;K,M,G&#125; (2048-8388607, default 8388607):   <span class="comment">#默认值</span></span><br><span class="line">Using default value 8388607</span><br><span class="line">Partition 1 of <span class="built_in">type</span> Linux and of size 4 GiB is <span class="built_in">set</span></span><br><span class="line"></span><br><span class="line">Command (m <span class="keyword">for</span> <span class="built_in">help</span>): w         <span class="comment"># &quot;write&quot;并回车，意思是对刚才的结果进行保存</span></span><br><span class="line">The partition table has been altered!</span><br><span class="line"></span><br><span class="line">Calling ioctl() to re-read partition table.</span><br><span class="line">Syncing disks.</span><br></pre></td></tr></table></figure>
<p>执行完后，效果如下图：<br><img src="/img/glusterfs_5.png" alt="image"><br>（4）格式化分区为XFS</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkfs.xfs -i size=512 /dev/sdb1</span><br></pre></td></tr></table></figure>
<p>（5）挂载：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> -p /glusterfs-data/data01/</span><br><span class="line">mount /dev/sdb1 /glusterfs-data/data01/</span><br><span class="line"></span><br><span class="line">   vim /etc/fstab</span><br><span class="line">   /dev/sdb1       /glusterfs-data/data01   xfs    defaults        0 0</span><br></pre></td></tr></table></figure>
<p>注意：所有节点都需创建Glusterfs所需磁盘及glusterfs-data数据目录</p>
<h3 id="创建GlusterFS-volume（master节点）"><a href="#创建GlusterFS-volume（master节点）" class="headerlink" title="创建GlusterFS volume（master节点）"></a>创建GlusterFS volume（master节点）</h3><p>分布式复制模式（组合型）, 最少需要4台服务器才能创建。创建分布式复制卷需指定卷类型为replica（复制卷）（否则默认为分布式卷），卷类型后边参数是副本数量。Transport指定传输类型为tcp。传输类型后的brick server数量需是副本数量的倍数，且&gt;&#x3D;2倍。当副本数量与brick server数量不等且符合倍数关系时，即是分布式复制卷</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@gfs129 glusterfs-data]<span class="comment"># gluster volume create devops-volume replica 2 transport tcp gfs129:/glusterfs-data/data01/ gfs130:/glusterfs-data/data01/ gfs131:/glusterfs-data/data01/ gfs132:/glusterfs-data/data01/ force</span></span><br><span class="line">volume create: devops-volume: success: please start the volume to access data</span><br></pre></td></tr></table></figure>

<h3 id="查看GlusterFS-volume-任意节点"><a href="#查看GlusterFS-volume-任意节点" class="headerlink" title="查看GlusterFS volume(任意节点)"></a>查看GlusterFS volume(任意节点)</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root@gfs130 ~]<span class="comment"># gluster volume info</span></span><br><span class="line"></span><br><span class="line">Volume Name: devops-volume</span><br><span class="line">Type: Distributed-Replicate</span><br><span class="line">Volume ID: 14573cf5-bd1d-4ce0-82b9-b44f13db60b3</span><br><span class="line">Status: Created</span><br><span class="line">Snapshot Count: 0</span><br><span class="line">Number of Bricks: 2 x 2 = 4</span><br><span class="line">Transport-<span class="built_in">type</span>: tcp</span><br><span class="line">Bricks:</span><br><span class="line">Brick1: gfs129:/glusterfs-data/data01</span><br><span class="line">Brick2: gfs130:/glusterfs-data/data01</span><br><span class="line">Brick3: gfs131:/glusterfs-data/data01</span><br><span class="line">Brick4: gfs132:/glusterfs-data/data01</span><br><span class="line">Options Reconfigured:</span><br><span class="line">transport.address-family: inet</span><br><span class="line">nfs.disable: on</span><br><span class="line">performance.client-io-threads: off</span><br></pre></td></tr></table></figure>
<h3 id="启动GlusterFS-volume"><a href="#启动GlusterFS-volume" class="headerlink" title="启动GlusterFS volume"></a>启动GlusterFS volume</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@gfs129 glusterfs-data]<span class="comment"># gluster volume start devops-volume</span></span><br><span class="line">volume start: devops-volume: success</span><br></pre></td></tr></table></figure>
<h3 id="再次查看GlusterFS-volume-任意节点"><a href="#再次查看GlusterFS-volume-任意节点" class="headerlink" title="再次查看GlusterFS volume(任意节点)"></a>再次查看GlusterFS volume(任意节点)</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root@gfs130 /]<span class="comment"># gluster volume info</span></span><br><span class="line"></span><br><span class="line">Volume Name: devops-volume</span><br><span class="line">Type: Distributed-Replicate</span><br><span class="line">Volume ID: 14573cf5-bd1d-4ce0-82b9-b44f13db60b3</span><br><span class="line">Status: Started          <span class="comment">#与前一次查看，状态有所改变</span></span><br><span class="line">Snapshot Count: 0</span><br><span class="line">Number of Bricks: 2 x 2 = 4</span><br><span class="line">Transport-<span class="built_in">type</span>: tcp</span><br><span class="line">Bricks:</span><br><span class="line">Brick1: gfs129:/glusterfs-data/data01</span><br><span class="line">Brick2: gfs130:/glusterfs-data/data01</span><br><span class="line">Brick3: gfs131:/glusterfs-data/data01</span><br><span class="line">Brick4: gfs132:/glusterfs-data/data01</span><br><span class="line">Options Reconfigured:</span><br><span class="line">transport.address-family: inet</span><br><span class="line">nfs.disable: on</span><br><span class="line">performance.client-io-threads: off</span><br></pre></td></tr></table></figure>
<h3 id="客户端挂载GlusterFS"><a href="#客户端挂载GlusterFS" class="headerlink" title="客户端挂载GlusterFS"></a>客户端挂载GlusterFS</h3><p>如果GlusterFS集群初始化使用了主机&#x2F;etc&#x2F;hosts中的信息，请在客户端也添加对应的信息。否则挂载过程会报错。这里就是需要在harbor所在的服务器上把hosts文件添加成跟glusterfs上一致，并且也需要在这台服务器上装一个glusterfs的客户端。安装方式同1中Glusterfs离线安装。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost /]<span class="comment"># mkdir -p /gfsdata01volume</span></span><br><span class="line">[root@localhost /]<span class="comment"># mount -t glusterfs gfs130:devops-volume /gfsdata01volume</span></span><br><span class="line">注意：gfs130:devops-volume中也可为129,131,132</span><br></pre></td></tr></table></figure>
<p>挂载成功后，效果如下：<br><img src="/img/glusterfs_6.png" alt="image"></p>
<h3 id="设置开机自动挂载"><a href="#设置开机自动挂载" class="headerlink" title="设置开机自动挂载"></a>设置开机自动挂载</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost harbor]<span class="comment">#  vim /etc/fstab</span></span><br><span class="line">gfs129:devops-volume                      /gfsdata01volume        glusterfs  defaults     0 0</span><br></pre></td></tr></table></figure>
<h3 id="Glusterfs的常用命令"><a href="#Glusterfs的常用命令" class="headerlink" title="Glusterfs的常用命令"></a>Glusterfs的常用命令</h3><p>参考自 <a target="_blank" rel="noopener" href="https://blog.csdn.net/lincoln_2012/article/details/52201227">https://blog.csdn.net/lincoln_2012/article/details/52201227</a></p>
<h4 id="服务器节点"><a href="#服务器节点" class="headerlink" title="服务器节点"></a>服务器节点</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">gluster peer status                          //查看所有节点信息，显示时不包括本节点</span><br><span class="line">gluster peer probe   NODE-NAME               //添加节点</span><br><span class="line">gluster peer detach  NODE-NAME               //移除节点，需要提前将该节点上的brick移除</span><br></pre></td></tr></table></figure>
<h4 id="glusterd服务"><a href="#glusterd服务" class="headerlink" title="glusterd服务"></a>glusterd服务</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">/etc/init.d/glusterd start      //启动glusterd服务</span><br><span class="line">/etc/init.d/glusterd stop      //关闭glusterd服务</span><br><span class="line">/etc/init.d/glusterd status   //查看glusterd服务</span><br></pre></td></tr></table></figure>
<h4 id="创建卷"><a href="#创建卷" class="headerlink" title="创建卷"></a>创建卷</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">&lt;1&gt;复制卷</span><br><span class="line"></span><br><span class="line">语法：  gluster volume create NEW-VOLNAME [replica COUNT] [transport tcp | rdma | tcp, rdma] NEW-BRICK</span><br><span class="line"></span><br><span class="line">示例1：gluster volume create test-volume replica 2 transport tcp server1:/exp1/brick server2:/exp2/brick</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&lt;2&gt;条带卷</span><br><span class="line"></span><br><span class="line">语法：gluster volume create NEW-VOLNAME [stripe COUNT] [transport tcp | rdma | tcp, rdma] NEW-BRICK...</span><br><span class="line"></span><br><span class="line">示例：gluster volume create test-volume stripe 2 transport tcp server1:/exp1/brick server2:/exp2/brick</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&lt;3&gt;分布式卷</span><br><span class="line"></span><br><span class="line">语法：  gluster volume create NEW-VOLNAME [transport tcp | rdma | tcp, rdma] NEW-BRICK</span><br><span class="line"></span><br><span class="line">示例1：gluster volume create test-volume server1:/exp1/brick server2:/exp2/brick</span><br><span class="line">示例2：gluster volume create test-volume transport rdma server1:/exp1/brick server2:/exp2/brick server3:/exp3/brick server4:/exp4/brick</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&lt;4&gt;分布式复制卷</span><br><span class="line"></span><br><span class="line">语法： gluster volume create NEW-VOLNAME [replica COUNT] [transport tcp | rdma | tcp, rdma] NEW-BRICK...</span><br><span class="line">示例： gluster volume create test-volume replica 2 transport tcp server1:/exp1/brick server2:/exp2/brick server3:/exp3/brick server4:/exp4/brick</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&lt;5&gt;分布式条带卷</span><br><span class="line"></span><br><span class="line">语法：gluster volume create NEW-VOLNAME [stripe COUNT] [transport tcp | rdma | tcp, rdma] NEW-BRICK...</span><br><span class="line"></span><br><span class="line">示例：gluster volume create test-volume stripe 2 transport tcp server1:/exp1/brick server2:/exp2/brick server3:/exp3/brick server4:/exp4/brick</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&lt;6&gt;条带复制卷</span><br><span class="line"></span><br><span class="line">语法：gluster volume create NEW-VOLNAME [stripe COUNT] [replica COUNT] [transport tcp | rdma | tcp, rdma] NEW-BRICK...</span><br><span class="line"></span><br><span class="line">示例：gluster volume create test-volume stripe 2 replica 2 transport tcp server1:/exp1/brick server2:/exp2/brick server3:/exp3/brick server4:/exp4/brick</span><br></pre></td></tr></table></figure>
<h4 id="启动卷"><a href="#启动卷" class="headerlink" title="启动卷"></a>启动卷</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gluster volume start test-volume</span><br></pre></td></tr></table></figure>
<h4 id="停止卷"><a href="#停止卷" class="headerlink" title="停止卷"></a>停止卷</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gluster volume stop test-volume</span><br></pre></td></tr></table></figure>
<h4 id="删除卷"><a href="#删除卷" class="headerlink" title="删除卷"></a>删除卷</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gluster volume delete test-volume  //先停止卷后才能删除</span><br></pre></td></tr></table></figure>
<h4 id="查看卷"><a href="#查看卷" class="headerlink" title="查看卷"></a>查看卷</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">gluster volume list              /*列出集群中的所有卷*/</span><br><span class="line">gluster volume info [all]      /*查看集群中的卷信息*/</span><br><span class="line">gluster volume status [all]  /*查看集群中的卷状态*/</span><br><span class="line">gluster volume status  [detail| clients | mem | inode | fd]</span><br></pre></td></tr></table></figure>
<h4 id="配置卷"><a href="#配置卷" class="headerlink" title="配置卷"></a>配置卷</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gluster volume <span class="built_in">set</span> &lt;VOLNAME&gt; &lt;OPTION&gt; &lt;PARAMETER&gt;</span><br></pre></td></tr></table></figure>
<h4 id="扩展卷"><a href="#扩展卷" class="headerlink" title="扩展卷"></a>扩展卷</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gluster volume add-brick &lt;VOLNAME&gt; &lt;NEW-BRICK&gt;</span><br></pre></td></tr></table></figure>
<p>注意，如果是复制卷或者条带卷，则每次添加的Brick数必须是replica或者stripe的整数倍。</p>
<h4 id="收缩卷"><a href="#收缩卷" class="headerlink" title="收缩卷"></a>收缩卷</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">先将数据迁移到其它可用的Brick，迁移结束后才将该Brick移除：</span><br><span class="line"><span class="comment"># gluster volume remove-brick  start</span></span><br><span class="line">在执行了start之后，可以使用status命令查看移除进度：</span><br><span class="line"><span class="comment"># gluster volume remove-brick  status</span></span><br><span class="line">不进行数据迁移，直接删除该Brick：</span><br><span class="line"><span class="comment"># gluster volume remove-brick  commit</span></span><br></pre></td></tr></table></figure>
<p>注意，如果是复制卷或者条带卷，则每次移除的Brick数必须是replica或者stripe的整数倍。</p>
<h4 id="迁移卷"><a href="#迁移卷" class="headerlink" title="迁移卷"></a>迁移卷</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">使用start命令开始进行迁移：</span><br><span class="line"><span class="comment"># gluster volume replace-brick  start</span></span><br><span class="line">在数据迁移过程中，可以使用pause命令暂停迁移：</span><br><span class="line"><span class="comment"># gluster volume replace-brick  pause</span></span><br><span class="line">在数据迁移过程中，可以使用abort命令终止迁移：</span><br><span class="line"><span class="comment"># gluster volume replace-brick  abort</span></span><br><span class="line">在数据迁移过程中，可以使用status命令查看迁移进度：</span><br><span class="line"><span class="comment"># gluster volume replace-brick  status</span></span><br><span class="line">在数据迁移结束后，执行commit命令来进行Brick替换：</span><br><span class="line"><span class="comment"># gluster volume replace-brick  commit</span></span><br></pre></td></tr></table></figure>
<h4 id="重新均衡卷"><a href="#重新均衡卷" class="headerlink" title="重新均衡卷"></a>重新均衡卷</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">不迁移数据：</span><br><span class="line"><span class="comment"># gluster volume rebalance  lay-outstart</span></span><br><span class="line"><span class="comment"># gluster volume rebalance  start</span></span><br><span class="line"><span class="comment"># gluster volume rebalance  startforce</span></span><br><span class="line"><span class="comment"># gluster volume rebalance  status</span></span><br><span class="line"><span class="comment"># gluster volume rebalance  stop</span></span><br></pre></td></tr></table></figure>
<h4 id="添加Brick"><a href="#添加Brick" class="headerlink" title="添加Brick"></a>添加Brick</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># gluster volume add-brick test-volume 192.168.1.&#123;151,152&#125;:/mnt/brick2</span></span><br></pre></td></tr></table></figure>
<h4 id="删除Brick"><a href="#删除Brick" class="headerlink" title="删除Brick"></a>删除Brick</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">若是副本卷，则移除的Bricks数是replica的整数倍</span><br><span class="line"><span class="comment">#gluster volume remove-brick test-volume 192.168.1.&#123;151,152&#125;:/mnt/brick2 start</span></span><br><span class="line">在执行开始移除之后，可以使用status命令进行移除状态查看。</span><br><span class="line"><span class="comment">#gluster volume remove-brick test-volume 192.168.1.&#123;151,152&#125;:/mnt/brick2 status</span></span><br><span class="line"></span><br><span class="line">使用commit命令执行Brick移除，则不会进行数据迁移而直接删除Brick，符合不需要数据迁移的用户需求。</span><br><span class="line"><span class="comment">#gluster volume remove-brick test-volume 192.168.1.&#123;151,152&#125;:/mnt/brick2 commit</span></span><br></pre></td></tr></table></figure>
<h4 id="替换Brick"><a href="#替换Brick" class="headerlink" title="替换Brick"></a>替换Brick</h4><p>任务：把192.168.1.151:&#x2F;mnt&#x2F;brick0 替换为192.168.1.151:&#x2F;mnt&#x2F;brick2</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">&lt;1&gt;开始替换</span><br><span class="line"><span class="comment">#gluster volume replace-brick test-volume 192.168.1.:/mnt/brick0 ..152:/mnt/brick2 start</span></span><br><span class="line">异常信息：volume replace-brick: failed: /data/share2 or a prefix of it is already part of a volume</span><br><span class="line"></span><br><span class="line">说明 /mnt/brick2 曾经是一个Brick。具体解决方法</span><br><span class="line"><span class="comment"># rm -rf /mnt/brick2/.glusterfs</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># setfattr -x trusted.glusterfs.volume-id /mnt/brick2</span></span><br><span class="line"><span class="comment"># setfattr -x trusted.gfid  /mnt/brick2</span></span><br><span class="line"></span><br><span class="line">//如上，执行replcace-brick卷替换启动命令，使用start启动命令后，开始将原始Brick的数据迁移到即将需要替换的Brick上。</span><br><span class="line"></span><br><span class="line">&lt;2&gt;查看是否替换完</span><br><span class="line"></span><br><span class="line"><span class="comment">#gluster volume replace-brick test-volume 192.168.1.151:/mnt/brick0 ..152:/mnt/brick2 status</span></span><br><span class="line">&lt;3&gt;在数据迁移的过程中，可以执行abort命令终止Brick替换。</span><br><span class="line"><span class="comment">#gluster volume replace-brick test-volume 192.168.1.151:/mnt/brick0 ..152:/mnt/brick2 abort</span></span><br><span class="line"></span><br><span class="line">&lt;4&gt;在数据迁移结束之后，执行commit命令结束任务，则进行Brick替换。使用volume info命令可以查看到Brick已经被替换。</span><br><span class="line"></span><br><span class="line"><span class="comment">#gluster volume replace-brick test-volume 192.168.1.151:/mnt/brick0 .152:/mnt/brick2 commit</span></span><br><span class="line"><span class="comment"># 此时我们再往 /sf/data/vs/gfs/rep2上添加数据的话，数据会同步到 192.168.1.152:/mnt/brick0和192.168.1.152:/mnt/brick2上。而不会同步到</span></span><br><span class="line">192.168.1.151:/mnt/brick0 上。</span><br></pre></td></tr></table></figure>
<h4 id="文件系统扩展属性"><a href="#文件系统扩展属性" class="headerlink" title="文件系统扩展属性"></a>文件系统扩展属性</h4><p>获取文件扩展属性</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">getfattr -d -m . -e hex filename</span><br><span class="line">getfattr -d -m <span class="string">&quot;trusted.afr.*&quot;</span> -e hex filename</span><br></pre></td></tr></table></figure>
<h3 id="日志文件路径"><a href="#日志文件路径" class="headerlink" title="日志文件路径"></a>日志文件路径</h3><p>相关日志，在客户端机器的&#x2F;var&#x2F;log&#x2F;glusterfs&#x2F;目录下，可根据需要查看；<br>如&#x2F;var&#x2F;log&#x2F;glusterfs&#x2F;brick&#x2F;下是各brick创建的日志；<br>如&#x2F;var&#x2F;log&#x2F;glusterfs&#x2F;cmd_history.log是命令执行记录日志；<br>如&#x2F;var&#x2F;log&#x2F;glusterfs&#x2F;glusterd.log是glusterd守护进程日志。</p>
<h3 id="Glusterfs容灾能力研究"><a href="#Glusterfs容灾能力研究" class="headerlink" title="Glusterfs容灾能力研究"></a>Glusterfs容灾能力研究</h3><h4 id="glusterfs集群节点关机重启-单节点"><a href="#glusterfs集群节点关机重启-单节点" class="headerlink" title="glusterfs集群节点关机重启(单节点)"></a>glusterfs集群节点关机重启(单节点)</h4><p>关机的机器没有设置开机自动挂载,关机重启后，挂载点消失 需手动重新挂载</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mount /dev/sdb1 /glusterfs-data/data01/</span><br></pre></td></tr></table></figure>

<p>若重新挂载后,出现关机重启后的机器的brick不正常，则在glusterfs集群节点重启数据卷即可：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gluster volume stop devops-volume</span><br><span class="line">gluster volume start devops-volume</span><br></pre></td></tr></table></figure>
<p><img src="/img/glusterfs_10.png" alt="image"></p>
<p>然后重新进入glusterfs目录，发现在关机期间，客户端新建的文件也同步过来了，但是和同一个副本集下的另一个副本的文件扩展属性有差别，如下（关机重启的是gfs131机器）：<br><img src="/img/glusterfs_8.png" alt="image"><br><img src="/img/glusterfs_9.png" alt="image"><br>如果属性值如上，则可用gfs132的bcv2.txt文件去恢复gfs131的bcv2.txt文件。</p>
<p>【说明】<br>如果gfs131和gfs132都正常的情况下，客户端新往这两台机器写入数据（bcv3.txt），那么bcv3.txt的扩展属性都与上图1类似，没有trusted.afr.dirty属性值，两台机器重启时扩展属性值不变。证明此种情况下，两台机器的bcv3.txt数据是正常的。</p>
<p>如果gfs131正常，gfs132离线，客户端新往这两台机器写入数据（bcv4.txt），那么，重启gfs132后，该文件的扩展属性与上图1类似，没有trusted.afr.dirty属性值。bcv4.txt的扩展属性在gfs131中与上图2类似，有trusted.afr.dirty属性值且为0x000000000000。 证明此种情况下，gfs131机器的bcv4.txt数据是正常的，gfs132机器的bcv4.txt数据可能是不可靠的。</p>
<h4 id="glusterfs集群节点关机重启-一个副本集下的双节点"><a href="#glusterfs集群节点关机重启-一个副本集下的双节点" class="headerlink" title="glusterfs集群节点关机重启(一个副本集下的双节点)"></a>glusterfs集群节点关机重启(一个副本集下的双节点)</h4><p>测试关闭了gfs131和gfs132，然后在客户端创建文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">touch</span> distributed-replica&#123;1..6&#125;.txt</span><br></pre></td></tr></table></figure>
<p>出现下述问题：<br><img src="/img/glusterfs_11.png" alt="image"><br> 此时，数据就会丢失且无法恢复，应尽量避免此情况发生。</p>
<h4 id="glusterfs集群状态检查"><a href="#glusterfs集群状态检查" class="headerlink" title="glusterfs集群状态检查"></a>glusterfs集群状态检查</h4><p>可以通过下述命令，对glusterfs集群进行健康状态的检查:<br>gluster volume status devops-volume<br>gluster volume info<br>下图即为正常<br><img src="/img/glusterfs_7.png" alt="image"></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" title="الصفحة التالية" aria-label="الصفحة التالية" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2023</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">wangdj</span>
  </div>
  <div class="powered-by">تطبيق الموقع <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  






  





</body>
</html>
